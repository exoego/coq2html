
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module impredicative_set.imonad_transformer</title>
<meta name="description" content="Documentation of Coq module impredicative_set.imonad_transformer" />
<link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath/texmath.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="init('proofscript')">
<h1 class="title">Module impredicative_set.imonad_transformer</h1>
<div class="coq">
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">all_ssreflect</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">imonae_lib</span>.<br/>
<span class="vernacular">From</span> <span class="id">HB</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">structures</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">ihierarchy</span> <span class="id">imonad_lib</span> <span class="id">ifail_lib</span> <span class="id">istate_lib</span>.<br/>
<br/>
<pre class="ssrdoc">
                   Formalization of monad transformers                     
                                                                           
This file corresponds to the formalization of [Mauro Jaskelioff, Modular   
Monad Transformers, ESOP 2009] (roughly, up to Sect. 5, Example 22).       
                                                                           
 Module MonadMLaws == laws of monad morphisms                              
            monadM == type of monad morphisms                              
            monadT == type of monad transformers, i.e., functions t of     
                      type monad -&gt; monad equipped with an operator Lift   
                      such that for any monad M Lift t M is a monad        
                      morphism from M to t M                               
                      instances:                                           
                      - stateT: the state monad transformer                
                      - exceptT: the exception monad transformer           
                      - envT: environment                                  
                      - outputT                                            
                      - contT: continuation                                
        mapStateT2 == standard utility function                            
           lifting == lifting of a sigma-operation along a monad morphism  
          alifting == algebraic operation defined using an algebraic       
                      operation op and a monad morphism e                  
uniform_algebraic_lifting == Theorem: alifting is a lifting                
                                                                           
        functorial == type of functors where the action on objects as type 
                      monad -&gt; monad                                       
               fmt == type of functorial monad transformers                
                      instances:                                           
                      - exceptFMT                                          
                      - stateFMT                                           
                      - envFMT                                             
                      - outputFMT                                          
                                                                           
</pre>
<br/>
<span class="gallina-kwd">Set</span> <span class="vernacular">Implicit</span> <span class="vernacular">Arguments</span>.<br/>
<span class="id">Unset</span> <span class="id">Strict</span> <span class="vernacular">Implicit</span>.<br/>
<span class="id">Unset</span> <span class="id">Printing</span> <span class="vernacular">Implicit</span> <span class="id">Defensive</span>.<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">MonadMLaws</span>.<br/>
<span class="vernacular">Section</span> <span class="id">monadmlaws</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">ret</span> (<span class="id">e</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~~&gt;</span> <span class="id">N</span>) <span class="id">:=</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">e</span> <span class="id">A</span> <span class="id">\o</span> <span class="id">Ret</span> <span class="id">=</span> <span class="id">Ret</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">bind</span> (<span class="id">e</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~~&gt;</span> <span class="id">N</span>) <span class="id">:=</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;<span class="id">e</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">=</span> <span class="id">e</span> <span class="id">A</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="id">e</span> <span class="id">B</span> <span class="id">\o</span> <span class="id">f</span>).<br/>
<span class="vernacular">End</span> <span class="id">monadmlaws</span>.<br/>
<span class="vernacular">End</span> <span class="id">MonadMLaws</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadM</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~~&gt;</span> <span class="id">N</span>) <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">monadMret</span> <span class="id">:</span> <span class="id">MonadMLaws.ret</span> <span class="id">e</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">monadMbind</span> <span class="id">:</span> <span class="id">MonadMLaws.bind</span> <span class="id">e</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=monadM</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadM</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{e</span> <span class="id">of</span> <span class="id">isMonadM</span> <span class="id">M</span> <span class="id">N</span> <span class="id">e</span> <span class="id">&amp;</span> <span class="id">isNatural</span> <span class="id">M</span> <span class="id">N</span> <span class="id">e}</span>.<br/>
<br/>
<span class="id">HB.factory</span> <span class="vernacular">Record</span> <span class="id">isMonadM_ret_bind</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~~&gt;</span> <span class="id">N</span>) <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">monadMret</span> <span class="id">:</span> <span class="id">MonadMLaws.ret</span> <span class="id">e</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">monadMbind</span> <span class="id">:</span> <span class="id">MonadMLaws.bind</span> <span class="id">e</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.builders</span> <span class="vernacular">Context</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~~&gt;</span> <span class="id">N</span>) <span class="id">of</span> <span class="id">isMonadM_ret_bind</span> <span class="id">M</span> <span class="id">N</span> <span class="id">e</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">naturality_monadM</span> <span class="id">:</span> <span class="id">naturality</span> <span class="id">M</span> <span class="id">N</span> <span class="id">e</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof1')">Proof.</span></div>
<div class="proofscript" id="proof1">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!fmapE</span> <span class="id">monadMbind</span> (<span class="id">compA</span> (<span class="id">e</span> <span class="id">B</span>)) <span class="id">monadMret</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span> <span class="id">M</span> <span class="id">N</span> <span class="id">e</span> <span class="id">naturality_monadM</span>.<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadM.Build</span> <span class="id">M</span> <span class="id">N</span> <span class="id">e</span> <span class="id">monadMret</span> <span class="id">monadMbind</span>.<br/>
<span class="id">HB.end</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadT</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">monad</span> <span class="id">-&gt;</span> <span class="id">monad</span>) <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">Lift</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">M,</span> <span class="id">monadM</span> <span class="id">M</span> (<span class="id">T</span> <span class="id">M</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=monadT</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadT</span> <span class="id">:=</span> <span class="id">{T</span> <span class="id">of</span> <span class="id">isMonadT</span> <span class="id">T}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">Lift</span> <span class="id">:</span> <span class="id">clear</span> <span class="id">implicits</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">state_monad_transformer</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">MS</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)<span class="id">%type</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">retS</span> <span class="id">:</span> <span class="id">FId</span> <span class="id">~~&gt;</span> <span class="id">MS</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">curry</span> <span class="id">Ret</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">bindS</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">MS</span> <span class="id">A</span>) <span class="id">f</span> <span class="id">:</span> <span class="id">MS</span> <span class="id">B</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="id">uncurry</span> <span class="id">f</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bindSretf</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bindS</span> <span class="id">retS</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof2')">Proof.</span></div>
<div class="proofscript" id="proof2">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/bindS;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindSmret</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bindS</span> <span class="id">retS</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof3')">Proof.</span></div>
<div class="proofscript" id="proof3">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">/bindS;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">RHS]</span>(<span class="id">bindmret</span> (<span class="id">m</span> <span class="id">s</span>))<span class="id">;</span> <span class="id">bind_ext;</span> <span class="id">case</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindSA</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bindS</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof4')">Proof.</span></div>
<div class="proofscript" id="proof4">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">m</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">/bindS;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">bind_ext;</span> <span class="id">case</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">MS</span> <span class="id">bindSretf</span> <span class="id">bindSmret</span> <span class="id">bindSA</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">MS_mapE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">MS</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">MS]</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span> <span class="id">=</span> (<span class="id">M</span> <span class="id">#</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> (<span class="id">f</span> <span class="id">x</span>.<span class="id">1,</span> <span class="id">x</span>.<span class="id">2</span>))) <span class="id">\o</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof5')">Proof.</span></div>
<div class="proofscript" id="proof5">
<span class="id">apply</span> <span class="id">funext=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> <span class="id">{1}/actm</span> <span class="id">/=</span> <span class="id">/bindS</span> <span class="id">/=</span> <span class="id">fmapE</span>.<br/>
<span class="id">congr</span> <span class="id">bind</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">funext;</span> <span class="id">case</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">liftS</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">MS</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x,</span> <span class="id">s</span>)).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">retliftS</span> <span class="id">:</span> <span class="id">MonadMLaws.ret</span> <span class="id">liftS</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof6')">Proof.</span></div>
<div class="proofscript" id="proof6">
<span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">rewrite</span> <span class="id">/liftS;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">a</span> <span class="id">/=;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindliftS</span> <span class="id">:</span> <span class="id">MonadMLaws.bind</span> <span class="id">liftS</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof7')">Proof.</span></div>
<div class="proofscript" id="proof7">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">{1}/liftS;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]bindA</span>.<br/>
<span class="id">transitivity</span> (<span class="id">liftS</span> <span class="id">m</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="id">uncurry</span> (<span class="id">@liftS</span> <span class="id">B</span> <span class="id">\o</span> <span class="id">f</span>)) <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]bindA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadM_ret_bind.Build</span><br/>
&nbsp;&nbsp;<span class="id">M</span> <span class="id">MS</span> <span class="id">liftS</span> <span class="id">retliftS</span> <span class="id">bindliftS</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">state_monad_transformer</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">MS_bindE</span> <span class="id">[S</span> <span class="id">:</span> <span class="id">UU0]</span> <span class="id">[M</span> <span class="id">:</span> <span class="id">monad]</span> <span class="id">[A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0]</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">s</span> <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">m</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="id">uncurry</span> <span class="id">f</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof8')">Proof.</span></div>
<div class="proofscript" id="proof8">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">stateT</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">monad</span> <span class="id">-&gt;</span> <span class="id">monad</span> <span class="id">:=</span> <span class="id">MS</span> <span class="id">S</span>.<br/>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">isMonadT.Build</span><br/>
&nbsp;&nbsp;(<span class="id">stateT</span> <span class="id">S</span>) (<span class="id">@liftS</span> <span class="id">S</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">mapStateT2</span> (<span class="id">A</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">N1</span> <span class="id">N2</span> <span class="id">N3</span> <span class="id">:</span> <span class="id">monad</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">f</span> <span class="id">:</span> <span class="id">N1</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)<span class="id">%type</span> <span class="id">-&gt;</span> <span class="id">N2</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)<span class="id">%type</span> <span class="id">-&gt;</span> <span class="id">N3</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)<span class="id">%type</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">m1</span> <span class="id">:</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">N1</span> <span class="id">A</span>) (<span class="id">m2</span> <span class="id">:</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">N2</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">N3</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">m1</span> <span class="id">s</span>) (<span class="id">m2</span> <span class="id">s</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">stateMonad_of_stateT</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Put</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">tt,</span> <span class="id">s</span>).<br/>
<span class="vernacular">Let</span> <span class="id">Get</span> <span class="id">:</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">M</span> <span class="id">S</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">s,</span> <span class="id">s</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bindputput</span> <span class="id">s</span> <span class="id">s'</span> <span class="id">:</span> <span class="id">Put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Put</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">Put</span> <span class="id">s'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof9')">Proof.</span></div>
<div class="proofscript" id="proof9">
<span class="id">rewrite</span> <span class="id">/Ret</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">/=</span> <span class="id">/bindS;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s0</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_mapE</span> <span class="id">bind_fmap</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindputget</span> <span class="id">s</span> <span class="id">:</span> <span class="id">Put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Get</span> <span class="id">=</span> <span class="id">Put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof10')">Proof.</span></div>
<div class="proofscript" id="proof10">
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">!MS_mapE</span> <span class="id">/=</span> <span class="id">/bindS</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s'</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!bind_fmap</span> <span class="id">!bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindgetput</span> <span class="id">:</span> <span class="id">Get</span> <span class="id">&gt;&gt;=</span> <span class="id">Put</span> <span class="id">=</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof11')">Proof.</span></div>
<div class="proofscript" id="proof11">
<span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">MS_mapE</span> <span class="id">/=</span> <span class="id">/bindS</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">bind_fmap</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindgetget</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">Get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">Get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">Get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof12')">Proof.</span></div>
<div class="proofscript" id="proof12">
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> <span class="id">/Get/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">!MS_mapE</span> <span class="id">/=</span> <span class="id">/bindS</span> <span class="id">/=</span> <span class="id">/retS/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bind_fmap</span> <span class="id">!bindretf/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">!MS_mapE</span> <span class="id">/=</span> <span class="id">/bindS</span> <span class="id">/=</span> <span class="id">/retS/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bind_fmap</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadState</span>.<span class="id">Build</span><br/>
&nbsp;&nbsp;<span class="id">S</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">M</span>) <span class="id">Get</span> <span class="id">Put</span> <span class="id">bindputput</span> <span class="id">bindputget</span> <span class="id">bindgetput</span> <span class="id">bindgetget</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">stateMonad_of_stateT</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">exception_monad_transformer</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Obligation</span> <span class="vernacular">Tactic</span> <span class="id">:=</span> <span class="id">idtac</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">Z</span> <span class="id">:</span> <span class="id">UU0</span>)  (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">MX</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">M</span> (<span class="id">Z</span> <span class="id">+</span> <span class="id">X</span>)<span class="id">%type</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">retX</span> <span class="id">:</span> <span class="id">FId</span> <span class="id">~~&gt;</span> <span class="id">MX</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">X</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">inr</span> <span class="id">x</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">bindX</span> <span class="id">X</span> <span class="id">Y</span> (<span class="id">t</span> <span class="id">:</span> <span class="id">MX</span> <span class="id">X</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">MX</span> <span class="id">Y</span>) <span class="id">:</span> <span class="id">MX</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">t</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">c</span> <span class="id">=&gt;</span> <span class="gallina-kwd">match</span> <span class="id">c</span> <span class="gallina-kwd">with</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">inl</span> <span class="id">z</span>) <span class="id">|</span> <span class="id">inr</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span> <span class="gallina-kwd">end</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bindXretf</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bindX</span> <span class="id">retX</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof13')">Proof.</span></div>
<div class="proofscript" id="proof13">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/bindX</span> <span class="id">bindretf</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindXmret</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bindX</span> <span class="id">retX</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof14')">Proof.</span></div>
<div class="proofscript" id="proof14">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">/bindX</span> <span class="id">-[in</span> <span class="id">RHS]</span>(<span class="id">bindmret</span> <span class="id">m</span>)<span class="id">;</span> <span class="id">bind_ext;</span> <span class="id">case</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindXA</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bindX</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof15')">Proof.</span></div>
<div class="proofscript" id="proof15">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">m</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">/bindX</span> <span class="id">bindA;</span> <span class="id">bind_ext;</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">z;</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">MX</span> <span class="id">bindXretf</span> <span class="id">bindXmret</span> <span class="id">bindXA</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">MX_mapE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">MX]</span> <span class="id">#</span> <span class="id">f</span> <span class="id">=</span> <span class="id">M</span> <span class="id">#</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="gallina-kwd">match</span> <span class="id">x</span> <span class="gallina-kwd">with</span> <span class="id">inl</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">inl</span> <span class="id">y</span> <span class="id">|</span> <span class="id">inr</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">inr</span> (<span class="id">f</span> <span class="id">y</span>) <span class="gallina-kwd">end</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof16')">Proof.</span></div>
<div class="proofscript" id="proof16">
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span>.<br/>
<span class="id">rewrite</span> <span class="id">{1}/actm</span> <span class="id">/=</span> <span class="id">/bindX</span> <span class="id">/=</span> <span class="id">[in</span> <span class="id">RHS]fmapE</span>.<br/>
<span class="id">congr</span> (<span class="id">_</span> <span class="id">_</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">funext;</span> <span class="id">case</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">liftX</span> <span class="id">X</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">MX</span> <span class="id">X</span> <span class="id">:=</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="id">@ret</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MX]</span> <span class="id">_</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">retliftX</span> <span class="id">:</span> <span class="id">MonadMLaws.ret</span> <span class="id">liftX</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof17')">Proof.</span></div>
<div class="proofscript" id="proof17">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">rewrite</span> <span class="id">/liftX</span> <span class="id">/=</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindliftX</span> <span class="id">:</span> <span class="id">MonadMLaws.bind</span> <span class="id">liftX</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof18')">Proof.</span></div>
<div class="proofscript" id="proof18">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">{1}/liftX</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">!fmapE</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">/join_of_bind</span> <span class="id">/bindX</span> <span class="id">/=</span> <span class="id">!bindA</span>.<br/>
<span class="id">rewrite</span> <span class="id">2!joinE</span> <span class="id">!bindA</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a</span>.<br/>
<span class="id">rewrite</span> <span class="id">3!bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">/liftX</span> <span class="id">/=</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">b</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadM_ret_bind.Build</span><br/>
&nbsp;&nbsp;<span class="id">M</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MX]</span> <span class="id">liftX</span> <span class="id">retliftX</span> <span class="id">bindliftX</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">exception_monad_transformer</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">exceptT</span> (<span class="id">Z</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">M</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MX</span> <span class="id">Z</span> <span class="id">M]</span>.<br/>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">Z</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">isMonadT.Build</span><br/>
&nbsp;&nbsp;(<span class="id">exceptT</span> <span class="id">Z</span>) (<span class="gallina-kwd">fun</span> <span class="id">M</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">monadM</span> <span class="id">M</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MX</span> <span class="id">Z</span> <span class="id">M]</span> <span class="id">of</span> <span class="id">@liftX</span> <span class="id">Z</span> <span class="id">M]</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">failMonad_of_exceptT</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>.<br/>
<span class="vernacular">Let</span> <span class="id">N</span> (<span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">M</span> (<span class="id">unit</span> <span class="id">+</span> <span class="id">B</span>)<span class="id">%type</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="vernacular">Fail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">B,</span> <span class="id">N</span> <span class="id">B</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">B</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">inl</span> <span class="id">tt</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bindfail</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> (<span class="id">@bind</span> (<span class="id">exceptT</span> <span class="id">unit</span> <span class="id">M</span>)) <span class="vernacular">Fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof19')">Proof.</span></div>
<div class="proofscript" id="proof19">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">/Fail</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">/=</span> <span class="id">/join_of_bind</span> <span class="id">/bindX</span> <span class="id">/=</span> <span class="id">fmapE</span> <span class="id">/=</span> <span class="id">bindA</span> <span class="id">2!bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadFail</span>.<span class="id">Build</span> (<span class="id">MX</span> <span class="id">unit</span> <span class="id">M</span>) <span class="vernacular">Fail</span> <span class="id">bindfail</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">failMonad_of_exceptT</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">exceptMonad_of_exceptT</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<span class="vernacular">Let</span> <span class="id">N</span> (<span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">M</span> (<span class="id">unit</span> <span class="id">+</span> <span class="id">B</span>)<span class="id">%type</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Catch</span> (<span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">x</span> <span class="id">:</span> <span class="id">N</span> <span class="id">B</span>) (<span class="id">y</span> <span class="id">:</span> <span class="id">N</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">N</span> <span class="id">B</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">x</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">k'</span> <span class="id">=&gt;</span> <span class="gallina-kwd">match</span> <span class="id">u</span> <span class="gallina-kwd">with</span> <span class="id">|</span> <span class="id">inl</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">a</span> <span class="id">|</span> <span class="id">inr</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">k'</span> <span class="id">b</span> <span class="gallina-kwd">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fun=&gt;</span> <span class="id">y</span>) (<span class="gallina-kwd">fun</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">inr</span> <span class="id">b</span>))).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Catchmfail</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">right_id</span> (<span class="id">@fail</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">MX</span> <span class="id">unit</span> <span class="id">M]</span> <span class="id">A</span>) (<span class="id">@Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof20')">Proof.</span></div>
<div class="proofscript" id="proof20">
<span class="id">move=&gt;</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/=</span> <span class="id">/fail</span> <span class="id">/=</span> <span class="id">-[in</span> <span class="id">RHS]</span>(<span class="id">bindmret</span> <span class="id">x</span>)<span class="id">;</span> <span class="id">bind_ext</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case=&gt;</span> <span class="id">/=</span> <span class="id">[[]|]</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">Catchfailm</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">left_id</span> (<span class="id">@fail</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">MX</span> <span class="id">unit</span> <span class="id">M]</span> <span class="id">A</span>) (<span class="id">@Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof21')">Proof.</span></div>
<div class="proofscript" id="proof21">
<span class="id">move=&gt;</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">/N</span> <span class="gallina-kwd">in</span> <span class="id">x</span> <span class="id">*</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/=</span> <span class="id">/fail</span> <span class="id">/=</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">CatchA</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">associative</span> (<span class="id">@Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof22')">Proof.</span></div>
<div class="proofscript" id="proof22">
<span class="id">move=&gt;</span> <span class="id">x</span> <span class="id">y</span> <span class="id">z;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">bindA;</span> <span class="id">bind_ext</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case=&gt;</span> <span class="id">[[]//|b];</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">Catchret</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">ua</span> <span class="id">:</span> <span class="id">A%type</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">@left_zero</span> (<span class="id">N</span> <span class="id">A</span>) (<span class="id">N</span> <span class="id">A</span>) (<span class="id">Ret</span> (<span class="id">inr</span> <span class="id">ua</span>)) (<span class="id">@Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof23')">Proof.</span></div>
<div class="proofscript" id="proof23">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">n</span> <span class="id">;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/=</span> <span class="id">bindretf</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadExcept</span>.<span class="id">Build</span><br/>
&nbsp;&nbsp;(<span class="id">MX</span> <span class="id">unit</span> <span class="id">M</span>) <span class="id">Catch</span> <span class="id">Catchmfail</span> <span class="id">Catchfailm</span> <span class="id">CatchA</span> <span class="id">Catchret</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">exceptMonad_of_exceptT</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">environment_monad_transformer</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Obligation</span> <span class="vernacular">Tactic</span> <span class="id">:=</span> <span class="id">idtac</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">R</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">MEnv</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">R</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">retEnv</span> <span class="id">:</span> <span class="id">FId</span> <span class="id">~~&gt;</span> <span class="id">MEnv</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">a</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">a</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">bindEnv</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">MEnv</span> <span class="id">A</span>) <span class="id">f</span> <span class="id">:</span> <span class="id">MEnv</span> <span class="id">B</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">a</span> <span class="id">r</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bindEnvretf</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bindEnv</span> <span class="id">retEnv</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof24')">Proof.</span></div>
<div class="proofscript" id="proof24">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/bindEnv;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">r;</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindEnvmret</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bindEnv</span> <span class="id">retEnv</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof25')">Proof.</span></div>
<div class="proofscript" id="proof25">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">/bindEnv;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">r</span>.<br/>
<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">RHS]</span>(<span class="id">bindmret</span> (<span class="id">m</span> <span class="id">r</span>))<span class="id">;</span> <span class="gallina-kwd">by</span> <span class="id">bind_ext;</span> <span class="id">case</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindEnvA</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bindEnv</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof26')">Proof.</span></div>
<div class="proofscript" id="proof26">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">m</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">/bindEnv;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">r</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">bind_ext;</span> <span class="id">case</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">MEnv</span> <span class="id">bindEnvretf</span> <span class="id">bindEnvmret</span> <span class="id">bindEnvA</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">MEnv_mapE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">MEnv</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">MEnv</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span> <span class="id">=</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">\o</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof27')">Proof.</span></div>
<div class="proofscript" id="proof27">
 <span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">r;</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">fmapE</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">liftEnv</span> <span class="id">A</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">MEnv</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">m</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">retliftEnv</span> <span class="id">:</span> <span class="id">MonadMLaws.ret</span> <span class="id">liftEnv</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof28')">Proof.</span></div>
<div class="proofscript" id="proof28">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindliftEnv</span> <span class="id">:</span> <span class="id">MonadMLaws.bind</span> <span class="id">liftEnv</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof29')">Proof.</span></div>
<div class="proofscript" id="proof29">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">envTmonadM</span> <span class="id">:=</span> <span class="id">isMonadM_ret_bind.Build</span><br/>
&nbsp;&nbsp;<span class="id">M</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MEnv]</span> <span class="id">liftEnv</span> <span class="id">retliftEnv</span> <span class="id">bindliftEnv</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">environment_monad_transformer</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">envT</span> (<span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">M</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MEnv</span> <span class="id">E</span> <span class="id">M]</span>.<br/>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">isMonadT.Build</span> (<span class="id">envT</span> <span class="id">E</span>)<br/>
&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">M</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">monadM</span> <span class="id">M</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MEnv</span> <span class="id">E</span> <span class="id">M]</span> <span class="id">of</span> <span class="id">@liftEnv</span> <span class="id">E</span> <span class="id">M]</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">output_monad_transformer</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Obligation</span> <span class="vernacular">Tactic</span> <span class="id">:=</span> <span class="id">idtac</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">R</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">MO</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">M</span> (<span class="id">X</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">R</span>)<span class="id">%type</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">retO</span> <span class="id">:</span> <span class="id">FId</span> <span class="id">~~&gt;</span> <span class="id">MO</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">a,</span> <span class="id">[::]</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">bindO</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">MO</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">MO</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">MO</span> <span class="id">B</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">o</span> <span class="id">=&gt;</span> <span class="id">let:</span> (<span class="id">x,</span> <span class="id">w</span>) <span class="id">:=</span> <span class="id">o</span> <span class="gallina-kwd">in</span> <span class="id">f</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">o'</span> <span class="id">=&gt;</span> <span class="gallina-kwd">let</span> (<span class="id">x',</span> <span class="id">w'</span>) <span class="id">:=</span> <span class="id">o'</span> <span class="gallina-kwd">in</span> <span class="id">Ret</span> (<span class="id">x',</span> <span class="id">w</span> <span class="id">++</span> <span class="id">w'</span>))).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bindOretf</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bindO</span> <span class="id">retO</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof30')">Proof.</span></div>
<div class="proofscript" id="proof30">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/bindO</span> <span class="id">/=</span> <span class="id">bindretf</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> (<span class="gallina-kwd">fun</span> <span class="id">o'</span> <span class="id">:</span> <span class="id">B</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">R</span> <span class="id">=&gt;</span> <span class="id">_</span>) <span class="id">=</span> (<span class="gallina-kwd">fun</span> <span class="id">o</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">o</span>)) <span class="id">?bindmret</span> <span class="id">//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindOmret</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bindO</span> <span class="id">retO</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof31')">Proof.</span></div>
<div class="proofscript" id="proof31">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">/bindO</span> <span class="id">/=</span> <span class="id">/retO</span> <span class="id">/=</span> <span class="id">-[RHS]bindmret</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">w];</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">cats0</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindOA</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bindO</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof32')">Proof.</span></div>
<div class="proofscript" id="proof32">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">m</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">/bindO</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">bind_ext;</span> <span class="id">case=&gt;</span> <span class="id">x</span> <span class="id">w</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindA;</span> <span class="id">bind_ext;</span> <span class="id">case=&gt;</span> <span class="id">x'</span> <span class="id">w'</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindA</span> <span class="id">bindretf;</span> <span class="id">bind_ext;</span> <span class="id">case=&gt;</span> <span class="id">x''</span> <span class="id">w''</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">catA</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">MO</span> <span class="id">bindOretf</span> <span class="id">bindOmret</span> <span class="id">bindOA</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">MO_mapE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">MO</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">MO]</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span> <span class="id">=</span> (<span class="id">M</span> <span class="id">#</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> (<span class="id">f</span> <span class="id">x</span>.<span class="id">1,</span> <span class="id">x</span>.<span class="id">2</span>))) <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof33')">Proof.</span></div>
<div class="proofscript" id="proof33">
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]/actm</span> <span class="id">/=</span> <span class="id">/bindO</span> <span class="id">/=</span> <span class="id">[in</span> <span class="id">RHS]fmapE</span>.<br/>
<span class="id">congr</span> (<span class="id">_</span> <span class="id">_</span>).<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span> <span class="id">?</span> <span class="id">?</span>.<br/>
<span class="gallina-kwd">by</span>  <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">cats0</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">liftO</span> <span class="id">A</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">MO</span> <span class="id">A</span> <span class="id">:=</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x,</span> <span class="id">[::]</span>)).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">retliftO</span> <span class="id">:</span> <span class="id">MonadMLaws.ret</span> <span class="id">liftO</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof34')">Proof.</span></div>
<div class="proofscript" id="proof34">
<span class="id">move=&gt;</span> <span class="id">a;</span> <span class="id">rewrite</span> <span class="id">/liftO</span> <span class="id">/=</span> <span class="id">/retO;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">o</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindliftO</span> <span class="id">:</span> <span class="id">MonadMLaws.bind</span> <span class="id">liftO</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof35')">Proof.</span></div>
<div class="proofscript" id="proof35">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">{1}/liftO</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">!fmapE</span> <span class="id">/=</span> <span class="id">/join_of_bind</span> <span class="id">/bindO</span> <span class="id">/=</span> <span class="id">2!joinE</span> <span class="id">!bindA</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">!bindretf</span> <span class="id">/liftO</span> <span class="id">bindA</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">b</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">outputTmonadM</span> <span class="id">:=</span> <span class="id">isMonadM_ret_bind.Build</span><br/>
&nbsp;&nbsp;<span class="id">M</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MO]</span> <span class="id">liftO</span> <span class="id">retliftO</span> <span class="id">bindliftO</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">output_monad_transformer</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">outputT</span> (<span class="id">R</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">M</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MO</span> <span class="id">R</span> <span class="id">M]</span>.<br/>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">R</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">isMonadT.Build</span> (<span class="id">outputT</span> <span class="id">R</span>)<br/>
&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">M</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">monadM</span> <span class="id">M</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MO</span> <span class="id">R</span> <span class="id">M]</span> <span class="id">of</span> <span class="id">@liftO</span> <span class="id">R</span> <span class="id">M]</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">continuation_monad_tranformer</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Obligation</span> <span class="vernacular">Tactic</span> <span class="id">:=</span> <span class="id">idtac</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">MC</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">r</span> <span class="id">%type</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">retC</span> <span class="id">:</span> <span class="id">FId</span> <span class="id">~~&gt;</span> <span class="id">MC</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">a</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">bindC</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">MC</span> <span class="id">A</span>) <span class="id">f</span> <span class="id">:</span> <span class="id">MC</span> <span class="id">B</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">m</span> (<span class="id">f^~</span> <span class="id">k</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bindCretf</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bindC</span> <span class="id">retC</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof36')">Proof.</span></div>
<div class="proofscript" id="proof36">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindCmret</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bindC</span> <span class="id">retC</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof37')">Proof.</span></div>
<div class="proofscript" id="proof37">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindCA</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bindC</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof38')">Proof.</span></div>
<div class="proofscript" id="proof38">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">MC</span> <span class="id">bindCretf</span> <span class="id">bindCmret</span> <span class="id">bindCA</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">MC_mapE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">MC</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">MC]</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">m</span> (<span class="id">k</span> <span class="id">\o</span> <span class="id">f</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof39')">Proof.</span></div>
<div class="proofscript" id="proof39">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">liftC</span> <span class="id">A</span> (<span class="id">x</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">MC</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">retliftC</span> <span class="id">:</span> <span class="id">MonadMLaws.ret</span> <span class="id">liftC</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof40')">Proof.</span></div>
<div class="proofscript" id="proof40">
<span class="id">move</span> <span class="id">=&gt;</span> <span class="id">A;</span> <span class="id">rewrite</span> <span class="id">/liftC;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">a</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindliftC</span> <span class="id">:</span> <span class="id">MonadMLaws.bind</span> <span class="id">liftC</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof41')">Proof.</span></div>
<div class="proofscript" id="proof41">
<span class="id">move</span> <span class="id">=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/liftC;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">cont</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">3!bindA</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">contTmonadM</span> <span class="id">:=</span> <span class="id">isMonadM_ret_bind.Build</span><br/>
&nbsp;&nbsp;<span class="id">M</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MC]</span> <span class="id">liftC</span> <span class="id">retliftC</span> <span class="id">bindliftC</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">continuation_monad_tranformer</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">contT</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">M</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MC</span> <span class="id">r</span> <span class="id">M]</span>.<br/>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">isMonadT.Build</span> (<span class="id">contT</span> <span class="id">r</span>)<br/>
&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">M</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">monadM</span> <span class="id">M</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MC</span> <span class="id">r</span> <span class="id">M]</span> <span class="id">of</span> <span class="id">@liftC</span> <span class="id">r</span> <span class="id">M]</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">abortT</span> <span class="id">r</span> <span class="id">X</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">A</span> <span class="id">:</span> <span class="id">contT</span> <span class="id">r</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">X</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">abortT</span> <span class="id">{r}</span> <span class="id">_</span> <span class="id">{M}</span> <span class="id">{A}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">contMonad_of_contT</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<span class="vernacular">Let</span> <span class="id">N</span> <span class="id">:=</span> <span class="id">MC</span> <span class="id">r</span> <span class="id">M</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Callcc</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> ((<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">A</span>) <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">k</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">fun=&gt;</span> <span class="id">f</span> <span class="id">a</span>) <span class="id">f</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Callcc0</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">g</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">A</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">@Callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">g</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>)) <span class="id">=</span> <span class="id">@Callcc</span> <span class="id">_</span> <span class="id">_</span> <span class="id">g</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof42')">Proof.</span></div>
<div class="proofscript" id="proof42">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">Callcc1</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">N</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">@Callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">m</span>) <span class="id">=</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof43')">Proof.</span></div>
<div class="proofscript" id="proof43">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">Callcc2</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">N</span> <span class="id">A</span>) <span class="id">x</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">C</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">@Callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">a</span> <span class="id">b</span>))) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">@Callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">x</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof44')">Proof.</span></div>
<div class="proofscript" id="proof44">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">Callcc3</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">N</span> <span class="id">A</span>) <span class="id">b</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">@Callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">B</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">b</span>) <span class="id">=</span> <span class="id">@Callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">B</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">b</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof45')">Proof.</span></div>
<div class="proofscript" id="proof45">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadContinuation</span>.<span class="id">Build</span><br/>
&nbsp;&nbsp;(<span class="id">MC</span> <span class="id">r</span> <span class="id">M</span>) <span class="id">Callcc</span> <span class="id">Callcc0</span> <span class="id">Callcc1</span> <span class="id">Callcc2</span> <span class="id">Callcc3</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">contMonad_of_contT</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">continuation_monad_transformer_examples</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">for_loop</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">it</span> <span class="id">min</span> <span class="id">:</span> <span class="id">nat</span>) (<span class="id">body</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">contT</span> <span class="id">unit</span> <span class="id">M</span> <span class="id">unit</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">it</span> <span class="id">&lt;=</span> <span class="id">min</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">tt</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="gallina-kwd">if</span> <span class="id">it</span> <span class="id">is</span> <span class="id">it'</span>.<span class="id">+1</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">body</span> <span class="id">it'</span>) (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">for_loop</span> <span class="id">it'</span> <span class="id">min</span> <span class="id">body</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">tt</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">for_loop_lemmas</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>.<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">body</span> <span class="id">:</span> <span class="id">nat</span>  <span class="id">-&gt;</span> <span class="id">contT</span> <span class="id">unit</span> <span class="id">M</span> <span class="id">unit</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">loop0</span> <span class="id">i</span> <span class="id">body</span> <span class="id">:</span> <span class="id">for_loop</span> <span class="id">i</span> <span class="id">i</span> <span class="id">body</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">tt</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof46')">Proof.</span></div>
<div class="proofscript" id="proof46">
<span class="gallina-kwd">by</span> <span class="id">case</span> <span class="id">i</span> <span class="id">=&gt;</span> <span class="id">//=</span> <span class="id">n;</span> <span class="id">rewrite</span> <span class="id">ltnS</span> <span class="id">leqnn</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">loop1</span> <span class="id">i</span> <span class="id">j</span> <span class="id">body</span> <span class="id">:</span> <span class="id">for_loop</span> (<span class="id">i</span>.<span class="id">+1</span> <span class="id">+</span> <span class="id">j</span>) <span class="id">i</span> <span class="id">body</span> <span class="id">=</span><br/>
&nbsp;&nbsp;(<span class="id">body</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">j</span>)) (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">for_loop</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">j</span>) <span class="id">i</span> <span class="id">body</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof47')">Proof.</span></div>
<div class="proofscript" id="proof47">
<span class="id">rewrite</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case</span> <span class="id">:</span> <span class="id">ifPn</span> <span class="id">;</span> <span class="id">rewrite</span> <span class="id">ltnNge</span> <span class="id">leq_addr</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">loop2</span> <span class="id">i</span> <span class="id">j</span> <span class="id">body</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">body</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">j</span>) <span class="id">=</span> <span class="id">abortT</span> <span class="id">tt</span> <span class="id">-&gt;</span> <span class="id">for_loop</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">j</span>).<span class="id">+1</span> <span class="id">i</span> <span class="id">body</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">tt</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof48')">Proof.</span></div>
<div class="proofscript" id="proof48">
<span class="id">move=&gt;</span> <span class="id">Hbody</span> <span class="id">/=</span>.<br/>
<span class="id">case</span> <span class="id">:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">Hcond</span>.<br/>
<span class="id">-</span> <span class="id">reflexivity</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">Hbody</span> <span class="id">/=</span> <span class="id">/abortT</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">for_loop_lemmas</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">foreach</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">items</span> <span class="id">:</span> <span class="id">list</span> <span class="id">nat</span>) (<span class="id">body</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">contT</span> <span class="id">unit</span> <span class="id">M</span> <span class="id">unit</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">foldr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">next</span> <span class="id">=&gt;</span> (<span class="id">body</span> <span class="id">x</span>) (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">next</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Ret</span> <span class="id">tt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">items</span>.<br/>
<br/>
<br/>
<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">sum</span>.<br/>
<span class="vernacular">Variables</span> <span class="id">M</span> <span class="id">:</span> <span class="id">stateMonad</span> <span class="id">nat</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">sum</span> <span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="id">for_loop</span> <span class="id">n</span> <span class="id">O</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">i</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">liftC</span> (<span class="id">get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">put</span> (<span class="id">z</span> <span class="id">+</span> <span class="id">i</span>)))).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">sum_test</span> <span class="id">n</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">sum</span> <span class="id">n</span> <span class="id">=</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">put</span> (<span class="id">m</span> <span class="id">+</span> <span class="id">sumn</span> (<span class="id">iota</span> <span class="id">0</span> <span class="id">n</span>))).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof49')">Proof.</span></div>
<div class="proofscript" id="proof49">
<span class="id">elim:</span> <span class="id">n</span> <span class="id">=&gt;</span> <span class="id">[|n</span> <span class="id">ih]</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">/sum</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">loop0</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">sumn</span> (<span class="id">iota</span> <span class="id">0</span> <span class="id">0</span>) <span class="id">=</span> <span class="id">0</span>) <span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[LHS]bindskipf</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-getputskip</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">addn0</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[RHS]bindmret</span>.<br/>
&nbsp;&nbsp;<span class="id">bind_ext</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">case</span>.<br/>
<span class="id">rewrite</span> <span class="id">/sum</span> <span class="id">-add1n</span> <span class="id">loop1</span> <span class="id">/liftC</span> <span class="id">bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">m</span>.<br/>
<span class="id">rewrite</span> <span class="id">-/</span>(<span class="id">sum</span> <span class="id">n</span>) <span class="id">{}ih</span> <span class="id">-bindA</span>.<br/>
<span class="id">rewrite</span> <span class="id">putget</span> <span class="id">bindA</span> <span class="id">bindretf</span> <span class="id">putput</span>.<br/>
<span class="id">congr</span> <span class="id">put</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">add0n</span> (<span class="id">addnC</span> <span class="id">1</span>) <span class="id">iotaD</span> <span class="id">/=</span> <span class="id">sumn_cat</span> <span class="id">/=</span> <span class="id">add0n</span> <span class="id">addn0</span> <span class="id">/=</span> <span class="id">addnAC</span> <span class="id">addnA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Example</span> <span class="id">sum_from_0_to_10</span> <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">foreach</span> (<span class="id">iota</span> <span class="id">100</span> <span class="id">0</span>) (<span class="gallina-kwd">fun</span> <span class="id">i</span> <span class="id">=&gt;</span> <span class="gallina-kwd">if</span> <span class="id">i</span> <span class="id">&gt;</span> <span class="id">90</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">abortT</span> <span class="id">tt</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">liftC</span> (<span class="id">get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">put</span> (<span class="id">z</span> <span class="id">+</span> <span class="id">i</span>)))).<br/>
<br/>
<span class="vernacular">End</span> <span class="id">sum</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">continuation_monad_transformer_examples</span>.<br/>
<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bindLfailf</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span>) <span class="id">S</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">BindLaws.left_zero</span> (<span class="id">@bind</span> (<span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span>)) (<span class="id">Lift</span> <span class="id">_</span> <span class="id">_</span> <span class="id">^~</span> <span class="id">fail</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof50')">Proof.</span></div>
<div class="proofscript" id="proof50">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">g</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">/liftS;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">bindfailf</span>.<br/>
<span class="id">set</span> <span class="id">x</span> <span class="id">:=</span> (<span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">&gt;&gt;=</span> <span class="id">_</span> <span class="id">=</span> <span class="id">_</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">x</span> <span class="id">=</span> <span class="id">fail</span>) <span class="id">?bindfailf//</span> <span class="id">/x</span> <span class="id">bindfailf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bindmLfail</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">failR0Monad</span>) <span class="id">S</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">BindLaws.right_zero</span> (<span class="id">@bind</span> (<span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span>)) (<span class="id">Lift</span> <span class="id">_</span> <span class="id">_</span> <span class="id">^~</span> <span class="id">fail</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof51')">Proof.</span></div>
<div class="proofscript" id="proof51">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">/liftS/=;</span> <span class="id">apply/funext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">bindfailf</span>.<br/>
<span class="id">set</span> <span class="id">x</span> <span class="id">:=</span> (<span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">&gt;&gt;=</span> <span class="id">X</span> <span class="id">=</span> <span class="id">_</span>).<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">x</span> <span class="id">=</span> <span class="id">fun=&gt;</span> <span class="id">fail</span>) <span class="id">?bindmfail//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply/funext=&gt;</span> <span class="id">-[b</span> <span class="id">s'];</span> <span class="id">rewrite</span> <span class="id">/x/=</span> <span class="id">bindfailf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">lifting</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">E</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">op</span> <span class="id">:</span> <span class="id">E</span>.<span class="id">-operation</span> <span class="id">M</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">M</span> <span class="id">N</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">lifting</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">N</span> <span class="id">~~&gt;</span> <span class="id">N</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">X</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">e</span> <span class="id">X</span> <span class="id">\o</span> <span class="id">op</span> <span class="id">X</span> <span class="id">=</span> <span class="id">f</span> <span class="id">X</span> <span class="id">\o</span> (<span class="id">E</span> <span class="id">#</span> <span class="id">e</span> <span class="id">X</span>).<br/>
<span class="vernacular">End</span> <span class="id">lifting</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">liftingt</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">E</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">op</span> <span class="id">:</span> <span class="id">E</span>.<span class="id">-operation</span> <span class="id">M</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">t</span> <span class="id">:</span> <span class="id">monadT</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">lifting_monadT</span> <span class="id">:=</span> <span class="id">lifting</span> <span class="id">op</span> (<span class="id">Lift</span> <span class="id">t</span> <span class="id">M</span>).<br/>
<span class="vernacular">End</span> <span class="id">liftingt</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">proposition17</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">psi</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">E</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">psi'</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">E</span> <span class="id">~~&gt;</span> <span class="id">M</span>) <span class="id">:</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">X</span> <span class="id">=&gt;</span> <span class="id">Join</span> <span class="id">\o</span> <span class="id">n</span> (<span class="id">M</span> <span class="id">X</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">natural_psi'</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">E</span> <span class="id">~&gt;</span> <span class="id">M</span>) <span class="id">:</span> <span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">M</span> (<span class="id">psi'</span> <span class="id">n</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof52')">Proof.</span></div>
<div class="proofscript" id="proof52">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">rewrite</span> <span class="id">/psi'</span>.<br/>
<span class="id">rewrite</span> <span class="id">-/</span>(<span class="id">Join</span> <span class="id">\o</span> <span class="id">n</span> (<span class="id">M</span> <span class="id">A</span>)) <span class="id">[LHS]compA</span> <span class="id">natural</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-compA</span> (<span class="id">natural</span> <span class="id">n</span>).<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">E</span> <span class="id">~&gt;</span> <span class="id">M</span>) <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">M</span> (<span class="id">psi'</span> <span class="id">n</span>) (<span class="id">natural_psi'</span> <span class="id">n</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_psi'</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">E</span> <span class="id">~&gt;</span> <span class="id">M</span>) <span class="id">:</span> <span class="id">algebraicity</span> (<span class="id">psi'</span> <span class="id">n</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof53')">Proof.</span></div>
<div class="proofscript" id="proof53">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">g</span> <span class="id">t</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">g</span>)).<br/>
<span class="id">rewrite</span> <span class="id">{1}/psi'</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]</span>(<span class="id">compA</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">g</span>) <span class="id">Join</span>).<br/>
<span class="id">rewrite</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">=</span> <span class="id">Join</span> <span class="id">X]compE</span>.<br/>
<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">RHS]</span>(<span class="id">natural</span> <span class="id">n</span>).<br/>
<span class="id">transitivity</span> (<span class="id">Join</span> ((<span class="id">M</span> <span class="id">#</span> (<span class="id">Join</span> <span class="id">\o</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">g</span>))) (<span class="id">n</span> (<span class="id">M</span> <span class="id">A</span>) <span class="id">t</span>)))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> <span class="id">_</span> (<span class="id">n</span> (<span class="id">M</span> <span class="id">A</span>)) <span class="id">t</span>).<br/>
&nbsp;&nbsp;<span class="id">congr</span> (<span class="id">Join</span> ((<span class="id">M</span> <span class="id">#</span> <span class="id">_</span> <span class="id">\o</span> <span class="id">_</span> ) <span class="id">t</span>)).<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">ma</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">Join</span> <span class="id">X</span> <span class="id">=</span> <span class="id">_]compE</span>.<br/>
<span class="id">rewrite</span> (<span class="id">natural</span> <span class="id">join</span>).<br/>
<span class="id">rewrite</span> <span class="id">functor_o</span>.<br/>
<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">RHS]FCompE</span>.<br/>
<span class="id">rewrite</span> <span class="id">-[RHS]compE</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]compA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">joinA</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">E</span> <span class="id">~&gt;</span> <span class="id">M</span>) <span class="id">:=</span> <span class="id">isAOperation.Build</span><br/>
&nbsp;&nbsp;<span class="id">E</span> <span class="id">M</span> (<span class="id">psi'</span> <span class="id">n</span>) (<span class="id">algebraic_psi'</span> <span class="id">n</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">psi</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">E</span> <span class="id">~&gt;</span> <span class="id">M</span>) <span class="id">:=</span> <span class="id">[the</span> <span class="id">E</span>.<span class="id">-aoperation</span> <span class="id">M</span> <span class="id">of</span> <span class="id">psi'</span> <span class="id">n]</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">psiE</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">E</span> <span class="id">~&gt;</span> <span class="id">M</span>) <span class="id">A</span> <span class="id">:</span> <span class="id">psi</span> <span class="id">n</span> <span class="id">A</span> <span class="id">=</span> <span class="id">Join</span> <span class="id">\o</span> <span class="id">n</span> (<span class="id">M</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof54')">Proof.</span></div>
<div class="proofscript" id="proof54">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">psi</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">phi</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">E</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">phi'</span> (<span class="id">op</span> <span class="id">:</span> <span class="id">E</span>.<span class="id">-operation</span> <span class="id">M</span>) <span class="id">:</span> <span class="id">E</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">X</span> <span class="id">=&gt;</span> <span class="id">op</span> <span class="id">X</span> <span class="id">\o</span> (<span class="id">E</span> <span class="id">#</span> <span class="id">Ret</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">natural_phi'</span> (<span class="id">op</span> <span class="id">:</span> <span class="id">E</span>.<span class="id">-operation</span> <span class="id">M</span>) <span class="id">:</span> <span class="id">naturality</span> <span class="id">E</span> <span class="id">M</span> (<span class="id">phi'</span> <span class="id">op</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof55')">Proof.</span></div>
<div class="proofscript" id="proof55">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">rewrite</span> <span class="id">/phi'</span>.<br/>
<span class="id">rewrite</span> <span class="id">compA</span>.<br/>
<span class="id">rewrite</span> (<span class="id">natural</span> <span class="id">op</span>).<br/>
<span class="id">rewrite</span> <span class="id">-compA</span>.<br/>
<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">RHS]compA</span>.<br/>
<span class="id">congr</span> (<span class="id">_</span> <span class="id">\o</span> <span class="id">_</span>).<br/>
<span class="id">rewrite</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">-2!</span>(<span class="id">@functor_o</span> <span class="id">E</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">FIdE</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">op</span> <span class="id">:</span> <span class="id">E</span>.<span class="id">-operation</span> <span class="id">M</span>) <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">E</span> <span class="id">M</span> (<span class="id">phi'</span> <span class="id">op</span>) (<span class="id">natural_phi'</span> <span class="id">op</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">phi</span> (<span class="id">op</span> <span class="id">:</span> <span class="id">E</span>.<span class="id">-operation</span> <span class="id">M</span>) <span class="id">:=</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">phi'</span> <span class="id">op]</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">phiE</span> (<span class="id">op</span> <span class="id">:</span> <span class="id">E</span>.<span class="id">-operation</span> <span class="id">M</span>) (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">phi</span> <span class="id">op</span> <span class="id">X</span> <span class="id">=</span> <span class="id">op</span> <span class="id">X</span> <span class="id">\o</span> (<span class="id">E</span> <span class="id">#</span> <span class="id">Ret</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof56')">Proof.</span></div>
<div class="proofscript" id="proof56">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">phi</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">bijection</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">E</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">psiK</span> (<span class="id">op</span> <span class="id">:</span> <span class="id">E</span> <span class="id">~&gt;</span> <span class="id">M</span>) <span class="id">:</span> <span class="id">phi</span> (<span class="id">psi</span> <span class="id">op</span>) <span class="id">=</span> <span class="id">op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof57')">Proof.</span></div>
<div class="proofscript" id="proof57">
<span class="id">apply/nattrans_ext</span> <span class="id">=&gt;</span> <span class="id">A</span>.<br/>
<span class="id">rewrite</span> <span class="id">phiE</span> <span class="id">/=</span> <span class="id">psiE;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">op</span> <span class="id">_</span>)) <span class="id">-</span>(<span class="id">natural</span> <span class="id">op</span>) <span class="id">-</span>(<span class="id">compE</span> <span class="id">Join</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">compA</span> <span class="id">joinMret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">phiK</span> (<span class="id">op</span> <span class="id">:</span> <span class="id">E</span>.<span class="id">-aoperation</span> <span class="id">M</span>) <span class="id">:</span> <span class="id">psi</span> (<span class="id">phi</span> <span class="id">op</span>) <span class="id">=</span> <span class="id">op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof58')">Proof.</span></div>
<div class="proofscript" id="proof58">
<span class="id">apply/aoperation_ext</span> <span class="id">=&gt;</span> <span class="id">A</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">psiE</span> <span class="id">phiE;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">op</span> <span class="id">_</span>)) <span class="id">joinE</span>.<br/>
<span class="id">rewrite</span> (<span class="id">algebraic</span> <span class="id">op</span>).<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">E</span> <span class="id">#</span> <span class="id">_</span>)) <span class="id">-functor_o</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">op</span> <span class="id">_</span>)).<br/>
<span class="id">set</span> <span class="id">x</span> <span class="id">:=</span> <span class="id">_^~</span> <span class="id">id</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">x</span> <span class="id">=</span> <span class="id">Join</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">mma</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/x</span> <span class="id">bindE</span> <span class="id">functor_id</span> <span class="comment">(*TODO:&nbsp;lemma*)</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">joinretM</span> <span class="id">functor_id</span> <span class="id">compfid</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">bijection</span>.<br/>
<span class="vernacular">End</span> <span class="id">proposition17</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">uniform_algebraic_lifting</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">E</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">op</span> <span class="id">:</span> <span class="id">E</span>.<span class="id">-aoperation</span> <span class="id">M</span>).<br/>
<span class="vernacular">Variables</span> (<span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">M</span> <span class="id">N</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">alifting</span> <span class="id">:=</span> <span class="id">psi</span> (<span class="id">e</span> <span class="id">\v</span> <span class="id">phi</span> <span class="id">op</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">aliftingE</span> <span class="id">:</span> <span class="id">alifting</span> <span class="id">=</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">X</span> <span class="id">=&gt;</span> <span class="id">Join</span> <span class="id">\o</span> <span class="id">e</span> (<span class="id">N</span> <span class="id">X</span>) <span class="id">\o</span> <span class="id">phi</span> <span class="id">op</span> (<span class="id">N</span> <span class="id">X</span>)) <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">~~&gt;</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof59')">Proof.</span></div>
<div class="proofscript" id="proof59">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/alifting/=</span> <span class="id">/vcomp;</span> <span class="id">unlock</span>. Qed.</div>
<br/>
<span class="vernacular">Theorem</span> <span class="id">uniform_algebraic_lifting</span> <span class="id">:</span> <span class="id">lifting</span> <span class="id">op</span> <span class="id">e</span> <span class="id">alifting</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof60')">Proof.</span></div>
<div class="proofscript" id="proof60">
<span class="id">move=&gt;</span> <span class="id">X</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">Y</span>.<br/>
<span class="id">rewrite</span> <span class="id">/alifting</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">psiE</span>.<br/>
<span class="id">rewrite</span> <span class="id">vcompE</span>.<br/>
<span class="id">rewrite</span> <span class="id">phiE</span>.<br/>
<span class="id">rewrite</span> <span class="id">!compE</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> (<span class="id">E</span> <span class="id">#</span> <span class="id">Ret</span>) ((<span class="id">E</span> <span class="id">#</span> <span class="id">e</span> <span class="id">X</span>) <span class="id">Y</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">E</span> <span class="id">#</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">e</span> <span class="id">X</span>)) ((<span class="id">E</span> <span class="id">#</span> <span class="id">Ret</span>) <span class="id">Y</span>))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">LHS]compE</span> <span class="id">-functor_o</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">RHS]compE</span> <span class="id">-functor_o</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">FIdE</span>.<br/>
<span class="id">set</span> <span class="id">x</span> <span class="id">:=</span> (<span class="id">Z</span> <span class="gallina-kwd">in</span> <span class="id">Join</span> (<span class="id">e</span> (<span class="id">N</span> <span class="id">X</span>) <span class="id">Z</span>)).<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">x</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">M</span> <span class="id">#</span> <span class="id">e</span> <span class="id">X</span>) (<span class="id">op</span> (<span class="id">M</span> <span class="id">X</span>) ((<span class="id">E</span> <span class="id">#</span> <span class="id">Ret</span>) <span class="id">Y</span>)))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">e</span> <span class="id">X</span>)).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">natural</span> <span class="id">op</span>).<br/>
<span class="id">transitivity</span> (<span class="id">e</span> <span class="id">X</span> (<span class="id">Join</span> (<span class="id">op</span> (<span class="id">M</span> <span class="id">X</span>) ((<span class="id">E</span> <span class="id">#</span> <span class="id">Ret</span>) <span class="id">Y</span>))))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">joinE</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">monadMbind</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">-</span>(<span class="id">compE</span> <span class="id">_</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">e</span> <span class="id">X</span>)).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-natural</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">LHS]</span>(<span class="id">phiK</span> <span class="id">op</span>).<br/>
Qed.</div>
<span class="vernacular">End</span> <span class="id">uniform_algebraic_lifting</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isFunctorial</span> (<span class="id">t</span> <span class="id">:</span> <span class="id">monad</span> <span class="id">-&gt;</span> <span class="id">monad</span>) <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">hmap</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">{M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad},</span> (<span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>) <span class="id">-&gt;</span> <span class="id">t</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">t</span> <span class="id">N</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">functorial_id</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">M</span> <span class="id">:</span> <span class="id">monad,</span> <span class="id">hmap</span> (<span class="id">NId</span> <span class="id">M</span>) <span class="id">=</span> <span class="id">NId</span> (<span class="id">t</span> <span class="id">M</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">functorial_o</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">P</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">N</span> <span class="id">~&gt;</span> <span class="id">P</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hmap</span> (<span class="id">s</span> <span class="id">\v</span> <span class="id">t</span>) <span class="id">=</span> <span class="id">hmap</span> <span class="id">s</span> <span class="id">\v</span> <span class="id">hmap</span> <span class="id">t</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=functorial</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">Functorial</span> <span class="id">:=</span> <span class="id">{t</span> <span class="id">of</span> <span class="id">isFunctorial</span> <span class="id">t}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">hmap</span> <span class="id">_</span> <span class="id">{M</span> <span class="id">N}</span> <span class="id">_</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isFMT</span> (<span class="id">t</span> <span class="id">:</span> <span class="id">monad</span> <span class="id">-&gt;</span> <span class="id">monad</span>) <span class="id">of</span> <span class="id">MonadT</span> <span class="id">t</span> <span class="id">&amp;</span> <span class="id">Functorial</span> <span class="id">t</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">fmt_ret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">M</span> <span class="id">N</span> (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">M</span> <span class="id">N</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">MonadMLaws.ret</span> (<span class="id">hmap</span> <span class="id">[the</span> <span class="id">functorial</span> <span class="id">of</span> <span class="id">t]</span> <span class="id">e</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">fmt_bind</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">M</span> <span class="id">N</span> (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">M</span> <span class="id">N</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">MonadMLaws.bind</span> (<span class="id">hmap</span> <span class="id">[the</span> <span class="id">functorial</span> <span class="id">of</span> <span class="id">t]</span> <span class="id">e</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">natural_hmap</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hmap</span> <span class="id">[the</span> <span class="id">functorial</span> <span class="id">of</span> <span class="id">t]</span> <span class="id">n</span> <span class="id">\v</span> <span class="id">Lift</span> <span class="id">[the</span> <span class="id">monadT</span> <span class="id">of</span> <span class="id">t]</span> <span class="id">M</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Lift</span> <span class="id">[the</span> <span class="id">monadT</span> <span class="id">of</span> <span class="id">t]</span> <span class="id">N</span> <span class="id">\v</span> <span class="id">n</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=fmt</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">FMT</span> <span class="id">:=</span> <span class="id">{t</span> <span class="id">of</span> <span class="id">isFMT</span> <span class="id">t</span> <span class="id">&amp;</span> <span class="id">isFunctorial</span> <span class="id">t</span> <span class="id">&amp;</span> <span class="id">isMonadT</span> <span class="id">t}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">fmt_lemmas</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">natural_hmapE</span> (<span class="id">t</span> <span class="id">:</span> <span class="id">fmt</span>) (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>) (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">hmap</span> <span class="id">t</span> <span class="id">n</span> <span class="id">X</span> <span class="id">\o</span> <span class="id">Lift</span> <span class="id">t</span> <span class="id">M</span> <span class="id">X</span> <span class="id">=</span> <span class="id">Lift</span> <span class="id">t</span> <span class="id">N</span> <span class="id">X</span> <span class="id">\o</span> <span class="id">n</span> <span class="id">X</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof61')">Proof.</span></div>
<div class="proofscript" id="proof61">
<span class="id">have</span> <span class="id">/nattrans_ext/</span>(<span class="id">_</span> <span class="id">X</span>)<span class="id">/=</span> <span class="id">:=</span> <span class="id">@natural_hmap</span> <span class="id">t</span> <span class="id">M</span> <span class="id">N</span> <span class="id">n</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!vcompE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">fmt_lemmas</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">exceptFMT</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">T</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monadT</span> <span class="id">of</span> <span class="id">exceptT</span> <span class="id">X]</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">hmapX'</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:</span> <span class="id">T</span> <span class="id">F</span> <span class="id">~~&gt;</span> <span class="id">T</span> <span class="id">G</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">tau</span> <span class="id">_</span> <span class="id">t</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">naturality_hmapX'</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> (<span class="id">T</span> <span class="id">F</span>) (<span class="id">T</span> <span class="id">G</span>) (<span class="id">hmapX'</span> <span class="id">tau</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof62')">Proof.</span></div>
<div class="proofscript" id="proof62">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/hmapX'</span> <span class="id">2!MX_mapE</span> (<span class="id">natural</span> <span class="id">tau</span>).<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">hmapX</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> (<span class="id">T</span> <span class="id">F</span>) (<span class="id">T</span> <span class="id">G</span>) (<span class="id">hmapX'</span> <span class="id">tau</span>) (<span class="id">naturality_hmapX'</span> <span class="id">tau</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapX_NId</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">:</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapX'</span> (<span class="id">NId</span> <span class="id">M</span>)<span class="id">]</span> <span class="id">=</span> <span class="id">NId</span> (<span class="id">T</span> <span class="id">M</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof63')">Proof.</span></div>
<div class="proofscript" id="proof63">
 <span class="gallina-kwd">by</span> <span class="id">apply/nattrans_ext</span> <span class="id">=&gt;</span> <span class="id">A</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapX_v</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">P</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">N</span> <span class="id">~&gt;</span> <span class="id">P</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapX'</span> (<span class="id">s</span> <span class="id">\v</span> <span class="id">t</span>)<span class="id">]</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapX'</span> <span class="id">s]</span> <span class="id">\v</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapX'</span> <span class="id">t]</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof64')">Proof.</span></div>
<div class="proofscript" id="proof64">
<span class="gallina-kwd">by</span> <span class="id">apply/nattrans_ext</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">A;</span> <span class="id">rewrite</span> <span class="id">vcompE</span> <span class="id">/=</span> <span class="id">/hmapX'/=</span> <span class="id">vcompE</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctorial.Build</span> (<span class="id">exceptT</span> <span class="id">X</span>) <span class="id">hmapX_NId</span> <span class="id">hmapX_v</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">monadMret_hmapX</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">F</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">MonadMLaws.ret</span> (<span class="id">hmapX'</span> <span class="id">e</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof65')">Proof.</span></div>
<div class="proofscript" id="proof65">
<span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">a</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/hmapX'</span> <span class="id">/retX</span> <span class="id">/=</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">e</span> <span class="id">_</span>)) <span class="id">monadMret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">monadMbind_hmapX</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">F</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">MonadMLaws.bind</span> (<span class="id">hmapX'</span> <span class="id">e</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof66')">Proof.</span></div>
<div class="proofscript" id="proof66">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/hmapX'</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/=</span> <span class="id">!MX_mapE</span> <span class="id">/bindX</span> <span class="id">/=</span> <span class="id">!bind_fmap</span>.<br/>
<span class="id">rewrite</span> <span class="id">!monadMbind</span> <span class="id">/=</span>.<br/>
<span class="id">congr</span> (<span class="id">bind</span> (<span class="id">e</span> (<span class="id">X</span> <span class="id">+</span> <span class="id">A</span>)<span class="id">%type</span> <span class="id">m</span>) <span class="id">_</span>).<br/>
<span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[x/=|//]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">e</span> <span class="id">_</span>)) <span class="id">monadMret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapX_lift</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">h</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">F</span> <span class="id">G</span> <span class="id">FG</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapX'</span> <span class="id">FG]</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;<span class="id">h</span> <span class="id">M</span> <span class="id">N</span> <span class="id">n</span> <span class="id">\v</span> <span class="id">Lift</span> <span class="id">T</span> <span class="id">M</span> <span class="id">=</span> <span class="id">Lift</span> <span class="id">T</span> <span class="id">N</span> <span class="id">\v</span> <span class="id">n</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof67')">Proof.</span></div>
<div class="proofscript" id="proof67">
<span class="id">move=&gt;</span> <span class="id">h</span> <span class="id">M</span> <span class="id">N</span> <span class="id">t;</span> <span class="id">apply/nattrans_ext</span> <span class="id">=&gt;</span> <span class="id">A/=;</span> <span class="id">rewrite</span> <span class="id">!vcompE/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapX'</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/liftX</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/retX</span> <span class="id">/=</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">ma</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">:</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">inr</span> <span class="id">x</span>)) <span class="id">=</span> <span class="id">Ret</span> <span class="id">\o</span> <span class="id">inr</span>) <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">-bind_fmap</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindmret</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">:</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">inr</span> <span class="id">x</span>)) <span class="id">=</span> <span class="id">Ret</span> <span class="id">\o</span> <span class="id">inr</span>) <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">-bind_fmap</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindmret</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">N</span> <span class="id">#</span> <span class="id">inr</span>)).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">natural</span> <span class="id">t</span>).<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFMT.Build</span> (<span class="id">exceptT</span> <span class="id">X</span>)<br/>
&nbsp;&nbsp;<span class="id">monadMret_hmapX</span> <span class="id">monadMbind_hmapX</span>  <span class="id">hmapX_lift</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">exceptFMT</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">Fmt_stateT</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">T</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monadT</span> <span class="id">of</span> <span class="id">stateT</span> <span class="id">S]</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">hmapS</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:</span> <span class="id">T</span> <span class="id">F</span> <span class="id">~~&gt;</span> <span class="id">T</span> <span class="id">G</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">t</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">tau</span> <span class="id">_</span> (<span class="id">t</span> <span class="id">s</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">naturality_hmapS</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> (<span class="id">T</span> <span class="id">F</span>) (<span class="id">T</span> <span class="id">G</span>) (<span class="id">hmapS</span> <span class="id">tau</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof68')">Proof.</span></div>
<div class="proofscript" id="proof68">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapS</span> <span class="id">/=</span>.<br/>
<span class="id">have</span> <span class="id">H</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">G,</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">G]</span> <span class="id">#</span> <span class="id">h</span> <span class="id">=</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">G]</span> <span class="id">#</span> <span class="id">h</span> <span class="gallina-kwd">by</span> <span class="id">[]</span>.<br/>
<span class="id">rewrite</span> <span class="id">!H</span> <span class="id">{H}</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!MS_mapE</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span>  <span class="id">_</span> (<span class="id">tau</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)<span class="id">%type</span>)).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">natural</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;(<span class="id">T</span> <span class="id">F</span>) (<span class="id">T</span> <span class="id">G</span>) (<span class="id">hmapS</span> <span class="id">tau</span>) (<span class="id">naturality_hmapS</span> <span class="id">tau</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapS_NId</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">:</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapS</span> (<span class="id">NId</span> <span class="id">M</span>)<span class="id">]</span> <span class="id">=</span> <span class="id">NId</span> (<span class="id">T</span> <span class="id">M</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof69')">Proof.</span></div>
<div class="proofscript" id="proof69">
 <span class="id">exact/nattrans_ext</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapS_v</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">P</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">N</span> <span class="id">~&gt;</span> <span class="id">P</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapS</span> (<span class="id">s</span> <span class="id">\v</span> <span class="id">t</span>)<span class="id">]</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapS</span> <span class="id">s]</span> <span class="id">\v</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapS</span> <span class="id">t]</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof70')">Proof.</span></div>
<div class="proofscript" id="proof70">
<span class="gallina-kwd">by</span> <span class="id">apply/nattrans_ext</span> <span class="id">=&gt;</span> <span class="id">A</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">vcompE/=</span> <span class="id">/hmapS/=</span> <span class="id">vcompE</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctorial.Build</span> (<span class="id">stateT</span> <span class="id">S</span>) <span class="id">hmapS_NId</span> <span class="id">hmapS_v</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">monadMret_hmapS</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">F</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">MonadMLaws.ret</span> (<span class="id">hmapS</span> <span class="id">e</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof71')">Proof.</span></div>
<div class="proofscript" id="proof71">
<span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">a</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapS</span> <span class="id">/=</span> <span class="id">/retS</span> <span class="id">/=;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]curryE</span> <span class="id">monadMret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">monadMbind_hmapS</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">F</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">MonadMLaws.bind</span> (<span class="id">hmapS</span> <span class="id">e</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof72')">Proof.</span></div>
<div class="proofscript" id="proof72">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapS</span> <span class="id">/=;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">2!bindE</span> <span class="id">/=</span> <span class="id">!MS_mapE</span> <span class="id">/bindS</span> <span class="id">/=</span> <span class="id">2!bind_fmap</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">monadMbind</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapS_lift</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">h</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">F</span> <span class="id">G</span> <span class="id">FG</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapS</span> <span class="id">FG]</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;<span class="id">h</span> <span class="id">M</span> <span class="id">N</span> <span class="id">n</span> <span class="id">\v</span> <span class="id">Lift</span> <span class="id">T</span> <span class="id">M</span> <span class="id">=</span> <span class="id">Lift</span> <span class="id">T</span> <span class="id">N</span> <span class="id">\v</span> <span class="id">n</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof73')">Proof.</span></div>
<div class="proofscript" id="proof73">
<span class="id">move=&gt;</span> <span class="id">h</span> <span class="id">M</span> <span class="id">N</span> <span class="id">t;</span> <span class="id">apply/nattrans_ext</span> <span class="id">=&gt;</span> <span class="id">A</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">!vcompE/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapS</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/liftS</span> <span class="id">/=</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">ma</span> <span class="id">/=</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">![in</span> <span class="id">LHS]bindE</span> <span class="id">![in</span> <span class="id">LHS]fmapE</span> <span class="id">![in</span> <span class="id">LHS]bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">2!</span>(<span class="id">_</span> <span class="id">:</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">:</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x,</span> <span class="id">s</span>)) <span class="id">=</span> <span class="id">Ret</span> <span class="id">\o</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> (<span class="id">x,</span> <span class="id">s</span>))) <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">functor_o</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> <span class="id">Join</span> (<span class="id">_</span> <span class="id">\o</span> <span class="id">_</span>)).<br/>
<span class="id">rewrite</span> (<span class="id">compA</span> <span class="id">Join</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">_</span>)).<br/>
<span class="id">rewrite</span> <span class="id">joinMret</span>.<br/>
<span class="id">rewrite</span> <span class="id">compidf</span>.<br/>
<span class="id">rewrite</span> <span class="id">functor_o</span>.<br/>
<span class="id">rewrite</span> <span class="id">compA</span>.<br/>
<span class="id">rewrite</span> <span class="id">joinMret</span>.<br/>
<span class="id">rewrite</span> <span class="id">compidf</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> <span class="id">_</span> (<span class="id">t</span> <span class="id">A</span>)).<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">t</span> <span class="id">_</span>)).<br/>
<span class="id">rewrite</span> <span class="id">-natural</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">![in</span> <span class="id">RHS]bindE</span> <span class="id">![in</span> <span class="id">RHS]fmapE</span> <span class="id">![in</span> <span class="id">RHS]bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">functor_o</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> <span class="id">Join</span> (<span class="id">_</span> <span class="id">\o</span> <span class="id">_</span>)).<br/>
<span class="id">rewrite</span> (<span class="id">compA</span> <span class="id">Join</span> (<span class="id">N</span> <span class="id">#</span> <span class="id">_</span>)).<br/>
<span class="id">rewrite</span> <span class="id">joinMret</span>.<br/>
<span class="id">rewrite</span> <span class="id">compidf</span>.<br/>
<span class="id">rewrite</span> <span class="id">functor_o</span>.<br/>
<span class="id">rewrite</span> <span class="id">compA</span>.<br/>
<span class="id">rewrite</span> <span class="id">joinMret</span>.<br/>
<span class="id">rewrite</span> <span class="id">compidf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> <span class="id">_</span> (<span class="id">t</span> <span class="id">A</span>)).<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFMT.Build</span> (<span class="id">stateT</span> <span class="id">S</span>)<br/>
&nbsp;&nbsp;<span class="id">monadMret_hmapS</span> <span class="id">monadMbind_hmapS</span> <span class="id">hmapS_lift</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">Fmt_stateT</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">Fmt_envT</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">T</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monadT</span> <span class="id">of</span> <span class="id">envT</span> <span class="id">E]</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">hmapEnv</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:</span> <span class="id">T</span> <span class="id">F</span> <span class="id">~~&gt;</span> <span class="id">T</span> <span class="id">G</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">t</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">tau</span> <span class="id">_</span> (<span class="id">t</span> <span class="id">s</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">naturality_hmapEnv</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> (<span class="id">T</span> <span class="id">F</span>) (<span class="id">T</span> <span class="id">G</span>) (<span class="id">hmapEnv</span> <span class="id">tau</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof74')">Proof.</span></div>
<div class="proofscript" id="proof74">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapEnv</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span>.<br/>
<span class="id">have</span> <span class="id">H</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">G,</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">envT</span> <span class="id">E</span> <span class="id">G]</span> <span class="id">#</span> <span class="id">h</span> <span class="id">=</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">MEnv</span> <span class="id">E</span> <span class="id">G]</span> <span class="id">#</span> <span class="id">h</span> <span class="gallina-kwd">by</span> <span class="id">[]</span>.<br/>
<span class="id">rewrite</span> <span class="id">!H</span> <span class="id">{H}</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!MEnv_mapE</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span>  <span class="id">_</span> (<span class="id">tau</span> <span class="id">A</span>)).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">natural</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> (<span class="id">T</span> <span class="id">F</span>) (<span class="id">T</span> <span class="id">G</span>) (<span class="id">hmapEnv</span> <span class="id">tau</span>) (<span class="id">naturality_hmapEnv</span> <span class="id">tau</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapEnv_NId</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">:</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapEnv</span> (<span class="id">NId</span> <span class="id">M</span>)<span class="id">]</span> <span class="id">=</span> <span class="id">NId</span> (<span class="id">T</span> <span class="id">M</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof75')">Proof.</span></div>
<div class="proofscript" id="proof75">
 <span class="id">exact/nattrans_ext</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapEnv_v</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">P</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">N</span> <span class="id">~&gt;</span> <span class="id">P</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapEnv</span> (<span class="id">s</span> <span class="id">\v</span> <span class="id">t</span>)<span class="id">]</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapEnv</span> <span class="id">s]</span> <span class="id">\v</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapEnv</span> <span class="id">t]</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof76')">Proof.</span></div>
<div class="proofscript" id="proof76">
 <span class="gallina-kwd">by</span> <span class="id">apply/nattrans_ext</span> <span class="id">=&gt;</span> <span class="id">A</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">vcompE/=</span> <span class="id">/hmapEnv</span> <span class="id">vcompE</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctorial.Build</span> (<span class="id">envT</span> <span class="id">E</span>) <span class="id">hmapEnv_NId</span> <span class="id">hmapEnv_v</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">monadMret_hmapEnv</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">F</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">MonadMLaws.ret</span> (<span class="id">hmapEnv</span> <span class="id">e</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof77')">Proof.</span></div>
<div class="proofscript" id="proof77">
<span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">a</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapEnv</span> <span class="id">/=</span> <span class="id">/retEnv</span> <span class="id">/=;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-[LHS]</span>(<span class="id">compE</span> <span class="id">_</span> <span class="id">Ret</span>) <span class="id">monadMret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">monadMbind_hmapEnv</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">F</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">MonadMLaws.bind</span> (<span class="id">hmapEnv</span> <span class="id">e</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof78')">Proof.</span></div>
<div class="proofscript" id="proof78">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapEnv</span> <span class="id">/=;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">2!bindE</span> <span class="id">/=</span> <span class="id">!MEnv_mapE</span> <span class="id">/bindEnv</span> <span class="id">/=</span> <span class="id">2!bind_fmap</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">monadMbind</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapEnv_lift</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">h</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">F</span> <span class="id">G</span> <span class="id">FG</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapEnv</span> <span class="id">FG]</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;<span class="id">h</span> <span class="id">M</span> <span class="id">N</span> <span class="id">n</span> <span class="id">\v</span> <span class="id">Lift</span> <span class="id">T</span> <span class="id">M</span> <span class="id">=</span> <span class="id">Lift</span> <span class="id">T</span> <span class="id">N</span> <span class="id">\v</span> <span class="id">n</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof79')">Proof.</span></div>
<div class="proofscript" id="proof79">
<span class="id">move=&gt;</span> <span class="id">h</span> <span class="id">M</span> <span class="id">N</span> <span class="id">t;</span> <span class="id">apply/nattrans_ext</span> <span class="id">=&gt;</span> <span class="id">A</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">!vcompE/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/hmapEnv/=</span> <span class="id">/liftEnv/=;</span> <span class="id">exact:</span> <span class="id">funext</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFMT.Build</span> (<span class="id">envT</span> <span class="id">E</span>)<br/>
&nbsp;&nbsp;<span class="id">monadMret_hmapEnv</span> <span class="id">monadMbind_hmapEnv</span> <span class="id">hmapEnv_lift</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">Fmt_envT</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">Fmt_outputT</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">R</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">T</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monadT</span> <span class="id">of</span> <span class="id">outputT</span> <span class="id">R]</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">hmapO</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:</span> <span class="id">T</span> <span class="id">F</span> <span class="id">~~&gt;</span> <span class="id">T</span> <span class="id">G</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">=&gt;</span> <span class="id">tau</span> <span class="id">_</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">naturality_hmapO</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> (<span class="id">T</span> <span class="id">F</span>) (<span class="id">T</span> <span class="id">G</span>) (<span class="id">hmapO</span> <span class="id">tau</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof80')">Proof.</span></div>
<div class="proofscript" id="proof80">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapO</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span>.<br/>
<span class="id">have</span> <span class="id">H</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">G,</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">outputT</span> <span class="id">R</span> <span class="id">G]</span> <span class="id">#</span> <span class="id">h</span> <span class="id">=</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">MO</span> <span class="id">R</span> <span class="id">G]</span> <span class="id">#</span> <span class="id">h</span> <span class="gallina-kwd">by</span> <span class="id">[]</span>.<br/>
<span class="id">rewrite</span> <span class="id">!H</span> <span class="id">{H}</span>.<br/>
<span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">!MO_mapE</span>.<br/>
<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">LHS]</span>(<span class="id">compE</span>  <span class="id">_</span> (<span class="id">tau</span> <span class="id">_</span>)).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">natural</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">tau</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> (<span class="id">T</span> <span class="id">F</span>) (<span class="id">T</span> <span class="id">G</span>) (<span class="id">hmapO</span> <span class="id">tau</span>) (<span class="id">naturality_hmapO</span> <span class="id">tau</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapO_NId</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">:</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapO</span> (<span class="id">NId</span> <span class="id">M</span>)<span class="id">]</span> <span class="id">=</span> <span class="id">NId</span> (<span class="id">T</span> <span class="id">M</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof81')">Proof.</span></div>
<div class="proofscript" id="proof81">
 <span class="id">exact/nattrans_ext</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapO_v</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">P</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">N</span> <span class="id">~&gt;</span> <span class="id">P</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapO</span> (<span class="id">s</span> <span class="id">\v</span> <span class="id">t</span>)<span class="id">]</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapO</span> <span class="id">s]</span> <span class="id">\v</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapO</span> <span class="id">t]</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof82')">Proof.</span></div>
<div class="proofscript" id="proof82">
 <span class="gallina-kwd">by</span> <span class="id">apply/nattrans_ext</span> <span class="id">=&gt;</span> <span class="id">A</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">vcompE/=</span> <span class="id">/hmapO/=</span> <span class="id">vcompE</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctorial.Build</span> (<span class="id">outputT</span> <span class="id">R</span>) <span class="id">hmapO_NId</span> <span class="id">hmapO_v</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">monadMret_hmapO</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">F</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">MonadMLaws.ret</span> (<span class="id">hmapO</span> <span class="id">e</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof83')">Proof.</span></div>
<div class="proofscript" id="proof83">
<span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">a;</span> <span class="id">rewrite</span> <span class="id">/hmapO</span> <span class="id">/=</span> <span class="id">/retO</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-[LHS]</span>(<span class="id">compE</span> <span class="id">_</span> <span class="id">Ret</span>) <span class="id">monadMret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">monadMbind_hmapO</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">monadM</span> <span class="id">F</span> <span class="id">G</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">MonadMLaws.bind</span> (<span class="id">hmapO</span> <span class="id">e</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof84')">Proof.</span></div>
<div class="proofscript" id="proof84">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapO</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">2!bindE</span> <span class="id">/=</span> <span class="id">!MO_mapE</span> <span class="id">/bindO</span> <span class="id">/=</span> <span class="id">2!bind_fmap</span>.<br/>
<span class="id">rewrite</span> <span class="id">!monadMbind</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[x</span> <span class="id">w]</span>.<br/>
<span class="id">rewrite</span> <span class="id">/retO</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">monadMbind</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">-[h</span> <span class="id">t]</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">-[LHS]</span>(<span class="id">compE</span> <span class="id">_</span> <span class="id">Ret</span> (<span class="id">h,</span> <span class="id">_</span>)).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">monadMret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">hmapO_lift</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">h</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">F</span> <span class="id">G</span> <span class="id">FG</span> <span class="id">=&gt;</span> <span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">hmapO</span> <span class="id">FG]</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> (<span class="id">M</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">~&gt;</span> <span class="id">N</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;<span class="id">h</span> <span class="id">M</span> <span class="id">N</span> <span class="id">n</span> <span class="id">\v</span> <span class="id">Lift</span> <span class="id">T</span> <span class="id">M</span> <span class="id">=</span> <span class="id">Lift</span> <span class="id">T</span> <span class="id">N</span> <span class="id">\v</span> <span class="id">n</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof85')">Proof.</span></div>
<div class="proofscript" id="proof85">
<span class="id">move=&gt;</span> <span class="id">h</span> <span class="id">M</span> <span class="id">N</span> <span class="id">t;</span> <span class="id">apply/nattrans_ext</span> <span class="id">=&gt;</span> <span class="id">A</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">!vcompE/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/hmapO</span> <span class="id">/=</span> <span class="id">/liftO</span> <span class="id">/=</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">ma</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">-!fmapE</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> <span class="id">_</span> (<span class="id">t</span> <span class="id">A</span>)).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">natural</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFMT.Build</span> (<span class="id">outputT</span> <span class="id">R</span>)<br/>
&nbsp;&nbsp;<span class="id">monadMret_hmapO</span> <span class="id">monadMbind_hmapO</span> <span class="id">hmapO_lift</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">Fmt_outputT</span>.<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/yoshihiro503/coq2html/">a fork of coq2html</a></div>
</body>
</html>


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module monad_model</title>
<meta name="description" content="Documentation of Coq module monad_model" />
<link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath/texmath.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="init('proofscript')">
<h1 class="title">Module monad_model</h1>
<div class="coq">
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">JMeq</span>.<br/>
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">all_ssreflect</span>.<br/>
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">finmap</span>.<br/>
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="id">boolp</span>.<br/>
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">classical_sets</span>.<br/>
<span class="vernacular">From</span> <span class="id">infotheo</span> <span class="vernacular">Require</span> <span class="id">convex</span> <span class="id">classical_sets_ext</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">monae_lib</span>.<br/>
<span class="vernacular">From</span> <span class="id">HB</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">structures</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">hierarchy</span> <span class="id">monad_lib</span> <span class="id">fail_lib</span> <span class="id">state_lib</span> <span class="id">trace_lib</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">monad_transformer</span>.<br/>
<br/>
<pre class="ssrdoc">
                      Models for various monads                            
                                                                           
Sample models for monads in hierarchy.v (see also other *_model.v files).  
As for naming, we tend to use the identifier acto for the actions on       
objects and actm for the actions on morphisms.                             
                                                                           
Instances of monads (Modules):                                             
IdentityMonad      == identity monad idfun                                 
ListMonad          == list monad seq                                       
SetMonad           == set monads using classical_sets                      
ExceptMonad        == exception monad E + A                                
option_monad       == alias for ExceptMonad.acto unit                      
OutputMonad        == output monad X * seq L                               
EnvironmentMonad   == environment monad E -&gt; A                             
StateMonad         == state monad S -&gt; A * S                               
ContMonad          == continuation monad (A -&gt; r) -&gt; r                     
                                                                           
Sigma-operations (with algebraicity proofs):                               
empty_op                == empty operation                                 
append_op               == append operation                                
flush_op                == flush operation                                 
output_op               == output operation                                
ask_op                  == ask operation                                   
local_op                == local operation                                 
throw_op                == throw operation                                 
handle_op               == handle operation                                
get_op                  == get operation                                   
put_op                  == put operation                                   
abort_op                == abort operation                                 
acallcc_op              == algebraic callcc operation                      
                                                                           
Models of interfaces:                                                      
Module Fail             == failMonad for option_monad, ListMonad.acto, set 
Module Except           == exceptMonad for ExcetMonad.acto unit            
Module State            == stateMonad for StateMonad.acto S                
Module Alt              == altMonad for ListMonad.acto, set                
Module AltCI            == altCIMonad for ListMonad.acto, set              
Module Nondet           == nondetMonad for ListMonad.acto, set             
Module ModelStateTrace  == stateTraceMonad for StateMonad.acto (S * seq T) 
Module ModelCont        == contMonad for ContMonad.acto r                  
Module ModelShiftReset  == shiftResetMonad for ContMonad.acto r            
Module ModelReify       == reifyModel for StateMonad.acto (S * seq T)      
Module ModelStateTraceReify == stateTraceReify monad for                   
                               StateMonad.acto (S * seq T)                 
Module ModelBacktrackableState == from the ground up using fsets, i.e.,    
                                  redefinition of monads state-fail-alt-   
                                  nondet-failR0-preplusmonad-nondetstate   
                                  for S -&gt; {fset (A * S)}                  
Module ModelArray       == array monad                                     
Module ModelPlusArray   == plus array monad                                
Module ModelMonadStateRun       == stateRunMonad for MS                    
Module ModelMonadExceptStateRun == exceptStateRunMonad                     
                                                                           
Module ModelTypedStore == model for typed store                            
                                                                           
references:                                                                
- Wadler, P. Monads and composable continuations. LISP and Symbolic        
  Computation 7, 39â€“55 (1994)                                              
</pre>
<br/>
<span class="gallina-kwd">Set</span> <span class="vernacular">Implicit</span> <span class="vernacular">Arguments</span>.<br/>
<span class="id">Unset</span> <span class="id">Strict</span> <span class="vernacular">Implicit</span>.<br/>
<span class="id">Unset</span> <span class="id">Printing</span> <span class="vernacular">Implicit</span> <span class="id">Defensive</span>.<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">PR_to_fset</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">fset_scope</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">K</span> <span class="id">V</span> <span class="id">:</span> <span class="id">choiceType</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">K</span> <span class="id">-&gt;</span> <span class="id">V</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">imfset_set1</span> <span class="id">x</span> <span class="id">:</span> <span class="id">f</span> <span class="id">@`</span> <span class="id">[fset</span> <span class="id">x]</span> <span class="id">=</span> <span class="id">[fset</span> <span class="id">f</span> <span class="id">x]</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof1')">Proof.</span></div>
<div class="proofscript" id="proof1">
<span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">y</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply/imfsetP/fset1P=&gt;</span> <span class="id">[[x'</span> <span class="id">/fset1P-&gt;</span> <span class="id">//]|</span> <span class="id">-&gt;];</span> <span class="gallina-kwd">exists</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">?fset11</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Variables</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">choiceType</span>) (<span class="id">I</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">r</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">I</span>).<br/>
<span class="vernacular">Lemma</span> <span class="id">bigfcupP'</span> <span class="id">x</span> (<span class="id">F</span> <span class="id">:</span> <span class="id">I</span> <span class="id">-&gt;</span> <span class="id">{fset</span> <span class="id">T}</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">reflect</span> (<span class="gallina-kwd">exists2</span> <span class="id">i</span> <span class="id">:</span> <span class="id">I,</span> (<span class="id">i</span> <span class="id">\in</span> <span class="id">r</span>) <span class="id">&amp;</span> <span class="id">x</span> <span class="id">\in</span> <span class="id">F</span> <span class="id">i</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">x</span> <span class="id">\in</span> <span class="id">\bigcup_</span>(<span class="id">i</span> <span class="id">&lt;-</span> <span class="id">r</span> <span class="id">|</span> <span class="id">true</span>) <span class="id">F</span> <span class="id">i</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof2')">Proof.</span></div>
<div class="proofscript" id="proof2">
<span class="id">apply:</span> (<span class="id">iffP</span> <span class="id">idP</span>) <span class="id">=&gt;</span> <span class="id">[|[i</span> <span class="id">ri]];</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">fsubsetP</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">bigfcup_sup</span>.<br/>
<span class="id">rewrite</span> <span class="id">big_seq_cond;</span> <span class="id">elim/big_rec:</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">[|i</span> <span class="id">_</span> <span class="id">/andP[ri</span> <span class="id">Pi]</span> <span class="id">_</span> <span class="id">/fsetUP[|//]]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">in_fset0</span>.<br/>
<span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> <span class="id">i;</span> <span class="id">rewrite</span> <span class="id">?ri</span>.<br/>
Qed.</div>
<span class="vernacular">End</span> <span class="id">PR_to_fset</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">assoc</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">I</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">s</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">I</span> <span class="id">-&gt;</span> <span class="id">S</span>) <span class="id">j</span> <span class="id">:=</span> <span class="gallina-kwd">if</span> <span class="id">i</span> <span class="id">==</span> <span class="id">j</span> <span class="gallina-kwd">then</span> <span class="id">s</span> <span class="gallina-kwd">else</span> <span class="id">a</span> <span class="id">j</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_insert</span> <span class="id">i</span> <span class="id">s'</span> <span class="id">s</span> <span class="id">a</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> <span class="id">i</span> <span class="id">s'</span> (<span class="id">insert</span> <span class="id">i</span> <span class="id">s</span> <span class="id">a</span>) <span class="id">=</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">s'</span> <span class="id">a</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof3')">Proof.</span></div>
<div class="proofscript" id="proof3">
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">j;</span> <span class="id">rewrite</span> <span class="id">/insert;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">/negbTE</span> <span class="id">-&gt;</span>.<br/>
Qed.</div>
<span class="vernacular">Lemma</span> <span class="id">insert_same</span> <span class="id">i</span> <span class="id">a</span> <span class="id">s</span> <span class="id">:</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">s</span> <span class="id">a</span> <span class="id">i</span> <span class="id">=</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof4')">Proof.</span></div>
<div class="proofscript" id="proof4">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/insert</span> <span class="id">eqxx</span>. Qed.</div>
<span class="vernacular">Lemma</span> <span class="id">insert_same2</span> <span class="id">i</span> <span class="id">a</span> <span class="id">:</span> <span class="id">insert</span> <span class="id">i</span> (<span class="id">a</span> <span class="id">i</span>) <span class="id">a</span> <span class="id">=</span> <span class="id">a</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof5')">Proof.</span></div>
<div class="proofscript" id="proof5">
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">j;</span> <span class="id">rewrite</span> <span class="id">/insert;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">/eqP</span> <span class="id">-&gt;</span>.<br/>
Qed.</div>
<span class="vernacular">Lemma</span> <span class="id">insertC</span> <span class="id">j</span> <span class="id">i</span> <span class="id">v</span> <span class="id">u</span> <span class="id">a</span> <span class="id">:</span> <span class="id">i</span> <span class="id">!=</span> <span class="id">j</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> <span class="id">j</span> <span class="id">v</span> (<span class="id">insert</span> <span class="id">i</span> <span class="id">u</span> <span class="id">a</span>) <span class="id">=</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">u</span> (<span class="id">insert</span> <span class="id">j</span> <span class="id">v</span> <span class="id">a</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof6')">Proof.</span></div>
<div class="proofscript" id="proof6">
<span class="id">move=&gt;</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">k;</span> <span class="id">rewrite</span> <span class="id">/insert;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">/eqP</span> <span class="id">&lt;-{k}</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">negbTE</span> <span class="id">h</span>).<br/>
Qed.</div>
<span class="vernacular">Lemma</span> <span class="id">insertC2</span> <span class="id">j</span> <span class="id">i</span> <span class="id">v</span> <span class="id">a</span> <span class="id">:</span> <span class="id">insert</span> <span class="id">j</span> <span class="id">v</span> (<span class="id">insert</span> <span class="id">i</span> <span class="id">v</span> <span class="id">a</span>) <span class="id">=</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">v</span> (<span class="id">insert</span> <span class="id">j</span> <span class="id">v</span> <span class="id">a</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof7')">Proof.</span></div>
<div class="proofscript" id="proof7">
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">k;</span> <span class="id">rewrite</span> <span class="id">/insert;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">/eqP</span> <span class="id">&lt;-{k}</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">if_same</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">assoc</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">IdentityMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">identitymonad</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">a</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> (<span class="id">NId</span> <span class="id">idfun</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof8')">Proof.</span></div>
<div class="proofscript" id="proof8">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> (<span class="id">NId</span> <span class="id">idfun</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof9')">Proof.</span></div>
<div class="proofscript" id="proof9">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof10')">Proof.</span></div>
<div class="proofscript" id="proof10">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">acto</span> <span class="id">:=</span> (<span class="id">@idfun</span> <span class="id">UU0</span>).<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonad_ret_bind.Build</span><br/>
&nbsp;&nbsp;<span class="id">acto</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">identitymonad</span>.<br/>
<span class="vernacular">End</span> <span class="id">IdentityMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">IdentityMonad</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ListMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">listmonad</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">x</span> <span class="id">=&gt;</span> (<span class="id">@cons</span> <span class="id">A</span>) <span class="id">x</span> <span class="id">[::]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="id">flatten</span> (<span class="id">map</span> <span class="id">f</span> <span class="id">m</span>).<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof11')">Proof.</span></div>
<div class="proofscript" id="proof11">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">/ret</span> <span class="id">/=</span> <span class="id">cats0</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof12')">Proof.</span></div>
<div class="proofscript" id="proof12">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">flatten_seq1</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof13')">Proof.</span></div>
<div class="proofscript" id="proof13">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">h</span> <span class="id">t;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">=&gt;</span> <span class="id">ih</span> <span class="id">f</span> <span class="id">g</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">map_cat</span> <span class="id">flatten_cat</span> <span class="id">/=</span> <span class="id">ih</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">listmonad</span>.<br/>
<span class="vernacular">End</span> <span class="id">ListMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">ListMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">list_bindE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">ListMonad.acto</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="id">flatten</span> (<span class="id">map</span> <span class="id">f</span> <span class="id">m</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof14')">Proof.</span></div>
<div class="proofscript" id="proof14">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">SetMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">setmonad</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">classical_set_scope</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="id">set</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">@set1</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">B</span> <span class="id">=&gt;</span> <span class="id">@bigcup</span> <span class="id">B</span> <span class="id">A</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof15')">Proof.</span></div>
<div class="proofscript" id="proof15">
 <span class="id">move=&gt;</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">bigcup_set1</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof16')">Proof.</span></div>
<div class="proofscript" id="proof16">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?</span> <span class="id">?;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">bigcup_imset1</span> <span class="id">image_id</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof17')">Proof.</span></div>
<div class="proofscript" id="proof17">
 <span class="id">move=&gt;</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">bigcup_bigcup</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">set</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">setmonad</span>.<br/>
<span class="vernacular">End</span> <span class="id">SetMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">SetMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">set_bindE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">set]</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="id">bigcup</span> <span class="id">m</span> <span class="id">f</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof18')">Proof.</span></div>
<div class="proofscript" id="proof18">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">ExceptMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">exceptmonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> (<span class="id">E</span> <span class="id">+</span> <span class="id">A</span>)<span class="id">%type</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">@inr</span> <span class="id">E</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">m</span> <span class="gallina-kwd">with</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">|</span> <span class="id">inr</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">b</span> <span class="gallina-kwd">end</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof19')">Proof.</span></div>
<div class="proofscript" id="proof19">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof20')">Proof.</span></div>
<div class="proofscript" id="proof20">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof21')">Proof.</span></div>
<div class="proofscript" id="proof21">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">exceptmonad</span>.<br/>
<span class="vernacular">End</span> <span class="id">ExceptMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">ExceptMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">except_bindE</span> (<span class="id">E</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">ExceptMonad.acto</span> <span class="id">E</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="gallina-kwd">match</span> <span class="id">m</span> <span class="gallina-kwd">with</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">|</span> <span class="id">inr</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">b</span> <span class="gallina-kwd">end</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof22')">Proof.</span></div>
<div class="proofscript" id="proof22">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">option_monad</span> <span class="id">:=</span> <span class="id">ExceptMonad.acto</span> <span class="id">unit</span>.<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">Monad.on</span> <span class="id">option_monad</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">OutputMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">output</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">L</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> (<span class="id">X</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">L</span>)<span class="id">%type</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">a</span> <span class="id">=&gt;</span> (<span class="id">a,</span> <span class="id">[::]</span>).<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> (<span class="id">x,</span> <span class="id">w</span>) <span class="id">:=</span> <span class="id">m</span> <span class="gallina-kwd">in</span> <span class="id">let:</span> (<span class="id">x',</span> <span class="id">w'</span>) <span class="id">:=</span> <span class="id">f</span> <span class="id">x</span> <span class="gallina-kwd">in</span> (<span class="id">x',</span> <span class="id">w</span> <span class="id">++</span> <span class="id">w'</span>).<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof23')">Proof.</span></div>
<div class="proofscript" id="proof23">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">f</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof24')">Proof.</span></div>
<div class="proofscript" id="proof24">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">w;</span> <span class="id">rewrite</span> <span class="id">cats0</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof25')">Proof.</span></div>
<div class="proofscript" id="proof25">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">m</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">/bind;</span> <span class="id">case:</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">w;</span> <span class="id">case:</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">x'</span> <span class="id">w'</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">g</span> <span class="id">=&gt;</span> <span class="id">x''</span> <span class="id">w'';</span> <span class="id">rewrite</span> <span class="id">catA</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">output</span>.<br/>
<span class="vernacular">End</span> <span class="id">OutputMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">OutputMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">output_bindE</span> (<span class="id">L</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">OutputMonad.acto</span> <span class="id">L</span>)<br/>
&nbsp;&nbsp;&nbsp;(<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="id">let:</span> (<span class="id">x,</span> <span class="id">w</span>) <span class="id">:=</span> <span class="id">m</span> <span class="gallina-kwd">in</span> <span class="id">let:</span> (<span class="id">x',</span> <span class="id">w'</span>) <span class="id">:=</span> <span class="id">f</span> <span class="id">x</span> <span class="gallina-kwd">in</span> (<span class="id">x',</span> <span class="id">w</span> <span class="id">++</span> <span class="id">w'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof26')">Proof.</span></div>
<div class="proofscript" id="proof26">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">EnvironmentMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">environment</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">E</span> <span class="id">-&gt;</span> <span class="id">A</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">e</span> <span class="id">=&gt;</span> <span class="id">x</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">e</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">m</span> <span class="id">e</span>) <span class="id">e</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof27')">Proof.</span></div>
<div class="proofscript" id="proof27">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof28')">Proof.</span></div>
<div class="proofscript" id="proof28">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof29')">Proof.</span></div>
<div class="proofscript" id="proof29">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">environment</span>.<br/>
<span class="vernacular">End</span> <span class="id">EnvironmentMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">EnvironmentMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">environment_bindE</span> (<span class="id">E</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">EnvironmentMonad.acto</span> <span class="id">E</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">e</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">m</span> <span class="id">e</span>) <span class="id">e</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof30')">Proof.</span></div>
<div class="proofscript" id="proof30">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">StateMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">state</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>. <br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">A</span> <span class="id">*</span> <span class="id">S</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="id">a,</span> <span class="id">s</span>).<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="id">uncurry</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">m</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof31')">Proof.</span></div>
<div class="proofscript" id="proof31">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof32')">Proof.</span></div>
<div class="proofscript" id="proof32">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">f;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">/=;</span> <span class="id">case:</span> (<span class="id">f</span> <span class="id">s</span>).<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof33')">Proof.</span></div>
<div class="proofscript" id="proof33">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">a</span> <span class="id">b</span> <span class="id">c;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">compA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">\o</span> <span class="id">_</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">state</span>.<br/>
<span class="vernacular">End</span> <span class="id">StateMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">StateMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">state_bindE</span> (<span class="id">S</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">StateMonad.acto</span> <span class="id">S</span>)<br/>
&nbsp;&nbsp;(<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="id">uncurry</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof34')">Proof.</span></div>
<div class="proofscript" id="proof34">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">ContMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">cont</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>. <br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">r</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">a</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">m</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">a</span> <span class="id">k</span>).<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof35')">Proof.</span></div>
<div class="proofscript" id="proof35">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">Br</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof36')">Proof.</span></div>
<div class="proofscript" id="proof36">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof37')">Proof.</span></div>
<div class="proofscript" id="proof37">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">cont</span>.<br/>
<span class="vernacular">End</span> <span class="id">ContMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">ContMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">cont_bindE</span> (<span class="id">r</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">ContMonad.acto</span> <span class="id">r</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">m</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">a</span> <span class="id">k</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof38')">Proof.</span></div>
<div class="proofscript" id="proof38">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">Empty</span>.<br/>
<span class="vernacular">Section</span> <span class="id">empty</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">UU0</span> <span class="id">:=</span> <span class="id">unit</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> <span class="id">tt</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof39')">Proof.</span></div>
<div class="proofscript" id="proof39">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof40')">Proof.</span></div>
<div class="proofscript" id="proof40">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">empty</span>.<br/>
<span class="vernacular">End</span> <span class="id">Empty</span>.<br/>
<span class="id">HB.export</span> <span class="id">Empty</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Append</span>.<br/>
<span class="vernacular">Section</span> <span class="id">append</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> (<span class="id">X</span> <span class="id">*</span> <span class="id">X</span>)<span class="id">%type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> (<span class="id">x1,</span> <span class="id">x2</span>) <span class="id">:=</span> <span class="id">t</span> <span class="gallina-kwd">in</span> (<span class="id">f</span> <span class="id">x1,</span> <span class="id">f</span> <span class="id">x2</span>).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof41')">Proof.</span></div>
<div class="proofscript" id="proof41">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof42')">Proof.</span></div>
<div class="proofscript" id="proof42">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">append</span>.<br/>
<span class="vernacular">End</span> <span class="id">Append</span>.<br/>
<span class="id">HB.export</span> <span class="id">Append</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">appendop</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">ListMonad.acto</span><span class="id">]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">empty</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Empty.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">@nil</span> <span class="id">A</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">naturality_empty</span> <span class="id">:</span> <span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Empty.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">M</span> <span class="id">empty</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof43')">Proof.</span></div>
<div class="proofscript" id="proof43">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Empty.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">M</span> <span class="id">empty</span> <span class="id">naturality_empty</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">empty_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Empty.acto</span><span class="id">]</span>.<span class="id">-operation</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">empty]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_empty</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">empty_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof44')">Proof.</span></div>
<div class="proofscript" id="proof44">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">append</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Append.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">let:</span> (<span class="id">s1,</span> <span class="id">s2</span>) <span class="id">:=</span> <span class="id">x</span> <span class="gallina-kwd">in</span> (<span class="id">s1</span> <span class="id">++</span> <span class="id">s2</span>).<br/>
<span class="vernacular">Let</span> <span class="id">naturality_append</span> <span class="id">:</span> <span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Append.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">M</span> <span class="id">append</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof45')">Proof.</span></div>
<div class="proofscript" id="proof45">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[s1</span> <span class="id">s2]</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/actm</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">map_cat</span> <span class="id">flatten_cat</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Append.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">M</span> <span class="id">append</span> <span class="id">naturality_append</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">append_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Append.acto</span><span class="id">]</span>.<span class="id">-operation</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">append]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_append</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">append_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof46')">Proof.</span></div>
<div class="proofscript" id="proof46">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">[t1</span> <span class="id">t2]</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">3!list_bindE</span> <span class="id">-flatten_cat</span> <span class="id">-map_cat</span>.<br/>
Qed.</div>
<span class="vernacular">End</span> <span class="id">appendop</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Output</span>.<br/>
<span class="vernacular">Section</span> <span class="id">output</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">L</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> (<span class="id">seq</span> <span class="id">L</span> <span class="id">*</span> <span class="id">X</span>)<span class="id">%type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> (<span class="id">w,</span> <span class="id">x</span>) <span class="id">:=</span> <span class="id">t</span> <span class="gallina-kwd">in</span> (<span class="id">w,</span> <span class="id">f</span> <span class="id">x</span>).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof47')">Proof.</span></div>
<div class="proofscript" id="proof47">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">boolp.funext</span><span class="id">;</span> <span class="id">case</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof48')">Proof.</span></div>
<div class="proofscript" id="proof48">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">apply</span> <span class="id">boolp.funext</span><span class="id">;</span> <span class="id">case</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">output</span>.<br/>
<span class="vernacular">End</span> <span class="id">Output</span>.<br/>
<span class="id">HB.export</span> <span class="id">Output</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Flush</span>.<br/>
<span class="vernacular">Section</span> <span class="id">flush</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">X</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> <span class="id">f</span> <span class="id">t</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof49')">Proof.</span></div>
<div class="proofscript" id="proof49">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof50')">Proof.</span></div>
<div class="proofscript" id="proof50">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">flush</span>.<br/>
<span class="vernacular">End</span> <span class="id">Flush</span>.<br/>
<span class="id">HB.export</span> <span class="id">Flush</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">outputops</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">L</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">OutputMonad.acto</span> <span class="id">L</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">output</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Output.acto</span> <span class="id">L</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">let:</span> (<span class="id">x,</span> <span class="id">w'</span>) <span class="id">:=</span> <span class="id">m</span>.<span class="id">2</span> <span class="gallina-kwd">in</span> (<span class="id">x,</span> <span class="id">m</span>.<span class="id">1</span> <span class="id">++</span> <span class="id">w'</span>). <br/>
<span class="vernacular">Let</span> <span class="id">naturality_output</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Output.acto</span> <span class="id">L</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">output</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof51')">Proof.</span></div>
<div class="proofscript" id="proof51">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h</span>.<br/>
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[w</span> <span class="id">[x</span> <span class="id">w']]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/output</span> <span class="id">/=</span> <span class="id">catA</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Output.acto</span> <span class="id">L</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">output</span> <span class="id">naturality_output</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">output_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Output.acto</span> <span class="id">L]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">output]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_output</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">output_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof52')">Proof.</span></div>
<div class="proofscript" id="proof52">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">[w</span> <span class="id">[x</span> <span class="id">w']]</span>.<br/>
<span class="id">rewrite</span> <span class="id">output_bindE/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/output</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">output_bindE</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">x'</span> <span class="id">w'';</span> <span class="id">rewrite</span> <span class="id">catA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">flush</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Flush.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">let:</span> (<span class="id">x,</span> <span class="id">_</span>) <span class="id">:=</span> <span class="id">m</span> <span class="gallina-kwd">in</span> (<span class="id">x,</span> <span class="id">[::]</span>).<br/>
<span class="vernacular">Let</span> <span class="id">naturality_flush</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Flush.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">flush</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof53')">Proof.</span></div>
<div class="proofscript" id="proof53">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Flush.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">flush</span> <span class="id">naturality_flush</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">flush_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Flush.acto</span><span class="id">]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">flush]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_flush</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">flush_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof54')">Proof.</span></div>
<div class="proofscript" id="proof54">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">[x</span> <span class="id">w]</span>.<br/>
<span class="id">rewrite</span> <span class="id">output_bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">/flush_op</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/flush</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/actm</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">output_bindE</span>.<br/>
<span class="id">case:</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">x'</span> <span class="id">w'</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">End</span> <span class="id">outputops</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Output'</span>.<br/>
<span class="vernacular">Section</span> <span class="id">output</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">L</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">OutputMonad.acto</span> <span class="id">L</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">output</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">L</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">w</span> <span class="id">=&gt;</span> <span class="id">output_op</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">w,</span> <span class="id">Ret</span> <span class="id">tt</span>).<br/>
<span class="vernacular">Lemma</span> <span class="id">outputE</span> <span class="id">:</span> <span class="id">output</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">w</span> <span class="id">=&gt;</span> (<span class="id">tt,</span> <span class="id">w</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof55')">Proof.</span></div>
<div class="proofscript" id="proof55">
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">w</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/output</span> <span class="id">/=</span> <span class="id">/monad_model</span>.<span class="id">output</span> <span class="id">/=</span> <span class="id">cats0</span>.<br/>
Qed.</div>
<span class="vernacular">End</span> <span class="id">output</span>.<br/>
<span class="vernacular">End</span> <span class="id">Output'</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Ask</span>.<br/>
<span class="vernacular">Section</span> <span class="id">ask</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">E</span> <span class="id">-&gt;</span> <span class="id">X</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">t</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof56')">Proof.</span></div>
<div class="proofscript" id="proof56">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof57')">Proof.</span></div>
<div class="proofscript" id="proof57">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">ask</span>.<br/>
<span class="vernacular">End</span> <span class="id">Ask</span>.<br/>
<span class="id">HB.export</span> <span class="id">Ask</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Local</span>.<br/>
<span class="vernacular">Section</span> <span class="id">local</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> ((<span class="id">E</span> <span class="id">-&gt;</span> <span class="id">E</span>) <span class="id">*</span> <span class="id">X</span>)<span class="id">%type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> (<span class="id">e,</span> <span class="id">x</span>) <span class="id">:=</span> <span class="id">t</span> <span class="gallina-kwd">in</span> (<span class="id">e,</span> <span class="id">f</span> <span class="id">x</span>).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof58')">Proof.</span></div>
<div class="proofscript" id="proof58">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof59')">Proof.</span></div>
<div class="proofscript" id="proof59">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">g</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">local</span>.<br/>
<span class="vernacular">End</span> <span class="id">Local</span>.<br/>
<span class="id">HB.export</span> <span class="id">Local</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">environmentops</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">EnvironmentMonad.acto</span> <span class="id">E</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">ask</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Ask.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">f</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">s</span> <span class="id">s</span>. <br/>
<span class="vernacular">Let</span> <span class="id">naturality_ask</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Ask.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">ask</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof60')">Proof.</span></div>
<div class="proofscript" id="proof60">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Ask.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">ask</span> <span class="id">naturality_ask</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">ask_op</span> <span class="id">:</span>  <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Ask.acto</span> <span class="id">E]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">ask]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_ask</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">ask_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof61')">Proof.</span></div>
<div class="proofscript" id="proof61">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">local</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Local.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">x</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">let:</span> (<span class="id">e,</span> <span class="id">t</span>) <span class="id">:=</span> <span class="id">x</span> <span class="gallina-kwd">in</span> <span class="id">t</span> (<span class="id">e</span> <span class="id">s</span>).<br/>
<span class="vernacular">Lemma</span> <span class="id">naturality_local</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Local.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">local</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof62')">Proof.</span></div>
<div class="proofscript" id="proof62">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Local.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">local</span> <span class="id">naturality_local</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">local_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Local.acto</span> <span class="id">E]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">local]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_local</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">local_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof63')">Proof.</span></div>
<div class="proofscript" id="proof63">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">t</span>.<br/>
<span class="id">rewrite</span> <span class="id">environment_bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">/local_op</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/local</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/actm</span> <span class="id">/=</span>.<br/>
<span class="id">case:</span> <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">ee</span> <span class="id">m</span>.<br/>
<span class="id">rewrite</span> <span class="id">environment_bindE</span>.<br/>
<span class="id">apply</span> <span class="id">boolp.funext</span><span class="id">=&gt;</span> <span class="id">x</span> <span class="id">/=</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">End</span> <span class="id">environmentops</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Environment</span>.<br/>
<span class="vernacular">Section</span> <span class="id">environment</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">EnvironmentMonad.acto</span> <span class="id">E</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">ask</span> <span class="id">:</span> <span class="id">M</span> <span class="id">E</span> <span class="id">:=</span> <span class="id">ask_op</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Ret</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">askE</span> <span class="id">:</span> <span class="id">ask</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">e</span> <span class="id">=&gt;</span> <span class="id">e</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof64')">Proof.</span></div>
<div class="proofscript" id="proof64">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">End</span> <span class="id">environment</span>.<br/>
<span class="vernacular">End</span> <span class="id">Environment</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Throw</span>.<br/>
<span class="vernacular">Section</span> <span class="id">throw</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">Z</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">Z</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> <span class="id">t</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof65')">Proof.</span></div>
<div class="proofscript" id="proof65">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof66')">Proof.</span></div>
<div class="proofscript" id="proof66">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">throw</span>.<br/>
<span class="vernacular">End</span> <span class="id">Throw</span>.<br/>
<span class="id">HB.export</span> <span class="id">Throw</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Handle</span>.<br/>
<span class="vernacular">Section</span> <span class="id">handle</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">Z</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> (<span class="id">X</span> <span class="id">*</span> (<span class="id">Z</span> <span class="id">-&gt;</span> <span class="id">X</span>))<span class="id">%type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> (<span class="id">x,</span> <span class="id">h</span>) <span class="id">:=</span> <span class="id">t</span> <span class="gallina-kwd">in</span> (<span class="id">f</span> <span class="id">x,</span> <span class="gallina-kwd">fun</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">h</span> <span class="id">z</span>)).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof67')">Proof.</span></div>
<div class="proofscript" id="proof67">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof68')">Proof.</span></div>
<div class="proofscript" id="proof68">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">g</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">handle</span>.<br/>
<span class="vernacular">End</span> <span class="id">Handle</span>.<br/>
<span class="id">HB.export</span> <span class="id">Handle</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">exceptops</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">Z</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">ExceptMonad.acto</span> <span class="id">Z</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">throw</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Throw.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">inl</span> <span class="id">z</span>.<br/>
<span class="vernacular">Let</span> <span class="id">naturality_throw</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Throw.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">throw</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof69')">Proof.</span></div>
<div class="proofscript" id="proof69">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Throw.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">throw</span> <span class="id">naturality_throw</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">throw_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Throw.acto</span> <span class="id">Z]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">throw]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_throw</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">throw_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof70')">Proof.</span></div>
<div class="proofscript" id="proof70">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isAOperation.Build</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">throw</span> <span class="id">algebraic_throw</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">throw_aop</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Throw.acto</span> <span class="id">Z]</span>.<span class="id">-aoperation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">aoperation</span> <span class="id">_</span> <span class="id">_</span> <span class="id">of</span> <span class="id">throw]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">handle'</span> <span class="id">A</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">h</span> <span class="id">:</span> <span class="id">Z</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">m</span> <span class="gallina-kwd">with</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">h</span> <span class="id">z</span> <span class="id">|</span> <span class="id">inr</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">inr</span> <span class="id">x</span> <span class="gallina-kwd">end</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">handle</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Handle.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">uncurry</span> (<span class="id">@handle'</span> <span class="id">A</span>).<br/>
<span class="vernacular">Let</span> <span class="id">naturality_handle</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Handle.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">handle</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof71')">Proof.</span></div>
<div class="proofscript" id="proof71">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[[]]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Handle.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">handle</span> <span class="id">naturality_handle</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">handle_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Handle.acto</span> <span class="id">Z]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">handle]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_handle</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">handle_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof72')">Proof.</span></div>
<div class="proofscript" id="proof72">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">t</span>.<br/>
<span class="id">rewrite</span> <span class="id">except_bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">/handle_op</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/handle</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/uncurry</span> <span class="id">/=</span>.<br/>
<span class="id">case:</span> <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">-[z//|a]</span> <span class="id">g</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">except_bindE</span>.<br/>
<span class="id">case:</span> (<span class="id">f</span> <span class="id">a</span>) <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">z</span>.<br/>
<span class="id">rewrite</span> <span class="id">/handle'</span>.<br/>
<span class="id">rewrite</span> <span class="id">except_bindE</span>.<br/>
<span class="id">case:</span> (<span class="id">g</span> <span class="id">z</span>) <span class="id">=&gt;</span> <span class="id">[z0|a0]</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">End</span> <span class="id">exceptops</span>.<br/>
<br/>
<span class="vernacular">Arguments</span> <span class="id">throw_op</span> <span class="id">{Z}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">handle_op</span> <span class="id">{Z}</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">StateOpsGet</span>.<br/>
<span class="vernacular">Section</span> <span class="id">get</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">X</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">t</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof73')">Proof.</span></div>
<div class="proofscript" id="proof73">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof74')">Proof.</span></div>
<div class="proofscript" id="proof74">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">g</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">get</span>.<br/>
<span class="vernacular">End</span> <span class="id">StateOpsGet</span>.<br/>
<span class="id">HB.export</span> <span class="id">StateOpsGet</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">StateOpsPut</span>.<br/>
<span class="vernacular">Section</span> <span class="id">put</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">X</span>)<span class="id">%type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">sx</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> (<span class="id">sx</span>.<span class="id">1,</span> <span class="id">f</span> <span class="id">sx</span>.<span class="id">2</span>).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof75')">Proof.</span></div>
<div class="proofscript" id="proof75">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof76')">Proof.</span></div>
<div class="proofscript" id="proof76">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">g</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">put</span>.<br/>
<span class="vernacular">End</span> <span class="id">StateOpsPut</span>.<br/>
<span class="id">HB.export</span> <span class="id">StateOpsPut</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">stateops</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">StateMonad.acto</span> <span class="id">S</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">get</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">k</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<span class="vernacular">Let</span> <span class="id">naturality_get</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">get</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof77')">Proof.</span></div>
<div class="proofscript" id="proof77">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">m;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">FCompE</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">get</span> <span class="id">naturality_get</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">get_op</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">get]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_get</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">get_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof78')">Proof.</span></div>
<div class="proofscript" id="proof78">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isAOperation.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">get</span> <span class="id">algebraic_get</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">get_aop</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S]</span>.<span class="id">-aoperation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">aoperation</span> <span class="id">_</span> <span class="id">_</span> <span class="id">of</span> <span class="id">get]</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">put'</span> <span class="id">A</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">s</span>.<br/>
<span class="vernacular">Let</span> <span class="id">put</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">uncurry</span> (<span class="id">put'</span> (<span class="id">A</span> <span class="id">:=</span> <span class="id">A</span>)).<br/>
<span class="vernacular">Let</span> <span class="id">naturality_put</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">put</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof79')">Proof.</span></div>
<div class="proofscript" id="proof79">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">-[s</span> <span class="id">m</span> <span class="id">/=];</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">put</span> <span class="id">naturality_put</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">put_op</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">put]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_put</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">put_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof80')">Proof.</span></div>
<div class="proofscript" id="proof80">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isAOperation.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">put</span> <span class="id">algebraic_put</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">put_aop</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S]</span>.<span class="id">-aoperation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">aoperation</span> <span class="id">_</span> <span class="id">_</span> <span class="id">of</span> <span class="id">put]</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">stateops</span>.<br/>
<br/>
<span class="vernacular">Arguments</span> <span class="id">get_op</span> <span class="id">{S}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">put_op</span> <span class="id">{S}</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ContOpsAbort</span>.<br/>
<span class="vernacular">Section</span> <span class="id">abort</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">r</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">x</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">B</span> <span class="id">:=</span> <span class="id">x</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof81')">Proof.</span></div>
<div class="proofscript" id="proof81">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof82')">Proof.</span></div>
<div class="proofscript" id="proof82">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">abort</span>.<br/>
<span class="vernacular">End</span> <span class="id">ContOpsAbort</span>.<br/>
<span class="id">HB.export</span> <span class="id">ContOpsAbort</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ContOpsAcallcc</span>.<br/>
<span class="vernacular">Section</span> <span class="id">acallcc</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">A</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> (<span class="id">g</span> <span class="id">:</span> <span class="id">Y</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">t</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">g</span> (<span class="id">f</span> <span class="id">x</span>))).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof83')">Proof.</span></div>
<div class="proofscript" id="proof83">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof84')">Proof.</span></div>
<div class="proofscript" id="proof84">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">acallcc</span>.<br/>
<span class="vernacular">End</span> <span class="id">ContOpsAcallcc</span>.<br/>
<span class="id">HB.export</span> <span class="id">ContOpsAcallcc</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">contops</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">ContMonad.acto</span> <span class="id">r</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">abort</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAbort.acto</span> <span class="id">r</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">r</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">r</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">naturality_abort</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAbort.acto</span> <span class="id">r</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">abort</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof85')">Proof.</span></div>
<div class="proofscript" id="proof85">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">_</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">abort</span> <span class="id">naturality_abort</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">abort_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAbort.acto</span> <span class="id">r]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">abort]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraicity_abort</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">abort_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof86')">Proof.</span></div>
<div class="proofscript" id="proof86">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isAOperation.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAbort.acto</span> <span class="id">r]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span><br/>
&nbsp;&nbsp;<span class="id">abort</span> <span class="id">algebraicity_abort</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">abort_aop</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAbort.acto</span> <span class="id">r]</span>.<span class="id">-aoperation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">aoperation</span> <span class="id">_</span> <span class="id">_</span> <span class="id">of</span> <span class="id">abort]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">acallcc</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">f</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">k</span>) <span class="id">k</span>.<br/>
<span class="vernacular">Let</span> <span class="id">naturality_acallcc</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">acallcc</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof87')">Proof.</span></div>
<div class="proofscript" id="proof87">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">acallcc</span> <span class="id">naturality_acallcc</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acallcc_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">acallcc]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">algebraicity_callcc</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">acallcc_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof88')">Proof.</span></div>
<div class="proofscript" id="proof88">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isAOperation.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span><br/>
&nbsp;&nbsp;<span class="id">acallcc</span> <span class="id">algebraicity_callcc</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">callcc_aop</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r]</span>.<span class="id">-aoperation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">aoperation</span> <span class="id">_</span> <span class="id">_</span> <span class="id">of</span> <span class="id">acallcc]</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">contops</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="vernacular">Fail</span>.<br/>
<span class="vernacular">Section</span> <span class="id">fail</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">option_fail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">option_monad</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">@throw</span> <span class="id">unit</span> <span class="id">A</span> <span class="id">tt</span>.<br/>
<span class="vernacular">Let</span> <span class="id">option_bindfailf</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> (<span class="id">@bind</span> <span class="id">_</span>) <span class="id">option_fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof89')">Proof.</span></div>
<div class="proofscript" id="proof89">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">Monad.on</span> <span class="id">option_monad</span>.<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadFail</span>.<span class="id">Build</span> <span class="id">option_monad</span><br/>
&nbsp;&nbsp;<span class="id">option_fail</span> <span class="id">option_bindfailf</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">list_fail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">ListMonad.acto</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">@empty</span> <span class="id">_</span> <span class="id">tt</span>.<br/>
<span class="vernacular">Let</span> <span class="id">list_bindfailf</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> (<span class="id">@bind</span> <span class="id">_</span>) <span class="id">list_fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof90')">Proof.</span></div>
<div class="proofscript" id="proof90">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadFail</span>.<span class="id">Build</span> <span class="id">ListMonad.acto</span> <span class="id">list_fail</span> <span class="id">list_bindfailf</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">set_fail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">set</span> <span class="id">A</span> <span class="id">:=</span> <span class="id">@set0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">set_bindfailf</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> (<span class="id">@bind</span> <span class="id">_</span>) <span class="id">set_fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof91')">Proof.</span></div>
<div class="proofscript" id="proof91">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">/=;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">b;</span> <span class="id">rewrite</span> <span class="id">boolp.propeqE</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">split=&gt;</span> <span class="id">//</span> <span class="id">-[a</span> <span class="id">[]]</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadFail.Build</span> <span class="id">set</span> <span class="id">set_bindfailf</span>.<br/>
<span class="vernacular">End</span> <span class="id">fail</span>.<br/>
<span class="vernacular">End</span> <span class="vernacular">Fail</span>.<br/>
<span class="id">HB.export</span> <span class="vernacular">Fail</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Except</span>.<br/>
<span class="vernacular">Section</span> <span class="id">except</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span> <span class="id">:=</span> <span class="id">option_monad</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">handle</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">m1</span> <span class="id">m2</span> <span class="id">=&gt;</span> <span class="id">@handle_op</span> <span class="id">unit</span> <span class="id">_</span> (<span class="id">m1,</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m2</span>)).<br/>
<span class="vernacular">Lemma</span> <span class="id">handleE</span> <span class="id">:</span> <span class="id">handle</span> <span class="id">=</span> (<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">m</span> <span class="id">m'</span> <span class="id">=&gt;</span> <span class="gallina-kwd">if</span> <span class="id">m</span> <span class="id">is</span> <span class="id">inr</span> <span class="id">x</span> <span class="gallina-kwd">then</span> <span class="id">m</span> <span class="gallina-kwd">else</span> <span class="id">m'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof92')">Proof.</span></div>
<div class="proofscript" id="proof92">
 <span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">catchmfail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">right_id</span> <span class="id">fail</span> (<span class="id">@handle</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof93')">Proof.</span></div>
<div class="proofscript" id="proof93">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">case</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">catchfailm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">left_id</span> <span class="id">fail</span> (<span class="id">@handle</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof94')">Proof.</span></div>
<div class="proofscript" id="proof94">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">case</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">catchA</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">ssrfun.associative</span> (<span class="id">@handle</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof95')">Proof.</span></div>
<div class="proofscript" id="proof95">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">case</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">catchret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">x,</span> <span class="id">@left_zero</span> (<span class="id">M</span> <span class="id">A</span>) (<span class="id">M</span> <span class="id">A</span>) (<span class="id">Ret</span> <span class="id">x</span>) (<span class="id">@handle</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof96')">Proof.</span></div>
<div class="proofscript" id="proof96">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">x;</span> <span class="id">case</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadExcept.Build</span> <span class="id">option_monad</span><br/>
&nbsp;&nbsp;<span class="id">catchmfail</span> <span class="id">catchfailm</span> <span class="id">catchA</span> <span class="id">catchret</span>.<br/>
<span class="vernacular">End</span> <span class="id">except</span>.<br/>
<span class="vernacular">End</span> <span class="id">Except</span>.<br/>
<span class="id">HB.export</span> <span class="id">Except</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">State</span>.<br/>
<span class="vernacular">Section</span> <span class="id">state</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">StateMonad.acto</span> <span class="id">S</span>).<br/>
<span class="vernacular">Let</span> <span class="id">get</span> <span class="id">:</span> <span class="id">M</span> <span class="id">S</span> <span class="id">:=</span> <span class="id">get_op</span> <span class="id">_</span> <span class="id">Ret</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">getE</span> <span class="id">:</span> <span class="id">get</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="id">s,</span> <span class="id">s</span>)<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof97')">Proof.</span></div>
<div class="proofscript" id="proof97">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">put</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">put_op</span> <span class="id">_</span> (<span class="id">s,</span> <span class="id">Ret</span> <span class="id">tt</span>).<br/>
<span class="vernacular">Lemma</span> <span class="id">putE</span> <span class="id">:</span> <span class="id">put</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">s'</span> <span class="id">_</span> <span class="id">=&gt;</span> (<span class="id">tt,</span> <span class="id">s'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof98')">Proof.</span></div>
<div class="proofscript" id="proof98">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">putput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">s',</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">put</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">put</span> <span class="id">s'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof99')">Proof.</span></div>
<div class="proofscript" id="proof99">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">putget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s,</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">get</span> <span class="id">=</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof100')">Proof.</span></div>
<div class="proofscript" id="proof100">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">getputskip</span> <span class="id">:</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="id">put</span> <span class="id">=</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof101')">Proof.</span></div>
<div class="proofscript" id="proof101">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">getget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof102')">Proof.</span></div>
<div class="proofscript" id="proof102">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadState.Build</span> <span class="id">S</span> (<span class="id">StateMonad.acto</span> <span class="id">S</span>)<br/>
&nbsp;&nbsp;<span class="id">putput</span> <span class="id">putget</span> <span class="id">getputskip</span> <span class="id">getget</span>.<br/>
<span class="vernacular">End</span> <span class="id">state</span>.<br/>
<span class="vernacular">End</span> <span class="id">State</span>.<br/>
<span class="id">HB.export</span> <span class="id">State</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Alt</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">list</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">ListMonad.acto</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">list_alt</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">T,</span> <span class="id">M</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">T</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">curry</span> (<span class="id">@append</span> <span class="id">A</span>).<br/>
<span class="vernacular">Let</span> <span class="id">altA</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">ssrfun.associative</span> (<span class="id">@list_alt</span> <span class="id">T</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof103')">Proof.</span></div>
<div class="proofscript" id="proof103">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">a</span> <span class="id">b</span> <span class="id">c;</span> <span class="id">rewrite</span> <span class="id">/list_alt</span> <span class="id">/=</span> <span class="id">/curry</span> <span class="id">/=</span> <span class="id">catA</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">alt_bindDl</span> <span class="id">:</span> <span class="id">BindLaws.left_distributive</span> (<span class="id">@bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">ListMonad.acto</span><span class="id">]</span>) <span class="id">list_alt</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof104')">Proof.</span></div>
<div class="proofscript" id="proof104">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">/=</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">k</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">list_bindE</span> <span class="id">map_cat</span> <span class="id">flatten_cat</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadAlt.Build</span> <span class="id">ListMonad.acto</span> <span class="id">altA</span> <span class="id">alt_bindDl</span>.<br/>
<span class="vernacular">End</span> <span class="id">list</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">setUDl</span> <span class="id">:</span> <span class="id">@BindLaws</span>.<span class="id">left_distributive</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">I</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">@bigcup</span> <span class="id">A</span> <span class="id">I</span>) (<span class="id">@setU</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof105')">Proof.</span></div>
<div class="proofscript" id="proof105">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">/=</span> <span class="id">p</span> <span class="id">q</span> <span class="id">r;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">b;</span> <span class="id">rewrite</span> <span class="id">boolp.propeqE</span><span class="id">;</span> <span class="id">split</span>.<br/>
<span class="id">move=&gt;</span> <span class="id">-[a</span> <span class="id">[?|?]</span> <span class="id">?];</span> <span class="gallina-kwd">by</span> <span class="id">[left;</span> <span class="gallina-kwd">exists</span> <span class="id">a</span> <span class="id">|</span> <span class="id">right;</span> <span class="gallina-kwd">exists</span> <span class="id">a]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/setU</span> <span class="id">=&gt;</span> <span class="id">-[[a</span> <span class="id">?</span> <span class="id">?]|[a</span> <span class="id">?</span> <span class="id">?]];</span> <span class="gallina-kwd">exists</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">[left|right]</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">set</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">set]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">altA</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">ssrfun.associative</span> (<span class="id">@setU</span> <span class="id">T</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof106')">Proof.</span></div>
<div class="proofscript" id="proof106">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">setUA</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">alt_bindDl</span> <span class="id">:</span> <span class="id">BindLaws.left_distributive</span> (<span class="id">@bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">set]</span>) (<span class="id">@setU</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof107')">Proof.</span></div>
<div class="proofscript" id="proof107">
<span class="id">rewrite</span> <span class="id">/BindLaws</span>.<span class="id">left_distributive</span> <span class="id">/=</span> <span class="id">=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m1</span> <span class="id">m2</span> <span class="id">k</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">set_bindE</span> <span class="id">setUDl</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadAlt.Build</span> <span class="id">set</span> <span class="id">altA</span> <span class="id">alt_bindDl</span>.<br/>
<span class="vernacular">End</span> <span class="id">set</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">Alt</span>.<br/>
<span class="id">HB.export</span> <span class="id">Alt</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">AltCI</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">set</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">set]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">altmm</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">idempotent</span> (<span class="id">@alt</span> <span class="id">M</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof108')">Proof.</span></div>
<div class="proofscript" id="proof108">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">setUid</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">altC</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">commutative</span> (<span class="id">@alt</span> <span class="id">M</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof109')">Proof.</span></div>
<div class="proofscript" id="proof109">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">setUC</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadAltCI</span>.<span class="id">Build</span> <span class="id">set</span> <span class="id">altmm</span> <span class="id">altC</span>.<br/>
<span class="vernacular">End</span> <span class="id">set</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">AltCI</span>.<br/>
<span class="id">HB.export</span> <span class="id">AltCI</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Nondet</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">list</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">ListMonad.acto</span><span class="id">]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">N</span> <span class="id">:</span> <span class="id">altMonad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">ListMonad.acto</span><span class="id">]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">altfailm</span> <span class="id">:</span> <span class="id">@BindLaws</span>.<span class="id">left_id</span> <span class="id">_</span> (<span class="id">@fail</span> <span class="id">M</span>) (<span class="id">@alt</span> <span class="id">N</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof110')">Proof.</span></div>
<div class="proofscript" id="proof110">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">altmfail</span> <span class="id">:</span> <span class="id">@BindLaws</span>.<span class="id">right_id</span> <span class="id">_</span> (<span class="id">@fail</span> <span class="id">M</span>) (<span class="id">@alt</span> <span class="id">N</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof111')">Proof.</span></div>
<div class="proofscript" id="proof111">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">l</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/alt</span> <span class="id">/=</span> <span class="id">/list_alt</span> <span class="id">/=</span> <span class="id">/curry</span> <span class="id">/=</span> <span class="id">/fail</span> <span class="id">/=</span> <span class="id">/list_fail</span> <span class="id">/=</span> <span class="id">cats0</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadNondet.Build</span> <span class="id">ListMonad.acto</span> <span class="id">altfailm</span> <span class="id">altmfail</span>.<br/>
<span class="vernacular">End</span> <span class="id">list</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">set</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">set]</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">N</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">set]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">altfailm</span> <span class="id">:</span> <span class="id">@BindLaws</span>.<span class="id">left_id</span> <span class="id">_</span> (<span class="id">@fail</span> <span class="id">M</span>) (<span class="id">@alt</span> <span class="id">N</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof112')">Proof.</span></div>
<div class="proofscript" id="proof112">
<span class="id">move=&gt;</span> <span class="id">T</span> <span class="id">m</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/fail</span> <span class="id">/=</span> <span class="id">/set_fail</span> <span class="id">/alt</span> <span class="id">/=</span> <span class="id">set0U</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">altmfail</span> <span class="id">:</span> <span class="id">@BindLaws</span>.<span class="id">right_id</span> <span class="id">_</span> (<span class="id">@fail</span> <span class="id">M</span>) (<span class="id">@alt</span> <span class="id">N</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof113')">Proof.</span></div>
<div class="proofscript" id="proof113">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">l</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/fail</span> <span class="id">/=</span> <span class="id">/alt</span> <span class="id">/=</span> <span class="id">/set_fail</span> <span class="id">setU0</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadNondet.Build</span> <span class="id">set</span> <span class="id">altfailm</span> <span class="id">altmfail</span>.<br/>
<span class="vernacular">End</span> <span class="id">set</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">Nondet</span>.<br/>
<span class="id">HB.export</span> <span class="id">Nondet</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">PrePlus</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">failr0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">set]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bindmfail</span> <span class="id">:</span> <span class="id">BindLaws.right_zero</span> (<span class="id">@bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">set]</span>) (<span class="id">@fail</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof114')">Proof.</span></div>
<div class="proofscript" id="proof114">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">T1</span> <span class="id">T2</span> <span class="id">A;</span> <span class="id">rewrite</span> <span class="id">/bind/=</span> <span class="id">bigcup0</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadFailR0.Build</span> <span class="id">set</span> <span class="id">bindmfail</span>.<br/>
<span class="vernacular">End</span> <span class="id">failr0</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">set</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">nondetMonad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">nondetMonad</span> <span class="id">of</span> <span class="id">set]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">alt_bindDr</span> <span class="id">:</span> <span class="id">BindLaws.right_distributive</span> (<span class="id">@bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">set]</span>) (<span class="id">@alt</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">set]</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof115')">Proof.</span></div>
<div class="proofscript" id="proof115">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">T1</span> <span class="id">T2</span> <span class="id">A</span> <span class="id">k1</span> <span class="id">k2;</span> <span class="id">rewrite</span> <span class="id">/bind/=</span> <span class="id">bigcupU</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadPrePlus.Build</span> <span class="id">set</span> <span class="id">alt_bindDr</span>.<br/>
<span class="vernacular">End</span> <span class="id">set</span>.<br/>
<span class="vernacular">End</span> <span class="id">PrePlus</span>.<br/>
<span class="id">HB.export</span> <span class="id">PrePlus</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelStateTrace</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">st</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">S</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">StateMonad.acto</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)<span class="id">%type]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">st_get</span> <span class="id">:</span> <span class="id">M</span> <span class="id">S</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="id">s</span>.<span class="id">1,</span> <span class="id">s</span>).<br/>
<span class="vernacular">Let</span> <span class="id">st_put</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> (<span class="gallina-kwd">fun</span> <span class="id">s'</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="id">tt,</span> (<span class="id">s',</span> <span class="id">s</span>.<span class="id">2</span>))).<br/>
<span class="vernacular">Let</span> <span class="id">st_mark</span> <span class="id">:</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> (<span class="gallina-kwd">fun</span> <span class="id">t</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="id">tt,</span> (<span class="id">s</span>.<span class="id">1,</span> <span class="id">rcons</span> <span class="id">s</span>.<span class="id">2</span> <span class="id">t</span>))).<br/>
<span class="vernacular">Let</span> <span class="id">st_putput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">s',</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">st_put</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">st_put</span> <span class="id">s'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof116')">Proof.</span></div>
<div class="proofscript" id="proof116">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">st_putget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s,</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">st_get</span> <span class="id">=</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof117')">Proof.</span></div>
<div class="proofscript" id="proof117">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">st_getputskip</span> <span class="id">:</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="id">st_put</span> <span class="id">=</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof118')">Proof.</span></div>
<div class="proofscript" id="proof118">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">*;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">st_getget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">st_get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof119')">Proof.</span></div>
<div class="proofscript" id="proof119">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">st_putmark</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">e,</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">st_mark</span> <span class="id">e</span> <span class="id">=</span> <span class="id">st_mark</span> <span class="id">e</span> <span class="id">&gt;&gt;</span> <span class="id">st_put</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof120')">Proof.</span></div>
<div class="proofscript" id="proof120">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">st_getmark</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">e</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">S</span>)<span class="id">,</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">st_mark</span> <span class="id">e</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">v</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">st_mark</span> <span class="id">e</span> <span class="id">&gt;&gt;</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof121')">Proof.</span></div>
<div class="proofscript" id="proof121">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadStateTrace</span>.<span class="id">Build</span> <span class="id">S</span> <span class="id">T</span> (<span class="id">StateMonad.acto</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)<span class="id">%type</span>)<br/>
&nbsp;&nbsp;<span class="id">st_get</span> <span class="id">st_put</span> <span class="id">st_mark</span> <span class="id">st_putput</span> <span class="id">st_putget</span> <span class="id">st_getputskip</span> <span class="id">st_getget</span> <span class="id">st_putmark</span> <span class="id">st_getmark</span>.<br/>
<span class="vernacular">End</span> <span class="id">st</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelStateTrace</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelStateTrace</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">usual_callcc</span> <span class="id">r</span> (<span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">C</span> <span class="id">=&gt;</span> (<span class="id">C</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">A</span> <span class="id">B</span> (<span class="id">f</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">a</span>) <span class="id">k</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelCont</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelcont</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> (<span class="id">ContMonad.acto</span> <span class="id">r</span>)<span class="id">]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">callcc</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">acallcc_op</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> (<span class="id">Ret</span> <span class="id">x</span>))).<br/>
<span class="vernacular">Lemma</span> <span class="id">callccE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">callcc</span> <span class="id">f</span> <span class="id">=</span> <span class="id">usual_callcc</span> <span class="id">f</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof122')">Proof.</span></div>
<div class="proofscript" id="proof122">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">callcc0</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">g</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">@callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">g</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>)) <span class="id">=</span> <span class="id">@callcc</span> <span class="id">_</span> <span class="id">_</span> <span class="id">g</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof123')">Proof.</span></div>
<div class="proofscript" id="proof123">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">callcc1</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">B</span>)<span class="id">,</span> <span class="id">@callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">m</span>) <span class="id">=</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof124')">Proof.</span></div>
<div class="proofscript" id="proof124">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">callcc2</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">x</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">@callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">a</span> <span class="id">b</span>))) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">@callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">x</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof125')">Proof.</span></div>
<div class="proofscript" id="proof125">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">callcc3</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">b,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">@callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">b</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">@callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">b</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof126')">Proof.</span></div>
<div class="proofscript" id="proof126">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadContinuation.Build</span> (<span class="id">ContMonad.acto</span> <span class="id">r</span>)<br/>
&nbsp;&nbsp;<span class="id">callcc0</span> <span class="id">callcc1</span> <span class="id">callcc2</span> <span class="id">callcc3</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelcont</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelCont</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelCont</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">continuation_examples</span>.<br/>
<span class="vernacular">Fixpoint</span> <span class="id">fib</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">n</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">0</span> <span class="id">=&gt;</span> <span class="id">1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">1</span> <span class="id">=&gt;</span> <span class="id">1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> (<span class="id">m</span>.<span class="id">+1</span> <span class="gallina-kwd">as</span> <span class="id">sm</span>).<span class="id">+1</span> <span class="id">=&gt;</span> <span class="id">fib</span> <span class="id">sm</span> <span class="id">+</span> <span class="id">fib</span> <span class="id">m</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">end</span>.<br/>
<span class="vernacular">Fixpoint</span> <span class="id">fib_cps</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">monad}</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">n</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">0</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">1</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> (<span class="id">m</span>.<span class="id">+1</span> <span class="gallina-kwd">as</span> <span class="id">sm</span>).<span class="id">+1</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fib_cps</span> <span class="id">sm</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">fib_cps</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">a</span> <span class="id">+</span> <span class="id">b</span>)<br/>
&nbsp;&nbsp;<span class="gallina-kwd">end</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fib_cpsE</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">n</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">fib_cps</span> <span class="id">n</span>.<span class="id">+2</span> <span class="id">=</span> (<span class="id">fib_cps</span> <span class="id">n</span>.<span class="id">+1</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">fib_cps</span> <span class="id">n</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">a</span> <span class="id">+</span> <span class="id">b</span>)) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof127')">Proof.</span></div>
<div class="proofscript" id="proof127">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">nat_ind2</span> (<span class="id">P</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="gallina-kwd">Prop</span>) (<span class="id">P0</span> <span class="id">:</span> <span class="id">P</span> <span class="id">O</span>) (<span class="id">P1</span> <span class="id">:</span> <span class="id">P</span> <span class="id">1</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span> <span class="id">m,</span> <span class="id">P</span> <span class="id">m</span> <span class="id">-&gt;</span> <span class="id">P</span> <span class="id">m</span>.<span class="id">+1</span> <span class="id">-&gt;</span> <span class="id">P</span> <span class="id">m</span>.<span class="id">+2</span>) <span class="id">-&gt;</span> <span class="gallina-kwd">forall</span> <span class="id">m,</span> <span class="id">P</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof128')">Proof.</span></div>
<div class="proofscript" id="proof128">
<span class="id">move=&gt;</span> <span class="id">H</span> <span class="id">n;</span> <span class="id">suff</span> <span class="id">:</span> <span class="id">P</span> <span class="id">n</span> <span class="id">/\</span> <span class="id">P</span> <span class="id">n</span>.<span class="id">+1</span> <span class="gallina-kwd">by</span> <span class="id">case</span>.<br/>
<span class="id">elim:</span> <span class="id">n</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">[]</span> <span class="id">H1</span> <span class="id">H2;</span> <span class="id">split</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">exact:</span> <span class="id">H</span>.<br/>
Qed.</div>
<span class="vernacular">Goal</span> <span class="gallina-kwd">forall</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">n,</span> <span class="id">fib_cps</span> <span class="id">n</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">fib</span> <span class="id">n</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">nat</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof129')">Proof.</span></div>
<div class="proofscript" id="proof129">
<span class="id">move=&gt;</span> <span class="id">M;</span> <span class="id">apply</span> <span class="id">nat_ind2</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih1</span> <span class="id">ih2</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fib_cpsE</span> <span class="id">ih2</span> <span class="id">bindretf</span> <span class="id">ih1</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">oaddn</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">acc</span> <span class="id">:</span> <span class="id">nat</span>) (<span class="id">x</span> <span class="id">:</span> <span class="id">option</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">is</span> <span class="id">Some</span> <span class="id">x</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">+</span> <span class="id">acc</span>) <span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">acc</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">sum_just</span> <span class="id">M</span> (<span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> (<span class="id">option</span> <span class="id">nat</span>)) <span class="id">:=</span> <span class="id">foldM</span> (<span class="id">oaddn</span> <span class="id">M</span>) <span class="id">0</span> <span class="id">xs</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">oaddn_break</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">break</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span>) (<span class="id">acc</span> <span class="id">:</span> <span class="id">nat</span>) (<span class="id">x</span> <span class="id">:</span> <span class="id">option</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">is</span> <span class="id">Some</span> <span class="id">x</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">+</span> <span class="id">acc</span>) <span class="gallina-kwd">else</span> <span class="id">break</span> <span class="id">acc</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">contMonad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">contMonad</span> <span class="id">of</span> <span class="id">ContMonad.acto</span> <span class="id">nat]</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">sum_break</span> (<span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> (<span class="id">option</span> <span class="id">nat</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">break</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">foldM</span> (<span class="id">oaddn_break</span> <span class="id">break</span>) <span class="id">0</span> <span class="id">xs</span>).<br/>
<br/>
<span class="vernacular">Compute</span> (<span class="id">sum_break</span> <span class="id">[::</span> <span class="id">Some</span> <span class="id">2;</span> <span class="id">Some</span> <span class="id">6;</span> <span class="id">None;</span> <span class="id">Some</span> <span class="id">4]</span>).<br/>
<br/>
<span class="vernacular">Goal</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">f</span> <span class="id">100</span>))) <span class="id">=</span> <span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">100</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof130')">Proof.</span></div>
<div class="proofscript" id="proof130">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/addM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Abort.</div>
<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">list_iter</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">A</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">is</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">f</span> <span class="id">h</span> <span class="id">&gt;&gt;</span> <span class="id">list_iter</span> <span class="id">f</span> <span class="id">t</span> <span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">tt</span>.<br/>
<br/>
<span class="vernacular">Compute</span> (<span class="id">@list_iter</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">idfun]</span> <span class="id">nat</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">tt</span>) <span class="id">[::</span> <span class="id">O;</span> <span class="id">1;</span> <span class="id">2]</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">list_find</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">contMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">list_iter</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="gallina-kwd">if</span> <span class="id">p</span> <span class="id">x</span> <span class="gallina-kwd">then</span>  <span class="id">k</span> (<span class="id">Some</span> <span class="id">x</span>) <span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">tt</span>) <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">None</span>).<br/>
<br/>
<br/>
<span class="vernacular">Compute</span> (<span class="id">@list_find</span> <span class="id">[the</span> <span class="id">contMonad</span> <span class="id">of</span> <span class="id">ContMonad.acto</span> <span class="id">bool]</span> <span class="id">nat</span> <span class="id">[pred</span> <span class="id">x</span> <span class="id">|</span> <span class="id">odd</span> <span class="id">x]</span> <span class="id">[::</span> <span class="id">2;</span> <span class="id">4;</span> <span class="id">6]</span>).<br/>
<br/>
<br/>
<span class="vernacular">Compute</span> (<span class="id">@list_find</span> <span class="id">[the</span> <span class="id">contMonad</span> <span class="id">of</span> (<span class="id">ContMonad.acto</span> <span class="id">bool</span>)<span class="id">]</span> <span class="id">nat</span> <span class="id">[pred</span> <span class="id">x</span> <span class="id">|</span> <span class="id">odd</span> <span class="id">x]</span> <span class="id">[::</span> <span class="id">2;</span> <span class="id">4;</span> <span class="id">3;</span> <span class="id">6]</span>).<br/>
<br/>
<span class="vernacular">End</span> <span class="id">continuation_examples</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelShiftReset</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelshiftreset</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">contMonad</span> <span class="id">of</span> <span class="id">ContMonad.acto</span> <span class="id">r]</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">shift</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> ((<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">h</span> <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">c</span> <span class="id">=&gt;</span> <span class="id">h</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">c'</span> <span class="id">=&gt;</span> <span class="id">c'</span> (<span class="id">c</span> <span class="id">v</span>)) <span class="id">ssrfun.id</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">reset</span> <span class="id">:</span> <span class="id">M</span> <span class="id">r</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">r</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">m</span>  <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">c</span> <span class="id">=&gt;</span> <span class="id">c</span> (<span class="id">m</span> <span class="id">ssrfun.id</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">shiftreset0</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span> <span class="id">@shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>) <span class="id">=</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof131')">Proof.</span></div>
<div class="proofscript" id="proof131">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">shiftreset1</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">h</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">callcc</span> <span class="id">h</span> <span class="id">=</span> <span class="id">@shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k'</span> <span class="id">=&gt;</span> <span class="id">h</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">@shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k''</span> <span class="id">=&gt;</span> <span class="id">k'</span> <span class="id">x</span>)) <span class="id">&gt;&gt;=</span> <span class="id">k'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof132')">Proof.</span></div>
<div class="proofscript" id="proof132">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">shiftreset2</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">c</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">c':</span> <span class="id">r</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span> <span class="id">-&gt;</span> <span class="id">_</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">reset</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">c;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">@shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">c'</span>)<span class="id">;</span> <span class="id">k</span> <span class="id">x</span> <span class="id">y</span>) <span class="id">=</span> <span class="id">Ret</span> <span class="id">c</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">c'</span>)<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof133')">Proof.</span></div>
<div class="proofscript" id="proof133">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">shiftreset3</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">c</span> <span class="id">c'</span> <span class="id">:</span> <span class="id">r</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">r</span> <span class="id">-&gt;</span> <span class="id">r</span> <span class="id">-&gt;</span> <span class="id">_</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">reset</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">c;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">@shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">do</span> <span class="id">v</span> <span class="id">&lt;-</span> <span class="id">f</span> <span class="id">c';</span> <span class="id">f</span> <span class="id">v</span>)<span class="id">;</span> <span class="id">Ret</span> (<span class="id">k</span> <span class="id">x</span> <span class="id">y</span>)) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reset</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">c;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">@shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">c'</span>)<span class="id">;</span> <span class="id">Ret</span> (<span class="id">k</span> <span class="id">x</span> (<span class="id">k</span> <span class="id">x</span> <span class="id">y</span>))))<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof134')">Proof.</span></div>
<div class="proofscript" id="proof134">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">shiftreset4</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">c</span> <span class="id">:</span> <span class="id">r</span>) <span class="id">k,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">reset</span> (<span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">@shift</span> <span class="id">_</span> (<span class="id">@^~</span> <span class="id">c</span>)<span class="id">;</span> <span class="id">Ret</span> (<span class="id">k</span> <span class="id">y</span>)) <span class="id">=</span> <span class="id">Ret</span> (<span class="id">k</span> <span class="id">c</span>))<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof135')">Proof.</span></div>
<div class="proofscript" id="proof135">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadShiftReset.Build</span> <span class="id">r</span> (<span class="id">ContMonad.acto</span> <span class="id">r</span>)<br/>
&nbsp;&nbsp;<span class="id">shiftreset0</span> <span class="id">shiftreset1</span> <span class="id">shiftreset2</span> <span class="id">shiftreset3</span> <span class="id">shiftreset4</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelshiftreset</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelShiftReset</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelShiftReset</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">shiftreset_examples</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">shiftresetMonad</span> <span class="id">nat</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">shiftresetMonad</span> <span class="id">nat</span> <span class="id">of</span> <span class="id">ContMonad.acto</span> <span class="id">nat]</span>.<br/>
<span class="vernacular">Goal</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">reset</span> (<span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">100</span>) <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> <span class="id">100</span>))).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof136')">Proof.</span></div>
<div class="proofscript" id="proof136">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/addM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Abort.</div>
<span class="vernacular">Goal</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">reset</span> (<span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">100</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">100</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof137')">Proof.</span></div>
<div class="proofscript" id="proof137">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/addM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Abort.</div>
<span class="vernacular">Goal</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">reset</span> (<span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">100</span> <span class="id">+m</span> <span class="id">f</span> <span class="id">1000</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> ((<span class="id">10</span> <span class="id">+</span> <span class="id">100</span>) <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> <span class="id">1000</span>))).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof138')">Proof.</span></div>
<div class="proofscript" id="proof138">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/addM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Abort.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">N</span> <span class="id">:</span> <span class="id">shiftresetMonad</span> (<span class="id">seq</span> <span class="id">nat</span>) <span class="id">:=</span> <span class="id">[the</span> <span class="id">shiftresetMonad</span> (<span class="id">seq</span> <span class="id">nat</span>) <span class="id">of</span> <span class="id">ContMonad.acto</span> (<span class="id">seq</span> <span class="id">nat</span>)<span class="id">]</span>.<br/>
<span class="vernacular">Fixpoint</span> <span class="id">perverse</span> (<span class="id">l</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">N</span> (<span class="id">seq</span> <span class="id">nat</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">l</span> <span class="id">is</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">h</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">perverse</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">y</span>))))<br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">[::]</span>.<br/>
<span class="vernacular">Goal</span> <span class="id">reset</span> (<span class="id">perverse</span> <span class="id">[::</span> <span class="id">1;</span> <span class="id">2;</span> <span class="id">3]</span>) <span class="id">=</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">3;</span> <span class="id">2;</span> <span class="id">1]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">[]</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">stranger</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">g</span> <span class="id">b</span> <span class="id">:=</span> <span class="id">reset</span> ((<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">b</span>) <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="gallina-kwd">if</span> <span class="id">x</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">2</span> <span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">3</span>))) <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">g</span> <span class="id">true</span> <span class="id">+m</span> <span class="id">g</span> <span class="id">false</span>.<br/>
<span class="vernacular">Goal</span> <span class="id">stranger</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">5</span>. <span class="gallina-kwd">by</span> <span class="id">[]</span>. Abort.</div>
<br/>
<span class="vernacular">Goal</span> <span class="id">reset</span> (<span class="id">Ret</span> <span class="id">2</span> <span class="id">+m</span> <span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">3</span> <span class="id">+m</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span> <span class="id">Ret</span> <span class="id">6</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof139')">Proof.</span></div>
<div class="proofscript" id="proof139">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/addM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Abort.</div>
<span class="vernacular">Goal</span> <span class="id">reset</span> (<span class="id">Ret</span> <span class="id">2</span> <span class="id">*m</span> <span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">4</span> <span class="id">+m</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">*m</span> <span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">3</span> <span class="id">+m</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span> ) <span class="id">=</span> <span class="id">Ret</span> <span class="id">26</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof140')">Proof.</span></div>
<div class="proofscript" id="proof140">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/mulM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>. Abort.</div>
<br/>
<span class="vernacular">End</span> <span class="id">shiftreset_examples</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelStateLoop</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelstateloop</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">StateMonad.acto</span> <span class="id">S</span>).<br/>
<span class="vernacular">Fixpoint</span> <span class="id">mforeach</span> (<span class="id">it</span> <span class="id">min</span> <span class="id">:</span> <span class="id">nat</span>) (<span class="id">body</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">it</span> <span class="id">&lt;=</span> <span class="id">min</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">tt</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="gallina-kwd">if</span> <span class="id">it</span> <span class="id">is</span> <span class="id">it'</span>.<span class="id">+1</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">body</span> <span class="id">it'</span>) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">mforeach</span> <span class="id">it'</span> <span class="id">min</span> <span class="id">body</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">tt</span>.<br/>
<span class="vernacular">Let</span> <span class="id">loop0</span> <span class="id">m</span> <span class="id">body</span> <span class="id">:</span> <span class="id">mforeach</span> <span class="id">m</span> <span class="id">m</span> <span class="id">body</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">tt</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof141')">Proof.</span></div>
<div class="proofscript" id="proof141">
 <span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">//=</span> <span class="id">n;</span> <span class="id">rewrite</span> <span class="id">ltnS</span> <span class="id">leqnn</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">loop1</span> <span class="id">m</span> <span class="id">n</span> <span class="id">body</span> <span class="id">:</span> <span class="id">mforeach</span> (<span class="id">m</span>.<span class="id">+1</span> <span class="id">+</span> <span class="id">n</span>) <span class="id">m</span> <span class="id">body</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">body</span> (<span class="id">m</span> <span class="id">+</span> <span class="id">n</span>)) <span class="id">&gt;&gt;</span> <span class="id">mforeach</span> (<span class="id">m</span> <span class="id">+</span> <span class="id">n</span>) <span class="id">m</span> <span class="id">body</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">unit</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof142')">Proof.</span></div>
<div class="proofscript" id="proof142">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/mforeach</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">rewrite</span> <span class="id">ltnNge</span> <span class="id">leq_addr</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadStateLoop.Build</span> <span class="id">S</span> <span class="id">M</span> <span class="id">loop0</span> <span class="id">loop1</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelstateloop</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelStateLoop</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelStateLoop</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelReify</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelreify</span>.<br/>
<span class="vernacular">Variables</span> <span class="id">S</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">state_trace</span> <span class="id">:=</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)<span class="id">%type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">StateMonad.acto</span> <span class="id">state_trace</span>).<br/>
<span class="vernacular">Let</span> <span class="id">reify</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">state_trace</span> <span class="id">-&gt;</span> <span class="id">option</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">state_trace</span>) <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">m</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">Some</span> (<span class="id">m</span> <span class="id">s</span>).<br/>
<span class="vernacular">Let</span> <span class="id">reifyret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">s,</span> <span class="id">@reify</span> <span class="id">_</span> (<span class="id">Ret</span> <span class="id">a</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Some</span> (<span class="id">a,</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof143')">Proof.</span></div>
<div class="proofscript" id="proof143">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">reifybind</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">s,</span><br/>
&nbsp;&nbsp;<span class="id">@reify</span> <span class="id">_</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">s</span> <span class="id">=</span> <span class="gallina-kwd">match</span> <span class="id">@reify</span> <span class="id">_</span> <span class="id">m</span> <span class="id">s</span> <span class="gallina-kwd">with</span> <span class="id">|</span> <span class="id">Some</span> <span class="id">a's'</span> <span class="id">=&gt;</span> <span class="id">@reify</span> <span class="id">_</span> (<span class="id">f</span> <span class="id">a's'</span>.<span class="id">1</span>) <span class="id">a's'</span>.<span class="id">2</span> <span class="id">|</span> <span class="id">None</span> <span class="id">=&gt;</span> <span class="id">None</span> <span class="gallina-kwd">end</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof144')">Proof.</span></div>
<div class="proofscript" id="proof144">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m0</span> <span class="id">f</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> <span class="id">state_bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">/uncurry</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/comp</span> <span class="id">/=</span> <span class="id">/reify</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case</span> (<span class="id">m0</span> <span class="id">s</span>).<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadReify.Build</span> <span class="id">state_trace</span> (<span class="id">StateMonad.acto</span> <span class="id">state_trace</span>)<br/>
&nbsp;&nbsp;<span class="id">reifyret</span> <span class="id">reifybind</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelreify</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelReify</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelReify</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelStateTraceReify</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelstatetracereify</span>.<br/>
<span class="vernacular">Variables</span> <span class="id">S</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">acto</span> <span class="id">:=</span> (<span class="id">StateMonad.acto</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)).<br/>
<span class="vernacular">Let</span> <span class="id">reifystget</span> <span class="id">:</span>  <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">l,</span> <span class="id">@reify</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">@st_get</span> <span class="id">_</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateTraceMonad</span> <span class="id">S</span> <span class="id">T</span> <span class="id">of</span> <span class="id">acto]</span>) (<span class="id">s,</span> <span class="id">l</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">s,</span> (<span class="id">s,</span> <span class="id">l</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof145')">Proof.</span></div>
<div class="proofscript" id="proof145">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">reifystput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">l</span> <span class="id">s',</span> <span class="id">@reify</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">@st_put</span> <span class="id">_</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateTraceMonad</span> <span class="id">S</span> <span class="id">T</span> <span class="id">of</span> <span class="id">acto]</span> <span class="id">s'</span>) (<span class="id">s,</span> <span class="id">l</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">tt,</span> (<span class="id">s',</span> <span class="id">l</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof146')">Proof.</span></div>
<div class="proofscript" id="proof146">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">reifystmark</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">t</span> <span class="id">s</span> <span class="id">l,</span> <span class="id">@reify</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">@st_mark</span> <span class="id">_</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateTraceMonad</span> <span class="id">S</span> <span class="id">T</span> <span class="id">of</span> <span class="id">acto]</span> <span class="id">t</span>) (<span class="id">s,</span> <span class="id">l</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">tt,</span> (<span class="id">s,</span> <span class="id">rcons</span> <span class="id">l</span> <span class="id">t</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof147')">Proof.</span></div>
<div class="proofscript" id="proof147">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadStateTraceReify.Build</span> <span class="id">S</span> <span class="id">T</span> (<span class="id">StateMonad.acto</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)) <span class="id">reifystget</span> <span class="id">reifystput</span> <span class="id">reifystmark</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelstatetracereify</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelStateTraceReify</span>.<br/>
<br/>
<span class="vernacular">Notation</span> <span class="id">choice_of_Type</span> <span class="id">:=</span> <span class="id">convex.choice_of_Type</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelBacktrackableState</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">fset_scope</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">monad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="gallina-kwd">Type</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Obligation</span> <span class="vernacular">Tactic</span> <span class="id">:=</span> <span class="id">try</span> <span class="gallina-kwd">by</span> <span class="id">[]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:</span> <span class="gallina-kwd">Type</span> <span class="id">-&gt;</span> <span class="gallina-kwd">Type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">{fset</span> (<span class="id">choice_of_Type</span> <span class="id">A</span> <span class="id">*</span> <span class="id">choice_of_Type</span> <span class="id">S</span>)<span class="id">}</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">s</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">[fset</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">choice_of_Type</span> <span class="id">A,</span> <span class="id">s</span> <span class="id">:</span> <span class="id">choice_of_Type</span> <span class="id">S</span>)<span class="id">]</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">A</span>)<br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">{fset</span> (<span class="id">choice_of_Type</span> <span class="id">B</span> <span class="id">*</span> <span class="id">choice_of_Type</span> <span class="id">S</span>)<span class="id">}</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">\bigcup_</span>(<span class="id">i</span> <span class="id">&lt;-</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">:</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">A</span> <span class="id">*</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">choice_of_Type</span> <span class="id">S]</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span>.<span class="id">1</span> <span class="id">x</span>.<span class="id">2</span>) <span class="id">@`</span> (<span class="id">m</span> <span class="id">s</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">i</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof148')">Proof.</span></div>
<div class="proofscript" id="proof148">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">/=</span> <span class="id">m</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">/ret</span> <span class="id">imfset_set1</span> <span class="id">/=</span> <span class="id">big_seq_fset1</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof149')">Proof.</span></div>
<div class="proofscript" id="proof149">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x;</span> <span class="id">apply/bigfcupP';</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">xBs</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">x'</span> <span class="id">:=</span> (<span class="id">x</span> <span class="id">:</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">A</span> <span class="id">*</span> <span class="id">choice_of_Type</span> <span class="id">S]</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> <span class="id">[fset</span> <span class="id">x'];</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">inE</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply/imfsetP;</span> <span class="gallina-kwd">exists</span> <span class="id">x'</span> <span class="id">=&gt;</span> <span class="id">//=;</span> <span class="id">case:</span> <span class="id">x'</span>.<br/>
<span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">SA</span> <span class="id">/imfsetP[]</span> <span class="id">/=</span> <span class="id">sa</span> <span class="id">saBs</span> <span class="id">-&gt;{SA}</span> <span class="id">/fset1P</span> <span class="id">=&gt;</span> <span class="id">Hx</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">move:</span> <span class="id">xBs;</span> <span class="id">rewrite</span> <span class="id">Hx;</span> <span class="id">apply/negP;</span> <span class="id">rewrite</span> <span class="id">negbK;</span> <span class="id">case:</span> <span class="id">sa</span> <span class="id">saBs</span> <span class="id">Hx</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof150')">Proof.</span></div>
<div class="proofscript" id="proof150">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">/=</span> <span class="id">m</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">have</span> <span class="id">@g'</span> <span class="id">:</span> <span class="id">choice_of_Type</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">choice_of_Type</span> <span class="id">S</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">{fset</span> <span class="id">choice_of_Type</span> <span class="id">C</span> <span class="id">*</span> <span class="id">choice_of_Type</span> <span class="id">S}</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">b'</span> <span class="id">s';</span> <span class="id">exact:</span> (<span class="id">g</span> <span class="id">b'</span> <span class="id">s'</span>).<br/>
<span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x;</span> <span class="id">apply/bigfcupP'/bigfcupP';</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">CS</span>  <span class="id">/imfsetP[/=]</span>.<br/>
<span class="id">-</span> <span class="id">move=&gt;</span> <span class="id">bs</span> <span class="id">/bigfcupP'[/=</span> <span class="id">BS]</span>  <span class="id">/imfsetP[/=</span> <span class="id">sa]</span> <span class="id">sams</span> <span class="id">-&gt;{BS}</span> <span class="id">bsfsa</span> <span class="id">-&gt;{CS}</span> <span class="id">xgbs</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="id">\bigcup_</span>(<span class="id">i</span> <span class="id">&lt;-</span> <span class="id">[fset</span> <span class="id">g'</span> <span class="id">x0</span>.<span class="id">1</span> <span class="id">x0</span>.<span class="id">2</span> <span class="id">|</span> <span class="id">x0</span> <span class="gallina-kwd">in</span> <span class="id">f</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2]</span>) <span class="id">i</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply/imfsetP</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="gallina-kwd">exists</span> <span class="id">sa</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/bigfcupP';</span> <span class="gallina-kwd">exists</span> (<span class="id">g</span> <span class="id">bs</span>.<span class="id">1</span> <span class="id">bs</span>.<span class="id">2</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="gallina-kwd">by</span> <span class="id">apply/imfsetP</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="gallina-kwd">exists</span> <span class="id">bs</span>.<br/>
<span class="id">-</span> <span class="id">move=&gt;</span> <span class="id">sa</span> <span class="id">sams</span> <span class="id">-&gt;{CS}</span> <span class="id">/bigfcupP'[/=</span> <span class="id">CS]</span>  <span class="id">/imfsetP[/=</span> <span class="id">bs]</span> <span class="id">bsfsa</span> <span class="id">-&gt;{CS}</span> <span class="id">xgbs</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="id">g</span> <span class="id">bs</span>.<span class="id">1</span> <span class="id">bs</span>.<span class="id">2</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">apply/imfsetP</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="gallina-kwd">exists</span> <span class="id">bs</span> <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/bigfcupP'</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="gallina-kwd">exists</span> (<span class="id">f</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">apply/imfsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> <span class="id">sa</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">acto</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bindE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="gallina-kwd">Type</span>) <span class="id">m</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">acto]</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">\bigcup_</span>(<span class="id">i</span> <span class="id">&lt;-</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">:</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">A</span> <span class="id">*</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">choice_of_Type</span> <span class="id">S]</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span>.<span class="id">1</span> <span class="id">x</span>.<span class="id">2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">@`</span> (<span class="id">m</span> <span class="id">s</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">i</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof151')">Proof.</span></div>
<div class="proofscript" id="proof151">
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">/=</span> <span class="id">/join_of_bind</span> <span class="id">/=</span> <span class="id">/bind</span> <span class="id">/=</span>.<br/>
<span class="id">set</span> <span class="id">lhs</span> <span class="id">:=</span> <span class="id">[fset</span> <span class="id">_</span> <span class="id">_</span> <span class="id">|</span> <span class="id">_</span> <span class="gallina-kwd">in</span> <span class="id">_]</span>.<br/>
<span class="id">set</span> <span class="id">rhs</span> <span class="id">:=</span> <span class="id">[fset</span> <span class="id">_</span> <span class="id">_</span> <span class="id">|</span> <span class="id">_</span> <span class="gallina-kwd">in</span> <span class="id">_]</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">lhs</span> <span class="id">=</span> <span class="id">rhs</span>) <span class="id">//;</span> <span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">{}/lhs</span> <span class="id">{}/rhs</span>.<br/>
<span class="id">apply/idP/imfsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span>.<br/>
<span class="id">-</span> <span class="id">case/imfsetP</span> <span class="id">=&gt;</span> <span class="id">-[a1</span> <span class="id">a2]</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">/actm</span> <span class="id">/=</span> <span class="id">/map</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">case/bigfcupP'</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="id">case/imfsetP</span> <span class="id">=&gt;</span> <span class="id">-[b1</span> <span class="id">b2]</span> <span class="id">/=</span> <span class="id">Hb</span> <span class="id">-&gt;{b}</span> <span class="id">/fset1P[-&gt;</span> <span class="id">-&gt;</span> <span class="id">-&gt;{x</span> <span class="id">a1</span> <span class="id">a2}]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> (<span class="id">b1,</span> <span class="id">b2</span>).<br/>
<span class="id">-</span> <span class="id">case=&gt;</span> <span class="id">-[a1</span> <span class="id">s1]</span> <span class="id">Ha</span> <span class="id">/=</span> <span class="id">-&gt;{x}</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/imfsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">/actm</span> <span class="id">/=</span> <span class="id">/map</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">eexists</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">apply/bigfcupP'</span> <span class="id">=&gt;</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eexists</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply/imfsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> (<span class="id">a1,</span> <span class="id">s1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply/fset1P;</span> <span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">[]</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">monad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">state</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="gallina-kwd">Type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">get</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">S</span> <span class="id">S</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[fset</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">choice_of_Type</span> <span class="id">S,</span> <span class="id">s</span> <span class="id">:</span> <span class="id">choice_of_Type</span> <span class="id">S</span>)<span class="id">]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">put</span> <span class="id">:=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">[fset</span> (<span class="id">tt</span> <span class="id">:</span> <span class="id">choice_of_Type</span> <span class="id">unit,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">s</span> <span class="id">:</span> <span class="id">choice_of_Type</span> <span class="id">S</span>)<span class="id">]</span>)) <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> (<span class="id">acto</span> <span class="id">S</span> <span class="id">unit</span>).<br/>
<span class="vernacular">Let</span> <span class="id">putput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">s',</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">put</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">put</span> <span class="id">s'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof152')">Proof.</span></div>
<div class="proofscript" id="proof152">
<span class="id">move=&gt;</span> <span class="id">s</span> <span class="id">s';</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">s''</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindE;</span> <span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x;</span> <span class="id">apply/bigfcupP'/fset1P</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x0</span> <span class="id">/imfsetP[/=</span> <span class="id">x1]</span> <span class="id">/fset1P</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">/fset1P</span>.<br/>
<span class="id">-</span> <span class="id">move=&gt;</span> <span class="id">-&gt;</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> <span class="id">[fset</span> ((<span class="id">tt,</span> <span class="id">s'</span>) <span class="id">:</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">unit</span> <span class="id">*</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">choice_of_Type</span> <span class="id">S]</span>)<span class="id">]</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact/fset1P</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/imfsetP</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="gallina-kwd">exists</span> (<span class="id">tt,</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">exact/fset1P</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">putget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s,</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">get</span> <span class="id">=</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof153')">Proof.</span></div>
<div class="proofscript" id="proof153">
<span class="id">move=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s'</span>.<br/>
<span class="id">rewrite</span> <span class="id">2!bindE</span> <span class="id">/=;</span> <span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x;</span> <span class="id">apply/bigfcupP'/bigfcupP'</span>.<br/>
<span class="id">-</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x0</span> <span class="id">/imfsetP[/=</span> <span class="id">x1]</span> <span class="id">/fset1P</span> <span class="id">-&gt;</span> <span class="id">-&gt;</span> <span class="id">/fset1P</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> <span class="id">[fset</span> ((<span class="id">s,</span> <span class="id">s</span>) <span class="id">:</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">S</span> <span class="id">*</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">choice_of_Type</span> <span class="id">S]</span>)<span class="id">];</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact/fset1P</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/imfsetP</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="gallina-kwd">exists</span> (<span class="id">tt,</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">exact/fset1P</span>.<br/>
<span class="id">-</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x0</span> <span class="id">/imfsetP[/=</span> <span class="id">x1]</span> <span class="id">/fset1P</span> <span class="id">-&gt;</span> <span class="id">-&gt;</span> <span class="id">/fset1P</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> <span class="id">[fset</span> ((<span class="id">s</span> <span class="id">,s</span>) <span class="id">:</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">S</span> <span class="id">*</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">choice_of_Type</span> <span class="id">S]</span>)<span class="id">];</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact/fset1P</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/imfsetP</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="gallina-kwd">exists</span> (<span class="id">tt,</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">exact/fset1P</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">getputskip</span> <span class="id">:</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="id">put</span> <span class="id">=</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof154')">Proof.</span></div>
<div class="proofscript" id="proof154">
<span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">/skip</span> <span class="id">/=</span> <span class="id">/Ret;</span> <span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x;</span> <span class="id">apply/bigfcupP'/idP</span>.<br/>
<span class="id">-</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x0</span> <span class="id">/imfsetP[/=</span> <span class="id">x1]</span> <span class="id">/fset1P</span> <span class="id">-&gt;</span> <span class="id">-&gt;</span> <span class="id">/fset1P</span> <span class="id">-&gt;;</span> <span class="id">exact/fset1P</span>.<br/>
<span class="id">-</span> <span class="id">move/fset1P</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> <span class="id">[fset</span> ((<span class="id">tt,</span> <span class="id">s</span>) <span class="id">:</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">unit</span> <span class="id">*</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">choice_of_Type</span> <span class="id">S]</span>)<span class="id">];</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact/fset1P</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply/imfsetP;</span> <span class="gallina-kwd">exists</span> (<span class="id">s,</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">rewrite</span> <span class="id">inE</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">getget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">_</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;<span class="id">get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof155')">Proof.</span></div>
<div class="proofscript" id="proof155">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">k;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> <span class="id">2!bindE;</span> <span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">x;</span> <span class="id">apply/bigfcupP'/bigfcupP'</span>.<br/>
<span class="id">-</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x0</span> <span class="id">/imfsetP[/=</span> <span class="id">x1]</span> <span class="id">/fset1P</span> <span class="id">-&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">=&gt;</span> <span class="id">/bigfcupP'[/=</span> <span class="id">x2]</span> <span class="id">/imfsetP[/=</span> <span class="id">x3]</span> <span class="id">/fset1P</span> <span class="id">-&gt;</span> <span class="id">-&gt;</span> <span class="id">xkss</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="id">k</span> <span class="id">s</span> <span class="id">s</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">apply/imfsetP;</span> <span class="gallina-kwd">exists</span> (<span class="id">s,</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">inE</span>.<br/>
<span class="id">-</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x0</span> <span class="id">/imfsetP[/=</span> <span class="id">x1]</span> <span class="id">/fset1P</span> <span class="id">-&gt;</span> <span class="id">-&gt;</span> <span class="id">/=</span> <span class="id">xksss</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">@k'</span> <span class="id">:</span> <span class="id">choice_of_Type</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">choice_of_Type</span> <span class="id">S</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">choice_of_Type</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">{fset</span> <span class="id">choice_of_Type</span> <span class="id">A</span> <span class="id">*</span> <span class="id">choice_of_Type</span> <span class="id">S}</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move=&gt;</span> <span class="id">a</span> <span class="id">b</span> <span class="id">s';</span> <span class="id">exact:</span> (<span class="id">k</span> <span class="id">a</span> <span class="id">b</span> <span class="id">s'</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="id">\bigcup_</span>(<span class="id">i</span> <span class="id">&lt;-</span> <span class="id">[fset</span> <span class="id">k'</span> (<span class="id">s,</span> <span class="id">s</span>).<span class="id">1</span> <span class="id">x2</span>.<span class="id">1</span> <span class="id">x2</span>.<span class="id">2</span> <span class="id">|</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">x2</span> <span class="gallina-kwd">in</span> <span class="id">[fset</span> (((<span class="id">s,</span> <span class="id">s</span>).<span class="id">2,</span> (<span class="id">s,</span> <span class="id">s</span>).<span class="id">2</span>) <span class="id">:</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">S</span> <span class="id">*</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">choice_of_Type</span> <span class="id">S]</span>)<span class="id">]]</span>) <span class="id">i</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply/imfsetP</span> <span class="id">;</span> <span class="gallina-kwd">exists</span> (<span class="id">s,</span> <span class="id">s</span>)<span class="id">;</span> <span class="gallina-kwd">by</span> <span class="id">[rewrite</span> <span class="id">inE</span> <span class="id">|</span> <span class="id">rewrite</span> <span class="id">bindE]</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/bigfcupP';</span> <span class="gallina-kwd">exists</span> (<span class="id">k</span> <span class="id">s</span> <span class="id">s</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">apply/imfsetP;</span> <span class="gallina-kwd">exists</span> (<span class="id">s,</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">//=</span>.<br/>
&nbsp;&nbsp;<span class="id">exact/fset1P</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadState.Build</span><br/>
&nbsp;&nbsp;<span class="id">S</span> (<span class="id">acto</span> <span class="id">S</span>) <span class="id">putput</span> <span class="id">putget</span> <span class="id">getputskip</span> <span class="id">getget</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">state</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">fail</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">choiceType</span>.<br/>
<span class="vernacular">Let</span> <span class="id">fail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">acto</span> <span class="id">S</span> <span class="id">A</span> <span class="id">:=</span> (<span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="gallina-kwd">Type</span>) (<span class="id">_</span> <span class="id">:</span> <span class="id">S</span>) <span class="id">=&gt;</span> <span class="id">fset0</span>).<br/>
<span class="vernacular">Let</span> <span class="id">bindfailf</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> (<span class="id">@bind</span> <span class="id">_</span> ) <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof156')">Proof.</span></div>
<div class="proofscript" id="proof156">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">inE</span> <span class="id">bindE</span>.<br/>
<span class="id">apply/negbTE/bigfcupP';</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">x0</span> <span class="id">/imfsetP[/=</span> <span class="id">sa]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">@in_fset0</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">A</span> <span class="id">*</span> <span class="id">choice_of_Type</span> <span class="id">S]</span>).<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadFail.Build</span> (<span class="id">acto</span> <span class="id">S</span>) <span class="id">bindfailf</span>.<br/>
<span class="vernacular">End</span> <span class="id">fail</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">alt</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">choiceType</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">acto</span> <span class="id">S]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">alt</span> <span class="id">:=</span> (<span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="gallina-kwd">Type</span>) (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">{fset</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">A</span> <span class="id">*</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">choice_of_Type</span> <span class="id">S]}</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>) <span class="id">=&gt;</span> <span class="id">a</span> <span class="id">s</span> <span class="id">`|`</span> <span class="id">b</span> <span class="id">s</span>).<br/>
<span class="vernacular">Let</span> <span class="id">altA</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">ssrfun.associative</span> (<span class="id">@alt</span> <span class="id">T</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof157')">Proof.</span></div>
<div class="proofscript" id="proof157">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">a</span> <span class="id">b</span> <span class="id">c;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">/alt</span> <span class="id">fsetUA</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">alt_bindDl</span> <span class="id">:</span> <span class="id">BindLaws.left_distributive</span> (<span class="id">@bind</span> <span class="id">M</span>) (<span class="id">@alt</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof158')">Proof.</span></div>
<div class="proofscript" id="proof158">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">/=</span> <span class="id">m1</span> <span class="id">m2</span> <span class="id">k;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/=</span>.<br/>
<span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">bs;</span> <span class="id">apply/bigfcupP'/fsetUP</span>.<br/>
<span class="id">-</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">BS</span> <span class="id">/imfsetP[/=</span> <span class="id">sa]</span> <span class="id">/fsetUP[sam1s</span> <span class="id">-&gt;{BS}</span> <span class="id">Hbs|sam2s</span> <span class="id">-&gt;{BS}</span> <span class="id">Hbs]</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">left;</span> <span class="id">apply/bigfcupP'</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="gallina-kwd">exists</span> (<span class="id">k</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span>) <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply/imfsetP;</span> <span class="gallina-kwd">exists</span> <span class="id">sa</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">right;</span> <span class="id">apply/bigfcupP'</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="gallina-kwd">exists</span> (<span class="id">k</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span>) <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply/imfsetP;</span> <span class="gallina-kwd">exists</span> <span class="id">sa</span>.<br/>
<span class="id">-</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/bigfcupP'[/=</span> <span class="id">BS</span> <span class="id">/imfsetP[/=</span> <span class="id">sa</span> <span class="id">sams</span> <span class="id">-&gt;{BS}</span> <span class="id">bsksa]]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> (<span class="id">k</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">apply/imfsetP;</span> <span class="gallina-kwd">exists</span> <span class="id">sa</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">rewrite</span> <span class="id">inE</span> <span class="id">sams</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> (<span class="id">k</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span>) <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">apply/imfsetP;</span> <span class="gallina-kwd">exists</span> <span class="id">sa</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">rewrite</span> <span class="id">inE</span> <span class="id">sams</span> <span class="id">orbT</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadAlt.Build</span> (<span class="id">acto</span> <span class="id">S</span>) <span class="id">altA</span> <span class="id">alt_bindDl</span>.<br/>
<span class="vernacular">End</span> <span class="id">alt</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">nondet</span>.<br/>
<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">choiceType</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">acto</span> <span class="id">S]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">N</span> <span class="id">:</span> <span class="id">altMonad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">acto</span> <span class="id">S]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">altfailm</span> <span class="id">:</span> <span class="id">@BindLaws</span>.<span class="id">left_id</span> <span class="id">_</span> (<span class="id">@fail</span> <span class="id">M</span>) (<span class="id">@alt</span> <span class="id">N</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof159')">Proof.</span></div>
<div class="proofscript" id="proof159">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">/=</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">/alt</span> <span class="id">/=</span> <span class="id">fset0U</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">altmfail</span> <span class="id">:</span> <span class="id">@BindLaws</span>.<span class="id">right_id</span> <span class="id">_</span> (<span class="id">@fail</span> <span class="id">M</span>) (<span class="id">@alt</span> <span class="id">N</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof160')">Proof.</span></div>
<div class="proofscript" id="proof160">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">/=</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">/alt</span> <span class="id">/=</span> <span class="id">fsetU0</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadNondet.Build</span> (<span class="id">acto</span> <span class="id">S</span>) <span class="id">altfailm</span> <span class="id">altmfail</span>.<br/>
<span class="vernacular">End</span> <span class="id">nondet</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">failR0monad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">choiceType</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bindmfail</span> <span class="id">:</span> <span class="id">BindLaws.right_zero</span> (<span class="id">@bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">acto</span> <span class="id">S]</span>) (<span class="id">@fail</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof161')">Proof.</span></div>
<div class="proofscript" id="proof161">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">/=</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">sa</span>.<br/>
<span class="id">apply/idP/idP/bigfcupP'</span>.<br/>
<span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">SA</span> <span class="id">/imfsetP[/=</span> <span class="id">bs</span> <span class="id">bsgs</span> <span class="id">-&gt;{SA}]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">@in_fset0</span> <span class="id">[choiceType</span> <span class="id">of</span> <span class="id">choice_of_Type</span> <span class="id">A</span> <span class="id">*</span> <span class="id">choice_of_Type</span> <span class="id">S]</span>).<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadFailR0.Build</span> (<span class="id">acto</span> <span class="id">S</span>) <span class="id">bindmfail</span>.<br/>
<span class="vernacular">End</span> <span class="id">failR0monad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">preplusmonad</span>.<br/>
<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">choiceType</span>.<br/>
<span class="vernacular">Let</span> <span class="id">alt_bindDr</span> <span class="id">:</span> <span class="id">BindLaws.right_distributive</span> (<span class="id">@bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">acto</span> <span class="id">S]</span>) (<span class="id">@alt</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof162')">Proof.</span></div>
<div class="proofscript" id="proof162">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">/=</span> <span class="id">m</span> <span class="id">k1</span> <span class="id">k2;</span> <span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/=</span>.<br/>
<span class="id">apply/fsetP</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">bs;</span> <span class="id">apply/bigfcupP'/idP</span>.<br/>
<span class="id">-</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">BS</span> <span class="id">/imfsetP[/=</span> <span class="id">sa</span> <span class="id">sams</span> <span class="id">-&gt;{BS}]</span> <span class="id">/fsetUP[bsk1|bsk2]</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">apply/fsetUP;</span> <span class="id">left;</span> <span class="id">apply/bigfcupP';</span> <span class="gallina-kwd">exists</span> (<span class="id">k1</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span>) <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply/imfsetP;</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> <span class="id">sa</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">apply/fsetUP;</span> <span class="id">right;</span> <span class="id">apply/bigfcupP';</span> <span class="gallina-kwd">exists</span> (<span class="id">k2</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span>) <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply/imfsetP;</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> <span class="id">sa</span>.<br/>
<span class="id">-</span> <span class="id">move/fsetUP</span> <span class="id">=&gt;</span> <span class="id">[|]</span> <span class="id">/bigfcupP'[/=</span> <span class="id">BS]</span> <span class="id">/imfsetP[/=</span> <span class="id">sa</span> <span class="id">sams</span> <span class="id">-&gt;{BS}]</span> <span class="id">bsk</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="id">k1</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span> <span class="id">`|`</span> <span class="id">k2</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply/imfsetP;</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> <span class="id">sa</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply/fsetUP;</span> <span class="id">left</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="id">k1</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span> <span class="id">`|`</span> <span class="id">k2</span> <span class="id">sa</span>.<span class="id">1</span> <span class="id">sa</span>.<span class="id">2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply/imfsetP;</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> <span class="id">sa</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply/fsetUP;</span> <span class="id">right</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadPrePlus.Build</span> (<span class="id">acto</span> <span class="id">S</span>) <span class="id">alt_bindDr</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">preplusmonad</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">ModelBacktrackableState</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelArray</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelarray</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">I</span> <span class="id">:</span> <span class="id">eqType</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> (<span class="id">i</span> <span class="id">j</span> <span class="id">:</span> <span class="id">I</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="id">StateMonad.acto</span> (<span class="id">I</span> <span class="id">-&gt;</span> <span class="id">S</span>).<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">:</span> <span class="id">M</span> <span class="id">S</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> (<span class="id">a</span> <span class="id">i,</span> <span class="id">a</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> (<span class="id">tt,</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">s</span> <span class="id">a</span>).<br/>
<span class="vernacular">Let</span> <span class="id">aputput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">s'</span> <span class="id">:</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof163')">Proof.</span></div>
<div class="proofscript" id="proof163">
<span class="id">rewrite</span> <span class="id">state_bindE;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">insert_insert</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">aputget</span> <span class="id">i</span> <span class="id">s</span> <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof164')">Proof.</span></div>
<div class="proofscript" id="proof164">
<span class="id">rewrite</span> <span class="id">state_bindE;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">insert_same</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">agetputskip</span> <span class="id">i</span> <span class="id">:</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">=</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof165')">Proof.</span></div>
<div class="proofscript" id="proof165">
<span class="id">rewrite</span> <span class="id">state_bindE;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">insert_same2</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">agetget</span> <span class="id">i</span> <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof166')">Proof.</span></div>
<div class="proofscript" id="proof166">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">agetC</span> <span class="id">i</span> <span class="id">j</span> <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">u</span> <span class="id">v</span>)) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">u</span> <span class="id">v</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof167')">Proof.</span></div>
<div class="proofscript" id="proof167">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">aputC</span> <span class="id">i</span> <span class="id">j</span> <span class="id">u</span> <span class="id">v</span> <span class="id">:</span> (<span class="id">i</span> <span class="id">!=</span> <span class="id">j</span>) <span class="id">\/</span> (<span class="id">u</span> <span class="id">=</span> <span class="id">v</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">j</span> <span class="id">v</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">j</span> <span class="id">v</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">u</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof168')">Proof.</span></div>
<div class="proofscript" id="proof168">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">[ij|-&gt;{u}];</span> <span class="id">rewrite</span> <span class="id">!state_bindE</span> <span class="id">/aput;</span> <span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span><br/>
&nbsp;&nbsp;<span class="id">[rewrite</span> <span class="id">insertC|rewrite</span> <span class="id">insertC2]</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">aputgetC</span> <span class="id">i</span> <span class="id">j</span> <span class="id">u</span> <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">i</span> <span class="id">!=</span> <span class="id">j</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">v</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof169')">Proof.</span></div>
<div class="proofscript" id="proof169">
<span class="id">move=&gt;</span> <span class="id">ij;</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">!state_bindE;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">state_bindE/=</span> <span class="id">{1}/insert</span> (<span class="id">negbTE</span> <span class="id">ij</span>).<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadArray.Build</span><br/>
&nbsp;&nbsp;<span class="id">S</span> <span class="id">I</span> <span class="id">acto</span> <span class="id">aputput</span> <span class="id">aputget</span> <span class="id">agetputskip</span> <span class="id">agetget</span> <span class="id">agetC</span> <span class="id">aputC</span> <span class="id">aputgetC</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelarray</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelArray</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelPlusArray</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelplusarray</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">classical_set_scope</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">I</span> <span class="id">:</span> <span class="id">eqType</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">i</span> <span class="id">j</span> <span class="id">:</span> <span class="id">I</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> (<span class="id">I</span> <span class="id">-&gt;</span> <span class="id">S</span>) <span class="id">-&gt;</span> <span class="id">SetMonad.acto</span> (<span class="id">A</span> <span class="id">*</span> (<span class="id">I</span> <span class="id">-&gt;</span> <span class="id">S</span>))<span class="id">%type</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[set</span> (<span class="id">a,</span> <span class="id">s</span>)<span class="id">]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="id">uncurry</span> <span class="id">f</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof170')">Proof.</span></div>
<div class="proofscript" id="proof170">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">X</span> <span class="id">Y</span> <span class="id">x</span> <span class="id">f;</span> <span class="id">apply:</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a1;</span> <span class="id">rewrite</span> <span class="id">/bind/=</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof171')">Proof.</span></div>
<div class="proofscript" id="proof171">
<span class="id">move=&gt;</span> <span class="id">X/=</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">/bind;</span> <span class="id">apply:</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a1</span>.<br/>
<span class="id">rewrite</span> <span class="id">/ret</span> <span class="id">/uncurry/=;</span> <span class="id">apply/seteqP;</span> <span class="id">split</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">[x</span> <span class="id">a2]/=</span> <span class="id">[[x'</span> <span class="id">a3]]</span> <span class="id">ma1x'a3/=</span> <span class="id">-&gt;</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">[x</span> <span class="id">a2]</span> <span class="id">ma1xa2/=;</span> <span class="id">eexists;</span> <span class="id">[exact:</span> <span class="id">ma1xa2|]</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof172')">Proof.</span></div>
<div class="proofscript" id="proof172">
<span class="id">move=&gt;</span> <span class="id">X</span> <span class="id">Y</span> <span class="id">Z</span> <span class="id">/=</span> <span class="id">m</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">/bind;</span> <span class="id">apply:</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">acto</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bindE</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="id">bind</span> <span class="id">m</span> <span class="id">f</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof173')">Proof.</span></div>
<div class="proofscript" id="proof173">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Definition</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">:</span> <span class="id">M</span> <span class="id">S</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">ModelArray.aget</span> <span class="id">i</span> <span class="id">s</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">a</span> <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">ModelArray.aput</span> <span class="id">i</span> <span class="id">a</span> <span class="id">s</span>).<br/>
<span class="vernacular">Let</span> <span class="id">aputput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">s'</span> <span class="id">:</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof174')">Proof.</span></div>
<div class="proofscript" id="proof174">
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span> <span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">/bind</span> <span class="id">set_bindE</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bigcup_set1/=</span> <span class="id">/aput</span> <span class="id">/ModelArray</span>.<span class="id">aput</span> <span class="id">insert_insert</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">aputget</span> <span class="id">i</span> <span class="id">s</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof175')">Proof.</span></div>
<div class="proofscript" id="proof175">
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span> <span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/bind</span> <span class="id">set_bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">set_bindE/=</span> <span class="id">bigcup_bigcup</span> <span class="id">!bigcup_set1/=</span> <span class="id">/aput</span> <span class="id">/ModelArray</span>.<span class="id">aput</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf/=</span> <span class="id">insert_same</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">agetputskip</span> <span class="id">i</span> <span class="id">:</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">=</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof176')">Proof.</span></div>
<div class="proofscript" id="proof176">
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span> <span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">/bind</span> <span class="id">set_bindE</span> <span class="id">bigcup_set1/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">/ModelArray</span>.<span class="id">aput</span> <span class="id">insert_same2</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">agetget</span> <span class="id">i</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof177')">Proof.</span></div>
<div class="proofscript" id="proof177">
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span> <span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/bind</span> <span class="id">!set_bindE/=</span> <span class="id">bigcup_set1/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aget</span> <span class="id">/ModelArray</span>.<span class="id">aget/=</span> <span class="id">!bindE/=</span> <span class="id">/bind/=</span> <span class="id">!set_bindE/=</span> <span class="id">!bigcup_set1</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">agetC</span> <span class="id">i</span> <span class="id">j</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">u</span> <span class="id">v</span>)) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">u</span> <span class="id">v</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof178')">Proof.</span></div>
<div class="proofscript" id="proof178">
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/bind/=</span> <span class="id">!set_bindE</span> <span class="id">!bigcup_set1/=</span> <span class="id">/aget</span> <span class="id">/ModelArray</span>.<span class="id">aget/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/bind/=</span> <span class="id">!set_bindE/=</span> <span class="id">!bigcup_set1</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">aputC</span> <span class="id">i</span> <span class="id">j</span> <span class="id">u</span> <span class="id">v</span> <span class="id">:</span> (<span class="id">i</span> <span class="id">!=</span> <span class="id">j</span>) <span class="id">\/</span> (<span class="id">u</span> <span class="id">=</span> <span class="id">v</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">j</span> <span class="id">v</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">j</span> <span class="id">v</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">u</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof179')">Proof.</span></div>
<div class="proofscript" id="proof179">
<span class="id">move=&gt;</span> <span class="id">[ij|-&gt;{u}]</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/bind/=</span> <span class="id">!set_bindE/=</span> <span class="id">!bigcup_set1/=</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">/ModelArray</span>.<span class="id">aput/=</span> <span class="id">insertC</span>.<br/>
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/bind/=</span> <span class="id">!set_bindE/=</span> <span class="id">!bigcup_set1/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">/ModelArray</span>.<span class="id">aput/=</span> <span class="id">insertC2</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">aputgetC</span> <span class="id">i</span> <span class="id">j</span> <span class="id">u</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">i</span> <span class="id">!=</span> <span class="id">j</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">v</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof180')">Proof.</span></div>
<div class="proofscript" id="proof180">
<span class="id">move=&gt;</span> <span class="id">ij</span>.<br/>
<span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/bind/=</span> <span class="id">!set_bindE</span> <span class="id">!bigcup_set1/=</span> <span class="id">/aput</span> <span class="id">/ModelArray</span>.<span class="id">aput/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">/bind/=</span> <span class="id">set_bindE</span> <span class="id">bigcup_set1/=</span> <span class="id">{1}/insert</span> (<span class="id">negbTE</span> <span class="id">ij</span>).<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadArray.Build</span><br/>
&nbsp;&nbsp;<span class="id">S</span> <span class="id">I</span> <span class="id">acto</span> <span class="id">aputput</span> <span class="id">aputget</span> <span class="id">agetputskip</span> <span class="id">agetget</span> <span class="id">agetC</span> <span class="id">aputC</span> <span class="id">aputgetC</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bindfailf</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> <span class="id">bind</span> (<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">@set_fail</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof181')">Proof.</span></div>
<div class="proofscript" id="proof181">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B/=</span> <span class="id">g;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">bindfailf</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadFail.Build</span> <span class="id">acto</span> <span class="id">bindfailf</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">aalt</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">T</span>) <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">a</span> <span class="id">x</span> <span class="id">[~]</span> <span class="id">b</span> <span class="id">x</span>.<br/>
<span class="vernacular">Let</span> <span class="id">altA</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">ssrfun.associative</span> (<span class="id">@aalt</span> <span class="id">T</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof182')">Proof.</span></div>
<div class="proofscript" id="proof182">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">x</span> <span class="id">y</span> <span class="id">z;</span> <span class="id">apply:</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">rewrite</span> <span class="id">/aalt</span> <span class="id">altA</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">alt_bindDl</span> <span class="id">:</span> <span class="id">BindLaws.left_distributive</span> <span class="id">bind</span> (<span class="id">@aalt</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof183')">Proof.</span></div>
<div class="proofscript" id="proof183">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B/=</span> <span class="id">m1</span> <span class="id">m2</span> <span class="id">k;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">/aalt/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">alt_bindDl</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadAlt.Build</span> <span class="id">M</span> <span class="id">altA</span> <span class="id">alt_bindDl</span>.<br/>
<span class="vernacular">Let</span> <span class="id">altfailm</span> <span class="id">:</span> <span class="id">@BindLaws</span>.<span class="id">left_id</span> <span class="id">_</span> (<span class="id">@fail</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">acto]</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">@alt</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">acto]</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof184')">Proof.</span></div>
<div class="proofscript" id="proof184">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[x</span> <span class="id">a1]/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/alt/=</span> <span class="id">/aalt</span> <span class="id">altfailm</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">altmfail</span> <span class="id">:</span> <span class="id">@BindLaws</span>.<span class="id">right_id</span> <span class="id">_</span> (<span class="id">@fail</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">acto]</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">@alt</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">acto]</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof185')">Proof.</span></div>
<div class="proofscript" id="proof185">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[x</span> <span class="id">a1]/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/alt/=</span> <span class="id">/aalt</span> <span class="id">altmfail</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadNondet.Build</span> <span class="id">M</span> <span class="id">altfailm</span> <span class="id">altmfail</span>.<br/>
<span class="vernacular">Let</span> <span class="id">altmm</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">idempotent</span> (<span class="id">@alt</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof186')">Proof.</span></div>
<div class="proofscript" id="proof186">
<span class="id">move=&gt;</span> <span class="id">m;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[x</span> <span class="id">a1]/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/alt/=</span> <span class="id">/aalt</span> <span class="id">altmm</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">altC</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">commutative</span> (<span class="id">@alt</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof187')">Proof.</span></div>
<div class="proofscript" id="proof187">
<span class="id">move=&gt;</span> <span class="id">m1</span> <span class="id">m2;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[x</span> <span class="id">a1]/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/alt/=</span> <span class="id">/aalt</span> <span class="id">altC</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadAltCI</span>.<span class="id">Build</span> <span class="id">M</span> <span class="id">altmm</span> <span class="id">altC</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bindmfail</span> <span class="id">:</span> <span class="id">BindLaws.right_zero</span> <span class="id">bind</span> (<span class="id">@fail</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">M]</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof188')">Proof.</span></div>
<div class="proofscript" id="proof188">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">/=</span> <span class="id">m;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[x</span> <span class="id">a1]/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/bind/=</span> <span class="id">set_bindE/=</span> <span class="id">bigcup0//</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadFailR0.Build</span> <span class="id">M</span> <span class="id">bindmfail</span>.<br/>
<span class="vernacular">Let</span> <span class="id">alt_bindDr</span> <span class="id">:</span> <span class="id">BindLaws.right_distributive</span> <span class="id">bind</span> (<span class="id">@alt</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">M]</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof189')">Proof.</span></div>
<div class="proofscript" id="proof189">
<span class="id">move=&gt;</span> <span class="id">T1</span> <span class="id">T2</span> <span class="id">/=</span> <span class="id">A</span> <span class="id">k1</span> <span class="id">k2;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">-[x</span> <span class="id">a1]</span>.<br/>
<span class="id">rewrite</span> <span class="id">/bind/=</span> <span class="id">!set_bindE;</span> <span class="id">apply/boolp</span>.<span class="id">propext;</span> <span class="id">split</span>.<br/>
&nbsp;&nbsp;<span class="id">move=&gt;</span> <span class="id">-[[x1</span> <span class="id">a2]</span> <span class="id">H1]/=</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/alt/=</span> <span class="id">/aalt</span> <span class="id">-alt_bindDr</span> <span class="id">set_bindE;</span> <span class="gallina-kwd">exists</span> (<span class="id">x1,</span> <span class="id">a2</span>).<br/>
<span class="id">move=&gt;</span> <span class="id">-[];</span> <span class="id">rewrite</span> <span class="id">!set_bindE</span> <span class="id">=&gt;</span> <span class="id">-[[x1</span> <span class="id">a2]</span> <span class="id">H1]</span> <span class="id">/=</span> <span class="id">H2;</span> <span class="gallina-kwd">exists</span> (<span class="id">x1,</span> <span class="id">a2</span>) <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">left</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">right</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadPrePlus.Build</span> <span class="id">M</span> <span class="id">alt_bindDr</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelplusarray</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelPlusArray</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelPlusArray</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">locT_nat</span> <span class="id">:=</span> <span class="id">[eqType</span> <span class="id">of</span> <span class="id">nat]</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelTypedStore</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">ModelTypedStore</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">MLU</span> <span class="id">:</span> <span class="id">ML_universe</span>) (<span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>).<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">coq_type</span> <span class="id">:=</span> (<span class="id">@coq_type</span> <span class="id">MLU</span> <span class="id">N</span>).<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">ml_type</span> <span class="id">:=</span> (<span class="id">MLU</span> <span class="id">:</span> <span class="gallina-kwd">Type</span>).<br/>
<br/>
<span class="vernacular">Record</span> <span class="id">binding</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">mkbind</span> <span class="id">{</span> <span class="id">bind_type</span> <span class="id">:</span> <span class="id">ml_type;</span> <span class="id">bind_val</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">bind_type</span> <span class="id">}</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">MS</span> (<span class="id">seq</span> <span class="id">binding</span>) <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">option_monad]</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">def</span> <span class="id">:</span> <span class="id">binding</span> <span class="id">:=</span> <span class="id">mkbind</span> (<span class="id">val_nonempty</span> <span class="id">N</span>).<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Notation</span> <span class="id">nth_error</span> <span class="id">:=</span> <span class="id">List.nth_error</span>.<br/>
<br/>
<span class="vernacular">Notation</span> <span class="id">loc</span> <span class="id">:=</span> (<span class="id">@loc</span> <span class="id">ml_type</span> <span class="id">locT_nat</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">cnew</span> <span class="id">T</span> (<span class="id">v</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">loc</span> <span class="id">T</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">st</span> <span class="id">=&gt;</span> <span class="gallina-kwd">let</span> <span class="id">n</span> <span class="id">:=</span> <span class="id">size</span> <span class="id">st</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">mkloc</span> <span class="id">T</span> <span class="id">n,</span> <span class="id">rcons</span> <span class="id">st</span> (<span class="id">mkbind</span> (<span class="id">v</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>))).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">cget</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">coq_type</span> <span class="id">T</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">st</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">nth_error</span> <span class="id">st</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">is</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">T'</span> <span class="id">v</span>) <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">coerce</span> <span class="id">T</span> <span class="id">v</span> <span class="id">is</span> <span class="id">Some</span> <span class="id">u</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">u,</span> <span class="id">st</span>) <span class="gallina-kwd">else</span> <span class="id">fail</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">fail</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">cput</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">v</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">st</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">n</span> <span class="id">:=</span> <span class="id">loc_id</span> <span class="id">r</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">nth_error</span> <span class="id">st</span> <span class="id">n</span> <span class="id">is</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">T'</span> <span class="id">_</span>) <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">coerce</span> <span class="id">T'</span> <span class="id">v</span> <span class="id">is</span> <span class="id">Some</span> <span class="id">u</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">tt,</span> <span class="id">set_nth</span> <span class="id">def</span> <span class="id">st</span> <span class="id">n</span> (<span class="id">mkbind</span> (<span class="id">u</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">_</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">fail</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">fail</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">crun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">option</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">m</span> <span class="id">nil</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">inl</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">inr</span> (<span class="id">a,</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="id">Some</span> <span class="id">a</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">end</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">Env</span> <span class="id">:=</span> <span class="id">seq</span> <span class="id">binding</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">fresh_loc</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">ml_type</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">Env</span>) <span class="id">:=</span> <span class="id">mkloc</span> <span class="id">T</span> (<span class="id">size</span> <span class="id">e</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">mkbind</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">extend_env</span> <span class="id">T</span> (<span class="id">v</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">Env</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">rcons</span> <span class="id">e</span> (<span class="id">mkbind</span> <span class="id">v</span>).<br/>
<br/>
<span class="vernacular">Variant</span> <span class="id">nth_error_spec</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">ml_type</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">Env</span>) (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) <span class="id">:</span> <span class="gallina-kwd">Type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">NthError</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">s</span>) <span class="id">-&gt;</span> <span class="id">nth_error_spec</span> <span class="id">e</span> <span class="id">r</span><br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">NthError_nocoerce</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">T'</span> (<span class="id">s'</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T'</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">s'</span>) <span class="id">-&gt;</span> <span class="id">~~</span> <span class="id">coercible</span> <span class="id">T</span> <span class="id">s'</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nth_error_spec</span> <span class="id">e</span> <span class="id">r</span><br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">NthError_None</span> <span class="id">:</span> <span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">None</span> <span class="id">-&gt;</span> <span class="id">nth_error_spec</span> <span class="id">e</span> <span class="id">r</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">ntherrorP</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">ml_type</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">Env</span>) (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) <span class="id">:</span> <span class="id">nth_error_spec</span> <span class="id">e</span> <span class="id">r</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof190')">Proof.</span></div>
<div class="proofscript" id="proof190">
<span class="id">case</span> <span class="id">H</span> <span class="id">:</span> (<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>)) <span class="id">=&gt;</span> <span class="id">[[T'</span> <span class="id">s']|]</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[Ts'|Ts']</span> <span class="id">:=</span> <span class="id">boolP</span> (<span class="id">coercible</span> <span class="id">T</span> <span class="id">s'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">?</span> <span class="id">:=</span> <span class="id">coercible_eq</span> <span class="id">Ts';</span> <span class="id">subst</span> <span class="id">T'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact:</span> <span class="id">NthError</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">exact:</span> <span class="id">NthError_nocoerce</span> <span class="id">H</span> <span class="id">Ts'</span>.<br/>
<span class="id">exact:</span> <span class="id">NthError_None</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bind_cnew</span> <span class="id">T</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">e</span> <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">cnew</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">=</span> <span class="id">k</span> (<span class="id">fresh_loc</span> <span class="id">T</span> <span class="id">e</span>) (<span class="id">extend_env</span> <span class="id">s</span> <span class="id">e</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof191')">Proof.</span></div>
<div class="proofscript" id="proof191">
 <span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">e</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">Some_cget</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">e</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">s</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">e</span> <span class="id">=</span> <span class="id">f</span> <span class="id">s</span> <span class="id">e</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof192')">Proof.</span></div>
<div class="proofscript" id="proof192">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">H;</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">/cget</span> <span class="id">H</span> <span class="id">coerce_Some</span>. Qed.</div>
<span class="vernacular">Arguments</span> <span class="id">Some_cget</span> <span class="id">{T</span> <span class="id">r}</span> <span class="id">s</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">cnewget</span> <span class="id">T</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">coq_type</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">cnew</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">cnew</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">r</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof193')">Proof.</span></div>
<div class="proofscript" id="proof193">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bind_cnew</span> (<span class="id">Some_cget</span> <span class="id">s</span>)<span class="id">//</span> <span class="id">nth_error_rcons_size</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cnewput</span> <span class="id">T</span> (<span class="id">s</span> <span class="id">t</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">cnew</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">t</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">cnew</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof194')">Proof.</span></div>
<div class="proofscript" id="proof194">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span>.<br/>
<span class="id">rewrite</span> <span class="id">bind_cnew</span> <span class="id">2!MS_bindE</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/cput/=</span> <span class="id">nth_error_rcons_size</span> <span class="id">coerce_Some</span> <span class="id">set_nth_rcons</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">nocoerce_cget</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) <span class="id">T'</span> (<span class="id">s'</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T'</span>) <span class="id">e</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">s'</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">~~</span> <span class="id">coercible</span> <span class="id">T</span> <span class="id">s'</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">cget</span> <span class="id">r</span> <span class="id">e</span> <span class="id">=</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof195')">Proof.</span></div>
<div class="proofscript" id="proof195">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">H</span> <span class="id">Ts';</span> <span class="id">rewrite</span> <span class="id">/cget</span> <span class="id">H</span> <span class="id">not_coercible</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">nocoerce_cput</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) (<span class="id">T'</span> <span class="id">:</span> <span class="id">ml_type</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">s'</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T'</span>) <span class="id">e</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">s'</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">~~</span> <span class="id">coercible</span> <span class="id">T</span> <span class="id">s'</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">e</span> <span class="id">=</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof196')">Proof.</span></div>
<div class="proofscript" id="proof196">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">H</span> <span class="id">Ts';</span> <span class="id">rewrite</span> <span class="id">/cput</span> <span class="id">H</span> <span class="id">not_coercible//</span> (<span class="id">coercible_sym</span> <span class="id">_</span> <span class="id">s'</span>).<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">None_cget</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) <span class="id">e</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">None</span> <span class="id">-&gt;</span> <span class="id">cget</span> <span class="id">r</span> <span class="id">e</span> <span class="id">=</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof197')">Proof.</span></div>
<div class="proofscript" id="proof197">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">H;</span> <span class="id">rewrite</span> <span class="id">/cget</span> <span class="id">H</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">None_cput</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">e</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">None</span> <span class="id">-&gt;</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">e</span> <span class="id">=</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof198')">Proof.</span></div>
<div class="proofscript" id="proof198">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">H;</span> <span class="id">rewrite</span> <span class="id">/cput</span> <span class="id">H</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">cgetput</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">=</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof199')">Proof.</span></div>
<div class="proofscript" id="proof199">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span>.<br/>
<span class="id">have</span> <span class="id">[s'</span> <span class="id">H|T'</span> <span class="id">s'</span> <span class="id">H</span> <span class="id">Ts'|H]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">s'</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">H</span>)<span class="id">//</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">H</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cget//</span> <span class="id">None_cput</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">Some_cput</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">e</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">s</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">e</span> <span class="id">=</span> (<span class="id">@skip</span> <span class="id">M</span>) <span class="id">e</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof200')">Proof.</span></div>
<div class="proofscript" id="proof200">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">H;</span> <span class="id">rewrite</span> <span class="id">/cput/=</span> <span class="id">H</span> <span class="id">coerce_Some/=</span> <span class="id">nth_error_set_nth_id</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cgetputskip</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) <span class="id">:</span> <span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">=</span> <span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof201')">Proof.</span></div>
<div class="proofscript" id="proof201">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span> <span class="id">/=</span>.<br/>
<span class="id">have</span> <span class="id">[s'</span> <span class="id">H|T'</span> <span class="id">s'</span> <span class="id">H</span> <span class="id">Ts'|H]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">s'</span>)<span class="id">//</span> (<span class="id">Some_cget</span> <span class="id">s'</span>)<span class="id">//</span> (<span class="id">Some_cput</span> <span class="id">H</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">H</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> <span class="id">None_cget</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cgetget</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">coq_type</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof202')">Proof.</span></div>
<div class="proofscript" id="proof202">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span> <span class="id">/=</span>.<br/>
<span class="id">have</span> <span class="id">[s'</span> <span class="id">H|T'</span> <span class="id">s'</span> <span class="id">H</span> <span class="id">Ts'|H]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">do</span> <span class="id">3</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">s'</span>)<span class="id">//</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">H</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> <span class="id">None_cget</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">Some_cputE</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">s'</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">e</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">s'</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">e</span> <span class="id">=</span> <span class="id">inr</span> (<span class="id">tt,</span> <span class="id">set_nth</span> <span class="id">def</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) (<span class="id">mkbind</span> <span class="id">s</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof203')">Proof.</span></div>
<div class="proofscript" id="proof203">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">H;</span> <span class="id">rewrite</span> <span class="id">/cput/=</span> <span class="id">H</span> <span class="id">coerce_Some</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">Some_cputget</span> <span class="id">T</span> (<span class="id">s'</span> <span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<br/>
&nbsp;&nbsp;(<span class="id">e</span> <span class="id">:</span> <span class="id">Env</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">s'</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> (<span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>)) <span class="id">e</span> <span class="id">=</span> (<span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">e</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof204')">Proof.</span></div>
<div class="proofscript" id="proof204">
<span class="id">move=&gt;</span> <span class="id">H</span>.<br/>
<span class="id">rewrite</span> <span class="id">2!MS_bindE</span> (<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">H</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindE/=</span> (<span class="id">Some_cget</span> <span class="id">s</span>)<span class="id">//</span> <span class="id">nth_error_set_nth</span>.<br/>
Qed.</div>
<span class="vernacular">Arguments</span> <span class="id">Some_cputget</span> <span class="id">{T}</span> <span class="id">s'</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">cputget</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> (<span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>) <span class="id">=</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof205')">Proof.</span></div>
<div class="proofscript" id="proof205">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span> <span class="id">/=</span>.<br/>
<span class="id">have</span> <span class="id">[s'</span> <span class="id">H|T'</span> <span class="id">s'</span> <span class="id">H</span> <span class="id">Ts'|H]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cputget</span> <span class="id">s'</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">H</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!MS_bindE</span> <span class="id">None_cput</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">Some_cputput</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">ml_type</span>) (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">s'</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>)<br/>
&nbsp;&nbsp;(<span class="id">e</span> <span class="id">:</span> <span class="id">Env</span>) (<span class="id">s''</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">s''</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">s'</span>) <span class="id">e</span> <span class="id">=</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">s'</span> <span class="id">e</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof206')">Proof.</span></div>
<div class="proofscript" id="proof206">
<span class="id">move=&gt;</span> <span class="id">H</span>.<br/>
<span class="id">rewrite</span> <span class="id">MS_bindE/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]</span>(<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">H</span>)<span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]</span>(<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">H</span>)<span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindE/=</span> <span class="id">/cput</span>.<br/>
<span class="id">rewrite</span> <span class="id">nth_error_set_nth</span> <span class="id">coerce_Some/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">set_set_nth</span> <span class="id">eqxx</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cputput</span> <span class="id">T</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">s'</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">s'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof207')">Proof.</span></div>
<div class="proofscript" id="proof207">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span>.<br/>
<span class="id">have</span> <span class="id">[s''</span> <span class="id">H|T''</span> <span class="id">s''</span> <span class="id">H</span> <span class="id">Ts''|H]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cputput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">H</span>)<span class="id">//</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">H</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">!None_cput</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cgetC</span> <span class="id">T1</span> <span class="id">T2</span> (<span class="id">r1</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T1</span>) (<span class="id">r2</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T2</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T1</span> <span class="id">-&gt;</span> <span class="id">coq_type</span> <span class="id">T2</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">cget</span> <span class="id">r1</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">cget</span> <span class="id">r2</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">u</span> <span class="id">v</span>)) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">cget</span> <span class="id">r2</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">cget</span> <span class="id">r1</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">u</span> <span class="id">v</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof208')">Proof.</span></div>
<div class="proofscript" id="proof208">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span> <span class="id">/=</span>.<br/>
<span class="id">have</span> <span class="id">[u</span> <span class="id">Hr1|u</span> <span class="id">T1'</span> <span class="id">Hr1</span> <span class="id">T1u|Hr1]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r1</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">u</span>)<span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[v</span> <span class="id">Hr2|v</span> <span class="id">T2'</span> <span class="id">Hr2</span> <span class="id">T2v|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">v</span>)<span class="id">//</span> (<span class="id">Some_cget</span> <span class="id">v</span>)<span class="id">//</span> (<span class="id">Some_cget</span> <span class="id">u</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">Hr2</span>)<span class="id">//</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> <span class="id">None_cget</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">Hr1</span>)<span class="id">//</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[v</span> <span class="id">Hr2|v</span> <span class="id">T2'</span> <span class="id">Hr2</span> <span class="id">T2v|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">v</span>)<span class="id">//</span> <span class="id">MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">Hr1</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">Hr2</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cget</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cget//</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[v</span> <span class="id">Hr2|v</span> <span class="id">T2'</span> <span class="id">Hr2</span> <span class="id">T2v|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">v</span>)<span class="id">//</span> <span class="id">MS_bindE</span> <span class="id">None_cget</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">Hr2</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">!None_cget</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cnewgetD_helper</span> <span class="id">e</span> <span class="id">T</span> <span class="id">T'</span> <span class="id">r</span> <span class="id">v</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T'</span>) <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T'</span> <span class="id">-&gt;</span> <span class="id">coq_type</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">v</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">cnew</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">r'</span> <span class="id">=&gt;</span> <span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">r'</span>)) <span class="id">e</span> <span class="id">=</span> (<span class="id">cnew</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">r</span> <span class="id">v</span>)) <span class="id">e</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof209')">Proof.</span></div>
<div class="proofscript" id="proof209">
<span class="id">move=&gt;</span> <span class="id">H</span>.<br/>
<span class="id">rewrite</span> <span class="id">bind_cnew//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">v</span>) <span class="id">//</span> (<span class="id">nth_error_rcons_some</span> <span class="id">_</span> <span class="id">H</span>).<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cgetnewD</span> <span class="id">T</span> <span class="id">T'</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T'</span>) <span class="id">A</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T'</span> <span class="id">-&gt;</span> <span class="id">coq_type</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">coq_type</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">cnew</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">r'</span> <span class="id">=&gt;</span> <span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">r'</span> <span class="id">u</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">cnew</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">r'</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">r'</span> <span class="id">u</span> <span class="id">u</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof210')">Proof.</span></div>
<div class="proofscript" id="proof210">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span>.<br/>
<span class="id">have</span> <span class="id">[u</span> <span class="id">Hr|u</span> <span class="id">T1</span> <span class="id">Hr</span> <span class="id">T1u|Hr]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">u</span>)<span class="id">//</span> (<span class="id">Some_cget</span> <span class="id">u</span>)<span class="id">//</span> (<span class="id">cnewgetD_helper</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr</span>)<span class="id">//</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">Hr</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> <span class="id">None_cget</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cgetnewE</span> <span class="id">T1</span> <span class="id">T2</span> (<span class="id">r1</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T1</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T2</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k1</span> <span class="id">k2</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T2</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span> <span class="id">r2</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T2,</span> <span class="id">loc_id</span> <span class="id">r1</span> <span class="id">!=</span> <span class="id">loc_id</span> <span class="id">r2</span> <span class="id">-&gt;</span> <span class="id">k1</span> <span class="id">r2</span> <span class="id">=</span> <span class="id">k2</span> <span class="id">r2</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">cget</span> <span class="id">r1</span> <span class="id">&gt;&gt;</span> (<span class="id">cnew</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="id">k1</span>) <span class="id">=</span> <span class="id">cget</span> <span class="id">r1</span> <span class="id">&gt;&gt;</span> (<span class="id">cnew</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="id">k2</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof211')">Proof.</span></div>
<div class="proofscript" id="proof211">
<span class="id">move=&gt;</span> <span class="id">Hk</span>.<br/>
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span>.<br/>
<span class="id">have</span> <span class="id">[u</span> <span class="id">r1u|T'</span> <span class="id">s'</span> <span class="id">Hr1</span> <span class="id">T1s'|Hr]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r1</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">u</span>)<span class="id">//</span> (<span class="id">Some_cget</span> <span class="id">u</span>)<span class="id">//</span> <span class="id">!bind_cnew</span> <span class="id">Hk//</span> <span class="id">neq_ltn</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">move:</span> <span class="id">r1u</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">/nth_error_size</span> <span class="id">-&gt;</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">Hr1</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!MS_bindE</span> <span class="id">None_cget</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cgetputC</span> <span class="id">T1</span> <span class="id">T2</span> (<span class="id">r1</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T1</span>) (<span class="id">r2</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T2</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T2</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">cget</span> <span class="id">r1</span> <span class="id">&gt;&gt;</span> <span class="id">cput</span> <span class="id">r2</span> <span class="id">s</span> <span class="id">=</span> <span class="id">cput</span> <span class="id">r2</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">cget</span> <span class="id">r1</span> <span class="id">&gt;&gt;</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof212')">Proof.</span></div>
<div class="proofscript" id="proof212">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span> <span class="id">/=</span>.<br/>
<span class="id">have</span> <span class="id">[u</span> <span class="id">r1u|T1'</span> <span class="id">v1</span> <span class="id">Hr1</span> <span class="id">T1v1|Hr1]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r1</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">u</span>)<span class="id">//</span> <span class="id">[in</span> <span class="id">RHS]bindA</span> <span class="id">MS_bindE</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[v</span> <span class="id">r2v|T'</span> <span class="id">v</span> <span class="id">r2v</span> <span class="id">T2v|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">rewrite</span> (<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">r2v</span>) <span class="id">[in</span> <span class="id">RHS]bindE/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">[r12|r12]</span> <span class="id">:=</span> <span class="id">eqVneq</span> (<span class="id">loc_id</span> <span class="id">r1</span>) (<span class="id">loc_id</span> <span class="id">r2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move:</span> <span class="id">r2v;</span> <span class="id">rewrite</span> <span class="id">-r12</span> <span class="id">r1u</span> <span class="id">=&gt;</span> <span class="id">-[?]</span> <span class="id">_;</span> <span class="id">subst</span> <span class="id">T2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">/cget</span> <span class="id">nth_error_set_nth//</span> <span class="id">coerce_Some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">u</span>)<span class="id">//</span> (<span class="id">nth_error_set_nth_other</span> <span class="id">_</span> <span class="id">_</span> <span class="id">r12</span> <span class="id">r1u</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T2v</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">None_cput</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">[RHS]MS_bindE</span> <span class="id">bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[v</span> <span class="id">r2v|T'</span> <span class="id">v</span> <span class="id">r2v</span> <span class="id">T2v|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">rewrite</span> <span class="id">{1}/cget</span> <span class="id">Hr1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">[?|T1'T1]</span> <span class="id">:=</span> <span class="id">eqVneq</span> <span class="id">T1'</span> <span class="id">T1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">*</span> <span class="id">subst</span> <span class="id">T1';</span> <span class="id">rewrite</span> <span class="id">coerce_Some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]bindE/=</span> (<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">r2v</span>) <span class="id">[in</span> <span class="id">RHS]bindE/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">[Hr|Hr]</span> <span class="id">:=</span> <span class="id">eqVneq</span> (<span class="id">loc_id</span> <span class="id">r1</span>) (<span class="id">loc_id</span> <span class="id">r2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move:</span> <span class="id">r2v;</span> <span class="id">rewrite</span> <span class="id">-Hr</span> <span class="id">Hr1</span> <span class="id">=&gt;</span> <span class="id">-[?]</span> <span class="id">_;</span> <span class="id">subst</span> <span class="id">T2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/cget</span> <span class="id">nth_error_set_nth</span> <span class="id">coerce_Some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/cget</span> (<span class="id">nth_error_set_nth_other</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr</span> <span class="id">Hr1</span>) <span class="id">coerce_Some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">*</span> <span class="id">rewrite</span> <span class="id">coerce_None//=</span> <span class="id">bindfailf</span> (<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">r2v</span>) <span class="id">[in</span> <span class="id">RHS]bindE/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">[r12|r12]</span> <span class="id">:=</span> <span class="id">eqVneq</span> (<span class="id">loc_id</span> <span class="id">r1</span>) (<span class="id">loc_id</span> <span class="id">r2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move:</span> <span class="id">r2v;</span> <span class="id">rewrite</span> <span class="id">-r12</span> <span class="id">Hr1</span> <span class="id">=&gt;</span> <span class="id">-[?]</span> <span class="id">_;</span> <span class="id">subst</span> <span class="id">T1'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/cget</span> <span class="id">nth_error_set_nth</span> <span class="id">coerce_None</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/cget</span> (<span class="id">nth_error_set_nth_other</span> <span class="id">_</span> <span class="id">_</span> <span class="id">r12</span> <span class="id">Hr1</span>) <span class="id">coerce_None</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">nocoerce_cget</span> <span class="id">_</span> <span class="id">T1v1</span>)<span class="id">//</span> <span class="id">bindfailf</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T2v</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">nocoerce_cget</span> <span class="id">_</span> <span class="id">T1v1</span>)<span class="id">//</span> <span class="id">None_cput//</span> <span class="id">bindfailf</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cget//</span> <span class="id">bindfailf</span> <span class="id">bindA</span> <span class="id">MS_bindE</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[v</span> <span class="id">r2v|T'</span> <span class="id">v</span> <span class="id">r2v</span> <span class="id">T2v|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">rewrite</span> (<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">r2v</span>)<span class="id">/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindE/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cget/=</span> <span class="id">?bindfailf//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">nth_error_set_nth_none</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr1</span> <span class="id">r2v</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">r2v</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">None_cput</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">cput_then_fail</span> <span class="id">T1</span> <span class="id">T2</span> <span class="id">T1'</span> <span class="id">e</span> (<span class="id">s1'</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T1'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">r2</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T2</span>) (<span class="id">s2</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">r1</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T1</span>) (<span class="id">s1</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T1</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">nth_error</span> <span class="id">e</span> (<span class="id">loc_id</span> <span class="id">r1</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">mkbind</span> <span class="id">s1'</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">~~</span> <span class="id">coercible</span> <span class="id">T1</span> <span class="id">s1'</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">cput</span> <span class="id">r2</span> <span class="id">s2</span> <span class="id">&gt;&gt;</span> <span class="id">cput</span> <span class="id">r1</span> <span class="id">s1</span>) <span class="id">e</span> <span class="id">=</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof213')">Proof.</span></div>
<div class="proofscript" id="proof213">
<span class="id">move=&gt;</span> <span class="id">Hr1</span> <span class="id">T1s'</span>.<br/>
<span class="id">have</span> <span class="id">[v</span> <span class="id">Hr2|T2'</span> <span class="id">v</span> <span class="id">Hr2</span> <span class="id">T2v|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cput</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T2v</span>).<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">Hr2</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindE/=</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[Hr|Hr]</span> <span class="id">:=</span> <span class="id">eqVneq</span> (<span class="id">loc_id</span> <span class="id">r1</span>) (<span class="id">loc_id</span> <span class="id">r2</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">rewrite</span> <span class="id">{1}/cput</span> <span class="id">-Hr</span> <span class="id">/=</span> <span class="id">nth_error_set_nth</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">[HT|HT]</span> <span class="id">:=</span> <span class="id">eqVneq</span> <span class="id">T1</span> <span class="id">T2;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">coerce_None</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">T2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">coerce_Some//=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move:</span> <span class="id">Hr1;</span> <span class="id">rewrite</span> <span class="id">Hr</span> <span class="id">Hr2</span> <span class="id">=&gt;</span> <span class="id">-[?];</span> <span class="id">subst</span> <span class="id">T1'</span> <span class="id">=&gt;</span> <span class="id">_</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">coercible_Some</span> <span class="id">//</span> <span class="gallina-kwd">in</span> <span class="id">T1s'</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">rewrite</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T1s'</span>)<span class="id">//=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">@nth_error_set_nth_other</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">mkbind</span> <span class="id">s1'</span>)).<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cputC</span> <span class="id">T1</span> <span class="id">T2</span> (<span class="id">r1</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T1</span>) (<span class="id">r2</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T2</span>) (<span class="id">s1</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">s2</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T2</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">loc_id</span> <span class="id">r1</span> <span class="id">!=</span> <span class="id">loc_id</span> <span class="id">r2</span> <span class="id">\/</span> <span class="id">JMeq</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">cput</span> <span class="id">r1</span> <span class="id">s1</span> <span class="id">&gt;&gt;</span> <span class="id">cput</span> <span class="id">r2</span> <span class="id">s2</span> <span class="id">=</span> <span class="id">cput</span> <span class="id">r2</span> <span class="id">s2</span> <span class="id">&gt;&gt;</span> <span class="id">cput</span> <span class="id">r1</span> <span class="id">s1</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof214')">Proof.</span></div>
<div class="proofscript" id="proof214">
<span class="id">move=&gt;</span> <span class="id">H;</span> <span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span> <span class="id">/=</span>.<br/>
<span class="id">have</span> <span class="id">[u</span> <span class="id">Hr1|T1'</span> <span class="id">s'd</span> <span class="id">Hr1</span> <span class="id">T1s'|Hr1]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r1;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cput//</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[v</span> <span class="id">Hr2|T2'</span> <span class="id">s'</span> <span class="id">Hr2</span> <span class="id">T2s'|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cput</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T2s'</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">Hr2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindE/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">None_cput//</span> (<span class="id">nth_error_set_nth_none</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr1</span> <span class="id">Hr2</span>).<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T1s'</span>)<span class="id">//</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">cput_then_fail</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr1</span>).<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">Hr1</span>)<span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindE/=</span>.<br/>
&nbsp;&nbsp;<span class="id">case/boolP:</span> (<span class="id">loc_id</span> <span class="id">r1</span> <span class="id">==</span> <span class="id">loc_id</span> <span class="id">r2</span>) <span class="id">H</span> <span class="id">=&gt;</span> <span class="id">[/eqP|]</span> <span class="id">Hr</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">MS_bindE</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">{2}/cput</span> <span class="id">-Hr</span> <span class="id">Hr1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case/boolP:</span> (<span class="id">T1</span> <span class="id">==</span> <span class="id">T2</span>) <span class="id">=&gt;</span> <span class="id">[/eqP</span> <span class="id">HT|HT];</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">coerce_None//;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">eq_sym</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/cput/=</span> <span class="id">Hr</span> <span class="id">nth_error_set_nth//</span> <span class="id">coerce_None//</span> <span class="id">eq_sym</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">T2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">coerce_Some</span> <span class="id">bindE/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">?</span> <span class="id">:=</span> <span class="id">JMeq_eq</span> <span class="id">H;</span> <span class="id">subst</span> <span class="id">s2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/cput</span> <span class="id">-Hr</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">move=&gt;</span> <span class="id">_</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">[v</span> <span class="id">r2v|T2'</span> <span class="id">s</span> <span class="id">Hr2</span> <span class="id">T2s|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">*</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cput/=;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">nth_error_set_nth_none</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr2</span> <span class="id">Hr1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">None_cput</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">*</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]</span>(<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T2s</span>)<span class="id">//</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T2s</span>)<span class="id">//=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">nth_error_set_nth_other</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr2</span>) <span class="id">1?eq_sym</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">*</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]</span>(<span class="id">Some_cputE</span> <span class="id">_</span> <span class="id">r2v</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">{1}/cput/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">nth_error_set_nth_other</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">r2v</span>) <span class="id">1?eq_sym//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">coerce_Some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindE/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">/cput</span> (<span class="id">nth_error_set_nth_other</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr</span> <span class="id">Hr1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">coerce_Some</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">set_set_nth</span> (<span class="id">negbTE</span> <span class="id">Hr</span>).<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cputgetC</span> <span class="id">T1</span> <span class="id">T2</span> (<span class="id">r1</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T1</span>) (<span class="id">r2</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T2</span>) (<span class="id">s1</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T2</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">loc_id</span> <span class="id">r1</span> <span class="id">!=</span> <span class="id">loc_id</span> <span class="id">r2</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">cput</span> <span class="id">r1</span> <span class="id">s1</span> <span class="id">&gt;&gt;</span> <span class="id">cget</span> <span class="id">r2</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span> <span class="id">cget</span> <span class="id">r2</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">cput</span> <span class="id">r1</span> <span class="id">s1</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">v</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof215')">Proof.</span></div>
<div class="proofscript" id="proof215">
<span class="id">move=&gt;</span> <span class="id">Hr;</span> <span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">!bindA</span>.<br/>
<span class="id">have</span> <span class="id">[u</span> <span class="id">Hr1|T1'</span> <span class="id">s1'</span> <span class="id">Hr1</span> <span class="id">T1s'|Hr1]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r1</span>.<br/>
<span class="id">-</span> <span class="id">have</span> <span class="id">[v</span> <span class="id">Hr2|T'</span> <span class="id">s'</span> <span class="id">Hr2</span> <span class="id">T2s'|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]MS_bindE</span> <span class="id">[in</span> <span class="id">RHS]MS_bindE</span> <span class="id">/cput</span> <span class="id">Hr1</span> <span class="id">coerce_Some</span> <span class="id">!bindretf/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">/cget</span> (<span class="id">nth_error_set_nth_other</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr2</span>) <span class="id">1?eq_sym//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">coerce_Some</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">rewrite</span> <span class="id">[RHS]MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">_</span> <span class="id">T2s'</span>)<span class="id">//</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!MS_bindE</span> <span class="id">/cput</span> <span class="id">Hr1</span> <span class="id">coerce_Some</span> <span class="id">bindretf//=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">/cget/=</span> (<span class="id">nth_error_set_nth_other</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr2</span>) <span class="id">1?eq_sym//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">not_coercible</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]MS_bindE</span> <span class="id">None_cget//</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">/cput</span> <span class="id">Hr1</span> <span class="id">coerce_Some</span> <span class="id">bindretf/=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">/cget</span> (<span class="id">nth_error_set_nth_none</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr2</span> <span class="id">Hr1</span>).<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T1s'</span>)<span class="id">//</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[v</span> <span class="id">Hr2|T'</span> <span class="id">s'</span> <span class="id">Hr2</span> <span class="id">T2s'|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr2</span>) <span class="id">MS_bindE</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T1s'</span>).<br/>
&nbsp;&nbsp;<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">_</span> <span class="id">T2s'</span>).<br/>
&nbsp;&nbsp;<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cget</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">MS_bindE</span> <span class="id">None_cput//</span> <span class="id">bindfailf</span> <span class="id">MS_bindE</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[v</span> <span class="id">Hr2|T'</span> <span class="id">s'</span> <span class="id">Hr2</span> <span class="id">T2s'|Hr2]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r2</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/cget</span> <span class="id">Hr2</span> <span class="id">coerce_Some</span> <span class="id">bindretf//=</span> <span class="id">MS_bindE</span> <span class="id">None_cput</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">nocoerce_cget</span> <span class="id">Hr2</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">None_cget</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">cputnewC</span> <span class="id">T</span> <span class="id">T'</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T</span>) (<span class="id">s'</span> <span class="id">:</span> <span class="id">coq_type</span> <span class="id">T'</span>) <span class="id">A</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">T'</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">cget</span> <span class="id">r</span> <span class="id">&gt;&gt;</span> (<span class="id">cnew</span> <span class="id">s'</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">r'</span> <span class="id">=&gt;</span> <span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">r'</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">cput</span> <span class="id">r</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> (<span class="id">cnew</span> <span class="id">s'</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof216')">Proof.</span></div>
<div class="proofscript" id="proof216">
<span class="id">apply/boolp</span>.<span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">e</span> <span class="id">/=</span>.<br/>
<span class="id">have</span> <span class="id">[u</span> <span class="id">Hr|T1</span> <span class="id">s1'</span> <span class="id">Hr</span> <span class="id">T1s'|Hr]</span> <span class="id">:=</span> <span class="id">ntherrorP</span> <span class="id">e</span> <span class="id">r</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> (<span class="id">Some_cget</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[RHS]MS_bindE</span> <span class="id">[in</span> <span class="id">RHS]/cput</span> <span class="id">Hr</span> <span class="id">coerce_Some</span> <span class="id">bindretf/=</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!MS_bindE</span> <span class="id">/cnew</span> <span class="id">!bindretf/=</span> <span class="id">!MS_bindE</span> <span class="id">/cput</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">nth_error_rcons_some</span> <span class="id">_</span> <span class="id">Hr</span>) <span class="id">coerce_Some</span> <span class="id">bindretf/=</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">nth_error_size_set_nth</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr</span>) (<span class="id">nth_error_set_nth_rcons</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hr</span>).<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">2!MS_bindE</span> (<span class="id">nocoerce_cget</span> <span class="id">_</span> <span class="id">T1s'</span>)<span class="id">//</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">nocoerce_cput</span> <span class="id">_</span> <span class="id">_</span> <span class="id">T1s'</span>).<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!MS_bindE</span> <span class="id">None_cget//</span> <span class="id">bindfailf</span> <span class="id">None_cput</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">crunret</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">crun</span> <span class="id">m</span> <span class="id">-&gt;</span> <span class="id">crun</span> (<span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">Some</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof217')">Proof.</span></div>
<div class="proofscript" id="proof217">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/crun</span> <span class="id">/=</span> <span class="id">MS_bindE/=;</span> <span class="id">case:</span> (<span class="id">m</span> <span class="id">[::]</span>) <span class="id">=&gt;</span> <span class="id">//-</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">crunskip</span> <span class="id">:</span> <span class="id">crun</span> <span class="id">skip</span> <span class="id">=</span> <span class="id">Some</span> <span class="id">tt</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof218')">Proof.</span></div>
<div class="proofscript" id="proof218">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">crunnew</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">T</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">crun</span> <span class="id">m</span> <span class="id">-&gt;</span> <span class="id">crun</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">cnew</span> (<span class="id">s</span> <span class="id">x</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof219')">Proof.</span></div>
<div class="proofscript" id="proof219">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/crun</span> <span class="id">/=</span> <span class="id">MS_bindE;</span> <span class="id">case:</span> (<span class="id">m</span> <span class="id">[::]</span>) <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">-[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">crunnewgetC</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">T1</span> <span class="id">T2</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">r</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">loc</span> <span class="id">T1</span>)<br/>
&nbsp;&nbsp;(<span class="id">s</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">coq_type</span> <span class="id">T2</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">crun</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">cget</span> (<span class="id">r</span> <span class="id">x</span>)) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">crun</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">cnew</span> (<span class="id">s</span> <span class="id">x</span>) <span class="id">&gt;&gt;</span> <span class="id">cget</span> (<span class="id">r</span> <span class="id">x</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof220')">Proof.</span></div>
<div class="proofscript" id="proof220">
<span class="id">rewrite</span> <span class="id">/crun</span> <span class="id">/=</span> <span class="id">!bindE</span> <span class="id">/=</span> <span class="id">/bindS</span> <span class="id">!MS_mapE</span> <span class="id">/=</span> <span class="id">!fmapE</span> <span class="id">/=</span> <span class="id">!bindA</span> <span class="id">/=</span>.<br/>
<span class="id">case</span> <span class="id">Hm:</span> (<span class="id">m</span> <span class="id">[::]</span>) <span class="id">=&gt;</span> <span class="id">[|[a</span> <span class="id">b]]</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/=</span> <span class="id">!bindE</span> <span class="id">/=</span> <span class="id">/bindS</span> <span class="id">MS_mapE</span> <span class="id">/=</span> <span class="id">fmapE</span> <span class="id">/=</span> <span class="id">bindA</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/=</span> <span class="id">!bindE</span> <span class="id">/=</span> <span class="id">/cget</span>.<br/>
<span class="id">case</span> <span class="id">Hnth:</span> <span class="id">nth_error</span> <span class="id">=&gt;</span> <span class="id">[[]|]</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> (<span class="id">nth_error_rcons_some</span> <span class="id">_</span> <span class="id">Hnth</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">case</span> <span class="id">Hcoe:</span> <span class="id">coerce</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">crungetput</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">T</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">r</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">loc</span> <span class="id">T</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">coq_type</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">crun</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">cget</span> (<span class="id">r</span> <span class="id">x</span>)) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">crun</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">cput</span> (<span class="id">r</span> <span class="id">x</span>) (<span class="id">s</span> <span class="id">x</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof221')">Proof.</span></div>
<div class="proofscript" id="proof221">
<span class="id">rewrite</span> <span class="id">/crun</span> <span class="id">/=</span> <span class="id">!bindE</span> <span class="id">/=</span> <span class="id">/bindS</span> <span class="id">!MS_mapE</span> <span class="id">/=</span> <span class="id">!fmapE</span> <span class="id">/=</span> <span class="id">!bindA</span> <span class="id">/=</span>.<br/>
<span class="id">case</span> <span class="id">Hm:</span> (<span class="id">m</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="id">[|[a</span> <span class="id">b]]</span> <span class="id">//=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindE</span> <span class="id">/=</span> <span class="id">!bindE</span> <span class="id">/=</span> <span class="id">/cget</span> <span class="id">/cput</span> <span class="id">/=</span>.<br/>
<span class="id">case</span> <span class="id">Hnth:</span> <span class="id">nth_error</span> <span class="id">=&gt;</span> <span class="id">[[T'</span> <span class="id">v]|]</span> <span class="id">//</span>.<br/>
<span class="id">case:</span> (<span class="id">eqVneq</span> <span class="id">T'</span> <span class="id">T</span>) <span class="id">=&gt;</span> <span class="id">T'T;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">coerce_None//</span> <span class="id">1?eq_sym//</span> <span class="id">coerce_None</span>.<br/>
<span class="id">subst</span> <span class="id">T'</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!coerce_Some</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">crunmskip</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">crun</span> (<span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">skip</span>) <span class="id">=</span> <span class="id">crun</span> <span class="id">m</span> <span class="id">:&gt;</span> <span class="id">bool</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof222')">Proof.</span></div>
<div class="proofscript" id="proof222">
<span class="id">rewrite</span> <span class="id">/crun</span> <span class="id">/=</span> <span class="id">!bindE</span> <span class="id">/=</span> <span class="id">/bindS</span> <span class="id">!MS_mapE</span> <span class="id">/=</span> <span class="id">!fmapE</span> <span class="id">/=</span> <span class="id">!bindA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case</span> <span class="id">Hm:</span> (<span class="id">m</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="id">[|[]]</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">Monad.on</span> <span class="id">M</span>.<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">isMonadTypedStoreModel</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonadTypedStore.Build</span> <span class="id">ml_type</span> <span class="id">N</span> <span class="id">locT_nat</span> <span class="id">M</span> <span class="id">cnewget</span> <span class="id">cnewput</span> <span class="id">cgetput</span> <span class="id">cgetputskip</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cgetget</span> <span class="id">cputget</span> <span class="id">cputput</span> <span class="id">cgetC</span> <span class="id">cgetnewD</span> <span class="id">cgetnewE</span> <span class="id">cgetputC</span> <span class="id">cputC</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cputgetC</span> <span class="id">cputnewC</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">crunret</span> <span class="id">crunskip</span> <span class="id">crunnew</span> <span class="id">crunnewgetC</span> <span class="id">crungetput</span> <span class="id">crunmskip</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">mkbind</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelTypedStore</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelTypedStore</span>.<br/>
<br/>
<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">monad_transformer_calcul</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">contTi</span> <span class="id">T</span> <span class="id">:=</span> <span class="id">MC</span> <span class="id">T</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">idfun]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">break_if_none</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">break</span> <span class="id">:</span> <span class="id">_</span>) (<span class="id">acc</span> <span class="id">:</span> <span class="id">nat</span>) (<span class="id">x</span> <span class="id">:</span> <span class="id">option</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">m</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">is</span> <span class="id">Some</span> <span class="id">x</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">+</span> <span class="id">acc</span>) <span class="gallina-kwd">else</span> <span class="id">break</span> <span class="id">acc</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">sum_until_none</span> (<span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> (<span class="id">option</span> <span class="id">nat</span>)) <span class="id">:</span> <span class="id">contTi</span> <span class="id">nat</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">break</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">contTi</span> <span class="id">nat</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">foldM</span> (<span class="id">break_if_none</span> <span class="id">break</span>) <span class="id">0</span> <span class="id">xs</span>).<br/>
<br/>
<span class="vernacular">Goal</span> <span class="id">sum_until_none</span> <span class="id">[::</span> <span class="id">Some</span> <span class="id">2;</span> <span class="id">Some</span> <span class="id">6;</span> <span class="id">None;</span> <span class="id">Some</span> <span class="id">4]</span> <span class="id">=</span> <span class="id">@^~</span> <span class="id">8</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">cbv</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">calcul</span> <span class="id">:</span> <span class="id">contTi</span> <span class="id">nat</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;(<span class="id">_</span> <span class="id">#</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">8</span> <span class="id">+</span> <span class="id">x</span>))<br/>
&nbsp;&nbsp;(<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">contTi</span> <span class="id">nat</span> <span class="id">_</span> <span class="id">=&gt;</span> (<span class="id">k</span> <span class="id">5</span>) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">y</span> <span class="id">+</span> <span class="id">4</span>)))).<br/>
<br/>
<span class="vernacular">Goal</span> <span class="id">calcul</span> <span class="id">=</span> <span class="id">@^~</span> <span class="id">13</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">cbv</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">End</span> <span class="id">monad_transformer_calcul</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">examples_of_algebraic_lifting</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">state_exceptT</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">S</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">StateMonad.acto</span> <span class="id">S]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">aLGet</span> <span class="id">{Z</span> <span class="id">S}</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S]</span>.<span class="id">-aoperation</span> (<span class="id">exceptT</span> <span class="id">Z</span> (<span class="id">M</span> <span class="id">S</span>)) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">alifting</span> (<span class="id">get_aop</span> <span class="id">S</span>) (<span class="id">Lift</span> <span class="id">_</span> (<span class="id">M</span> <span class="id">S</span>)).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">aLPut</span> <span class="id">{Z</span> <span class="id">S}</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S]</span>.<span class="id">-operation</span> (<span class="id">exceptT</span> <span class="id">Z</span> (<span class="id">M</span> <span class="id">S</span>)) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">alifting</span> (<span class="id">put_aop</span> <span class="id">S</span>) (<span class="id">Lift</span> <span class="id">_</span> (<span class="id">M</span> <span class="id">S</span>)).<br/>
<br/>
<span class="vernacular">Goal</span> <span class="gallina-kwd">forall</span> <span class="id">Z</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">X</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">exceptT</span> <span class="id">Z</span> (<span class="id">M</span> <span class="id">S</span>) <span class="id">X</span>)<span class="id">,</span> <span class="id">aLGet</span> <span class="id">_</span> <span class="id">k</span> <span class="id">=</span> <span class="id">get_op</span> <span class="id">_</span> <span class="id">k</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof223')">Proof.</span></div>
<div class="proofscript" id="proof223">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">Z</span> <span class="id">S</span> <span class="id">X</span> <span class="id">k;</span> <span class="id">rewrite</span> <span class="id">/aLGet</span> <span class="id">aliftingE</span>. Qed.</div>
<br/>
<span class="vernacular">Goal</span> <span class="gallina-kwd">forall</span> <span class="id">Z</span> <span class="id">S,</span> <span class="id">aLGet</span> <span class="id">_</span> <span class="id">Ret</span> <span class="id">=</span> <span class="id">Lift</span> <span class="id">[the</span> <span class="id">monadT</span> <span class="id">of</span> <span class="id">exceptT</span> <span class="id">Z]</span> (<span class="id">M</span> <span class="id">S</span>) <span class="id">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">@get</span> <span class="id">S</span> <span class="id">[the</span> <span class="id">stateMonad</span> <span class="id">S</span> <span class="id">of</span> <span class="id">StateMonad.acto</span> <span class="id">S]</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof224')">Proof.</span></div>
<div class="proofscript" id="proof224">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">Z</span> <span class="id">S;</span> <span class="id">rewrite</span> <span class="id">/aLGet</span> <span class="id">aliftingE</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">state_exceptT</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">continuation_stateT</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">r</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">monad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">ContMonad.acto</span> <span class="id">r]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">aLCallcc</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r]</span>.<span class="id">-aoperation</span> (<span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">alifting</span> (<span class="id">callcc_aop</span> <span class="id">r</span>) (<span class="id">Lift</span> <span class="id">_</span> <span class="id">M</span>).<br/>
<br/>
<span class="vernacular">Goal</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> (<span class="id">f</span> <span class="id">:</span> (<span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;<span class="id">aLCallcc</span> <span class="id">_</span> <span class="id">f</span> <span class="id">=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">uncurry</span> <span class="id">m</span> (<span class="id">s,</span> <span class="id">k</span>)) <span class="id">s</span> <span class="id">k</span>) <span class="id">:&gt;</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof225')">Proof.</span></div>
<div class="proofscript" id="proof225">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/aLCallcc</span> <span class="id">aliftingE</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">usual_callccS</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">_</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> (<span class="id">x,</span> <span class="id">s</span>)) <span class="id">s</span> <span class="id">k</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">callccS_E</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">:</span> <span class="id">@aLCallcc</span> <span class="id">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> (<span class="gallina-kwd">fun</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">S</span>) (<span class="id">_</span> <span class="id">:</span> <span class="id">B</span> <span class="id">*</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">=&gt;</span> <span class="id">k</span> (<span class="id">Ret</span> <span class="id">x</span>)) <span class="id">:</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">B</span>)) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">usual_callccS</span> <span class="id">f</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof226')">Proof.</span></div>
<div class="proofscript" id="proof226">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aLCallcc</span> <span class="id">aliftingE</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">continuation_stateT</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">examples_of_algebraic_lifting</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelMonadStateRun</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelmonadstaterun</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span> <span class="id">:=</span> <span class="id">option_monad</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">M</span> <span class="id">:</span> <span class="id">stateMonad</span> <span class="id">S</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">stateMonad</span> <span class="id">S</span> <span class="id">of</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">N]</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">runStateT</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">N</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)<span class="id">%type</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">id</span>.<br/>
<span class="vernacular">Let</span> <span class="id">runStateTret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>)<span class="id">,</span> <span class="id">@runStateT</span> <span class="id">_</span> (<span class="id">Ret</span> <span class="id">a</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">a,</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof227')">Proof.</span></div>
<div class="proofscript" id="proof227">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">runStateTbind</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;<span class="id">@runStateT</span> <span class="id">_</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">@runStateT</span> <span class="id">_</span> <span class="id">m</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">@runStateT</span> <span class="id">_</span> (<span class="id">f</span> <span class="id">x</span>.<span class="id">1</span>) <span class="id">x</span>.<span class="id">2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof228')">Proof.</span></div>
<div class="proofscript" id="proof228">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">M</span> <span class="id">m</span> <span class="id">f</span> <span class="id">s</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">/runStateT</span> <span class="id">bindE</span> <span class="id">/=</span> <span class="id">/join_of_bind</span> <span class="id">/bindS</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">MS_mapE</span> <span class="id">/actm</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case:</span> (<span class="id">m</span> <span class="id">s</span>).<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">runStateTget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">:</span> <span class="id">S,</span> <span class="id">runStateT</span> <span class="id">get</span> <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">s,</span> <span class="id">s</span>) <span class="id">:&gt;</span> <span class="id">N</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof229')">Proof.</span></div>
<div class="proofscript" id="proof229">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">runStateTput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s'</span> <span class="id">s</span> <span class="id">:</span> <span class="id">S,</span> <span class="id">@runStateT</span> <span class="id">_</span> (<span class="id">put</span> <span class="id">s'</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">tt,</span> <span class="id">s'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof230')">Proof.</span></div>
<div class="proofscript" id="proof230">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonadStateRun.Build</span> <span class="id">S</span> <span class="id">N</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">N</span>)<br/>
&nbsp;&nbsp;<span class="id">runStateTret</span><br/>
&nbsp;&nbsp;<span class="id">runStateTbind</span><br/>
&nbsp;&nbsp;<span class="id">runStateTget</span><br/>
&nbsp;&nbsp;<span class="id">runStateTput</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">modelmonadstaterun</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelMonadStateRun</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelMonadStateRun</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelMonadExceptStateRun</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelmonadexceptstaterun</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">N</span> <span class="id">:</span> <span class="id">exceptMonad</span> <span class="id">:=</span> <span class="id">option_monad</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">M</span> <span class="id">:</span> <span class="id">stateRunMonad</span> <span class="id">S</span> <span class="id">N</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">stateRunMonad</span> <span class="id">S</span> <span class="id">N</span> <span class="id">of</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">N]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">failure</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">N</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">liftS</span> (<span class="id">@fail</span> <span class="id">N</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Bindfailf</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> (<span class="id">@bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">N]</span>) <span class="id">failure</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof231')">Proof.</span></div>
<div class="proofscript" id="proof231">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadFail</span>.<span class="id">Build</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">N</span>) <span class="id">failure</span> <span class="id">Bindfailf</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Catch</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">mapStateT2</span> (<span class="id">@catch</span> <span class="id">N</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)<span class="id">%type</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Catchmfail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">right_id</span> (<span class="id">liftS</span> (<span class="id">@fail</span> <span class="id">N</span> <span class="id">A</span>)) (<span class="id">@Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof232')">Proof.</span></div>
<div class="proofscript" id="proof232">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/mapStateT2;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">catchmfail</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">Catchfailm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">left_id</span> (<span class="id">liftS</span> (<span class="id">@fail</span> <span class="id">N</span> <span class="id">A</span>)) (<span class="id">@Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof233')">Proof.</span></div>
<div class="proofscript" id="proof233">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/mapStateT2;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">catchfailm</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">CatchA</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">ssrfun.associative</span> (<span class="id">@Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof234')">Proof.</span></div>
<div class="proofscript" id="proof234">
<span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/mapStateT2</span> <span class="id">=&gt;</span> <span class="id">a</span> <span class="id">b</span> <span class="id">c;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">catchA</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">Catchret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">x,</span> <span class="id">@left_zero</span> (<span class="id">M</span> <span class="id">A</span>) (<span class="id">M</span> <span class="id">A</span>) (<span class="id">Ret</span> <span class="id">x</span>) (<span class="id">@Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof235')">Proof.</span></div>
<div class="proofscript" id="proof235">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">x</span> <span class="id">y;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/mapStateT2;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">catchret</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">@isMonadExcept</span>.<span class="id">Build</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">N</span>) <span class="id">Catch</span> <span class="id">Catchmfail</span> <span class="id">Catchfailm</span> <span class="id">CatchA</span> <span class="id">Catchret</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">RunStateTfail</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">runStateT</span> (<span class="id">@fail</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">N</span>)<span class="id">]</span> <span class="id">A</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">@fail</span> <span class="id">N</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof236')">Proof.</span></div>
<div class="proofscript" id="proof236">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">RunStateTcatch</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">_</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">runStateT</span> (<span class="id">Catch</span> <span class="id">m1</span> <span class="id">m2</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">catch</span> (<span class="id">runStateT</span> <span class="id">m1</span> <span class="id">s</span>) (<span class="id">runStateT</span> <span class="id">m2</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof237')">Proof.</span></div>
<div class="proofscript" id="proof237">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isMonadExceptStateRun</span>.<span class="id">Build</span> <span class="id">S</span> <span class="id">N</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">N</span>)<br/>
&nbsp;&nbsp;<span class="id">RunStateTfail</span> <span class="id">RunStateTcatch</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">modelmonadexceptstaterun</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelMonadExceptStateRun</span>.<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/yoshihiro503/coq2html/">a fork of coq2html</a></div>
</body>
</html>

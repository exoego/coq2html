
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module example_iquicksort</title>
<meta name="description" content="Documentation of Coq module example_iquicksort" />
<link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath/texmath.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="init('proofscript')">
<h1 class="title">Module example_iquicksort</h1>
<div class="coq">
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">all_ssreflect</span>.<br/>
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="id">boolp</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">monae_lib</span> <span class="id">hierarchy</span> <span class="id">monad_lib</span> <span class="id">fail_lib</span> <span class="id">state_lib</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">array_lib</span> <span class="id">example_quicksort</span>.<br/>
<span class="vernacular">From</span> <span class="id">infotheo</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">ssr_ext</span>.<br/>
<br/>
<pre class="ssrdoc">
                     Quicksort with the Array Monad                        
                                                                           
   partl p (s, t) u == partition u into (x, y) w.r.t. pivot p and returns  
                       (s ++ x, t ++ y)                                    
           dispatch == if x &lt;= p then qperm zs &gt;&gt;= f (rcons ys x)          
                       else qperm (rcons zs x) &gt;&gt;= f ys                    
qperm_partl p s t u == fusion of qperm and partl; this is a computation    
                       of type M (seq E * seq E * seq E) where E is the    
                       type of the values in the array monad               
ipartl p i ny nz nx == partition the array stored at i w.r.t. the pivot p, 
                       the array is yz ++ zs ++ xs where the lengths of    
                       yz, zs, xs are resp. ny, nz, nx; it returns the     
                       lengths of the partitions this is a computation of  
                       of type M (nat * nat)                               
  dipartl p i y z x == same as ipartl except that it returns a dependent   
                       pair of type                                        
                       {(a, b)| a &lt;= x + y + z &amp;&amp; b &lt;= x + y +z}           
      iqsort (i, n) == quicksort the list of size n stored from address i  
                                                                           
                                                                           
Reference:                                                                 
- [1] Shin-Cheng Mu, Tsung-Ju Chiang, Declarative Pearl: Deriving Monadic  
      Quicksort, FLOPS 2020                                                
</pre>
<br/>
<span class="gallina-kwd">Set</span> <span class="vernacular">Implicit</span> <span class="vernacular">Arguments</span>.<br/>
<span class="id">Unset</span> <span class="id">Strict</span> <span class="vernacular">Implicit</span>.<br/>
<span class="id">Unset</span> <span class="id">Printing</span> <span class="vernacular">Implicit</span> <span class="id">Defensive</span>.<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">order_scope</span>.<br/>
<span class="vernacular">Import</span> <span class="id">Order.Theory</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">monae_scope</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">tuple_ext_scope</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">partl</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">E</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">plusArrayMonad</span> <span class="id">E</span> <span class="id">nat_eqType</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">p</span> <span class="id">:</span> <span class="id">E</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">partl</span> <span class="id">p</span> (<span class="id">s</span> <span class="id">:</span> (<span class="id">seq</span> <span class="id">E</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">E</span>)<span class="id">%type</span>) (<span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">E</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">:</span> (<span class="id">seq</span> <span class="id">E</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">E</span>)<span class="id">%type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">xs</span> <span class="id">is</span> <span class="id">x</span> <span class="id">::</span> <span class="id">xs</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">&lt;=</span> <span class="id">p</span> <span class="gallina-kwd">then</span> <span class="id">partl</span> <span class="id">p</span> (<span class="id">rcons</span> <span class="id">s</span>.<span class="id">1</span> <span class="id">x,</span> <span class="id">s</span>.<span class="id">2</span>) <span class="id">xs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">partl</span> <span class="id">p</span> (<span class="id">s</span>.<span class="id">1,</span> <span class="id">rcons</span> <span class="id">s</span>.<span class="id">2</span> <span class="id">x</span>) <span class="id">xs</span>)<br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">s</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">partlE</span> <span class="id">s</span> <span class="id">t</span> <span class="id">p</span> <span class="id">u</span> <span class="id">:</span> <span class="gallina-kwd">let</span> <span class="id">x</span> <span class="id">:=</span> <span class="id">partition</span> <span class="id">p</span> <span class="id">u</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">partl</span> <span class="id">p</span> (<span class="id">s,</span> <span class="id">t</span>) <span class="id">u</span> <span class="id">=</span> (<span class="id">s</span> <span class="id">++</span> <span class="id">x</span>.<span class="id">1,</span> <span class="id">t</span> <span class="id">++</span> <span class="id">x</span>.<span class="id">2</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof1')">Proof.</span></div>
<div class="proofscript" id="proof1">
<span class="id">elim:</span> <span class="id">u</span> <span class="id">p</span> <span class="id">s</span> <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">tl</span> <span class="id">ih]</span> <span class="id">/=</span> <span class="id">p</span> <span class="id">a</span> <span class="id">b;</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!cats0</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">hp;</span> <span class="id">rewrite</span> <span class="id">ih</span> <span class="id">/=</span> <span class="id">-cats1</span> <span class="id">/=</span> <span class="id">-catA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">partition_partl</span> <span class="id">p</span> <span class="id">xs</span> <span class="id">:</span> <span class="id">partition</span> <span class="id">p</span> <span class="id">xs</span> <span class="id">=</span> <span class="id">partl</span> <span class="id">p</span> (<span class="id">[::],</span> <span class="id">[::]</span>) <span class="id">xs</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof2')">Proof.</span></div>
<div class="proofscript" id="proof2">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">partlE</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">partition</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">partl</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">dispatch</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">E</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">plusArrayMonad</span> <span class="id">E</span> <span class="id">nat_eqType</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">i</span> <span class="id">:</span> <span class="id">nat</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">dispatch</span> (<span class="id">x</span> <span class="id">p</span> <span class="id">:</span> <span class="id">E</span>) <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">A</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">E</span> <span class="id">-&gt;</span> <span class="id">seq</span> <span class="id">E</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">&lt;=</span> <span class="id">p</span> <span class="gallina-kwd">then</span> <span class="id">qperm</span> <span class="id">zs</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> (<span class="id">rcons</span> <span class="id">ys</span> <span class="id">x</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">qperm</span> (<span class="id">rcons</span> <span class="id">zs</span> <span class="id">x</span>) <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">ys</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">dispatch_Ret</span> (<span class="id">x</span> <span class="id">p</span> <span class="id">:</span> <span class="id">E</span>) <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs,</span> <span class="id">xs</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">E</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">E</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">E</span>)<span class="id">%type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">dispatch</span> <span class="id">x</span> <span class="id">p</span> (<span class="id">ys,</span> <span class="id">zs</span>) (<span class="gallina-kwd">fun</span> <span class="id">ys'</span> <span class="id">zs'</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">ys',</span> <span class="id">zs',</span> <span class="id">xs</span>)).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">dispatch_Ret_isNondet</span> <span class="id">x</span> <span class="id">p</span> <span class="id">yszsxs</span> <span class="id">:</span> <span class="id">plus_isNondet</span> (<span class="id">dispatch_Ret</span> <span class="id">x</span> <span class="id">p</span> <span class="id">yszsxs</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof3')">Proof.</span></div>
<div class="proofscript" id="proof3">
<span class="id">rewrite</span> <span class="id">/dispatch/=;</span> <span class="id">move:</span> <span class="id">yszsxs</span> <span class="id">=&gt;</span> <span class="id">[[ys</span> <span class="id">zs]</span> <span class="id">xs]/=;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">xp</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[syn</span> <span class="id">syn_qperm]</span> <span class="id">:=</span> <span class="id">@qperm_isNondet</span> <span class="id">M</span> <span class="id">_</span> <span class="id">zs</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="id">ndBind</span> <span class="id">syn</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">ndRet</span> (<span class="id">rcons</span> <span class="id">ys</span> <span class="id">x,</span> <span class="id">s,</span> <span class="id">xs</span>))).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">syn_qperm</span>.<br/>
<span class="id">have</span> <span class="id">[syn</span> <span class="id">syn_qperm]</span> <span class="id">:=</span> <span class="id">@qperm_isNondet</span> <span class="id">M</span> <span class="id">_</span> (<span class="id">rcons</span> <span class="id">zs</span> <span class="id">x</span>).<br/>
<span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> (<span class="id">ndBind</span> <span class="id">syn</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">ndRet</span> (<span class="id">ys,</span> <span class="id">s,</span> <span class="id">xs</span>)))<span class="id">;</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">syn_qperm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">dispatch</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">dispatch_Ret</span> <span class="id">{d</span> <span class="id">E</span> <span class="id">M}</span>.<br/>
<br/>
<span class="id">#[global]</span> <span class="vernacular">Hint</span> <span class="id">Extern</span> <span class="id">0</span> (<span class="id">plus_isNondet</span> (<span class="id">dispatch_Ret</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>)) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">solve[exact:</span> <span class="id">dispatch_Ret_isNondet]</span> <span class="id">:</span> <span class="id">core</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">qperm_partl</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">E</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">plusArrayMonad</span> <span class="id">E</span> <span class="id">nat_eqType</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">p</span> <span class="id">:</span> <span class="id">E</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">qperm_partl</span> <span class="id">p</span> (<span class="id">ys</span> <span class="id">zs</span> <span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">E</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">E</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">E</span>)<span class="id">%type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">xs</span> <span class="id">is</span> <span class="id">x</span> <span class="id">::</span> <span class="id">xs</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dispatch</span> <span class="id">x</span> <span class="id">p</span> (<span class="id">ys,</span> <span class="id">zs</span>) (<span class="gallina-kwd">fun</span> <span class="id">ys'</span> <span class="id">zs'</span> <span class="id">=&gt;</span> <span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">ys'</span> <span class="id">zs'</span> <span class="id">xs</span>)<br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">Ret</span> (<span class="id">ys,</span> <span class="id">zs</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_partl_isNondet</span> <span class="id">p</span> (<span class="id">s</span> <span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">E</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">plus_isNondet</span> (<span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">a</span> <span class="id">b</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof4')">Proof.</span></div>
<div class="proofscript" id="proof4">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">p</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[p</span> <span class="id">a</span> <span class="id">b|h</span> <span class="id">t</span> <span class="id">ih</span> <span class="id">p</span> <span class="id">a</span> <span class="id">b</span> <span class="id">/=];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> (<span class="id">ndRet</span> (<span class="id">a,</span> <span class="id">b</span>)).<br/>
<span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">hp</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[syn</span> <span class="id">synE]</span> <span class="id">:=</span> <span class="id">@qperm_isNondet</span> <span class="id">M</span> <span class="id">_</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="id">ndBind</span> <span class="id">syn</span> (<span class="gallina-kwd">fun</span> <span class="id">zs'</span> <span class="id">=&gt;</span> <span class="id">sval</span> (<span class="id">ih</span> <span class="id">p</span> (<span class="id">rcons</span> <span class="id">a</span> <span class="id">h</span>) <span class="id">zs'</span>))) <span class="id">=&gt;</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">synE</span> <span class="id">/=;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span>  <span class="id">?</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">ih</span>.<br/>
<span class="id">have</span> <span class="id">[syn</span> <span class="id">synE]</span> <span class="id">:=</span> <span class="id">@qperm_isNondet</span> <span class="id">M</span> <span class="id">_</span> (<span class="id">rcons</span> <span class="id">b</span> <span class="id">h</span>).<br/>
<span class="gallina-kwd">exists</span> (<span class="id">ndBind</span> <span class="id">syn</span> (<span class="gallina-kwd">fun</span> <span class="id">zs'</span> <span class="id">=&gt;</span> <span class="id">sval</span> (<span class="id">ih</span> <span class="id">p</span> <span class="id">a</span> <span class="id">zs'</span>))) <span class="id">=&gt;</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">synE</span> <span class="id">/=;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">?</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">ih</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_partl_cons</span> (<span class="id">p</span> <span class="id">x</span> <span class="id">:</span> <span class="id">E</span>) (<span class="id">ys</span> <span class="id">zs</span> <span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">E</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">ys</span> <span class="id">zs</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">xs</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">dispatch_Ret</span> <span class="id">x</span> <span class="id">p</span> (<span class="id">ys,</span> <span class="id">zs,</span> <span class="id">xs</span>) <span class="id">&gt;&gt;=</span> <span class="id">uncurry3</span> (<span class="id">qperm_partl</span> <span class="id">p</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof5')">Proof.</span></div>
<div class="proofscript" id="proof5">
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">xp;</span> <span class="id">rewrite</span> <span class="id">bindA;</span><br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">[RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">qperm_partl</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">qperm_partl</span> <span class="id">{d</span> <span class="id">E</span> <span class="id">M}</span>.<br/>
<br/>
<span class="id">#[global]</span> <span class="vernacular">Hint</span> <span class="id">Extern</span> <span class="id">0</span> (<span class="id">plus_isNondet</span> (<span class="id">qperm_partl</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>)) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">solve[exact:</span> <span class="id">qperm_partl_isNondet]</span> <span class="id">:</span> <span class="id">core</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">ipartl</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">T</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">arrayMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">arrayMonad</span> <span class="id">T</span> <span class="id">nat_eqType</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> <span class="id">ny</span> <span class="id">nz</span> <span class="id">nx</span> <span class="id">:</span> <span class="id">M</span> (<span class="id">nat</span> <span class="id">*</span> <span class="id">nat</span>)<span class="id">%type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">nx</span> <span class="id">is</span> <span class="id">k</span>.<span class="id">+1</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aget</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">ny</span> <span class="id">+</span> <span class="id">nz</span>)) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">&lt;=</span> <span class="id">p</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aswap</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">ny</span>) (<span class="id">i</span> <span class="id">+</span> <span class="id">ny</span> <span class="id">+</span> <span class="id">nz</span>) <span class="id">&gt;&gt;</span> <span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> <span class="id">ny</span>.<span class="id">+1</span> <span class="id">nz</span> <span class="id">k</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> <span class="id">ny</span> <span class="id">nz</span>.<span class="id">+1</span> <span class="id">k</span>)<br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">Ret</span> (<span class="id">ny,</span> <span class="id">nz</span>).<br/>
<br/>
<span class="vernacular">End</span> <span class="id">arrayMonad</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">ipartl</span> <span class="id">{M}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">plusArrayMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">plusArrayMonad</span> <span class="id">T</span> <span class="id">nat_eqType</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">ipartl_guard</span> <span class="id">p</span> <span class="id">i</span> <span class="id">ny</span> <span class="id">nz</span> <span class="id">nx</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">ipartl</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) <span class="id">p</span> <span class="id">i</span> <span class="id">ny</span> <span class="id">nz</span> <span class="id">nx</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> <span class="id">ny</span> <span class="id">nz</span> <span class="id">nx</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">a,</span> <span class="id">b</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">guard</span> ((<span class="id">a</span> <span class="id">&lt;=</span> <span class="id">nx</span> <span class="id">+</span> <span class="id">ny</span> <span class="id">+</span> <span class="id">nz</span>) <span class="id">&amp;&amp;</span> (<span class="id">b</span> <span class="id">&lt;=</span> <span class="id">nx</span> <span class="id">+</span> <span class="id">ny</span> <span class="id">+</span> <span class="id">nz</span>))<span class="id">%N</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> (<span class="id">a,</span> <span class="id">b</span>))).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof6')">Proof.</span></div>
<div class="proofscript" id="proof6">
<span class="id">elim:</span> <span class="id">nx</span> <span class="id">ny</span> <span class="id">nz</span> <span class="id">=&gt;</span> <span class="id">[ny</span> <span class="id">nz|n</span> <span class="id">ih</span> <span class="id">ny</span> <span class="id">nz]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">bindretf</span> <span class="id">add0n</span> <span class="id">leq_addr</span> <span class="id">leq_addl</span> <span class="id">guardT</span> <span class="id">bindskipf</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">[in</span> <span class="id">RHS]bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">x;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">xp</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[];</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]ih</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">-addSnnS</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]ih</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">addSnnS</span> <span class="id">-addnA</span> <span class="id">addSnnS</span> <span class="id">addnA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">plusArrayMonad</span>.<br/>
<span class="vernacular">End</span> <span class="id">ipartl</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">ipartl</span> <span class="id">{d</span> <span class="id">T</span> <span class="id">M}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">dipartl</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">T</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">plusArrayMonad</span> <span class="id">T</span> <span class="id">nat_eqType</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">dipartlT</span> <span class="id">y</span> <span class="id">z</span> <span class="id">x</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{n</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">*</span> <span class="id">nat</span> <span class="id">|</span> (<span class="id">n</span>.<span class="id">1</span> <span class="id">&lt;=</span> <span class="id">x</span> <span class="id">+</span> <span class="id">y</span> <span class="id">+</span> <span class="id">z</span>) <span class="id">&amp;&amp;</span> (<span class="id">n</span>.<span class="id">2</span> <span class="id">&lt;=</span> <span class="id">x</span> <span class="id">+</span> <span class="id">y</span> <span class="id">+</span> <span class="id">z</span>)<span class="id">}</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">dipartlT1</span> <span class="id">y</span> <span class="id">z</span> <span class="id">x</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">dipartlT</span> <span class="id">y</span> <span class="id">z</span> <span class="id">x</span>) <span class="id">:</span> <span class="id">nat</span> <span class="id">:=</span> (<span class="id">sval</span> <span class="id">a</span>).<span class="id">1</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">dipartlT2</span> <span class="id">y</span> <span class="id">z</span> <span class="id">x</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">dipartlT</span> <span class="id">y</span> <span class="id">z</span> <span class="id">x</span>) <span class="id">:</span> <span class="id">nat</span> <span class="id">:=</span> (<span class="id">sval</span> <span class="id">a</span>).<span class="id">2</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">dipartl</span> <span class="id">p</span> <span class="id">i</span> <span class="id">y</span> <span class="id">z</span> <span class="id">x</span> <span class="id">:</span> <span class="id">M</span> (<span class="id">dipartlT</span> <span class="id">y</span> <span class="id">z</span> <span class="id">x</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> <span class="id">y</span> <span class="id">z</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dassert</span> <span class="id">[pred</span> <span class="id">n</span> <span class="id">|</span> (<span class="id">n</span>.<span class="id">1</span> <span class="id">&lt;=</span> <span class="id">x</span> <span class="id">+</span> <span class="id">y</span> <span class="id">+</span> <span class="id">z</span>) <span class="id">&amp;&amp;</span> (<span class="id">n</span>.<span class="id">2</span> <span class="id">&lt;=</span> <span class="id">x</span> <span class="id">+</span> <span class="id">y</span> <span class="id">+</span> <span class="id">z</span>)<span class="id">]</span>.<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">ipartlE</span> <span class="id">p</span> <span class="id">i</span> <span class="id">n</span> <span class="id">:</span> <span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> <span class="id">0</span> <span class="id">0</span> <span class="id">n</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">fmap</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> (<span class="id">dipartlT1</span> <span class="id">x,</span> <span class="id">dipartlT2</span> <span class="id">x</span>)) (<span class="id">dipartl</span> <span class="id">p</span> <span class="id">i</span> <span class="id">0</span> <span class="id">0</span> <span class="id">n</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof7')">Proof.</span></div>
<div class="proofscript" id="proof7">
<span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">/dipartl</span> <span class="id">bindA</span> <span class="id">ipartl_guard</span> <span class="id">bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">apply:</span> <span class="id">bind_ext_guard</span> <span class="id">=&gt;</span> <span class="id">/andP[na</span> <span class="id">nb]</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">/dassert</span> <span class="id">/=</span>.<br/>
<span class="id">case:</span> <span class="id">Bool.bool_dec</span> <span class="id">=&gt;</span> <span class="id">[nanb|/negP];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">negb_and</span> <span class="id">=&gt;</span> <span class="id">/orP[|]</span> <span class="id">/negP</span>.<br/>
Qed.</div>
<span class="id">Local</span> <span class="vernacular">Close</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">refin_dispatch_write3L_ipartl</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">i</span> <span class="id">:</span> <span class="id">nat</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">T</span>) (<span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">T</span>).<br/>
<span class="vernacular">Hypothesis</span> <span class="id">ih</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">ys</span> <span class="id">zs,</span><br/>
&nbsp;&nbsp;<span class="id">writeList</span> <span class="id">i</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs</span> <span class="id">++</span> <span class="id">xs</span>) <span class="id">&gt;&gt;</span> <span class="id">ipartl</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) <span class="id">p</span> <span class="id">i</span> (<span class="id">size</span> <span class="id">ys</span>) (<span class="id">size</span> <span class="id">zs</span>) (<span class="id">size</span> <span class="id">xs</span>)<br/>
&nbsp;&nbsp;<span class="id">`&lt;=`</span> <span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">ys</span> <span class="id">zs</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> <span class="id">write2L</span> <span class="id">i</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">refin_write3L_ipartl</span> <span class="id">x</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">write3L</span> <span class="id">i</span> (<span class="id">x,</span> <span class="id">xs</span>) <span class="id">&gt;&gt;=</span> <span class="id">uncurry3</span> (<span class="id">ipartl</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) <span class="id">p</span> <span class="id">i</span>)<br/>
&nbsp;&nbsp;<span class="id">`&lt;=`</span> <span class="id">uncurry3</span> (<span class="id">qperm_partl</span> <span class="id">p</span>) (<span class="id">x,</span> <span class="id">xs</span>) <span class="id">&gt;&gt;=</span> <span class="id">write2L</span> <span class="id">i</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof8')">Proof.</span></div>
<div class="proofscript" id="proof8">
<span class="id">case:</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">ys</span> <span class="id">zs</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">refin_trans</span> (<span class="id">ih</span> <span class="id">_</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">bindA</span> <span class="id">bindretf;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_dispatch_Ret_write3L_ipartl</span> <span class="id">x</span> <span class="id">ys</span> <span class="id">zs</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">dispatch_Ret</span> <span class="id">x</span> <span class="id">p</span> (<span class="id">ys,</span> <span class="id">zs,</span> <span class="id">xs</span>) <span class="id">&gt;&gt;=</span> <span class="id">write3L</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">uncurry3</span> (<span class="id">ipartl</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) <span class="id">p</span> <span class="id">i</span>)<br/>
&nbsp;&nbsp;<span class="id">`&lt;=`</span> <span class="id">dispatch_Ret</span> <span class="id">x</span> <span class="id">p</span> (<span class="id">ys,</span> <span class="id">zs,</span> <span class="id">xs</span>) <span class="id">&gt;&gt;=</span> <span class="id">uncurry3</span> (<span class="id">qperm_partl</span> <span class="id">p</span>) <span class="id">&gt;&gt;=</span> <span class="id">write2L</span> <span class="id">i</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof9')">Proof.</span></div>
<div class="proofscript" id="proof9">
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">!if_bind;</span> <span class="id">apply:</span> <span class="id">refin_if</span> <span class="id">=&gt;</span> <span class="id">_;</span> <span class="id">rewrite</span> <span class="id">!bindA;</span><br/>
&nbsp;&nbsp;<span class="id">apply/refin_bindl</span> <span class="id">=&gt;</span> <span class="id">zs';</span> <span class="id">rewrite</span> <span class="id">!bindretf;</span> <span class="id">exact:</span> <span class="id">refin_write3L_ipartl</span>.<br/>
Qed.</div>
<span class="vernacular">End</span> <span class="id">refin_dispatch_write3L_ipartl</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">dipartl</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">dipartl</span> <span class="id">{d</span> <span class="id">T</span> <span class="id">M}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">derivation_qperm_partl_ipartl</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">E</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">plusArrayMonad</span> <span class="id">E</span> <span class="id">nat_eqType</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">i</span> <span class="id">:</span> <span class="id">nat</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_preserves_length</span> <span class="id">i</span> (<span class="id">x</span> <span class="id">p</span> <span class="id">:</span> <span class="id">E</span>) (<span class="id">ys</span> <span class="id">zs</span> <span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">E</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">D</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">D</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">dispatch_Ret</span> <span class="id">x</span> <span class="id">p</span> (<span class="id">ys,</span> <span class="id">zs,</span> <span class="id">xs</span>) <span class="id">&gt;&gt;=</span> <span class="id">write3L</span> <span class="id">i</span>) <span class="id">&gt;&gt;=</span> <span class="id">uncurry3</span> <span class="id">k</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span> <span class="id">+</span> <span class="id">size</span> <span class="id">zs</span>).<span class="id">+1</span>) <span class="id">xs</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dispatch_Ret</span> <span class="id">x</span> <span class="id">p</span> (<span class="id">ys,</span> <span class="id">zs,</span> <span class="id">xs</span>) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys',</span> <span class="id">zs',</span> <span class="id">xs'</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">writeList</span> <span class="id">i</span> (<span class="id">ys'</span> <span class="id">++</span> <span class="id">zs'</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">k</span> (<span class="id">size</span> <span class="id">ys'</span>) (<span class="id">size</span> <span class="id">zs'</span>) (<span class="id">size</span> <span class="id">xs'</span>)) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof10')">Proof.</span></div>
<div class="proofscript" id="proof10">
<span class="id">rewrite</span> <span class="id">bindA</span> <span class="id">[in</span> <span class="id">RHS]bindA</span> <span class="id">-[in</span> <span class="id">RHS]</span>(<span class="id">plus_commute</span> (<span class="id">dispatch_Ret</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>))<span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">xp</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">write3LE</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">-bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[RHS]</span>(<span class="id">qperm_preserves_size2</span> <span class="id">zs</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span> <span class="id">+</span> <span class="id">b</span>).<span class="id">+1</span>) <span class="id">xs</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">writeList</span> <span class="id">i</span> (<span class="id">rcons</span> <span class="id">ys</span> <span class="id">x</span> <span class="id">++</span> <span class="id">a</span>)) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">k</span> (<span class="id">size</span> (<span class="id">rcons</span> <span class="id">ys</span> <span class="id">x</span>)) (<span class="id">size</span> <span class="id">a</span>) (<span class="id">size</span> <span class="id">xs</span>))).<br/>
&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">zs'</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-writeListC;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_cat</span> <span class="id">size_rcons</span> <span class="id">addSn</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">catA</span> <span class="id">writeList_cat</span> <span class="id">cat_rcons</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_cat/=</span> <span class="id">-addnS</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindA</span>.<br/>
<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">write3LE</span>.<br/>
<span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">-bindA</span>.<br/>
<span class="id">rewrite</span> <span class="id">-addnS</span> <span class="id">-</span>(<span class="id">size_rcons</span> <span class="id">zs</span> <span class="id">x</span>).<br/>
<span class="id">rewrite</span> <span class="id">[RHS]</span>(<span class="id">qperm_preserves_size2</span> (<span class="id">rcons</span> <span class="id">zs</span> <span class="id">x</span>) (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span> <span class="id">+</span> <span class="id">b</span>)) <span class="id">xs</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;<span class="id">writeList</span> <span class="id">i</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">a</span>)) <span class="id">&gt;&gt;</span> <span class="id">k</span> (<span class="id">size</span> <span class="id">ys</span>) (<span class="id">size</span> <span class="id">a</span>) (<span class="id">size</span> <span class="id">xs</span>))).<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">zs'</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> (<span class="id">_</span> <span class="id">+</span> (<span class="id">_</span> <span class="id">+</span> <span class="id">_</span>)) <span class="id">=</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">size</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs'</span>)))<span class="id">;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_cat</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-writeListC//</span> <span class="id">catA</span> <span class="id">writeList_cat</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_qperm_partl_writeList</span> (<span class="id">p</span> <span class="id">x</span> <span class="id">:</span> <span class="id">E</span>) (<span class="id">ys</span> <span class="id">zs</span> <span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">E</span>) <span class="id">i</span> <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span> <span class="id">ys</span> <span class="id">zs,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">writeList</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) <span class="id">i</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs</span> <span class="id">++</span> <span class="id">xs</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> (<span class="id">size</span> <span class="id">ys</span>) (<span class="id">size</span> <span class="id">zs</span>) (<span class="id">size</span> <span class="id">xs</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">`&lt;=`</span> <span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">ys</span> <span class="id">zs</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> <span class="id">write2L</span> <span class="id">i</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">writeList</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span> <span class="id">+</span> <span class="id">size</span> <span class="id">zs</span>).<span class="id">+1</span>) <span class="id">xs</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">&lt;=</span> <span class="id">p</span> <span class="gallina-kwd">then</span> <span class="id">qperm</span> <span class="id">zs</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">zs'</span> <span class="id">=&gt;</span> <span class="id">writeList</span> <span class="id">i</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">x</span> <span class="id">::</span> <span class="id">zs'</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> (<span class="id">size</span> <span class="id">ys</span>).<span class="id">+1</span> (<span class="id">size</span> <span class="id">zs'</span>) (<span class="id">size</span> <span class="id">xs</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">qperm</span> (<span class="id">rcons</span> <span class="id">zs</span> <span class="id">x</span>) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">zs'</span> <span class="id">=&gt;</span> <span class="id">writeList</span> <span class="id">i</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs'</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> (<span class="id">size</span> <span class="id">ys</span>) (<span class="id">size</span> <span class="id">zs'</span>) (<span class="id">size</span> <span class="id">xs</span>)))<br/>
&nbsp;&nbsp;<span class="id">`&lt;=`</span><br/>
&nbsp;&nbsp;<span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">ys</span> <span class="id">zs</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">xs</span>) <span class="id">&gt;&gt;=</span> <span class="id">write2L</span> <span class="id">i</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof11')">Proof.</span></div>
<div class="proofscript" id="proof11">
<span class="id">move=&gt;</span> <span class="id">ih;</span> <span class="id">rewrite</span> <span class="id">qperm_partl_cons</span>.<br/>
<span class="id">apply:</span> <span class="id">refin_trans;</span> <span class="id">last</span> <span class="id">exact:</span> (<span class="id">refin_dispatch_Ret_write3L_ipartl</span> <span class="id">ih</span>).<br/>
<span class="id">rewrite</span> <span class="id">qperm_preserves_length</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">apply</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
<span class="id">rewrite</span> <span class="id">if_bind;</span> <span class="id">apply:</span> <span class="id">refin_if</span> <span class="id">=&gt;</span> <span class="id">_;</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">zs'</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">size_rcons</span> <span class="id">-cats1</span> <span class="id">-catA</span> <span class="id">/=;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">derivation_qperm_partl_ipartl</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">refin_qperm_partl</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">E</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">plusArrayMonad</span> <span class="id">E</span> <span class="id">nat_eqType</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">refin_qperm_partl_helper</span> <span class="id">a</span> <span class="id">b</span> <span class="id">p</span> <span class="id">xs</span> <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">apply_triple_snd</span> <span class="id">qperm</span> <span class="id">&gt;=&gt;</span> <span class="id">uncurry3</span> (<span class="id">qperm_partl</span> <span class="id">p</span>)) (<span class="id">a,</span> <span class="id">b,</span> <span class="id">xs</span>) <span class="id">`&lt;=`</span><br/>
&nbsp;&nbsp;<span class="id">apply_pair_snd</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) <span class="id">qperm</span> (<span class="id">partl</span> <span class="id">p</span> (<span class="id">a,</span> <span class="id">b</span>) <span class="id">xs</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof12')">Proof.</span></div>
<div class="proofscript" id="proof12">
<span class="id">elim:</span> <span class="id">xs</span> <span class="id">p</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[/=|h</span> <span class="id">t</span> <span class="id">ih]</span> <span class="id">p</span> <span class="id">a</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">kleisliE</span> <span class="id">apply_triple_sndE;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]/=</span> <span class="id">-if_arg</span> <span class="id">-fun_if</span> <span class="id">if_pair</span><span class="comment">(*if&nbsp;inside&nbsp;args*)</span>.<br/>
<span class="id">apply/</span>(<span class="id">refin_trans</span> <span class="id">_</span> (<span class="id">ih</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>))<span class="id">/eq_refin/esym</span>.<br/>
<span class="id">rewrite</span> <span class="id">-if_pair</span> <span class="id">-[in</span> <span class="id">LHS]</span>(<span class="id">if_same</span> (<span class="id">h</span> <span class="id">&lt;=</span> <span class="id">p</span>) <span class="id">t</span>) <span class="id">-if_pair</span><span class="comment">(*if&nbsp;outside&nbsp;args*)</span>.<br/>
<span class="id">rewrite</span> <span class="id">kleisliE</span> <span class="id">-[X</span> <span class="gallina-kwd">in</span> <span class="id">apply_triple_snd</span> <span class="id">X</span> <span class="id">_]qperm_idempotent</span> <span class="id">fun_if</span>.<br/>
<span class="id">rewrite</span> <span class="id">kleisliE</span> <span class="id">apply_triple_sndE</span>.<br/>
<span class="id">rewrite</span> <span class="id">2!apply_triple_snd_kleisli</span> <span class="id">qperm_rcons</span> <span class="id">bindA</span> <span class="id">-bind_if</span> <span class="id">bindA</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">b'</span>.<br/>
<span class="id">rewrite</span> <span class="id">-apply_triple_snd_kleisli</span> <span class="id">qperm_idempotent</span> <span class="id">if_bind</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindA</span> <span class="id">/=</span>.<br/>
<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="gallina-kwd">if</span> <span class="id">_</span> <span class="gallina-kwd">then</span> <span class="id">_</span> <span class="gallina-kwd">else</span> <span class="id">X]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_qperm_partl</span> <span class="id">a</span> <span class="id">b</span> <span class="id">p</span> <span class="id">xs</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">qperm_partl</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) <span class="id">p</span> <span class="id">a</span> <span class="id">b</span> <span class="id">xs</span> <span class="id">`&lt;=`</span> <span class="id">apply_pair_snd</span> <span class="id">qperm</span> (<span class="id">partl</span> <span class="id">p</span> (<span class="id">a,</span> <span class="id">b</span>) <span class="id">xs</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof13')">Proof.</span></div>
<div class="proofscript" id="proof13">
<span class="id">apply:</span> <span class="id">refin_trans;</span> <span class="id">last</span> <span class="id">exact:</span> <span class="id">refin_qperm_partl_helper</span>.<br/>
<span class="id">rewrite</span> <span class="id">kleisliE</span> <span class="id">apply_triple_sndE</span>.<br/>
<span class="id">rewrite</span> <span class="id">-[X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">`&lt;=`</span> <span class="id">_]</span>(<span class="id">bindretf</span> <span class="id">b</span> (<span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">a</span> <span class="id">^~</span> <span class="id">xs</span>)).<br/>
<span class="id">exact/refin_bindr/refin_qperm_ret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">refin_qperm_partl</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">refin_ipartl</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">E</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">plusArrayMonad</span> <span class="id">E</span> <span class="id">nat_eqType</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">i</span> <span class="id">:</span> <span class="id">nat</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">writeList_ipartl</span> (<span class="id">p</span> <span class="id">x</span> <span class="id">:</span> <span class="id">E</span>) <span class="id">i</span> (<span class="id">s</span> <span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">E</span>) (<span class="id">k1</span> <span class="id">k2</span> <span class="id">:</span> <span class="id">M</span> (<span class="id">nat</span> <span class="id">*</span> <span class="id">nat</span>)<span class="id">%type</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">s</span>).<span class="id">+1</span>) <span class="id">xs</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">&lt;=</span> <span class="id">p</span> <span class="gallina-kwd">then</span> <span class="id">writeList</span> <span class="id">i</span> (<span class="id">rcons</span> <span class="id">s</span> <span class="id">x</span>) <span class="id">&gt;&gt;</span> <span class="id">k1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">writeList</span> <span class="id">i</span> (<span class="id">rcons</span> <span class="id">s</span> <span class="id">x</span>) <span class="id">&gt;&gt;</span> <span class="id">k2</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">writeList</span> <span class="id">i</span> (<span class="id">s</span> <span class="id">++</span> <span class="id">x</span> <span class="id">::</span> <span class="id">xs</span>) <span class="id">&gt;&gt;</span> <span class="id">aget</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">size</span> <span class="id">s</span>) <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">&lt;=</span> <span class="id">p</span> <span class="gallina-kwd">then</span> <span class="id">k1</span> <span class="gallina-kwd">else</span> <span class="id">k2</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof14')">Proof.</span></div>
<div class="proofscript" id="proof14">
<span class="id">transitivity</span> (<span class="id">writeList</span> <span class="id">i</span> (<span class="id">s</span> <span class="id">++</span> <span class="id">x</span> <span class="id">::</span> <span class="id">xs</span>) <span class="id">&gt;&gt;</span> <span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">&lt;=</span> <span class="id">p</span> <span class="gallina-kwd">then</span> <span class="id">k1</span> <span class="gallina-kwd">else</span> <span class="id">k2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">xp</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span> <span class="id">rewrite</span> <span class="id">-cat1s</span> <span class="id">catA</span> <span class="id">writeList_cat</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]writeListC//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">cats1</span> <span class="id">size_rcons</span> <span class="id">bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span> <span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">RHS]cat1s</span> <span class="id">catA</span> <span class="id">writeList_cat</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">writeListC//=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">cats1</span> <span class="id">size_rcons</span> <span class="id">bindA</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA</span> <span class="id">writeList_cat</span> <span class="id">2!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-bindA</span> <span class="id">-writeList_ret_aget</span> <span class="id">bindA</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_ipartl</span> <span class="id">p</span> <span class="id">i</span> (<span class="id">xs</span> <span class="id">zs</span> <span class="id">ys</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">E</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">write3L</span> <span class="id">i</span> (<span class="id">ys,</span> <span class="id">zs,</span> <span class="id">xs</span>) <span class="id">&gt;&gt;=</span> <span class="id">uncurry3</span> (<span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span>)<br/>
&nbsp;&nbsp;<span class="id">`&lt;=`</span><br/>
&nbsp;&nbsp;<span class="id">qperm_partl</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) <span class="id">p</span> <span class="id">ys</span> <span class="id">zs</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> <span class="id">write2L</span> <span class="id">i</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof15')">Proof.</span></div>
<div class="proofscript" id="proof15">
<span class="id">elim:</span> <span class="id">xs</span> <span class="id">i</span> <span class="id">p</span> <span class="id">zs</span> <span class="id">ys</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">ih]</span> <span class="id">i</span> <span class="id">p</span> <span class="id">zs</span> <span class="id">ys</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">eq_refin</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">bindretf</span> <span class="id">cats0</span> <span class="id">bindA</span> <span class="id">bindretf</span>.<br/>
<span class="id">have</span> <span class="id">:</span> (<span class="gallina-kwd">forall</span> <span class="id">ys</span> <span class="id">zs,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">writeList</span> <span class="id">i</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs</span> <span class="id">++</span> <span class="id">t</span>) <span class="id">&gt;&gt;</span> <span class="id">ipartl</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) <span class="id">p</span> <span class="id">i</span> (<span class="id">size</span> <span class="id">ys</span>) (<span class="id">size</span> <span class="id">zs</span>) (<span class="id">size</span> <span class="id">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">`&lt;=`</span> <span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">ys</span> <span class="id">zs</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> <span class="id">write2L</span> <span class="id">i</span>).<br/>
&nbsp;&nbsp;<span class="id">move=&gt;</span> <span class="id">{}ys</span> <span class="id">{}zs;</span> <span class="id">apply:</span> (<span class="id">refin_trans</span> <span class="id">_</span> (<span class="id">ih</span> <span class="id">i</span> <span class="id">p</span> <span class="id">_</span> <span class="id">_</span>)).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">write3LE;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
<span class="id">move=&gt;</span> <span class="id">/</span>(<span class="id">@refin_qperm_partl_writeList</span> <span class="id">_</span> <span class="id">E</span> <span class="id">M</span> <span class="id">p</span> <span class="id">h</span> <span class="id">ys</span> <span class="id">zs</span> <span class="id">t</span> <span class="id">i</span>).<br/>
<span class="id">apply:</span> <span class="id">refin_trans</span>.<br/>
<span class="id">apply:</span> (<span class="id">@refin_trans</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span> <span class="id">+</span> <span class="id">size</span> <span class="id">zs</span>).<span class="id">+1</span>) <span class="id">t</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">if</span> <span class="id">h</span> <span class="id">&lt;=</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">then</span> <span class="id">writeList</span> <span class="id">i</span> (<span class="id">rcons</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs</span>) <span class="id">h</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aswap</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">size</span> <span class="id">ys</span>) (<span class="id">i</span> <span class="id">+</span> <span class="id">size</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs</span>)) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> (<span class="id">size</span> <span class="id">ys</span>).<span class="id">+1</span> (<span class="id">size</span> <span class="id">zs</span>) (<span class="id">size</span> <span class="id">t</span>)<br/>
&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">writeList</span> <span class="id">i</span> (<span class="id">rcons</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs</span>) <span class="id">h</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> (<span class="id">size</span> <span class="id">ys</span>) (<span class="id">size</span> <span class="id">zs</span>).<span class="id">+1</span> (<span class="id">size</span> <span class="id">t</span>))))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_if</span> <span class="id">=&gt;</span> <span class="id">hp;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply:</span> (<span class="id">@refin_trans</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">Ret</span> (<span class="id">rcons</span> <span class="id">zs</span> <span class="id">h</span>) <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">zs'</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">writeList</span> <span class="id">i</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs'</span>) <span class="id">&gt;&gt;</span> <span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> (<span class="id">size</span> <span class="id">ys</span>) (<span class="id">size</span> <span class="id">zs'</span>) (<span class="id">size</span> <span class="id">t</span>)))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact/refin_bindr/refin_qperm_ret</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">size_rcons</span> <span class="id">rcons_cat;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]</span>(<span class="id">qperm_preserves_size2</span> <span class="id">zs</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">writeList</span> <span class="id">i</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">h</span> <span class="id">::</span> <span class="id">a</span>) <span class="id">&gt;&gt;</span> <span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span> (<span class="id">size</span> <span class="id">ys</span>).<span class="id">+1</span> <span class="id">b</span> (<span class="id">size</span> <span class="id">t</span>))).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">exact/refin_bindr/refin_writeList_rcons_cat_aswap</span>.<br/>
<span class="id">rewrite</span> <span class="id">-size_cat</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA</span> <span class="id">writeList_ipartl</span> <span class="id">write3LE</span>.<br/>
<span class="id">rewrite</span> <span class="id">/uncurry3</span> <span class="id">/=</span> <span class="id">-addnA</span> <span class="id">-size_cat</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindA</span> <span class="id">-catA;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">refin_ipartl</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">iqsort_def</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">T</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">plusArrayMonad</span> <span class="id">T</span> <span class="id">nat_eqType</span>).<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Obligation</span> <span class="vernacular">Tactic</span> <span class="id">:=</span> <span class="id">idtac</span>.<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<span class="id">Program</span> <span class="vernacular">Fixpoint</span> <span class="id">iqsort'</span> <span class="id">ni</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">f</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">mj,</span> (<span class="id">mj</span>.<span class="id">2</span> <span class="id">&lt;</span> <span class="id">ni</span>.<span class="id">2</span>)<span class="id">%coq_nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">ni</span>.<span class="id">2</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">0</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">tt</span><br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">n</span>.<span class="id">+1</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">ni</span>.<span class="id">1</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">p</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dipartl</span> <span class="id">p</span> <span class="id">ni</span>.<span class="id">1</span>.<span class="id">+1</span> <span class="id">0</span> <span class="id">0</span> <span class="id">n</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">nynz</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">ny</span> <span class="id">:=</span> <span class="id">nynz</span>.<span class="id">1</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">nz</span> <span class="id">:=</span> <span class="id">nynz</span>.<span class="id">2</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aswap</span> <span class="id">ni</span>.<span class="id">1</span> (<span class="id">ni</span>.<span class="id">1</span> <span class="id">+</span> <span class="id">ny</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">f</span> (<span class="id">ni</span>.<span class="id">1,</span> <span class="id">ny</span>) <span class="id">_</span> <span class="id">&gt;&gt;</span> <span class="id">f</span> (<span class="id">ni</span>.<span class="id">1</span> <span class="id">+</span> <span class="id">ny</span>.<span class="id">+1,</span> <span class="id">nz</span>) <span class="id">_</span>))<br/>
&nbsp;&nbsp;<span class="gallina-kwd">end</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof16')">Next Obligation.</span></div>
<div class="proofscript" id="proof16">
<span class="id">move</span> <span class="id">=&gt;</span> <span class="id">[i</span> <span class="id">[//|n']]</span> <span class="id">/=</span> <span class="id">_</span> <span class="id">n</span> <span class="id">[&lt;-]</span> <span class="id">p</span> <span class="id">[[a</span> <span class="id">b]</span> <span class="id">/=]</span> <span class="id">/andP[an</span> <span class="id">_]</span> <span class="id">_</span>.<br/>
<span class="id">apply/ssrnat</span>.<span class="id">ltP;</span> <span class="id">rewrite</span> <span class="id">ltnS</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!addn0</span> <span class="gallina-kwd">in</span> <span class="id">an</span>.<br/>
Qed.</div>
<div><span class="toggleproof" onclick="toggleDisplay('proof17')">Next Obligation.</span></div>
<div class="proofscript" id="proof17">
<span class="id">move</span> <span class="id">=&gt;</span> <span class="id">[i</span> <span class="id">[//|n']]</span> <span class="id">/=</span> <span class="id">_</span> <span class="id">n</span> <span class="id">[&lt;-]</span> <span class="id">p</span> <span class="id">[[a</span> <span class="id">b]</span> <span class="id">/=]</span> <span class="id">/andP[_</span> <span class="id">bn]</span> <span class="id">_</span>.<br/>
<span class="id">apply/ssrnat</span>.<span class="id">ltP;</span> <span class="id">rewrite</span> <span class="id">ltnS</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!addn0</span> <span class="gallina-kwd">in</span> <span class="id">bn</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">well_founded_lt2</span> <span class="id">:</span> <span class="id">well_founded</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">*</span> <span class="id">nat</span> <span class="id">=&gt;</span> (<span class="id">x</span>.<span class="id">2</span> <span class="id">&lt;</span> <span class="id">y</span>.<span class="id">2</span>)<span class="id">%coq_nat</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof18')">Proof.</span></div>
<div class="proofscript" id="proof18">
<span class="gallina-kwd">by</span> <span class="id">apply:</span> (<span class="id">@Wf_nat</span>.<span class="id">well_founded_lt_compat</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="id">-[x1</span> <span class="id">x2]</span> <span class="id">[y1</span> <span class="id">y2];</span> <span class="id">exact</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">iqsort</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">*</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">Fix</span> <span class="id">well_founded_lt2</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">M</span> <span class="id">unit</span>) <span class="id">iqsort'</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iqsort'_Fix</span> (<span class="id">ni</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">*</span> <span class="id">nat</span>)<br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">n'j</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">*</span> <span class="id">nat</span>)<span class="id">,</span> (<span class="id">n'j</span>.<span class="id">2</span> <span class="id">&lt;</span> <span class="id">ni</span>.<span class="id">2</span>)<span class="id">%coq_nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span> (<span class="id">n'j</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">*</span> <span class="id">nat</span>) (<span class="id">p</span> <span class="id">:</span> (<span class="id">n'j</span>.<span class="id">2</span> <span class="id">&lt;</span> <span class="id">ni</span>.<span class="id">2</span>)<span class="id">%coq_nat</span>)<span class="id">,</span> <span class="id">f</span> <span class="id">n'j</span> <span class="id">p</span> <span class="id">=</span> <span class="id">g</span> <span class="id">n'j</span> <span class="id">p</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">iqsort'</span> <span class="id">f</span> <span class="id">=</span> <span class="id">iqsort'</span> <span class="id">g</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof19')">Proof.</span></div>
<div class="proofscript" id="proof19">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?;</span> <span class="id">congr</span> <span class="id">iqsort';</span> <span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">?;</span> <span class="id">apply</span> <span class="id">boolp.funext</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iqsort_nil</span> <span class="id">i</span> <span class="id">:</span> <span class="id">iqsort</span> (<span class="id">i,</span> <span class="id">0</span>) <span class="id">=</span> <span class="id">Ret</span> <span class="id">tt</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof20')">Proof.</span></div>
<div class="proofscript" id="proof20">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/iqsort</span> <span class="id">Fix_eq</span> <span class="id">//;</span> <span class="id">exact:</span> <span class="id">iqsort'_Fix</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iqsort_cons</span> <span class="id">i</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">iqsort</span> (<span class="id">i,</span> <span class="id">n</span>.<span class="id">+1</span>) <span class="id">=</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">p</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">dipartl</span> <span class="id">p</span> <span class="id">i</span>.<span class="id">+1</span> <span class="id">0</span> <span class="id">0</span> <span class="id">n</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">nynz</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">ny</span> <span class="id">:=</span> <span class="id">dipartlT1</span> <span class="id">nynz</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">nz</span> <span class="id">:=</span> <span class="id">dipartlT2</span> <span class="id">nynz</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aswap</span> <span class="id">i</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">ny</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">iqsort</span> (<span class="id">i,</span> <span class="id">ny</span>) <span class="id">&gt;&gt;</span> <span class="id">iqsort</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">ny</span>.<span class="id">+1,</span> <span class="id">nz</span>))).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof21')">Proof.</span></div>
<div class="proofscript" id="proof21">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]/iqsort</span> <span class="id">Fix_eq</span> <span class="id">//=;</span> <span class="id">exact:</span> <span class="id">iqsort'_Fix</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">iqsort_def</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">iqsort</span> <span class="id">{d</span> <span class="id">T</span> <span class="id">M}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">iqsort_spec</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">E</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">plusArrayMonad</span> <span class="id">E</span> <span class="id">nat_eqType</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">i</span> <span class="id">:</span> <span class="id">nat</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iqsort_slowsort</span> <span class="id">i</span> <span class="id">xs</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">writeList</span> <span class="id">i</span> <span class="id">xs</span> <span class="id">&gt;&gt;</span> <span class="id">iqsort</span> (<span class="id">M</span> <span class="id">:=</span> <span class="id">M</span>) (<span class="id">i,</span> <span class="id">size</span> <span class="id">xs</span>) <span class="id">`&lt;=`</span> <span class="id">slowsort</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> <span class="id">writeList</span> <span class="id">i</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof22')">Proof.</span></div>
<div class="proofscript" id="proof22">
<span class="id">have</span> <span class="id">[n</span> <span class="id">nxs]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">xs</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">xs</span> <span class="id">i</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span> <span class="id">xs</span> <span class="id">i</span> <span class="gallina-kwd">in</span> <span class="id">nxs</span> <span class="id">*</span>.<br/>
<span class="id">move:</span> <span class="id">xs</span> <span class="id">=&gt;</span> <span class="id">[|p</span> <span class="id">xs]</span> <span class="gallina-kwd">in</span> <span class="id">nxs</span> <span class="id">*</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">iqsort_nil</span> <span class="id">slowsort_nil</span> <span class="id">2!bindretf</span> <span class="id">/=;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
<span class="comment">(*&nbsp;step&nbsp;1:&nbsp;l.342&nbsp;in&nbsp;IQSOrt.agda,<br/>
&nbsp;&nbsp;&nbsp;corresponds&nbsp;to&nbsp;second&nbsp;equation&nbsp;on&nbsp;page&nbsp;13&nbsp;of&nbsp;mu2020flops&nbsp;*)</span><br/>
<span class="id">pose</span> <span class="id">p1</span> <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">[::]</span> <span class="id">[::]</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span>).<span class="id">+1</span>) <span class="id">zs</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;<span class="id">qperm</span> <span class="id">ys</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">ys'</span> <span class="id">=&gt;</span> <span class="id">writeList</span> <span class="id">i</span> (<span class="id">rcons</span> <span class="id">ys'</span> <span class="id">p</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">iqsort</span> (<span class="id">i,</span> <span class="id">size</span> <span class="id">ys</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">iqsort</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span>).<span class="id">+1,</span> <span class="id">size</span> <span class="id">zs</span>))).<br/>
<span class="id">apply:</span> (<span class="id">@refin_trans</span> <span class="id">_</span> <span class="id">_</span> <span class="id">p1</span>).<br/>
<span class="id">-</span> <span class="comment">(*&nbsp;step&nbsp;2:&nbsp;introduce&nbsp;aswap&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">apply:</span> (<span class="id">@refin_trans</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">[::]</span> <span class="id">[::]</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span>).<span class="id">+1</span>) <span class="id">zs</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">writeList</span> <span class="id">i</span> (<span class="id">p</span> <span class="id">::</span> <span class="id">ys</span>) <span class="id">&gt;&gt;</span> <span class="id">aswap</span> <span class="id">i</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">size</span> <span class="id">ys</span>)) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">iqsort</span> (<span class="id">i,</span> <span class="id">size</span> <span class="id">ys</span>)) <span class="id">&gt;&gt;</span> <span class="id">iqsort</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span>).<span class="id">+1,</span> <span class="id">size</span> <span class="id">zs</span>)))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;3:&nbsp;commute&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">rewrite</span> <span class="id">[X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]</span>(<span class="id">_</span> <span class="id">:</span> <span class="id">_</span> <span class="id">=</span> <span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">[::]</span> <span class="id">[::]</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">p</span> <span class="id">&gt;&gt;</span> <span class="id">writeList</span> <span class="id">i</span>.<span class="id">+1</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">aswap</span> <span class="id">i</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">size</span> <span class="id">ys</span>)) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">iqsort</span> (<span class="id">i,</span> <span class="id">size</span> <span class="id">ys</span>)) <span class="id">&gt;&gt;</span> <span class="id">iqsort</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span>).<span class="id">+1,</span> <span class="id">size</span> <span class="id">zs</span>)))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[ys</span> <span class="id">zs]</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-bindA</span> <span class="id">-writeListC//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">bindA</span> <span class="id">writeList_cat</span> <span class="id">!bindA</span> <span class="id">-addSnnS</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;4:&nbsp;commute&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]</span>(<span class="id">_</span> <span class="id">:</span> <span class="id">_</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">p</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">[::]</span> <span class="id">[::]</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">writeList</span> <span class="id">i</span>.<span class="id">+1</span> (<span class="id">ys</span> <span class="id">++</span> <span class="id">zs</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aswap</span> <span class="id">i</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">size</span> <span class="id">ys</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">iqsort</span> (<span class="id">i,</span> <span class="id">size</span> <span class="id">ys</span>) <span class="id">&gt;&gt;</span> <span class="id">iqsort</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys</span>).<span class="id">+1,</span> <span class="id">size</span> <span class="id">zs</span>))))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[RHS]bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">plus_commute</span> (<span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">[::]</span> <span class="id">[::]</span> <span class="id">xs</span>))<span class="id">//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">bind_ext=&gt;</span> <span class="id">-[a</span> <span class="id">b];</span> <span class="id">rewrite</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;5&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">{nxs}</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]</span>(<span class="id">_</span> <span class="id">:</span> <span class="id">_</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">p</span> <span class="id">&gt;&gt;</span> <span class="id">qperm_partl</span> <span class="id">p</span> <span class="id">[::]</span> <span class="id">[::]</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span> <span class="id">write2L</span> <span class="id">i</span>.<span class="id">+1</span> (<span class="id">ys,</span> <span class="id">zs</span>)) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ny,</span> <span class="id">nz</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aswap</span> <span class="id">i</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">ny</span>) <span class="id">&gt;&gt;</span> <span class="id">iqsort</span> (<span class="id">i,</span> <span class="id">ny</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">iqsort</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">ny</span>.<span class="id">+1,</span> <span class="id">nz</span>)))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b];</span> <span class="id">rewrite</span> <span class="id">write2LE</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;6:&nbsp;refin_ipartl_qperm_partl&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]</span>(<span class="id">bindA</span> (<span class="id">aput</span> <span class="id">i</span> <span class="id">p</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_trans;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">ttt;</span> <span class="id">exact/refin_bindr/refin_ipartl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;7&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">p</span> <span class="id">&gt;&gt;</span> <span class="id">_</span> <span class="id">=</span> (<span class="id">writeList</span> <span class="id">i</span> (<span class="id">p</span> <span class="id">::</span> <span class="id">xs</span>) <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">p</span>) <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">p</span> <span class="id">=&gt;</span> <span class="id">ipartl</span> <span class="id">p</span> <span class="id">i</span>.<span class="id">+1</span> <span class="id">0</span> <span class="id">0</span> (<span class="id">size</span> <span class="id">xs</span>)))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">bindA</span> <span class="id">-[in</span> <span class="id">LHS]</span>(<span class="id">bindA</span> (<span class="id">aput</span> <span class="id">i</span> <span class="id">p</span>)) <span class="id">[in</span> <span class="id">RHS]bindA</span> <span class="id">!bindretf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;8&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">writeListRet</span> <span class="id">2![in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">iqsort_cons</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">ipartlE</span> <span class="id">/=</span> <span class="id">fmapE</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">under</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span> <span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">-[ys</span> <span class="id">sz]</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">4!bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-2![in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]</span>(<span class="id">bindA</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">iqsort</span> <span class="id">_</span>) (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">iqsort</span> <span class="id">_</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-2![in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">`&lt;=`</span> <span class="id">_]bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">`&lt;=`</span> <span class="id">_]</span>(<span class="id">bindA</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">iqsort</span> <span class="id">_</span>) (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">iqsort</span> <span class="id">_</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_bindr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact:</span> <span class="id">refin_writeList_cons_aswap</span>.<br/>
<span class="id">-</span> <span class="comment">(*&nbsp;step&nbsp;1a:&nbsp;refin_partition_slowsort&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_trans;</span> <span class="id">last</span> <span class="id">exact/refin_bindr/refin_partition_slowsort</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> <span class="id">pxs</span> <span class="id">:</span> (<span class="id">partition</span> <span class="id">p</span> <span class="id">xs</span>) <span class="id">=&gt;</span> <span class="id">tmp;</span> <span class="id">case:</span> <span class="id">tmp</span> <span class="id">=&gt;</span> <span class="id">[ys</span> <span class="id">zs]</span> <span class="gallina-kwd">in</span> <span class="id">pxs</span> <span class="id">*</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;1b:&nbsp;introduce&nbsp;qperm's&nbsp;and&nbsp;commute&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-qperm_slowsort</span> <span class="id">2!kleisliE</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]</span>(<span class="id">_</span> <span class="id">:</span> <span class="id">_</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">do</span> <span class="id">zs'</span> <span class="id">&lt;-</span> <span class="id">qperm</span> <span class="id">zs;</span> <span class="id">do</span> <span class="id">ys'</span> <span class="id">&lt;-</span> <span class="id">qperm</span> <span class="id">ys;</span> <span class="id">do</span> <span class="id">ys''</span> <span class="id">&lt;-</span> <span class="id">slowsort</span> <span class="id">ys';</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">do</span> <span class="id">zs''</span> <span class="id">&lt;-</span> <span class="id">slowsort</span> <span class="id">zs';</span> <span class="id">writeList</span> <span class="id">i</span> (<span class="id">ys''</span> <span class="id">++</span> <span class="id">p</span> <span class="id">::</span> <span class="id">zs''</span>))<span class="id">%Do</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">plus_commute</span> (<span class="id">qperm</span> <span class="id">zs</span>))<span class="id">//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">ys'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!bindA;</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">plus_commute</span> (<span class="id">qperm</span> <span class="id">zs</span>))<span class="id">//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">zs';</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">ys''</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;1c:&nbsp;refine&nbsp;partl&nbsp;to&nbsp;qperm_partl&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_trans;</span> <span class="id">first</span> <span class="id">exact/refin_bindr/refin_qperm_partl</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;1d:&nbsp;execute&nbsp;the&nbsp;first&nbsp;qperm&nbsp;and&nbsp;record&nbsp;size&nbsp;information&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-partition_partl</span> <span class="id">pxs</span> <span class="id">bindA</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bind_qperm_guard</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]bind_qperm_guard</span><span class="comment">(*NB:&nbsp;interesting?*)</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">zs'</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_bind_guard</span> <span class="id">=&gt;</span> <span class="id">/eqP</span> <span class="id">zszs'</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;1e:&nbsp;commutation&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">![in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">`&lt;=`</span> <span class="id">_]bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">plus_commute</span> (<span class="id">qperm</span> <span class="id">ys</span>))<span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;1f:&nbsp;qperm_preserves_size2,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execute&nbsp;the&nbsp;second&nbsp;qperm&nbsp;and&nbsp;record&nbsp;size&nbsp;information&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">qperm_preserves_size2</span> <span class="id">ys</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">b</span>.<span class="id">+1</span>) <span class="id">zs'</span> <span class="id">&gt;&gt;</span> (<span class="id">writeList</span> <span class="id">i</span> (<span class="id">rcons</span> <span class="id">a</span> <span class="id">p</span>) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">iqsort</span> (<span class="id">i,</span> <span class="id">b</span>) <span class="id">&gt;&gt;</span> <span class="id">iqsort</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">b</span>.<span class="id">+1,</span> <span class="id">size</span> <span class="id">zs'</span>))))).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bind_qperm_guard</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]bind_qperm_guard</span> <span class="comment">(*NB:&nbsp;interesting?*)</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">ys'</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_bind_guard</span> <span class="id">=&gt;</span> <span class="id">/eqP</span> <span class="id">ysys'</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;1g:&nbsp;ih&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-cats1</span> <span class="id">writeList_cat</span> <span class="id">writeListC//</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">bindA</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">iqsort</span> (<span class="id">i,</span> <span class="id">size</span> <span class="id">ys'</span>))).<br/>
&nbsp;&nbsp;<span class="id">apply:</span> (<span class="id">@refin_trans</span> <span class="id">_</span> <span class="id">_</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys'</span>).<span class="id">+1</span>) <span class="id">zs'</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">size</span> <span class="id">ys'</span>) <span class="id">[::</span> <span class="id">p]</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">slowsort</span> <span class="id">ys'</span> <span class="id">&gt;&gt;=</span> <span class="id">writeList</span> <span class="id">i</span>))) <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">iqsort</span> (<span class="id">i</span> <span class="id">+</span> (<span class="id">size</span> <span class="id">ys'</span>).<span class="id">+1,</span> <span class="id">size</span> <span class="id">zs'</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">do</span> <span class="id">2</span> <span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">2!bindretf</span> <span class="id">-2!bindA;</span> <span class="id">apply/refin_bindr/ih</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move:</span> <span class="id">nxs;</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">ltnS;</span> <span class="id">apply:</span> <span class="id">leq_ltn_trans</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-ysys'</span> <span class="id">-</span>(<span class="id">size_partition</span> <span class="id">p</span> <span class="id">xs</span>) <span class="id">pxs</span> <span class="id">/=</span> <span class="id">leq_addr</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;1h:&nbsp;slowsort_preserves_size2&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">`&lt;=`</span> <span class="id">_]</span>(<span class="id">plus_commute</span> (<span class="id">slowsort</span> <span class="id">ys'</span>))<span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">`&lt;=`</span> <span class="id">_]</span>(<span class="id">plus_commute</span> (<span class="id">slowsort</span> <span class="id">ys'</span>))<span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">slowsort_preserves_size2</span> <span class="id">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">b</span>.<span class="id">+1</span>) <span class="id">zs'</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">writeList</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">b</span>) <span class="id">[::</span> <span class="id">p]</span> <span class="id">&gt;&gt;</span> <span class="id">writeList</span> <span class="id">i</span> <span class="id">a</span> <span class="id">&gt;&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">iqsort</span> (<span class="id">i</span> <span class="id">+</span> <span class="id">b</span>.<span class="id">+1,</span> <span class="id">size</span> <span class="id">zs'</span>)))).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bind_slowsort_guard</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]bind_slowsort_guard</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">ys''</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">refin_bind_guard</span> <span class="id">=&gt;</span> <span class="id">/eqP</span> <span class="id">ys'ys''</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-bindA</span> <span class="id">-</span>(<span class="id">writeListC</span> <span class="id">_</span> <span class="id">_</span> <span class="id">ys''</span>)<span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">-cat_rcons</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">`&lt;=`</span> <span class="id">X]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">writeList_cat</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">plus_commute</span> (<span class="id">slowsort</span> <span class="id">zs'</span>))<span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">writeList_cat</span> <span class="id">i</span> <span class="id">ys''</span> <span class="id">[::</span> <span class="id">p]</span>) <span class="id">-</span>(<span class="id">writeListC</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">zs'</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">cats1</span> <span class="id">size_rcons/=</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;step&nbsp;1i:&nbsp;ih&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">cats1</span> <span class="id">bindA;</span> <span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">size_rcons;</span> <span class="id">apply:</span> <span class="id">ih</span>.<br/>
&nbsp;&nbsp;<span class="id">move:</span> <span class="id">nxs;</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">ltnS;</span> <span class="id">apply:</span> <span class="id">leq_ltn_trans</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-zszs'</span> <span class="id">-</span>(<span class="id">size_partition</span> <span class="id">p</span> <span class="id">xs</span>) <span class="id">pxs</span> <span class="id">/=</span> <span class="id">leq_addl</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">iqsort_spec</span>.<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/yoshihiro503/coq2html/">a fork of coq2html</a></div>
</body>
</html>

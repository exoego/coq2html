
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module fail_lib</title>
<meta name="description" content="Documentation of Coq module fail_lib" />
<link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath/texmath.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="init('proofscript')">
<h1 class="title">Module fail_lib</h1>
<div class="coq">
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">all_ssreflect</span>.<br/>
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="id">boolp</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">monae_lib</span>.<br/>
<span class="vernacular">From</span> <span class="id">HB</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">structures</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">hierarchy</span> <span class="id">monad_lib</span>.<br/>
<span class="vernacular">From</span> <span class="id">infotheo</span> <span class="vernacular">Require</span> <span class="id">convex</span> <span class="id">necset</span>.<br/>
<span class="vernacular">From</span> <span class="id">Equations</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">Equations</span>.<br/>
<br/>
<pre class="ssrdoc">
    Definitions and lemmas using failure and nondeterministic monads       
                                                                           
                  arb == arbitrary nondeterministic choice between         
                         booleans                                          
                foldM                                                      
        unfoldM p f y == generates a list a from a seed y, if p y holds    
                         the generation stops,otherwise an element and a   
                         new seed of generated using f                     
                hyloM == [2, Sect. 5.1]                                    
      arbitrary def s == nondeterministic choice of an element in the list 
                         s and def if the list is empty                    
               subs s == subsequence of a list                             
                         (ref: Sect. 3.1, gibbons2012utp)                  
         nondetSyntax == syntax of nondeterministic monad                  
                         (constructors: ndRet ndBind ndFail ndAlt)         
          nondetSem x == semantics of x : nondetSyntax                     
           insert a s == insert a in the list s nondeterministically       
              iperm s == nondeterministic permutation of the list s,       
                         defined as a Fixpoint using insert [1, Sect. 3]   
             select s == nondeterministically splits the list s into a     
                         pair of one chosen element and the rest           
                         [3, Sect. 4.4] [2, Sect. 3.2]                     
            tselect s == same as select but returns a pair whose second    
                         projection has type (size s).-1.-tuple A, useful  
                         to write perms                                    
              perms s == of type seq A -&gt; M (seq A), nondeterministically  
                         computes a permutation of s using (t)select       
              uperm s == nondeterministically computes a permutation of s, 
                         defined using unfoldM and select [2, Sect. 3.2]   
          dassert p a == computation of type M {x | p x} that fails if a   
                         does not satisfy p or return a otherwise (with a  
                         proof that is satisfies p)                        
             splits s == split a list nondeterministically                 
                         type: seq A -&gt; M (seq A * seq A)                  
                         with M : plusMonad                                
        splits_bseq s == same as splits with an enriched return type       
                         M ((size s).-bseq A * (size s).-bseq A))          
            dsplits s == same as split with an enriched return type        
                         M {x : seq A * seq A | size x.1 + size x.2 == n}  
              qperm s == permute the list s                                
                         type: seq A -&gt; M (seq A) with M : plusMonad       
      plus_isNondet m == m is a computation of the plusMonad that can be   
                         written with the syntax of the nondeterministic   
                         monad                                             
           m1 `&lt;=` m2 == m1 refines m2, i.e., every result of m1 is a      
                         possible result of m2                             
            f `&lt;.=` g == refinement relation lifted to functions, i.e.,    
                         forall x, f x `&lt;=` g x                            
                                                                           
ref:                                                                       
- [1] mu2019tr2                                                            
- [2] mu2019tr3                                                            
- [3] gibbons2011icfp                                                      
- [4] mu2020flops                                                          
</pre>
<br/>
<span class="vernacular">Reserved</span> <span class="vernacular">Notation</span> <span class="id">"m1&nbsp;`&lt;=`&nbsp;m2"</span> (<span class="gallina-kwd">at</span> <span class="id">level</span> <span class="id">70,</span> <span class="id">no</span> <span class="id">associativity</span>).<br/>
<span class="vernacular">Reserved</span> <span class="vernacular">Notation</span> <span class="id">"f&nbsp;`&lt;.=`&nbsp;g"</span> (<span class="gallina-kwd">at</span> <span class="id">level</span> <span class="id">70,</span> <span class="id">no</span> <span class="id">associativity</span>).<br/>
<br/>
<span class="gallina-kwd">Set</span> <span class="vernacular">Implicit</span> <span class="vernacular">Arguments</span>.<br/>
<span class="id">Unset</span> <span class="id">Strict</span> <span class="vernacular">Implicit</span>.<br/>
<span class="id">Unset</span> <span class="id">Printing</span> <span class="vernacular">Implicit</span> <span class="id">Defensive</span>.<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">mem_rcons_cat</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">b</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">h</span> <span class="id">:</span> <span class="id">h</span> <span class="id">\in</span> <span class="id">b</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> <span class="id">b1</span> <span class="id">b2,</span> <span class="id">b</span> <span class="id">=</span> <span class="id">rcons</span> <span class="id">b1</span> <span class="id">h</span> <span class="id">++</span> <span class="id">b2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof1')">Proof.</span></div>
<div class="proofscript" id="proof1">
<span class="id">move=&gt;</span> <span class="id">hb;</span> <span class="gallina-kwd">exists</span> (<span class="id">take</span> (<span class="id">index</span> <span class="id">h</span> <span class="id">b</span>) <span class="id">b</span>)<span class="id">,</span> (<span class="id">drop</span> (<span class="id">index</span> <span class="id">h</span> <span class="id">b</span>).<span class="id">+1</span> <span class="id">b</span>).<br/>
<span class="id">rewrite</span> <span class="id">-cats1</span> <span class="id">-catA</span> <span class="id">-{1}</span>(<span class="id">cat_take_drop</span> (<span class="id">index</span> <span class="id">h</span> <span class="id">b</span>) <span class="id">b</span>)<span class="id">;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">++</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-{2}</span>(<span class="id">nth_index</span> <span class="id">h</span> <span class="id">hb</span>) <span class="id">-drop_nth</span> <span class="id">//</span> <span class="id">index_mem</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">altci_semilatttype</span>.<br/>
<span class="vernacular">Import</span> <span class="id">necset</span> <span class="id">SemiLattice</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">T</span> <span class="id">:</span> <span class="gallina-kwd">Type</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">altCI_semiLattType</span> <span class="id">:=</span> <span class="id">M</span> <span class="id">T</span>.<br/>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">@isSemiLattice</span>.<span class="id">Build</span> <span class="id">altCI_semiLattType</span><br/>
&nbsp;&nbsp;(<span class="id">Choice.class</span> (<span class="id">convex.choice_of_Type</span> (<span class="id">M</span> <span class="id">T</span>)))<br/>
&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">[~]</span> <span class="id">y</span>)<br/>
&nbsp;&nbsp;(<span class="id">@altC</span> <span class="id">M</span> <span class="id">T</span>) (<span class="id">@altA</span> <span class="id">M</span> <span class="id">T</span>) (<span class="id">@altmm</span> <span class="id">M</span> <span class="id">T</span>).<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">latt_scope</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">alt_lub</span> (<span class="id">x</span> <span class="id">y</span> <span class="id">:</span> <span class="id">altCI_semiLattType</span>) <span class="id">:</span> <span class="id">x</span> <span class="id">[~]</span> <span class="id">y</span> <span class="id">=</span> <span class="id">x</span> <span class="id">[+]</span> <span class="id">y</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof2')">Proof.</span></div>
<div class="proofscript" id="proof2">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">altci_semilatttype</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bind_ext_guard</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">failMonad}</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">b</span> <span class="id">:</span> <span class="id">bool</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">b</span> <span class="id">-&gt;</span> <span class="id">m1</span> <span class="id">=</span> <span class="id">m2</span>) <span class="id">-&gt;</span> <span class="id">guard</span> <span class="id">b</span> <span class="id">&gt;&gt;</span> <span class="id">m1</span> <span class="id">=</span> <span class="id">guard</span> <span class="id">b</span> <span class="id">&gt;&gt;</span> <span class="id">m2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof3')">Proof.</span></div>
<div class="proofscript" id="proof3">
 <span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[-&gt;//|_];</span> <span class="id">rewrite</span> <span class="id">guardF</span> <span class="id">!bindfailf</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">arb</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">:</span> <span class="id">M</span> <span class="id">bool</span> <span class="id">:=</span> <span class="id">Ret</span> <span class="id">true</span> <span class="id">[~]</span> <span class="id">Ret</span> <span class="id">false</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">monadalt_lemmas</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">alt_fmapDr</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) (<span class="id">m1</span> <span class="id">[~]</span> <span class="id">m2</span>) <span class="id">=</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m1</span> <span class="id">[~]</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof4')">Proof.</span></div>
<div class="proofscript" id="proof4">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">3!fmapE</span> <span class="id">alt_bindDl</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">monadalt_lemmas</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fmap_fail</span> <span class="id">{A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">fail</span> <span class="id">=</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof5')">Proof.</span></div>
<div class="proofscript" id="proof5">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindfailf</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">well_founded_size</span> <span class="id">A</span> <span class="id">:</span> <span class="id">well_founded</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">size</span> <span class="id">x</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">y</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof6')">Proof.</span></div>
<div class="proofscript" id="proof6">
 <span class="gallina-kwd">by</span> <span class="id">apply:</span> (<span class="id">@Wf_nat</span>.<span class="id">well_founded_lt_compat</span> <span class="id">_</span> <span class="id">size</span>) <span class="id">=&gt;</span> <span class="id">?</span> <span class="id">?</span> <span class="id">/ltP</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">bassert_hylo</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">failMonad}</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">B</span>)<span class="id">%type</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">B</span>) (<span class="id">r</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">p</span> <span class="id">f,</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">bool</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">b,</span> <span class="id">f</span> <span class="id">b</span> <span class="id">=</span> <span class="id">bassert</span> (<span class="gallina-kwd">fun</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">r</span> <span class="id">p</span> <span class="id">f</span> <span class="id">z</span>.<span class="id">2</span> <span class="id">b</span>) (<span class="id">f</span> <span class="id">b</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">bassert_size</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">failMonad}</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">B</span>)<span class="id">%type</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">@bassert_hylo</span> <span class="id">M</span> <span class="id">_</span> <span class="id">_</span> <span class="id">f</span> <span class="id">predT</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">_</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">size</span> <span class="id">x</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">y</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">foldM</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">T</span> <span class="id">R</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">R</span> <span class="id">-&gt;</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">R</span>).<br/>
<span class="vernacular">Fixpoint</span> <span class="id">foldM</span> <span class="id">z</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span> <span class="id">:=</span> <span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">is</span> <span class="id">x</span> <span class="id">::</span> <span class="id">s'</span> <span class="gallina-kwd">then</span> <span class="id">f</span> <span class="id">z</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">foldM</span> <span class="id">y</span> <span class="id">s'</span>) <span class="gallina-kwd">else</span> (<span class="id">Ret</span> <span class="id">z</span>).<br/>
<span class="vernacular">End</span> <span class="id">foldM</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">unfoldM</span>.<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">unfoldM_monad</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Variable</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">bool</span>).<br/>
<span class="vernacular">Hypothesis</span> <span class="id">wfr</span> <span class="id">:</span> <span class="id">well_founded</span> <span class="id">r</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">B</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">B</span>)<span class="id">%type</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">unfoldM'</span> (<span class="id">y</span> <span class="id">:</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">y'</span> <span class="id">:</span> <span class="id">B,</span> <span class="id">r</span> <span class="id">y'</span> <span class="id">y</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>)) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">p</span> <span class="id">y</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span> <span class="id">f</span> <span class="id">y</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">xz</span> <span class="id">=&gt;</span> <span class="gallina-kwd">match</span> <span class="id">Bool.bool_dec</span> (<span class="id">r</span> <span class="id">xz</span>.<span class="id">2</span> <span class="id">y</span>) <span class="id">true</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">left</span> <span class="id">H</span> <span class="id">=&gt;</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">xz</span>.<span class="id">1</span>) (<span class="id">g</span> <span class="id">xz</span>.<span class="id">2</span> <span class="id">H</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">right</span> <span class="id">H</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">[::]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">end</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">unfoldM</span> <span class="id">:=</span> <span class="id">Fix</span> <span class="id">wfr</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">unfoldM'</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">unfoldM_monad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">unfoldM_failMonad</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span>) (<span class="id">A</span> <span class="id">B'</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Let</span> <span class="id">B</span> <span class="id">:=</span> <span class="id">seq</span> <span class="id">B'</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">unfoldM</span> <span class="id">:=</span> (<span class="id">@unfoldM</span> <span class="id">M</span> <span class="id">A</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">@well_founded_size</span> <span class="id">B'</span>)).<br/>
<span class="vernacular">Variables</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">B</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">B</span>)<span class="id">%type</span>).<br/>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">decr_size</span> <span class="id">:</span> <span class="id">bassert_size</span> <span class="id">f</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">unfoldME</span> <span class="id">y</span> <span class="id">:</span> <span class="id">unfoldM</span> <span class="id">p</span> <span class="id">f</span> <span class="id">y</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">p</span> <span class="id">y</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">f</span> <span class="id">y</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">xz</span> <span class="id">=&gt;</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">xz</span>.<span class="id">1</span>) (<span class="id">unfoldM</span> <span class="id">p</span> <span class="id">f</span> <span class="id">xz</span>.<span class="id">2</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof7')">Proof.</span></div>
<div class="proofscript" id="proof7">
<span class="id">rewrite</span> <span class="id">/unfoldM</span> <span class="id">Init.Wf.Fix_eq</span><span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> <span class="id">=&gt;</span> <span class="id">b</span> <span class="id">g</span> <span class="id">g'</span> <span class="id">H;</span> <span class="id">rewrite</span> <span class="id">/unfoldM';</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">pb</span>.<br/>
&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a'</span> <span class="id">b']</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">Bool.bool_dec</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">H</span>.<br/>
<span class="id">rewrite</span> <span class="id">/unfoldM';</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">py</span>.<br/>
<span class="id">rewrite</span> <span class="id">decr_size</span> <span class="id">/bassert</span> <span class="id">2!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a'</span> <span class="id">b']</span>.<br/>
<span class="id">case:</span> <span class="id">assertPn</span> <span class="id">=&gt;</span> <span class="id">b'y;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!bindfailf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!bindretf</span> <span class="id">/=</span> <span class="id">b'y</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">unfoldM_failMonad</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">unfoldM</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">unfoldM</span> <span class="id">:</span> <span class="id">simpl</span> <span class="id">never</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">hyloM</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span>) (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Variables</span> (<span class="id">op</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">C</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">B</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">B</span>)<span class="id">%type</span>).<br/>
<span class="vernacular">Variable</span> <span class="id">seed</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">B</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">B</span>)<span class="id">%type</span>)<span class="id">,</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">bool</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">hyloM'</span> (<span class="id">y</span> <span class="id">:</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">y',</span> <span class="id">seed</span> <span class="id">p</span> <span class="id">f</span> <span class="id">y'</span> <span class="id">y</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">C</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">p</span> <span class="id">y</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">e</span> <span class="gallina-kwd">else</span> <span class="id">f</span> <span class="id">y</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">xz</span> <span class="id">=&gt;</span> <span class="gallina-kwd">match</span> <span class="id">Bool.bool_dec</span> (<span class="id">seed</span> <span class="id">p</span> <span class="id">f</span> <span class="id">xz</span>.<span class="id">2</span> <span class="id">y</span>) <span class="id">true</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">left</span> <span class="id">H</span> <span class="id">=&gt;</span> <span class="id">op</span> <span class="id">xz</span>.<span class="id">1</span> (<span class="id">g</span> <span class="id">xz</span>.<span class="id">2</span> <span class="id">H</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">right</span> <span class="id">H</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">end</span>).<br/>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">well_founded_seed</span> <span class="id">:</span> <span class="id">well_founded</span> (<span class="id">seed</span> <span class="id">p</span> <span class="id">f</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">hyloM</span> <span class="id">:=</span> <span class="id">Fix</span> <span class="id">well_founded_seed</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">hyloM'</span>.<br/>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">Hdecr_seed</span> <span class="id">:</span> <span class="id">bassert_hylo</span> <span class="id">f</span> <span class="id">p</span> <span class="id">seed</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">hyloME</span> <span class="id">y</span> <span class="id">:</span> <span class="id">hyloM</span> <span class="id">y</span> <span class="id">=</span> <span class="gallina-kwd">if</span> <span class="id">p</span> <span class="id">y</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">f</span> <span class="id">y</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">xz</span> <span class="id">=&gt;</span> <span class="id">op</span> <span class="id">xz</span>.<span class="id">1</span> (<span class="id">hyloM</span> <span class="id">xz</span>.<span class="id">2</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof8')">Proof.</span></div>
<div class="proofscript" id="proof8">
<span class="id">rewrite</span> <span class="id">/hyloM</span> <span class="id">Init.Wf.Fix_eq</span><span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> <span class="id">=&gt;</span> <span class="id">b</span> <span class="id">g</span> <span class="id">g'</span> <span class="id">K;</span> <span class="id">rewrite</span> <span class="id">/hyloM';</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">pb</span>.<br/>
&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a'</span> <span class="id">b']</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">Bool.bool_dec</span> <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">K</span>.<br/>
<span class="id">rewrite</span> <span class="id">{1}/hyloM';</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">py</span>.<br/>
<span class="id">rewrite</span> <span class="id">Hdecr_seed</span> <span class="id">/bassert</span> <span class="id">!bindA</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[b'</span> <span class="id">a']</span>.<br/>
<span class="id">case:</span> <span class="id">assertPn</span> <span class="id">=&gt;</span> <span class="id">Hseed;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!bindfailf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!bindretf</span> <span class="id">Hseed</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">hyloM</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">hyloM</span> <span class="id">{M}</span> <span class="id">{A}</span> <span class="id">{B}</span> <span class="id">{C}</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">arbitrary</span>.<br/>
<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">def</span> <span class="id">:</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">arbitrary</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">foldr1</span> (<span class="id">Ret</span> <span class="id">def</span>) (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">[~]</span> <span class="id">y</span>) <span class="id">\o</span> <span class="id">map</span> <span class="id">Ret</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">arbitrary</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">arbitrary</span> <span class="id">{M}</span> <span class="id">{A}</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary1</span> (<span class="id">N</span> <span class="id">:</span> <span class="id">altMonad</span>) (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">def</span> <span class="id">:</span> <span class="id">T</span>) <span class="id">h</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> <span class="id">[::</span> <span class="id">h]</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">h</span> <span class="id">:&gt;</span> <span class="id">N</span> <span class="id">T</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof9')">Proof.</span></div>
<div class="proofscript" id="proof9">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">arbitrary_lemmas</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary2</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">def</span> <span class="id">:</span> <span class="id">T</span>) <span class="id">h</span> <span class="id">t</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> <span class="id">[::</span> <span class="id">h;</span> <span class="id">t]</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">h</span> <span class="id">[~]</span> <span class="id">Ret</span> <span class="id">t</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof10')">Proof.</span></div>
<div class="proofscript" id="proof10">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/arbitrary</span> <span class="id">/=</span> <span class="id">altC</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_cons</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">def</span> <span class="id">:</span> <span class="id">T</span>) <span class="id">h</span> <span class="id">t</span> <span class="id">:</span> <span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">t</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">=</span> <span class="id">Ret</span> <span class="id">h</span> <span class="id">[~]</span> <span class="id">arbitrary</span> <span class="id">def</span> <span class="id">t</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof11')">Proof.</span></div>
<div class="proofscript" id="proof11">
<span class="id">move:</span> <span class="id">def</span> <span class="id">h;</span> <span class="id">elim:</span> <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">a</span> <span class="id">[//|b</span> <span class="id">[|c</span> <span class="id">t]]</span> <span class="id">ih</span> <span class="id">def</span> <span class="id">h</span> <span class="id">_</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">arbitrary2</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/arbitrary</span> <span class="id">/=</span> <span class="id">altA</span> <span class="id">altC</span> (<span class="id">altC</span> (<span class="id">Ret</span> <span class="id">b</span>)).<br/>
<span class="id">-</span> <span class="id">move:</span> (<span class="id">ih</span> <span class="id">a</span> <span class="id">h</span> <span class="id">erefl</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">/arbitrary</span> <span class="id">/=</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="id">move:</span> (<span class="id">ih</span> <span class="id">h</span> <span class="id">a</span> <span class="id">erefl</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">/arbitrary</span> <span class="id">/=</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">altCA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_naturality</span> (<span class="id">T</span> <span class="id">U</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">T</span>) (<span class="id">b</span> <span class="id">:</span> <span class="id">U</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">U</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">x,</span> <span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">x</span> <span class="id">-&gt;</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">arbitrary</span> <span class="id">a</span>) <span class="id">x</span> <span class="id">=</span> (<span class="id">arbitrary</span> <span class="id">b</span> <span class="id">\o</span> <span class="id">map</span> <span class="id">f</span>) <span class="id">x</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof12')">Proof.</span></div>
<div class="proofscript" id="proof12">
<span class="id">elim=&gt;</span> <span class="id">//</span> <span class="id">x</span> <span class="id">[_</span> <span class="id">_</span> <span class="id">|</span> <span class="id">x'</span> <span class="id">xs</span> <span class="id">/</span>(<span class="id">_</span> <span class="id">isT</span>)<span class="id">]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]compE</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">_]/=</span> <span class="id">fmapE</span> <span class="id">=&gt;</span> <span class="id">ih</span> <span class="id">_</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]compE</span> <span class="id">[in</span> <span class="id">RHS]/=</span> <span class="id">[in</span> <span class="id">RHS]</span>(<span class="id">arbitrary_cons</span> <span class="id">b</span>) <span class="id">//</span> <span class="id">[in</span> <span class="id">LHS]compE</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]arbitrary_cons</span> <span class="id">//</span> <span class="id">fmapE</span> <span class="id">/=</span> <span class="id">alt_bindDl</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">ih</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">mpair_arbitrary_base_case</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">a</span> <span class="id">x</span> (<span class="id">y</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">y</span>)<span class="id">%nat</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> (<span class="id">a,</span> <span class="id">a</span>) (<span class="id">cp</span> <span class="id">[::</span> <span class="id">x]</span> <span class="id">y</span>) <span class="id">=</span> <span class="id">mpair</span> (<span class="id">arbitrary</span> <span class="id">a</span> <span class="id">[::</span> <span class="id">x],</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">y</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof13')">Proof.</span></div>
<div class="proofscript" id="proof13">
<span class="id">move=&gt;</span> <span class="id">y0;</span> <span class="id">rewrite</span> <span class="id">cp1</span>.<br/>
<span class="id">transitivity</span> (<span class="id">arbitrary</span> <span class="id">a</span> <span class="id">y</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y'</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x,</span> <span class="id">y'</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">arbitrary</span> <span class="id">_</span>)) <span class="id">-</span>(<span class="id">arbitrary_naturality</span> <span class="id">a</span>) <span class="id">//</span> <span class="id">compE</span> <span class="id">fmapE</span>.<br/>
<span class="id">transitivity</span> (<span class="id">do</span> <span class="id">z</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">x;</span> <span class="id">do</span> <span class="id">y'</span> <span class="id">&lt;-</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">y;</span> <span class="id">Ret</span> (<span class="id">z,</span> <span class="id">y'</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">%Do</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">[]</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_cat</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">T</span>) <span class="id">s</span> <span class="id">t</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">m</span> <span class="id">:=</span> <span class="id">size</span> <span class="id">s</span> <span class="gallina-kwd">in</span> <span class="gallina-kwd">let</span> <span class="id">n</span> <span class="id">:=</span> <span class="id">size</span> <span class="id">t</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">0</span> <span class="id">&lt;</span> <span class="id">m</span> <span class="id">-&gt;</span> <span class="id">0</span> <span class="id">&lt;</span> <span class="id">n</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">a</span> (<span class="id">s</span> <span class="id">++</span> <span class="id">t</span>) <span class="id">=</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">s</span> <span class="id">[~]</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">t</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof14')">Proof.</span></div>
<div class="proofscript" id="proof14">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">[//|s1</span> <span class="id">s2</span> <span class="id">IH]</span>.<br/>
<span class="id">elim/last_ind</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">t1</span> <span class="id">t2</span> <span class="id">_</span> <span class="id">m</span> <span class="id">n</span> <span class="id">m0</span> <span class="id">n0</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">cat_cons</span> <span class="id">[in</span> <span class="id">LHS]arbitrary_cons;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_cat</span> <span class="id">size_rcons</span> <span class="id">addnS</span>.<br/>
<span class="id">destruct</span> <span class="id">s2</span> <span class="gallina-kwd">as</span> <span class="id">[|s2</span> <span class="id">s3]</span> <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">IH</span> <span class="id">//</span> <span class="id">altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]arbitrary_cons</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">mpair_arbitrary</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">a</span> (<span class="id">x</span> <span class="id">y</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">x</span> <span class="id">-&gt;</span> <span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">y</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">mpair</span> (<span class="id">arbitrary</span> <span class="id">a</span> <span class="id">x,</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">y</span>) <span class="id">=</span> <span class="id">arbitrary</span> (<span class="id">a,</span> <span class="id">a</span>) (<span class="id">cp</span> <span class="id">x</span> <span class="id">y</span>) <span class="id">:&gt;</span> <span class="id">M</span> (<span class="id">T</span> <span class="id">*</span> <span class="id">T</span>)<span class="id">%type</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof15')">Proof.</span></div>
<div class="proofscript" id="proof15">
<span class="id">elim:</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">x;</span> <span class="id">case=&gt;</span> <span class="id">[_</span> <span class="id">y</span> <span class="id">_</span> <span class="id">size_y|x'</span> <span class="id">xs</span> <span class="id">IH</span> <span class="id">y</span> <span class="id">_</span> <span class="id">size_y];</span> <span class="id">apply/esym</span>.<br/>
&nbsp;&nbsp;<span class="id">exact/mpair_arbitrary_base_case</span>.<br/>
<span class="id">set</span> <span class="id">xxs</span> <span class="id">:=</span> <span class="id">x'</span> <span class="id">::</span> <span class="id">xs</span>.<br/>
<span class="id">rewrite</span> <span class="id">/cp</span> <span class="id">-cat1s</span> <span class="id">allpairs_cat</span> <span class="id">-/</span>(<span class="id">cp</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">cp1</span> <span class="id">/=</span> <span class="id">arbitrary_cat;</span> <span class="id">last</span> <span class="id">2</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_map</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_cat</span> <span class="id">size_map</span> <span class="id">addn_gt0</span> <span class="id">size_y</span>.<br/>
<span class="id">pose</span> <span class="id">n</span> <span class="id">:=</span> <span class="id">size</span> <span class="id">y</span>.<br/>
<span class="id">pose</span> <span class="id">l</span> <span class="id">:=</span> <span class="id">size</span> (<span class="id">cp</span> <span class="id">xxs</span> <span class="id">y</span>).<br/>
<span class="id">rewrite</span> <span class="id">-IH</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">-/xxs</span>.<br/>
<span class="id">move:</span> (<span class="id">mpair_arbitrary_base_case</span> <span class="id">a</span> <span class="id">x</span> <span class="id">size_y</span>).<br/>
<span class="id">rewrite</span> <span class="id">{1}/cp</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">arbitrary</span> <span class="id">_</span> <span class="id">X]/=</span> <span class="id">cats0</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
<span class="id">rewrite</span> <span class="id">-alt_bindDl</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-arbitrary_cat</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_inde</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">a</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">T</span>) <span class="id">{U}</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">U</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">s</span> <span class="id">-&gt;</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">m</span> <span class="id">=</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof16')">Proof.</span></div>
<div class="proofscript" id="proof16">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">a</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">h</span> <span class="id">[_</span> <span class="id">a</span> <span class="id">m</span> <span class="id">_|h'</span> <span class="id">t</span> <span class="id">ih</span> <span class="id">a</span> <span class="id">m</span> <span class="id">_]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">arbitrary1</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">arbitrary_cons</span> <span class="id">//</span> <span class="id">alt_bindDl</span> <span class="id">ih</span> <span class="id">//</span> <span class="id">bindretf</span> <span class="id">altmm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">perm_eq_arbitrary</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) <span class="id">def</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">perm_eq</span> <span class="id">a</span> <span class="id">b</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> <span class="id">a</span> <span class="id">=</span> <span class="id">arbitrary</span> <span class="id">def</span> <span class="id">b</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof17')">Proof.</span></div>
<div class="proofscript" id="proof17">
<span class="id">elim:</span> <span class="id">a</span> <span class="id">def</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[def</span> <span class="id">b|</span> <span class="id">h</span> <span class="id">[|t1</span> <span class="id">t2]</span> <span class="id">ih</span> <span class="id">def</span> <span class="id">b]</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">move/perm_size/esym/size0nil</span> <span class="id">-&gt;</span>.<br/>
<span class="id">-</span> <span class="id">move:</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[/perm_size//|b1];</span> <span class="id">move</span> <span class="id">=&gt;</span> <span class="id">[|b2</span> <span class="id">b3</span> <span class="id">/perm_size//]</span>.<br/>
&nbsp;&nbsp;<span class="id">move/perm_consP</span> <span class="id">=&gt;</span> <span class="id">[i</span> <span class="id">[s</span> <span class="id">[ihb1s</span> <span class="id">/perm_size/size0nil</span> <span class="id">s0]]]</span>.<br/>
&nbsp;&nbsp;<span class="id">move:</span> <span class="id">ihb1s;</span> <span class="id">rewrite</span> <span class="id">s0</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">move:</span> <span class="id">i</span> <span class="id">=&gt;</span> <span class="id">[/=|i];</span> <span class="id">[rewrite</span> <span class="id">rot0</span> <span class="id">=&gt;</span> <span class="id">-[-&gt;]|rewrite</span> <span class="id">/rot</span> <span class="id">/=</span> <span class="id">=&gt;</span> <span class="id">-[-&gt;]]</span>.<br/>
<span class="id">-</span> <span class="id">move=&gt;</span> <span class="id">htb</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">[b1</span> <span class="id">[b2</span> <span class="id">bE]]</span> <span class="id">:</span> <span class="gallina-kwd">exists</span> <span class="id">b1</span> <span class="id">b2,</span> <span class="id">b</span> <span class="id">=</span> <span class="id">rcons</span> <span class="id">b1</span> <span class="id">h</span> <span class="id">++</span> <span class="id">b2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span> <span class="id">:</span> <span class="id">h</span> <span class="id">\in</span> <span class="id">b</span> <span class="gallina-kwd">by</span> <span class="id">exact:</span> <span class="id">mem_rcons_cat</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">move:</span> <span class="id">htb</span> <span class="id">=&gt;</span> <span class="id">/perm_mem</span> <span class="id">/</span>(<span class="id">_</span> <span class="id">h</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">mem_head</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bE</span> <span class="id">arbitrary_cons</span> <span class="id">//</span> (<span class="id">ih</span> <span class="id">_</span> (<span class="id">b1</span> <span class="id">++</span> <span class="id">b2</span>))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move:</span> <span class="id">htb;</span> <span class="id">rewrite</span> <span class="id">bE</span> <span class="id">-cats1</span> <span class="id">-catA</span> <span class="id">perm_sym</span> (<span class="id">perm_catCA</span> <span class="id">b1</span> <span class="id">[::</span> <span class="id">h]</span> <span class="id">b2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">perm_cons</span> <span class="id">perm_sym</span>.<br/>
&nbsp;&nbsp;<span class="id">move:</span> <span class="id">b2</span> <span class="id">bE</span> <span class="id">=&gt;</span> <span class="id">[|b2</span> <span class="id">b3</span> <span class="id">bE]</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!cats0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move:</span> <span class="id">b1</span> <span class="id">=&gt;</span> <span class="id">[bE|b1</span> <span class="id">b11]</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">move:</span> <span class="id">htb;</span> <span class="id">rewrite</span> <span class="id">bE</span> <span class="id">=&gt;</span> <span class="id">/perm_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-cats1</span> <span class="id">arbitrary_cat//</span> <span class="id">arbitrary1</span> <span class="id">altC</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]arbitrary_cat</span> <span class="id">?size_rcons//</span>.<br/>
&nbsp;&nbsp;<span class="id">move:</span> <span class="id">b1</span> <span class="id">=&gt;</span> <span class="id">[//|b1</span> <span class="id">b11]</span> <span class="gallina-kwd">in</span> <span class="id">bE</span> <span class="id">*</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">arbitrary_cat//</span> <span class="id">altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-cats1</span> <span class="id">arbitrary_cat//</span> <span class="id">arbitrary1</span> <span class="id">altC</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_flatten</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">def</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">A</span>) <span class="id">:</span> (<span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">s</span>)<span class="id">%nat</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">arbitrary</span> <span class="id">def</span> <span class="id">s;</span> <span class="id">Ret</span> (<span class="id">f</span> <span class="id">x</span>))<span class="id">%Do</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> (<span class="id">flatten</span> <span class="id">[seq</span> <span class="id">[::</span> <span class="id">f</span> <span class="id">y]</span> <span class="id">|</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">s]</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof18')">Proof.</span></div>
<div class="proofscript" id="proof18">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">a</span> <span class="id">[_</span> <span class="id">f</span> <span class="id">_</span> <span class="id">/=|h</span> <span class="id">t</span> <span class="id">ih</span> <span class="id">f</span> <span class="id">_]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/arbitrary</span> <span class="id">/=</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[h</span> <span class="id">::</span> <span class="id">t]lock</span> <span class="id">/=</span> <span class="id">-lock</span> <span class="id">[in</span> <span class="id">RHS]arbitrary_cons//</span> <span class="id">-ih//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">arbitrary_cons//</span> <span class="id">alt_bindDl</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_flatten2</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">def</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">A</span>) <span class="id">:</span> (<span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">s</span>)<span class="id">%nat</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">arbitrary</span> <span class="id">def</span> <span class="id">s;</span> <span class="id">Ret</span> (<span class="id">f</span> <span class="id">x</span>) <span class="id">[~]</span> <span class="id">Ret</span> (<span class="id">g</span> <span class="id">x</span>))<span class="id">%Do</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> (<span class="id">flatten</span> <span class="id">[seq</span> <span class="id">[::</span> <span class="id">f</span> <span class="id">y;</span> <span class="id">g</span> <span class="id">y]</span> <span class="id">|</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">s]</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof19')">Proof.</span></div>
<div class="proofscript" id="proof19">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">def</span> <span class="id">f</span> <span class="id">g</span> <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
<span class="id">move=&gt;</span> <span class="id">h</span> <span class="id">[|t1</span> <span class="id">t2]</span> <span class="id">ih</span> <span class="id">def</span> <span class="id">f</span> <span class="id">g</span> <span class="id">_</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">arbitrary1</span> <span class="id">bindretf</span> <span class="id">arbitrary_cons</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">[t1</span> <span class="id">::</span> <span class="id">t2]lock</span> <span class="id">/=</span> <span class="id">-lock</span> <span class="id">[in</span> <span class="id">RHS]arbitrary_cons//</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]arbitrary_cons//</span> <span class="id">-ih//</span> <span class="id">arbitrary_cons//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">alt_bindDl</span> <span class="id">bindretf</span> <span class="id">altA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">arbitrary_lemmas</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">arbitrary_naturality</span> <span class="id">{M</span> <span class="id">T</span> <span class="id">U}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">perm_eq_arbitrary</span> <span class="id">{M</span> <span class="id">A}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">subsequences_of_a_list</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">subs</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">t'</span> <span class="id">:=</span> <span class="id">subs</span> <span class="id">t</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">fmap</span> (<span class="id">cons</span> <span class="id">h</span>) <span class="id">t'</span> <span class="id">[~]</span> <span class="id">t'</span>.<br/>
<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">subs_cons</span> <span class="id">x</span> (<span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">subs</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">xs</span>) <span class="id">=</span> <span class="gallina-kwd">let</span> <span class="id">t'</span> <span class="id">:=</span> <span class="id">subs</span> <span class="id">xs</span> <span class="gallina-kwd">in</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">x</span>) <span class="id">t'</span> <span class="id">[~]</span> <span class="id">t'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof20')">Proof.</span></div>
<div class="proofscript" id="proof20">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">subs_cat</span> (<span class="id">xs</span> <span class="id">ys</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">subs</span> (<span class="id">xs</span> <span class="id">++</span> <span class="id">ys</span>) <span class="id">=</span> <span class="id">do</span> <span class="id">us</span> <span class="id">&lt;-</span> <span class="id">subs</span> <span class="id">xs;</span> <span class="id">do</span> <span class="id">vs</span> <span class="id">&lt;-</span> <span class="id">subs</span> <span class="id">ys;</span> <span class="id">Ret</span> (<span class="id">us</span> <span class="id">++</span> <span class="id">vs</span>))<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof21')">Proof.</span></div>
<div class="proofscript" id="proof21">
<span class="id">elim:</span> <span class="id">xs</span> <span class="id">ys</span> <span class="id">=&gt;</span> <span class="id">[ys</span> <span class="id">|x</span> <span class="id">xs</span> <span class="id">ih</span> <span class="id">ys]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">cat0s</span> <span class="id">/=</span> <span class="id">bindretf</span> <span class="id">bindmret</span>.<br/>
<span class="id">rewrite</span> <span class="id">{1}[in</span> <span class="id">RHS]/subs</span> <span class="id">fmapE</span> <span class="id">-/</span>(<span class="id">subs</span> <span class="id">_</span>) <span class="id">alt_bindDl</span> <span class="id">bindA</span>.<br/>
<span class="vernacular">Open</span> (<span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">subs</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> <span class="id">X</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">cat_cons</span>.<br/>
&nbsp;&nbsp;<span class="id">over</span>.<br/>
<span class="id">rewrite</span> <span class="id">[X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">=</span> <span class="id">X</span> <span class="id">[~]</span> <span class="id">_]</span>(<span class="id">_</span> <span class="id">:</span> <span class="id">_</span> <span class="id">=</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">x</span>) (<span class="id">do</span> <span class="id">x0</span> <span class="id">&lt;-</span> <span class="id">subs</span> <span class="id">xs;</span> <span class="id">do</span> <span class="id">x1</span> <span class="id">&lt;-</span> <span class="id">subs</span> <span class="id">ys;</span> <span class="id">Ret</span> (<span class="id">x0</span> <span class="id">++</span> <span class="id">x1</span>)))<span class="id">%Do;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">x0</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindA</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-ih</span> <span class="id">cat_cons</span> <span class="id">subs_cons</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">subsequences_of_a_list</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">SyntaxNondet</span>.<br/>
<br/>
<span class="vernacular">Inductive</span> <span class="id">t</span> <span class="id">:</span> <span class="gallina-kwd">Type</span> <span class="id">-&gt;</span> <span class="gallina-kwd">Type</span> <span class="id">:=</span><br/>
<span class="id">|</span> <span class="id">ret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">t</span> <span class="id">A</span><br/>
<span class="id">|</span> <span class="id">bind</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">B</span> <span class="id">A,</span> <span class="id">t</span> <span class="id">B</span> <span class="id">-&gt;</span> (<span class="id">B</span> <span class="id">-&gt;</span> <span class="id">t</span> <span class="id">A</span>) <span class="id">-&gt;</span> <span class="id">t</span> <span class="id">A</span><br/>
<span class="id">|</span> <span class="id">fail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">t</span> <span class="id">A</span><br/>
<span class="id">|</span> <span class="id">alt</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">t</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">t</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">t</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">sem</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">nondetMonad}</span> <span class="id">{A}</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">t</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">m</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">ret</span> <span class="id">A</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">a</span><br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">bind</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">sem</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="id">sem</span> <span class="id">\o</span> <span class="id">f</span>)<br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">fail</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">hierarchy.fail</span><br/>
&nbsp;&nbsp;<span class="id">|</span> <span class="id">alt</span> <span class="id">A</span> <span class="id">m1</span> <span class="id">m2</span> <span class="id">=&gt;</span> <span class="id">sem</span> <span class="id">m1</span> <span class="id">[~]</span> <span class="id">sem</span> <span class="id">m2</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">end</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Exports</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">nondetSyntax</span> <span class="id">:=</span> <span class="id">t</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">ndAlt</span> <span class="id">:=</span> <span class="id">alt</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">ndRet</span> <span class="id">:=</span> <span class="id">ret</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">ndBind</span> <span class="id">:=</span> <span class="id">bind</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">ndFail</span> <span class="id">:=</span> <span class="id">fail</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">nondetSem</span> <span class="id">:=</span> <span class="id">sem</span>.<br/>
<span class="vernacular">End</span> <span class="id">Exports</span>.<br/>
<span class="vernacular">End</span> <span class="id">SyntaxNondet</span>.<br/>
<span class="vernacular">Export</span> <span class="id">SyntaxNondet.Exports</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">insert</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">insert</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">a]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">a</span> <span class="id">::</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">[~]</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">h</span>) (<span class="id">insert</span> <span class="id">a</span> <span class="id">t</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insertE</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">s</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> <span class="id">a</span> <span class="id">s</span> <span class="id">=</span> <span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">a]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">a</span> <span class="id">::</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">[~]</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">h</span>) (<span class="id">insert</span> <span class="id">a</span> <span class="id">t</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof22')">Proof.</span></div>
<div class="proofscript" id="proof22">
 <span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">s</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">insert</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">insert</span> <span class="id">:</span> <span class="id">simpl</span> <span class="id">never</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">insert_altMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_map</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> (<span class="id">f</span> <span class="id">a</span>) <span class="id">\o</span> <span class="id">map</span> <span class="id">f</span> <span class="id">=</span> <span class="id">map</span> <span class="id">f</span> (<span class="id">o</span>) <span class="id">insert</span> <span class="id">a</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof23')">Proof.</span></div>
<div class="proofscript" id="proof23">
<span class="id">apply</span> <span class="id">boolp.funext</span><span class="id">;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[|y</span> <span class="id">xs</span> <span class="id">IH]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">fmap</span> (<span class="id">map</span> <span class="id">f</span>))) (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">compE</span> <span class="id">insertE</span>.<br/>
<span class="id">apply/esym</span>.<br/>
<span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">alt_fmapDr</span>.<br/>
<span class="comment">(*&nbsp;first&nbsp;branch&nbsp;*)</span><br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">fmap</span> (<span class="id">map</span> <span class="id">f</span>))) (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">FIdE</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">[~]</span> <span class="id">_</span> <span class="id">]/=</span>.<br/>
<span class="comment">(*&nbsp;second&nbsp;branch&nbsp;*)</span><br/>
<span class="id">rewrite</span> <span class="id">-fmap_oE</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">map</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">cons</span> <span class="id">y</span> <span class="id">=</span> <span class="id">cons</span> (<span class="id">f</span> <span class="id">y</span>) <span class="id">\o</span> <span class="id">map</span> <span class="id">f</span>) <span class="id">//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmap_oE</span> <span class="id">-</span>(<span class="id">fcompE</span> (<span class="id">map</span> <span class="id">f</span>)) <span class="id">-IH</span> <span class="id">[RHS]/=</span> <span class="id">insertE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">Mmm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">idempotent</span> (<span class="id">@alt</span> <span class="id">_</span> <span class="id">A</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Variables</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">filter_insertN</span> <span class="id">a</span> <span class="id">:</span> <span class="id">~~</span> <span class="id">p</span> <span class="id">a</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">s,</span> (<span class="id">filter</span> <span class="id">p</span> (<span class="id">o</span>) <span class="id">insert</span> <span class="id">a</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">filter</span> <span class="id">p</span> <span class="id">s</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof24')">Proof.</span></div>
<div class="proofscript" id="proof24">
<span class="id">move=&gt;</span> <span class="id">pa;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">IH]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">fmap</span> <span class="id">_</span>)) (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">FIdE</span> <span class="id">/=</span> (<span class="id">negbTE</span> <span class="id">pa</span>).<br/>
<span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">alt_fmapDr</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">fmap</span> <span class="id">_</span>)) (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">FIdE</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">[~]</span> <span class="id">_]/=</span> (<span class="id">negbTE</span> <span class="id">pa</span>).<br/>
<span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">ph</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">-fmap_oE</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">filter</span> <span class="id">p</span> <span class="id">\o</span> <span class="id">cons</span> <span class="id">h</span> <span class="id">=</span> <span class="id">cons</span> <span class="id">h</span> <span class="id">\o</span> <span class="id">filter</span> <span class="id">p</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">ph</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">fmap_oE</span>.<br/>
&nbsp;&nbsp;<span class="id">move:</span> (<span class="id">IH</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">/=</span> <span class="id">ph</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">Mmm</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">-fmap_oE</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">filter</span> <span class="id">p</span> <span class="id">\o</span> <span class="id">cons</span> <span class="id">h</span> <span class="id">=</span> <span class="id">filter</span> <span class="id">p</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">/=;</span> <span class="id">rewrite</span> (<span class="id">negbTE</span> <span class="id">ph</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">move:</span> (<span class="id">IH</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span> <span class="id">/=;</span> <span class="id">rewrite</span> (<span class="id">negbTE</span> <span class="id">ph</span>) <span class="id">Mmm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">filter_insertT</span> <span class="id">a</span> <span class="id">:</span> <span class="id">p</span> <span class="id">a</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">filter</span> <span class="id">p</span> (<span class="id">o</span>) <span class="id">insert</span> <span class="id">a</span> <span class="id">=</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">\o</span> <span class="id">filter</span> <span class="id">p</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof25')">Proof.</span></div>
<div class="proofscript" id="proof25">
<span class="id">move=&gt;</span> <span class="id">pa;</span> <span class="id">apply</span> <span class="id">boolp.funext</span><span class="id">;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">IH]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">!insertE</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">pa</span>.<br/>
<span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">[in</span> <span class="id">RHS]/=;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">ph</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]insertE</span>.<br/>
&nbsp;&nbsp;<span class="id">move:</span> (<span class="id">IH</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">_]/=</span> <span class="id">=&gt;</span> <span class="id">&lt;-</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]insertE</span> <span class="id">alt_fmapDr;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">pa</span> <span class="id">ph</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!fmapE</span> <span class="id">/=</span> <span class="id">fcompE</span> <span class="id">bind_fmap</span> <span class="id">bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">[LHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">ph</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]insertE</span> <span class="id">alt_fmapDr</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">[~]</span> <span class="id">X</span> <span class="id">=</span> <span class="id">_]fmap_oE</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> (<span class="id">filter</span> <span class="id">p</span> <span class="id">\o</span> <span class="id">cons</span> <span class="id">h</span>) <span class="id">=</span> <span class="id">filter</span> <span class="id">p</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">/=;</span> <span class="id">rewrite</span> (<span class="id">negbTE</span> <span class="id">ph</span>).<br/>
&nbsp;&nbsp;<span class="id">move:</span> (<span class="id">IH</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">pa</span> (<span class="id">negbTE</span> <span class="id">ph</span>) <span class="id">[in</span> <span class="id">RHS]insertE;</span> <span class="id">case:</span> (<span class="id">filter</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="id">[|h'</span> <span class="id">t']</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE</span> <span class="id">Mmm</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!insertE</span> <span class="id">altA</span> <span class="id">Mmm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">insert_altMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">insert_altCIMonad</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>).<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_rcons</span> <span class="id">a'</span> <span class="id">s</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> <span class="id">a</span> (<span class="id">rcons</span> <span class="id">s</span> <span class="id">a'</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">s</span> <span class="id">++</span> <span class="id">[::</span> <span class="id">a';</span> <span class="id">a]</span>) <span class="id">[~]</span> <span class="id">fmap</span> (<span class="id">rcons^~</span> <span class="id">a'</span>) (<span class="id">insert</span> <span class="id">a</span> <span class="id">s</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof26')">Proof.</span></div>
<div class="proofscript" id="proof26">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">a'</span> <span class="id">=&gt;</span> <span class="id">[a'|s1</span> <span class="id">s2</span> <span class="id">IH</span> <span class="id">a']</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">cat0s</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">insertE</span> <span class="id">altC;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]/=</span> <span class="id">insertE</span> <span class="id">IH</span>.<br/>
<span class="id">rewrite</span> <span class="id">alt_fmapDr</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">[~]</span> <span class="id">X</span> <span class="id">=</span> <span class="id">_]fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">alt_fmapDr</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">=</span> <span class="id">_</span> <span class="id">[~]</span> <span class="id">X]fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-!fmap_oE</span> <span class="id">altCA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">rev_insert</span> <span class="id">:</span> <span class="id">rev</span> (<span class="id">o</span>) <span class="id">insert</span> <span class="id">a</span> <span class="id">=</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">\o</span> <span class="id">rev</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof27')">Proof.</span></div>
<div class="proofscript" id="proof27">
<span class="id">apply</span> <span class="id">boolp.funext</span><span class="id">;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">ih]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">compE</span> <span class="id">alt_fmapDr</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">compE</span> <span class="id">[in</span> <span class="id">RHS]rev_cons</span>.<br/>
<span class="id">rewrite</span> <span class="id">insert_rcons</span> <span class="id">rev_cons</span> <span class="id">-cats1</span> <span class="id">rev_cons</span> <span class="id">-cats1</span> <span class="id">-catA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
<span class="id">move:</span> <span class="id">ih;</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">[X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">_]/=</span> <span class="id">=&gt;</span> <span class="id">&lt;-</span>.<br/>
<span class="id">rewrite</span> <span class="id">-!fmap_oE</span>. <span class="id">congr</span> (<span class="id">fmap</span> <span class="id">_</span> (<span class="id">insert</span> <span class="id">a</span> <span class="id">t</span>)).<br/>
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">-rev_cons</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">insert_altCIMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">test_canonical</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">nondetMonad</span>) <span class="id">A</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">b</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">a</span> <span class="id">[~]</span> (<span class="id">fail</span> <span class="id">&gt;&gt;=</span> <span class="id">b</span>) <span class="id">=</span> <span class="id">a</span> <span class="id">[~]</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof28')">Proof.</span></div>
<div class="proofscript" id="proof28">
<span class="gallina-kwd">Set</span> <span class="id">Printing</span> <span class="id">All</span>.<br/>
<span class="id">Unset</span> <span class="id">Printing</span> <span class="id">All</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindfailf</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">insert_plusMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insertC</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">a</span> <span class="id">b</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">b</span> <span class="id">s;</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">x</span> <span class="id">=</span> <span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">s;</span> <span class="id">insert</span> <span class="id">b</span> <span class="id">x</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof29')">Proof.</span></div>
<div class="proofscript" id="proof29">
<span class="id">have</span> <span class="id">[n</span> <span class="id">ns]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">s</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">a</span> <span class="id">b</span>.<br/>
<span class="id">case:</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!insertE</span> <span class="id">!bindretf</span> <span class="id">!insertE</span> <span class="id">altC</span> <span class="id">!fmapE</span> <span class="id">!bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">ltnS</span> <span class="id">/=</span> <span class="id">=&gt;</span> <span class="id">ns</span>.<br/>
<span class="id">rewrite</span> (<span class="id">insertE</span> <span class="id">_</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>)) <span class="id">alt_bindDl</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]</span>(<span class="id">insertE</span> <span class="id">_</span> <span class="id">[::</span> <span class="id">b,</span> <span class="id">h</span> <span class="id">&amp;</span> <span class="id">t]</span>) <span class="id">[in</span> <span class="id">LHS]</span>(<span class="id">insertE</span> <span class="id">_</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>)).<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]</span>(<span class="id">insertE</span> <span class="id">_</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>)) <span class="id">[in</span> <span class="id">RHS]alt_bindDl</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">2![in</span> <span class="id">RHS]insertE</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]alt_fmapDr</span> <span class="id">![in</span> <span class="id">LHS]altA</span> <span class="id">[in</span> <span class="id">LHS]</span>(<span class="id">altC</span> (<span class="id">Ret</span> <span class="id">[::</span> <span class="id">a,</span> <span class="id">b,</span> <span class="id">h</span> <span class="id">&amp;</span> <span class="id">t]</span>)).<br/>
<span class="id">rewrite</span> <span class="id">-!altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">alt_fmapDr</span> <span class="id">-!altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]altC</span> <span class="id">bind_fmap</span> <span class="id">/=</span> <span class="id">[in</span> <span class="id">LHS]/comp</span> <span class="id">/=</span>.<br/>
<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insertE</span>.<br/>
<span class="id">rewrite</span> <span class="id">alt_bindDr</span>.<br/>
<span class="id">under</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">X</span>) <span class="id">[~]</span> <span class="id">_]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">fmapE</span>.<br/>
<span class="id">rewrite</span> <span class="id">-bindA</span> <span class="id">[in</span> <span class="id">LHS]ih</span> <span class="id">//</span> <span class="id">[in</span> <span class="id">RHS]altC</span> <span class="id">bind_fmap</span> <span class="id">/=</span> <span class="id">[in</span> <span class="id">RHS]/comp</span> <span class="id">/=</span>.<br/>
<span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insertE</span>.<br/>
<span class="id">rewrite</span> <span class="id">alt_bindDr</span> <span class="id">[in</span> <span class="id">RHS]altC</span> <span class="id">-!altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!fmapE</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">!bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]altC;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!fmapE</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">fmapE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_cat</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">h</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">u</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> <span class="id">h</span> (<span class="id">a</span> <span class="id">++</span> <span class="id">u</span> <span class="id">::</span> <span class="id">b</span>) <span class="id">=</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">h</span> <span class="id">a;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">++</span> <span class="id">u</span> <span class="id">::</span> <span class="id">b</span>))<span class="id">%Do</span> <span class="id">[~]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">h</span> <span class="id">b;</span> <span class="id">Ret</span> (<span class="id">a</span> <span class="id">++</span> <span class="id">u</span> <span class="id">::</span> <span class="id">x</span>))<span class="id">%Do</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof30')">Proof.</span></div>
<div class="proofscript" id="proof30">
<span class="id">elim:</span> <span class="id">a</span> <span class="id">h</span> <span class="id">u</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[h</span> <span class="id">u</span> <span class="id">b|a1</span> <span class="id">a2</span> <span class="id">ih</span> <span class="id">h</span> <span class="id">u</span> <span class="id">b]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> (<span class="id">insertE</span> <span class="id">h</span> <span class="id">nil</span>) <span class="id">bindretf</span> <span class="id">insertE</span> <span class="id">fmapE</span>.<br/>
<span class="id">rewrite</span> <span class="id">cat_cons</span> <span class="id">[in</span> <span class="id">LHS]insertE</span> <span class="id">[u</span> <span class="id">::</span> <span class="id">b]lock</span> <span class="id">/=</span> <span class="id">-lock</span> <span class="id">[in</span> <span class="id">LHS]ih</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]insertE</span> <span class="id">[in</span> <span class="id">RHS]alt_bindDl</span> <span class="id">bindretf</span> <span class="id">-altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]bind_fmap</span> <span class="id">[in</span> <span class="id">LHS]fmapE</span> <span class="id">[in</span> <span class="id">LHS]alt_bindDl</span> <span class="id">!bindA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">insert_plusMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">insert_nondetMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">nondetMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span>.<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_Ret</span> <span class="id">a</span> <span class="id">s</span> <span class="id">:</span> <span class="gallina-kwd">exists</span> <span class="id">m,</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">a</span> <span class="id">::</span> <span class="id">s</span>) <span class="id">[~]</span> <span class="id">m</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof31')">Proof.</span></div>
<div class="proofscript" id="proof31">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">[m</span> <span class="id">ih]]</span> <span class="id">/=;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">eexists;</span> <span class="id">rewrite</span> <span class="id">insertE;</span> <span class="id">reflexivity</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE;</span> <span class="gallina-kwd">exists</span> <span class="id">fail;</span> <span class="id">rewrite</span> <span class="id">altmfail</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">insert_nondetMonad</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">iperm</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span> <span class="id">iperm</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> <span class="id">insert</span> <span class="id">h</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">iperm_altMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_o_map</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">iperm</span> <span class="id">\o</span> <span class="id">map</span> <span class="id">f</span> <span class="id">=</span> <span class="id">map</span> <span class="id">f</span> (<span class="id">o</span>) <span class="id">iperm</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof32')">Proof.</span></div>
<div class="proofscript" id="proof32">
<span class="id">apply</span> <span class="id">boolp.funext</span><span class="id">;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[/=|x</span> <span class="id">xs</span> <span class="id">IH]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">[iperm</span> <span class="id">_]/=</span> <span class="id">-[in</span> <span class="id">RHS]compE</span> (<span class="id">natural</span> <span class="id">ret</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">[in</span> <span class="id">iperm</span> <span class="id">_]/=</span> <span class="id">fmap_bind</span> <span class="id">-insert_map</span> <span class="id">-bind_fmap</span> <span class="id">-fcompE</span> <span class="id">-IH</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">Mmm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">idempotent</span> (<span class="id">@alt</span> <span class="id">_</span> <span class="id">A</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Variables</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_filter</span> <span class="id">:</span> <span class="id">iperm</span> <span class="id">\o</span> <span class="id">filter</span> <span class="id">p</span> <span class="id">=</span> <span class="id">filter</span> <span class="id">p</span> (<span class="id">o</span>) <span class="id">iperm</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof33')">Proof.</span></div>
<div class="proofscript" id="proof33">
<span class="id">apply</span> <span class="id">boolp.funext</span><span class="id">;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">/=</span> <span class="id">IH]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">ph</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]/=</span> <span class="id">IH</span> <span class="id">[in</span> <span class="id">LHS]fcomp_def</span> <span class="id">compE</span> <span class="id">[in</span> <span class="id">LHS]bind_fmap</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]fcomp_def</span> <span class="id">compE</span> <span class="id">-/</span>(<span class="id">fmap</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">[in</span> <span class="id">RHS]fmap_bind;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">filter_insertT</span>.<br/>
<span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">fmap_bind</span> <span class="id">IH</span> <span class="id">fcompE</span> <span class="id">fmapE;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">filter_insertN</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">iperm_altMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">iperm_nondetMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">nondetMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span>.<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_is_alt_ret</span> <span class="id">s</span> <span class="id">:</span> <span class="gallina-kwd">exists</span> <span class="id">m,</span> <span class="id">iperm</span> <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">s</span> <span class="id">[~]</span> <span class="id">m</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof34')">Proof.</span></div>
<div class="proofscript" id="proof34">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">[m</span> <span class="id">ih]</span> <span class="id">/=];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> <span class="id">fail;</span> <span class="id">rewrite</span> <span class="id">altmfail</span>.<br/>
<span class="id">case:</span> (<span class="id">@insert_Ret</span> <span class="id">M</span> <span class="id">A</span> <span class="id">h</span> <span class="id">t</span>) <span class="id">=&gt;</span> <span class="id">n</span> <span class="id">Hn</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">eexists;</span> <span class="id">rewrite</span> <span class="id">ih</span> <span class="id">alt_bindDl</span> <span class="id">bindretf</span> <span class="id">Hn</span> <span class="id">-altA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">iperm_nondetMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">iperm_plusMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">plusMonad}</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_insert</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span> <span class="id">a</span> <span class="id">b</span> (<span class="id">s</span> <span class="id">t</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">iperm</span> (<span class="id">b</span> <span class="id">::</span> <span class="id">s</span> <span class="id">++</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">x</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">s</span> <span class="id">a</span> <span class="id">++</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">insert</span> <span class="id">b</span> <span class="id">x</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof35')">Proof.</span></div>
<div class="proofscript" id="proof35">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[/=|h</span> <span class="id">tl</span> <span class="id">ih]</span> <span class="gallina-kwd">in</span> <span class="id">a</span> <span class="id">b</span> <span class="id">t</span> <span class="id">*</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insertC</span>.<br/>
<span class="id">rewrite</span> <span class="id">[h</span> <span class="id">::</span> <span class="id">tl]lock</span> <span class="id">/=</span> <span class="id">-lock</span> <span class="id">ih</span> <span class="id">/=</span> <span class="id">!bindA</span>.<br/>
<span class="id">suff</span> <span class="id">:</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">tl</span> <span class="id">b</span> <span class="id">++</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">do</span> <span class="id">x0</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">x;</span> <span class="id">insert</span> <span class="id">h</span> <span class="id">x0</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">tl</span> <span class="id">a</span> <span class="id">++</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">do</span> <span class="id">x0</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">b</span> <span class="id">x;</span> <span class="id">insert</span> <span class="id">h</span> <span class="id">x0</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">%Do</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insertC</span>.<br/>
&nbsp;&nbsp;<span class="id">move=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insertC</span>.<br/>
<span class="id">rewrite</span> <span class="id">-bindA</span> <span class="id">-ih</span> <span class="id">/=</span> <span class="id">-bindA</span> <span class="id">-[in</span> <span class="id">RHS]ih</span> <span class="id">/=</span> <span class="id">!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a'</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-bindA</span> <span class="id">insertC</span> <span class="id">bindA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">perm_eq_iperm</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">perm_eq</span> <span class="id">a</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">iperm</span> <span class="id">a</span> <span class="id">=</span> <span class="id">iperm</span> <span class="id">b</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof36')">Proof.</span></div>
<div class="proofscript" id="proof36">
<span class="id">have</span> <span class="id">[n</span> <span class="id">na]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">a</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">a</span> <span class="id">na</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span> <span class="id">a</span> <span class="id">na</span> <span class="id">b</span>.<br/>
<span class="id">case:</span> <span class="id">a</span> <span class="id">na</span> <span class="id">=&gt;</span> <span class="id">[na|a1</span> <span class="id">a2];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">/perm_size/esym/size0nil</span> <span class="id">-&gt;</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">_]/=</span> <span class="id">ltnS</span> <span class="id">=&gt;</span> <span class="id">na</span>.<br/>
<span class="id">case:</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[/perm_size</span> <span class="id">//|b1</span> <span class="id">b2]</span>.<br/>
<span class="id">have</span> <span class="id">[a1b1|a1b1</span> <span class="id">ab]</span> <span class="id">:=</span> <span class="id">eqVneq</span> <span class="id">a1</span> <span class="id">b1</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">{}a1b1</span> <span class="id">perm_cons</span> <span class="id">=&gt;</span> <span class="id">ab</span> <span class="id">/=;</span> <span class="id">rewrite</span> (<span class="id">ih</span> <span class="id">_</span> <span class="id">na</span> <span class="id">b2</span>).<br/>
<span class="id">have</span> <span class="id">[b21</span> <span class="id">[b22</span> <span class="id">Hb]]</span> <span class="id">:</span> <span class="gallina-kwd">exists</span> <span class="id">b21</span> <span class="id">b22,</span> <span class="id">b2</span> <span class="id">=</span> <span class="id">rcons</span> <span class="id">b21</span> <span class="id">a1</span> <span class="id">++</span> <span class="id">b22</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">mem_rcons_cat</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">move/perm_mem</span> <span class="id">:</span> <span class="id">ab</span> <span class="id">=&gt;</span> <span class="id">/</span>(<span class="id">_</span> <span class="id">a1</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">mem_head</span> <span class="id">inE</span> (<span class="id">negbTE</span> <span class="id">a1b1</span>).<br/>
<span class="id">have</span> <span class="id">{}</span> <span class="id">:</span> <span class="id">perm_eq</span> <span class="id">a2</span> (<span class="id">b1</span> <span class="id">::</span> <span class="id">b21</span> <span class="id">++</span> <span class="id">b22</span>).<br/>
&nbsp;&nbsp;<span class="id">move:</span> <span class="id">ab;</span> <span class="id">rewrite</span> <span class="id">Hb</span> <span class="id">-cats1</span> <span class="id">-catA</span> <span class="id">-cat_cons</span> <span class="id">perm_sym</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">perm_catCA</span> <span class="id">perm_cons</span> <span class="id">perm_sym</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">/</span>(<span class="id">ih</span> <span class="id">_</span> <span class="id">na</span>) <span class="id">/=</span> <span class="id">-&gt;;</span> <span class="id">rewrite</span> <span class="id">Hb</span> <span class="id">iperm_insert</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_rcons</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) <span class="id">t</span> (<span class="id">x</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">t</span> <span class="id">x</span>) <span class="id">=</span> <span class="id">iperm</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof37')">Proof.</span></div>
<div class="proofscript" id="proof37">
 <span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">perm_eq_iperm;</span> <span class="id">rewrite</span> <span class="id">perm_rcons</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_insertC</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) <span class="id">x</span> <span class="id">y</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">do</span> <span class="id">s'</span> <span class="id">&lt;-</span> <span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">s</span> <span class="id">x</span>)<span class="id">;</span> <span class="id">insert</span> <span class="id">y</span> <span class="id">s'</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id">do</span> <span class="id">s'</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">y</span> <span class="id">s;</span> <span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">s'</span> <span class="id">x</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof38')">Proof.</span></div>
<div class="proofscript" id="proof38">
<span class="id">have</span> <span class="id">[n</span> <span class="id">ns]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">s</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span>.<br/>
<span class="id">move=&gt;</span> <span class="id">[/=</span> <span class="id">_</span> <span class="id">x</span> <span class="id">y|h</span> <span class="id">t]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!bindA</span> <span class="id">!bindretf</span> <span class="id">/=</span> <span class="id">bindA</span> <span class="id">bindretf</span> <span class="id">[in</span> <span class="id">RHS]insertE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">ltnS</span> <span class="id">/=</span> <span class="id">=&gt;</span> <span class="id">tn</span> <span class="id">x</span> <span class="id">y</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA</span> <span class="id">iperm_rcons</span> <span class="id">/=</span> <span class="id">!bindA</span> <span class="id">[in</span> <span class="id">RHS]insertE</span> <span class="id">alt_bindDl</span> <span class="id">bindretf</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA</span> <span class="id">iperm_rcons</span> <span class="id">/=</span> <span class="id">bindA</span> <span class="id">bind_fmap</span> <span class="id">/comp</span> <span class="id">/=</span> <span class="id">-[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">[~]X]bindA</span>.<br/>
<span class="id">rewrite</span> <span class="id">-ih//</span> <span class="id">bindA</span> <span class="id">iperm_rcons</span> <span class="id">/=</span> <span class="id">!bindA</span> <span class="id">-alt_bindDr;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">s'</span>.<br/>
<span class="id">rewrite</span> <span class="id">-alt_bindDr;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">t'</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertC</span> <span class="id">altmm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_rcons_bind</span> (<span class="id">E</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">E</span>) <span class="id">x</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">s</span> <span class="id">x</span>) <span class="id">=</span> <span class="id">iperm</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s'</span> <span class="id">=&gt;</span> <span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">s'</span> <span class="id">x</span>)) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof39')">Proof.</span></div>
<div class="proofscript" id="proof39">
<span class="id">have</span> <span class="id">[n</span> <span class="id">ns]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">s</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span>.<br/>
<span class="id">case=&gt;</span> <span class="id">[_</span> <span class="id">x|h</span> <span class="id">t];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">2!bindretf</span> <span class="id">/=</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">ltnS</span> <span class="id">/=</span> <span class="id">=&gt;</span> <span class="id">tn</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">ih//</span> <span class="id">!bindA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">-iperm_insertC</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_idempotent</span> (<span class="id">E</span> <span class="id">:</span> <span class="id">eqType</span>) <span class="id">:</span> <span class="id">iperm</span> <span class="id">&gt;=&gt;</span> <span class="id">iperm</span> <span class="id">=</span> <span class="id">iperm</span> <span class="id">:&gt;</span> (<span class="id">seq</span> <span class="id">E</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof40')">Proof.</span></div>
<div class="proofscript" id="proof40">
<span class="id">apply:</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">kleisliE</span>.<br/>
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">ih];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">-[in</span> <span class="id">RHS]ih</span> <span class="id">!bindA;</span> <span class="id">bind_ext</span>.<br/>
<span class="id">elim/last_ind</span> <span class="id">=&gt;</span> <span class="id">[|s</span> <span class="id">x</span> <span class="id">_]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE</span> <span class="id">/=</span> <span class="id">!bindretf</span> <span class="id">insertE</span> <span class="id">/=</span> <span class="id">bindretf</span> <span class="id">insertE</span>.<br/>
<span class="id">rewrite</span> <span class="id">iperm_insertC</span> <span class="id">insert_rcons</span> <span class="id">alt_bindDl</span> <span class="id">bind_fmap</span> <span class="id">/=</span> <span class="id">/comp</span> <span class="id">/=</span>.<br/>
<span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">iperm_rcons_bind</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindretf</span> (<span class="id">@perm_eq_iperm</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">rcons</span> <span class="id">s</span> <span class="id">x</span>))<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-cats1</span> <span class="id">-cat1s</span> <span class="id">catA</span> <span class="id">perm_catC</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">iperm_insertC</span> <span class="id">-alt_bindDr;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">s'</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">altmm</span> <span class="id">iperm_rcons_bind</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">iperm_plusMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">select</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">nondetMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">select</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">A</span>)<span class="id">%type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">fail</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;(<span class="id">Ret</span> (<span class="id">h,</span> <span class="id">t</span>) <span class="id">[~]</span> <span class="id">select</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span>.<span class="id">1,</span> <span class="id">h</span> <span class="id">::</span> <span class="id">x</span>.<span class="id">2</span>))).<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Obligation</span> <span class="vernacular">Tactic</span> <span class="id">:=</span> <span class="id">idtac</span>.<br/>
<span class="id">Program</span> <span class="vernacular">Fixpoint</span> <span class="id">tselect</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> (<span class="id">size</span> <span class="id">s</span>).<span class="id">-1</span>.<span class="id">-tuple</span> <span class="id">A</span>)<span class="id">%type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">fail</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">h,</span> <span class="id">@Tuple</span> (<span class="id">size</span> <span class="id">t</span>) <span class="id">A</span> <span class="id">t</span> <span class="id">_</span>) <span class="id">[~]</span><br/>
&nbsp;&nbsp;<span class="id">tselect</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span>.<span class="id">1,</span> <span class="id">@Tuple</span> (<span class="id">size</span> <span class="id">t</span>) <span class="id">A</span> <span class="id">_</span> <span class="id">_</span> )).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof41')">Next Obligation.</span></div>
<div class="proofscript" id="proof41">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Defined.</div>
<div><span class="toggleproof" onclick="toggleDisplay('proof42')">Next Obligation.</span></div>
<div class="proofscript" id="proof42">
<span class="id">move=&gt;</span> <span class="id">s</span> <span class="id">h</span> <span class="id">[|h'</span> <span class="id">t]</span> <span class="id">hts</span> <span class="id">[x1</span> <span class="id">x2];</span> <span class="id">[exact:</span> <span class="id">[::]</span> <span class="id">|</span> <span class="id">exact:</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">x2</span>)<span class="id">]</span>.<br/>
Defined.</div>
<div><span class="toggleproof" onclick="toggleDisplay('proof43')">Next Obligation.</span></div>
<div class="proofscript" id="proof43">
<span class="id">move=&gt;</span> <span class="id">s</span> <span class="id">h</span> <span class="id">[|h'</span> <span class="id">t]</span> <span class="id">hts</span> <span class="id">[x1</span> <span class="id">x2]</span> <span class="id">//=;</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_tuple</span>.<br/>
Defined.</div>
<div><span class="toggleproof" onclick="toggleDisplay('proof44')">Next Obligation.</span></div>
<div class="proofscript" id="proof44">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Defined.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">tselect_nil</span> <span class="id">:</span> <span class="id">tselect</span> <span class="id">[::]</span> <span class="id">=</span> <span class="id">fail</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof45')">Proof.</span></div>
<div class="proofscript" id="proof45">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">tselect1</span> <span class="id">a</span> <span class="id">:</span> <span class="id">tselect</span> <span class="id">[::</span> <span class="id">a]</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">a,</span> <span class="id">[tuple]</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof46')">Proof.</span></div>
<div class="proofscript" id="proof46">
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">bindfailf</span> <span class="id">altmfail</span> <span class="id">/tselect_obligation_1</span> <span class="id">/=</span> <span class="id">tupleE</span> <span class="id">/nil_tuple</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">do</span> <span class="id">3</span> <span class="id">f_equal;</span> <span class="id">apply</span> <span class="id">eq_irrelevance</span>.<br/>
Qed.</div>
<br/>
<span class="id">Program</span> <span class="vernacular">Definition</span> <span class="id">tselect_cons_statement</span> <span class="id">a</span> <span class="id">t</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">t</span> <span class="id">&lt;&gt;</span> <span class="id">nil</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">tselect</span> (<span class="id">a</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">=</span> <span class="id">Ret</span> (<span class="id">a,</span> <span class="id">@Tuple</span> <span class="id">_</span> <span class="id">_</span> <span class="id">t</span> <span class="id">_</span>) <span class="id">[~]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tselect</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span>.<span class="id">1,</span> <span class="id">@Tuple</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">a</span> <span class="id">::</span> <span class="id">x</span>.<span class="id">2</span>) <span class="id">_</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof47')">Next Obligation.</span></div>
<div class="proofscript" id="proof47">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Defined.</div>
<div><span class="toggleproof" onclick="toggleDisplay('proof48')">Next Obligation.</span></div>
<div class="proofscript" id="proof48">
<span class="id">move=&gt;</span> <span class="id">a</span> <span class="id">t</span> <span class="id">t0</span> <span class="id">[x1</span> <span class="id">x2]</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">size_tuple</span> <span class="id">prednK</span> <span class="id">//;</span> <span class="gallina-kwd">by</span> <span class="id">destruct</span> <span class="id">t</span>.<br/>
Defined.</div>
<br/>
<span class="id">Program</span> <span class="vernacular">Lemma</span> <span class="id">tselect_cons</span> <span class="id">a</span> <span class="id">t</span> (<span class="id">Ht</span> <span class="id">:</span> <span class="id">t</span> <span class="id">&lt;&gt;</span> <span class="id">nil</span>) <span class="id">:</span> <span class="id">tselect_cons_statement</span> <span class="id">a</span> <span class="id">Ht</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof49')">Proof.</span></div>
<div class="proofscript" id="proof49">
<span class="id">rewrite</span> <span class="id">/tselect_cons_statement</span> <span class="id">[in</span> <span class="id">LHS]/=;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
<span class="id">bind_ext;</span> <span class="id">case=&gt;</span> <span class="id">x1</span> <span class="id">x2</span> <span class="id">/=</span>.<br/>
<span class="id">do</span> <span class="id">2</span> <span class="id">f_equal;</span> <span class="id">apply</span> <span class="id">val_inj</span> <span class="id">=&gt;</span> <span class="id">/=;</span> <span class="gallina-kwd">by</span> <span class="id">destruct</span> <span class="id">t</span>.<br/>
Qed.</div>
<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">selectE</span> <span class="id">s</span> <span class="id">:</span> <span class="id">select</span> <span class="id">s</span> <span class="id">=</span> <span class="id">fmap</span> (<span class="gallina-kwd">fun</span> <span class="id">xy</span> <span class="id">=&gt;</span> (<span class="id">xy</span>.<span class="id">1,</span> <span class="id">tval</span> <span class="id">xy</span>.<span class="id">2</span>)) (<span class="id">tselect</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof50')">Proof.</span></div>
<div class="proofscript" id="proof50">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">[|h'</span> <span class="id">t]</span> <span class="id">IH]</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindfailf</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">tselect1</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">bindfailf</span> <span class="id">altmfail</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">{1}/select</span> <span class="id">-/</span>(<span class="id">select</span> (<span class="id">h'</span> <span class="id">::</span> <span class="id">t</span>)) <span class="id">IH</span> <span class="id">[in</span> <span class="id">RHS]alt_fmapDr</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">=</span> <span class="id">X</span> <span class="id">[~]</span> <span class="id">_]fmapE</span> <span class="id">bindretf;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bind_fmap</span> <span class="id">fmap_bind;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[x1</span> <span class="id">x2]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">decr_size_select</span> <span class="id">:</span> <span class="id">bassert_size</span> <span class="id">select</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof51')">Proof.</span></div>
<div class="proofscript" id="proof51">
<span class="id">case</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!selectE</span> <span class="id">fmap_fail</span> <span class="id">/bassert</span> <span class="id">bindfailf</span>.<br/>
<span class="id">rewrite</span> <span class="id">/bassert</span> <span class="id">selectE</span> <span class="id">bind_fmap</span> <span class="id">fmapE;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[x</span> <span class="id">y]</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">assertPn</span> <span class="id">=&gt;</span> <span class="id">//=;</span> <span class="id">rewrite</span> <span class="id">size_tuple</span> <span class="id">/=</span> <span class="id">ltnS</span> <span class="id">leqnn</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">select</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">select</span> <span class="id">{M}</span> <span class="id">{A}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">tselect</span> <span class="id">{M}</span> <span class="id">{A}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">permutations</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">nondetMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="gallina-kwd">Type</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Obligation</span> <span class="vernacular">Tactic</span> <span class="id">:=</span> <span class="id">idtac</span>.<br/>
<span class="id">Program</span> <span class="vernacular">Definition</span> <span class="id">perms'</span> <span class="id">s</span><br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s',</span> <span class="id">size</span> <span class="id">s'</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">s</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>)) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">tselect</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">f</span> <span class="id">x</span>.<span class="id">2</span> <span class="id">_;</span> <span class="id">Ret</span> (<span class="id">x</span>.<span class="id">1</span> <span class="id">::</span> <span class="id">y</span>))<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof52')">Next Obligation.</span></div>
<div class="proofscript" id="proof52">
<span class="id">move=&gt;</span> <span class="id">s</span> <span class="id">H</span> <span class="id">h</span> <span class="id">t</span> <span class="id">hts</span> <span class="id">[y</span> <span class="id">ys];</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_tuple</span> <span class="id">-hts</span> <span class="id">ltnS</span> <span class="id">leqnn</span>.<br/>
Qed.</div>
<div><span class="toggleproof" onclick="toggleDisplay('proof53')">Next Obligation.</span></div>
<div class="proofscript" id="proof53">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">perms</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">Fix</span> (<span class="id">@well_founded_size</span> <span class="id">_</span>) (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">perms'</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">tpermsE</span> <span class="id">s</span> <span class="id">:</span> (<span class="id">perms</span> <span class="id">s</span> <span class="id">=</span> <span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">tselect</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">perms</span> <span class="id">x</span>.<span class="id">2;</span> <span class="id">Ret</span> (<span class="id">x</span>.<span class="id">1</span> <span class="id">::</span> <span class="id">y</span>))<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof54')">Proof.</span></div>
<div class="proofscript" id="proof54">
<span class="id">rewrite</span> <span class="id">{1}/perms</span> <span class="id">Init.Wf.Fix_eq</span> <span class="id">//;</span> <span class="id">[by</span> <span class="id">case:</span> <span class="id">s|move=&gt;</span> <span class="id">s'</span> <span class="id">f</span> <span class="id">g</span> <span class="id">H]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/perms';</span> <span class="id">destruct</span> <span class="id">s'</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">bind_ext=&gt;</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">H</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">permsE</span> <span class="id">s</span> <span class="id">:</span> (<span class="id">perms</span> <span class="id">s</span> <span class="id">=</span> <span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">select</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">perms</span> <span class="id">x</span>.<span class="id">2;</span> <span class="id">Ret</span> (<span class="id">x</span>.<span class="id">1</span> <span class="id">::</span> <span class="id">y</span>))<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof55')">Proof.</span></div>
<div class="proofscript" id="proof55">
<span class="id">rewrite</span> <span class="id">tpermsE;</span> <span class="id">case:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">h</span> <span class="id">t</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">selectE</span> <span class="id">bind_fmap</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">permutations</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">perms</span> <span class="id">{M}</span> <span class="id">{A}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">uperm</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">nondetMonad</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">uperm</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">unfoldM</span> (<span class="id">@well_founded_size</span> <span class="id">_</span>) (<span class="id">@nilp</span> <span class="id">_</span>) <span class="id">select</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">upermE</span> <span class="id">s</span> <span class="id">:</span> (<span class="id">uperm</span> <span class="id">s</span> <span class="id">=</span> <span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">do</span> <span class="id">a</span> <span class="id">&lt;-</span> <span class="id">select</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">;</span> <span class="id">do</span> <span class="id">b</span> <span class="id">&lt;-</span> <span class="id">uperm</span> <span class="id">a</span>.<span class="id">2;</span> <span class="id">Ret</span> (<span class="id">a</span>.<span class="id">1</span> <span class="id">::</span> <span class="id">b</span>))<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof56')">Proof.</span></div>
<div class="proofscript" id="proof56">
<span class="id">rewrite</span> <span class="id">/uperm</span> <span class="id">unfoldME;</span> <span class="id">last</span> <span class="id">exact:</span> <span class="id">decr_size_select</span>.<br/>
<span class="id">case:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">h</span> <span class="id">t;</span> <span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">nilp</span> <span class="id">_</span> <span class="id">=</span> <span class="id">false</span>) <span class="id">//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[x1</span> <span class="id">x2]</span> <span class="id">;</span> <span class="id">rewrite</span> <span class="id">fmapE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">perms_uperm</span> <span class="id">s</span> <span class="id">:</span> <span class="id">perms</span> <span class="id">s</span> <span class="id">=</span> <span class="id">uperm</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof57')">Proof.</span></div>
<div class="proofscript" id="proof57">
<span class="id">move</span> <span class="id">Hn</span> <span class="id">:</span> (<span class="id">size</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">n</span>.<br/>
<span class="id">elim:</span> <span class="id">n</span> <span class="id">s</span> <span class="id">Hn</span> <span class="id">=&gt;</span> <span class="id">[|n</span> <span class="id">IH</span> <span class="id">[//|h</span> <span class="id">t]</span> <span class="id">/=</span> <span class="id">[tn]]</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">permsE</span> <span class="id">upermE</span>.<br/>
<span class="id">rewrite</span> <span class="id">tpermsE</span> <span class="id">upermE</span> <span class="id">selectE</span> <span class="id">bind_fmap;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">IH</span> <span class="id">//</span> <span class="id">size_tuple</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">uperm</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">uperm</span> <span class="id">{A}</span> <span class="id">{M}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">dassert</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">failMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">dassert</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>) <span class="id">a</span> <span class="id">:</span> <span class="id">M</span> <span class="id">{</span> <span class="id">a</span> <span class="id">|</span> <span class="id">p</span> <span class="id">a</span> <span class="id">}</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">Bool.bool_dec</span> (<span class="id">p</span> <span class="id">a</span>) <span class="id">true</span> <span class="id">is</span> <span class="id">left</span> <span class="id">pa</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">exist</span> <span class="id">_</span> <span class="id">_</span> <span class="id">pa</span>) <span class="gallina-kwd">else</span> <span class="id">fail</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bind_ext_dassert</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>) <span class="id">a</span> (<span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">{x</span> <span class="id">:</span> <span class="id">A</span> <span class="id">|</span> <span class="id">p</span> <span class="id">x}</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span> <span class="id">x</span> <span class="id">h,</span> <span class="id">p</span> <span class="id">x</span> <span class="id">-&gt;</span> <span class="id">m1</span> (<span class="id">exist</span> <span class="id">_</span> <span class="id">x</span> <span class="id">h</span>) <span class="id">=</span> <span class="id">m2</span> (<span class="id">exist</span> <span class="id">_</span> <span class="id">x</span> <span class="id">h</span>)) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">dassert</span> <span class="id">p</span> <span class="id">a</span> <span class="id">&gt;&gt;=</span> <span class="id">m1</span> <span class="id">=</span> <span class="id">dassert</span> <span class="id">p</span> <span class="id">a</span> <span class="id">&gt;&gt;=</span> <span class="id">m2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof58')">Proof.</span></div>
<div class="proofscript" id="proof58">
<span class="id">move=&gt;</span> <span class="id">m1m2;</span> <span class="id">have</span> <span class="id">[pa|pa]</span> <span class="id">:=</span> <span class="id">boolP</span> (<span class="id">p</span> <span class="id">a</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[x</span> <span class="id">px];</span> <span class="id">exact:</span> <span class="id">m1m2</span>.<br/>
<span class="id">rewrite</span> <span class="id">/dassert;</span> <span class="id">case:</span> <span class="id">Bool.bool_dec</span> <span class="id">=&gt;</span> <span class="id">[px|px];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">px</span> <span class="gallina-kwd">in</span> <span class="id">pa</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!bindfailf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">dassert</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">splits</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span>.<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">splits</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">A</span>)<span class="id">%type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">x</span> <span class="id">::</span> <span class="id">xs</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">[::],</span> <span class="id">[::]</span>) <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">splits</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">yz</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">yz</span>.<span class="id">1,</span> <span class="id">yz</span>.<span class="id">2</span>) <span class="id">[~]</span> <span class="id">Ret</span> (<span class="id">yz</span>.<span class="id">1,</span> <span class="id">x</span> <span class="id">::</span> <span class="id">yz</span>.<span class="id">2</span>)).<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">splits_bseq</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> ((<span class="id">size</span> <span class="id">s</span>).<span class="id">-bseq</span> <span class="id">A</span> <span class="id">*</span> (<span class="id">size</span> <span class="id">s</span>).<span class="id">-bseq</span> <span class="id">A</span>)<span class="id">%type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">x</span> <span class="id">::</span> <span class="id">xs</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">[bseq</span> <span class="id">of</span> <span class="id">[::]],</span> <span class="id">[bseq</span> <span class="id">of</span> <span class="id">[::]]</span>)<br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">splits_bseq</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">[bseq</span> <span class="id">of</span> <span class="id">x</span> <span class="id">::</span> <span class="id">ys],</span> <span class="id">widen_bseq</span> (<span class="id">leqnSn</span> <span class="id">_</span>) <span class="id">zs</span>) <span class="id">[~]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">widen_bseq</span> (<span class="id">leqnSn</span> <span class="id">_</span>) <span class="id">ys,</span> <span class="id">[bseq</span> <span class="id">of</span> <span class="id">x</span> <span class="id">::</span> <span class="id">zs]</span>)).<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">splits_bseqE</span> <span class="id">s</span> <span class="id">:</span> <span class="id">splits</span> <span class="id">s</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">fmap</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span> (<span class="id">bseqval</span> <span class="id">ys,</span> <span class="id">bseqval</span> <span class="id">zs</span>)) (<span class="id">splits_bseq</span> <span class="id">s</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof59')">Proof.</span></div>
<div class="proofscript" id="proof59">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">ih];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">{}ih</span> <span class="id">/=</span> <span class="id">!fmapE</span> <span class="id">2!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">alt_bindDl</span> <span class="id">2!bindretf</span>.<br/>
Qed.</div>
<span class="id">Local</span> <span class="vernacular">Close</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">splits</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">splits_examples</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>.<br/>
<br/>
<span class="vernacular">Example</span> <span class="id">splits0</span> <span class="id">:</span> <span class="id">@splits</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">[::]</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">[::],</span> <span class="id">[::]</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof60')">Proof.</span></div>
<div class="proofscript" id="proof60">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Example</span> <span class="id">splits2</span> <span class="id">:</span> <span class="id">@splits</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">[::</span> <span class="id">1;</span> <span class="id">2]</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">[::</span> <span class="id">1;</span> <span class="id">2],</span> <span class="id">[::]</span>) <span class="id">[~]</span> <span class="id">Ret</span> (<span class="id">[::</span> <span class="id">2],</span> <span class="id">[::</span> <span class="id">1]</span>) <span class="id">[~]</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">[::</span> <span class="id">1],</span> <span class="id">[::</span> <span class="id">2]</span>) <span class="id">[~]</span> <span class="id">Ret</span> (<span class="id">[::],</span> <span class="id">[::</span> <span class="id">1;</span> <span class="id">2]</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof61')">Proof.</span></div>
<div class="proofscript" id="proof61">
<span class="id">rewrite</span> <span class="id">/splits</span> <span class="id">bindA</span>.<br/>
<span class="id">repeat</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">alt_bindDl</span> <span class="id">!bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">altA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">splits_examples</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">splits_nondetMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">nondetMonad}</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">splits_guard_subseq</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">splits</span> <span class="id">s</span> <span class="id">=</span> <span class="id">splits</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">guard</span> <span class="id">[&amp;&amp;</span> <span class="id">subseq</span> <span class="id">x</span>.<span class="id">1</span> <span class="id">s,</span> <span class="id">subseq</span> <span class="id">x</span>.<span class="id">2</span> <span class="id">s</span> <span class="id">&amp;</span> <span class="id">perm_eq</span> (<span class="id">x</span>.<span class="id">1</span> <span class="id">++</span> <span class="id">x</span>.<span class="id">2</span>) <span class="id">s]</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">x</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof62')">Proof.</span></div>
<div class="proofscript" id="proof62">
<span class="id">have</span> <span class="id">[n</span> <span class="id">ns]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">s</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span> <span class="id">s</span> <span class="id">ns</span>.<br/>
<span class="id">move:</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">=&gt;</span> <span class="id">[ns</span> <span class="id">|h</span> <span class="id">t]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">perm_refl</span> <span class="id">guardT</span> <span class="id">bindskipf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">_]/=</span> <span class="id">ltnS</span> <span class="id">=&gt;</span> <span class="id">ns</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]/=</span> <span class="id">[splits</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>)<span class="id">]/=</span> <span class="id">bindA</span>.<br/>
<span class="id">rewrite</span> <span class="id">ih</span> <span class="id">//</span> <span class="id">[in</span> <span class="id">LHS]bindA</span> <span class="id">[in</span> <span class="id">RHS]bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span>.<br/>
<span class="id">rewrite</span> <span class="id">[subseq]lock</span> <span class="id">/=</span> <span class="id">-lock</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]bindA</span> <span class="id">[in</span> <span class="id">RHS]bindA</span>.<br/>
<span class="id">apply:</span> <span class="id">bind_ext_guard</span> <span class="id">=&gt;</span> <span class="id">/and3P[ta</span> <span class="id">tb</span> <span class="id">abt];</span> <span class="id">rewrite</span> <span class="id">[subseq]lock</span> <span class="id">/=</span> <span class="id">-lock</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindretf</span> <span class="id">alt_bindDl</span> <span class="id">!bindretf;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[subseq</span> (<span class="id">_</span> <span class="id">::</span> <span class="id">_</span>) <span class="id">_]/=</span> <span class="id">eqxx</span> <span class="id">ta</span> <span class="id">andTb</span> <span class="id">perm_cons</span> <span class="id">abt</span> <span class="id">andbT</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">subseq_trans</span> <span class="id">tb</span> (<span class="id">subseq_cons</span> <span class="id">_</span> <span class="id">_</span>)) <span class="id">guardT</span> <span class="id">bindskipf</span>.<br/>
<span class="id">rewrite</span> (<span class="id">subseq_trans</span> <span class="id">ta</span> (<span class="id">subseq_cons</span> <span class="id">_</span> <span class="id">_</span>)) <span class="id">andTb</span>.<br/>
<span class="id">rewrite</span> <span class="id">[subseq</span> (<span class="id">_</span> <span class="id">::</span> <span class="id">_</span>) <span class="id">_]/=</span> <span class="id">eqxx</span> <span class="id">tb</span> <span class="id">andTb</span>.<br/>
<span class="id">rewrite</span> <span class="id">-cat_rcons</span> <span class="id">-cats1</span> <span class="id">-catA</span> <span class="id">perm_catCA</span> <span class="id">perm_cons</span> <span class="id">abt</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">guardT</span> <span class="id">bindskipf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">dsplitsT</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">n</span> <span class="id">:=</span> <span class="id">{x</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">|</span> <span class="id">size</span> <span class="id">x</span>.<span class="id">1</span> <span class="id">+</span> <span class="id">size</span> <span class="id">x</span>.<span class="id">2</span> <span class="id">==</span> <span class="id">n}</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">dsplitsT1</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">n</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">dsplitsT</span> <span class="id">A</span> <span class="id">n</span>) <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">:=</span> (<span class="id">sval</span> <span class="id">a</span>).<span class="id">1</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">dsplitsT2</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">n</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">dsplitsT</span> <span class="id">A</span> <span class="id">n</span>) <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">:=</span> (<span class="id">sval</span> <span class="id">a</span>).<span class="id">2</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">dsplits</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">dsplitsT</span> <span class="id">A</span> (<span class="id">size</span> <span class="id">s</span>)) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">splits</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="id">dassert</span> <span class="id">[pred</span> <span class="id">n</span> <span class="id">|</span> <span class="id">size</span> <span class="id">n</span>.<span class="id">1</span> <span class="id">+</span> <span class="id">size</span> <span class="id">n</span>.<span class="id">2</span> <span class="id">==</span> <span class="id">size</span> <span class="id">s]</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">splits_nondetMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">splits_prePlusMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">prePlusMonad}</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">splits_guard</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">splits</span> <span class="id">s</span> <span class="id">=</span> <span class="id">splits</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">guard</span> (<span class="id">size</span> <span class="id">x</span>.<span class="id">1</span> <span class="id">+</span> <span class="id">size</span> <span class="id">x</span>.<span class="id">2</span> <span class="id">==</span> <span class="id">size</span> <span class="id">s</span>) <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">x</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof63')">Proof.</span></div>
<div class="proofscript" id="proof63">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">ih];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">addn0</span> <span class="id">eqxx</span> <span class="id">guardT</span> <span class="id">bindskipf</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">{1}ih</span> <span class="id">!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">alt_bindDl</span> <span class="id">!bindretf</span> <span class="id">/=</span> <span class="id">bindA</span> <span class="id">bindretf</span> <span class="id">alt_bindDr</span> <span class="id">addSn</span> <span class="id">addnS</span> <span class="id">eqSS</span>.<br/>
Qed.</div>
<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">dsplitsE</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">splits</span> <span class="id">s</span> <span class="id">=</span> <span class="id">fmap</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> (<span class="id">dsplitsT1</span> <span class="id">x,</span> <span class="id">dsplitsT2</span> <span class="id">x</span>)) (<span class="id">dsplits</span> <span class="id">s</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof64')">Proof.</span></div>
<div class="proofscript" id="proof64">
<span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">/dsplits</span> <span class="id">/=</span> <span class="id">bindA</span> <span class="id">[LHS]splits_guard;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span>.<br/>
<span class="id">rewrite</span> <span class="id">/dassert;</span> <span class="id">case:</span> <span class="id">Bool.bool_dec</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">[|/negP]</span> <span class="id">abs</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!bindretf</span> <span class="id">/=</span> <span class="id">abs</span> <span class="id">guardT</span> <span class="id">bindskipf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">negbTE</span> <span class="id">abs</span>) <span class="id">guardF</span> <span class="id">2!bindfailf</span>.<br/>
Qed.</div>
<span class="id">Local</span> <span class="vernacular">Close</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">splits_prePlusMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">qperm</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">T</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>).<br/>
<br/>
<span class="id">Equations?</span> <span class="id">qperm</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="gallina-kwd">by</span> <span class="id">wf</span> (<span class="id">size</span> <span class="id">s</span>) <span class="id">lt</span> <span class="id">:=</span><br/>
<span class="id">|</span> <span class="id">[::]</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">[::]</span><br/>
<span class="id">|</span> <span class="id">x</span> <span class="id">::</span> <span class="id">xs</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">splits_bseq</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span> <span class="id">liftM2</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">a</span> <span class="id">++</span> <span class="id">x</span> <span class="id">::</span> <span class="id">b</span>) (<span class="id">qperm</span> <span class="id">ys</span> <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>)) (<span class="id">qperm</span> <span class="id">zs</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof65')">Proof.</span></div>
<div class="proofscript" id="proof65">
<span class="id">apply</span> <span class="id">/ltP</span>.<br/>
<span class="id">exact:</span> (<span class="id">leq_ltn_trans</span> (<span class="id">size_bseq</span> <span class="id">ys</span>)).<br/>
<span class="id">apply</span> <span class="id">/ltP</span>.<br/>
<span class="id">exact:</span> (<span class="id">leq_ltn_trans</span> (<span class="id">size_bseq</span> <span class="id">zs</span>)).<br/>
Defined.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_nil</span> <span class="id">:</span> <span class="id">qperm</span> <span class="id">[::]</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">[::]</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof66')">Proof.</span></div>
<div class="proofscript" id="proof66">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_cons</span> <span class="id">x</span> <span class="id">xs</span> <span class="id">:</span> <span class="id">qperm</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">xs</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">splits</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">liftM2</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">a</span> <span class="id">++</span> <span class="id">x</span> <span class="id">::</span> <span class="id">b</span>) (<span class="id">qperm</span> <span class="id">ys</span>) (<span class="id">qperm</span> <span class="id">zs</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof67')">Proof.</span></div>
<div class="proofscript" id="proof67">
<span class="id">rewrite</span> <span class="id">qperm_equation_2</span> <span class="id">splits_bseqE</span> <span class="id">fmapE</span> <span class="id">bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[?</span> <span class="id">?]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="comment">(*&nbsp;rewrite&nbsp;{1}/qperm&nbsp;{1}(Fix_eq&nbsp;_&nbsp;_&nbsp;_&nbsp;qperm'_Fix)&nbsp;/=.<br/>
rewrite&nbsp;splitsE&nbsp;/=&nbsp;fmapE&nbsp;bindA;&nbsp;bind_ext&nbsp;=&gt;&nbsp;-[?&nbsp;?].<br/>
by&nbsp;rewrite&nbsp;bindretf.&nbsp;*)</span><br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">qpermE</span> <span class="id">:=</span> (<span class="id">qperm_nil,</span> <span class="id">qperm_cons</span>).<br/>
<br/>
<span class="vernacular">End</span> <span class="id">qperm</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">qperm</span> <span class="id">{M}</span> <span class="id">{A}</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">qperm_function</span>.<br/>
<span class="vernacular">Section</span> <span class="id">qperm_function</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">T</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>).<br/>
<br/>
<span class="id">Local</span> <span class="vernacular">Obligation</span> <span class="vernacular">Tactic</span> <span class="id">:=</span> <span class="id">idtac</span>.<br/>
<span class="id">Program</span> <span class="vernacular">Definition</span> <span class="id">qperm'</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>)<br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s',</span> <span class="id">size</span> <span class="id">s'</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">s</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>)) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">x</span> <span class="id">::</span> <span class="id">xs</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">splits_bseq</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span> <span class="id">liftM2</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">a</span> <span class="id">++</span> <span class="id">x</span> <span class="id">::</span> <span class="id">b</span>) (<span class="id">f</span> <span class="id">ys</span> <span class="id">_</span>) (<span class="id">f</span> <span class="id">zs</span> <span class="id">_</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof68')">Next Obligation.</span></div>
<div class="proofscript" id="proof68">
<span class="id">move=&gt;</span> <span class="id">[|h</span> <span class="id">t]</span> <span class="id">//</span> <span class="id">ht</span> <span class="id">x</span> <span class="id">xs</span> <span class="id">[xh</span> <span class="id">-&gt;]</span> <span class="id">[a</span> <span class="id">b]</span> <span class="id">ys</span> <span class="id">_</span> <span class="id">_</span> <span class="id">.</span><br/>
<span class="id">exact:</span> (<span class="id">leq_ltn_trans</span> (<span class="id">size_bseq</span> <span class="id">ys</span>)).<br/>
Qed.</div>
<div><span class="toggleproof" onclick="toggleDisplay('proof69')">Next Obligation.</span></div>
<div class="proofscript" id="proof69">
<span class="id">move=&gt;</span> <span class="id">[|h</span> <span class="id">t]</span> <span class="id">//</span> <span class="id">ht</span> <span class="id">x</span> <span class="id">xs</span> <span class="id">[xh</span> <span class="id">-&gt;]</span> <span class="id">[a</span> <span class="id">b]</span> <span class="id">_</span> <span class="id">zs</span> <span class="id">_</span>.<br/>
<span class="id">exact:</span> (<span class="id">leq_ltn_trans</span> (<span class="id">size_bseq</span> <span class="id">zs</span>)).<br/>
Qed.</div>
<div><span class="toggleproof" onclick="toggleDisplay('proof70')">Next Obligation.</span></div>
<div class="proofscript" id="proof70">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">qperm</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">Fix</span> (<span class="id">@well_founded_size</span> <span class="id">_</span>) (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">qperm'</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm'_Fix</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>)<br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">y,</span> (<span class="id">size</span> <span class="id">y</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">s</span>)<span class="id">%N</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>)) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span> <span class="id">y</span> (<span class="id">p</span> <span class="id">:</span> (<span class="id">size</span> <span class="id">y</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">s</span>)<span class="id">%N</span>)<span class="id">,</span> <span class="id">f</span> <span class="id">y</span> <span class="id">p</span> <span class="id">=</span> <span class="id">g</span> <span class="id">y</span> <span class="id">p</span>) <span class="id">-&gt;</span> <span class="id">qperm'</span> <span class="id">f</span> <span class="id">=</span> <span class="id">qperm'</span> <span class="id">g</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof71')">Proof.</span></div>
<div class="proofscript" id="proof71">
<span class="id">move=&gt;</span> <span class="id">H;</span> <span class="id">rewrite</span> <span class="id">/qperm';</span> <span class="id">case:</span> <span class="id">s</span> <span class="id">f</span> <span class="id">g</span> <span class="id">H</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">h</span> <span class="id">t</span> <span class="id">f</span> <span class="id">g</span> <span class="id">H</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">f</span> <span class="id">=</span> <span class="id">g</span>) <span class="id">//;</span> <span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">H</span>.<br/>
Qed.</div>
<span class="vernacular">End</span> <span class="id">qperm_function</span>.<br/>
<span class="vernacular">End</span> <span class="id">qperm_function</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">qperm_examples</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>.<br/>
<br/>
<span class="vernacular">Example</span> <span class="id">perm1</span> <span class="id">:</span> <span class="id">qperm</span> <span class="id">[::</span> <span class="id">1]%N</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">1]</span> <span class="id">:&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">nat</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof72')">Proof.</span></div>
<div class="proofscript" id="proof72">
<span class="id">rewrite</span> <span class="id">qperm_cons</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">qperm_nil</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">liftM2_ret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Example</span> <span class="id">perm2</span> <span class="id">:</span> <span class="id">qperm</span> <span class="id">[::</span> <span class="id">2;</span> <span class="id">1]</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">1;</span> <span class="id">2]</span> <span class="id">[~]</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">2;</span> <span class="id">1]</span> <span class="id">:&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">nat</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof73')">Proof.</span></div>
<div class="proofscript" id="proof73">
<span class="id">rewrite</span> <span class="id">qpermE</span> <span class="id">!bindA</span> <span class="id">bindretf</span> <span class="id">alt_bindDl</span> <span class="id">bindretf</span> <span class="id">/liftM2</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">repeat</span> <span class="id">rewrite</span> <span class="id">!qpermE</span> <span class="id">!bindA</span> <span class="id">bindretf</span> <span class="id">!bindretf</span> <span class="id">/=</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Example</span> <span class="id">perm3</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">qperm</span> <span class="id">[::</span> <span class="id">3;</span> <span class="id">2;</span> <span class="id">1]</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">1;</span> <span class="id">2;</span> <span class="id">3]</span> <span class="id">[~]</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">1;</span> <span class="id">3;</span> <span class="id">2]</span> <span class="id">[~]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> <span class="id">[::</span> <span class="id">2;</span> <span class="id">1;</span> <span class="id">3]</span> <span class="id">[~]</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">2;</span> <span class="id">3;</span> <span class="id">1]</span> <span class="id">[~]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> <span class="id">[::</span> <span class="id">3;</span> <span class="id">1;</span> <span class="id">2]</span> <span class="id">[~]</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">3;</span> <span class="id">2;</span> <span class="id">1]</span> <span class="id">:&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">nat</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof74')">Proof.</span></div>
<div class="proofscript" id="proof74">
<span class="id">rewrite</span> <span class="id">qpermE</span> <span class="id">!bindA</span>.<br/>
<span class="id">repeat</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">alt_bindDl</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">/liftM2</span>.<br/>
<span class="id">repeat</span> <span class="id">rewrite</span> <span class="id">!qpermE</span> <span class="id">/=</span> <span class="id">!bindA</span> <span class="id">!bindretf</span> <span class="id">!alt_bindDl</span> <span class="id">!bindretf</span> <span class="id">/=</span> <span class="id">!/liftM2</span>.<br/>
<span class="id">repeat</span> <span class="id">rewrite</span> <span class="id">!qpermE</span> <span class="id">!bindA</span> <span class="id">bindretf</span> <span class="id">!bindretf</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-altA</span> <span class="id">altACA</span> <span class="id">!altA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">qperm_examples</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">qperm_preserves_nondetMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">nondetMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_preserves_elements</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">qperm</span> <span class="id">s</span> <span class="id">=</span> <span class="id">qperm</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">guard</span> (<span class="id">perm_eq</span> <span class="id">x</span> <span class="id">s</span>) <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">x</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof75')">Proof.</span></div>
<div class="proofscript" id="proof75">
<span class="id">have</span> <span class="id">[n</span> <span class="id">ns]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">s</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span> <span class="id">s</span> <span class="id">ns</span>.<br/>
<span class="id">move:</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">=&gt;</span> <span class="id">[ns</span> <span class="id">|h</span> <span class="id">t]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">qperm_nil</span> <span class="id">bindretf</span> <span class="id">perm_refl</span> <span class="id">guardT</span> <span class="id">bindskipf</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">ltnS</span> <span class="id">=&gt;</span> <span class="id">ns;</span> <span class="id">rewrite</span> <span class="id">qperm_cons</span> <span class="id">bindA</span> <span class="id">splits_guard_subseq</span> <span class="id">!bindA</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b];</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">!bindA;</span> <span class="id">apply:</span> <span class="id">bind_ext_guard</span> <span class="id">=&gt;</span> <span class="id">/and3P[_</span> <span class="id">_</span> <span class="id">abt]</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindretf</span> <span class="id">/liftM2</span> <span class="id">/=</span> <span class="id">!bindA</span> <span class="id">ih;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">leq_trans</span> <span class="id">_</span> <span class="id">ns</span>) <span class="id">//</span> <span class="id">ltnS</span> <span class="id">-</span>(<span class="id">perm_size</span> <span class="id">abt</span>) <span class="id">size_cat</span> <span class="id">leq_addr</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a';</span> <span class="id">rewrite</span> <span class="id">!bindA;</span> <span class="id">apply:</span> <span class="id">bind_ext_guard</span> <span class="id">=&gt;</span> <span class="id">aa'</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindretf</span> <span class="id">!bindA</span> <span class="id">ih;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">leq_trans</span> <span class="id">_</span> <span class="id">ns</span>) <span class="id">//</span> <span class="id">ltnS</span> <span class="id">-</span>(<span class="id">perm_size</span> <span class="id">abt</span>) <span class="id">size_cat</span> <span class="id">leq_addl</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">b';</span> <span class="id">rewrite</span> <span class="id">!bindA;</span> <span class="id">apply:</span> <span class="id">bind_ext_guard</span> <span class="id">=&gt;</span> <span class="id">bb'</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindretf</span> <span class="id">-[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">=</span> <span class="id">X</span> <span class="id">&gt;&gt;</span> <span class="id">_]cat_rcons</span> <span class="id">-cats1</span> <span class="id">-catA</span> <span class="id">perm_catCA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">perm_cons</span> (<span class="id">perm_trans</span> (<span class="id">perm_cat</span> <span class="id">aa'</span> <span class="id">bb'</span>) <span class="id">abt</span>) <span class="id">guardT</span> <span class="id">bindskipf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">qperm_preserves_nondetMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">qperm_preserves_prePlusMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">prePlusMonad</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">qperm_preserves_size</span> <span class="id">A</span> <span class="id">:</span> <span class="id">preserves</span> (<span class="id">@qperm</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">size</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof76')">Proof.</span></div>
<div class="proofscript" id="proof76">
<span class="id">move=&gt;</span> <span class="id">s;</span> <span class="id">have</span> <span class="id">[n</span> <span class="id">ns]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">s</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span> <span class="id">s</span> <span class="id">ns</span>.<br/>
<span class="id">move:</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">=&gt;</span> <span class="id">[ns|p</span> <span class="id">s];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!qperm_nil</span> <span class="id">!bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">ltnS</span> <span class="id">=&gt;</span> <span class="id">ns;</span> <span class="id">rewrite</span> <span class="id">qpermE</span> <span class="id">!bindA</span> <span class="id">!dsplitsE</span> <span class="id">!fmapE</span> <span class="id">!bindA</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span> <span class="id">/=;</span> <span class="id">apply:</span> <span class="id">bind_ext_dassert</span> <span class="id">=&gt;</span> <span class="id">-[{}a</span> <span class="id">{}b</span> <span class="id">/=</span> <span class="id">abs</span> <span class="id">_]</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindretf</span> (<span class="id">bind_liftM2_size</span> <span class="id">_</span> <span class="id">_</span> <span class="id">1%N</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">x</span> <span class="id">y;</span> <span class="id">rewrite</span> <span class="id">size_cat</span> <span class="id">/=</span> <span class="id">addn1</span> <span class="id">-addnS</span>.<br/>
<span class="id">rewrite</span> <span class="id">{1}/liftM2</span> <span class="id">ih;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/dsplitsT1</span> <span class="id">/=</span> (<span class="id">leq_trans</span> <span class="id">_</span> <span class="id">ns</span>)<span class="id">//</span> <span class="id">ltnS</span> <span class="id">-</span>(<span class="id">eqP</span> <span class="id">abs</span>) <span class="id">leq_addr</span>.<br/>
<span class="id">rewrite</span> <span class="id">/liftM2</span> <span class="id">!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">xa;</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">ih;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/dsplitsT2</span> <span class="id">/=</span> (<span class="id">leq_trans</span> <span class="id">_</span> <span class="id">ns</span>)<span class="id">//</span> <span class="id">ltnS</span> <span class="id">-</span>(<span class="id">eqP</span> <span class="id">abs</span>) <span class="id">leq_addl</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">xb;</span> <span class="id">rewrite</span> <span class="id">!bindretf</span> <span class="id">/=</span> (<span class="id">eqP</span> <span class="id">abs</span>) <span class="id">addn1</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_preserves_size2</span> <span class="id">A</span> (<span class="id">x</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">B</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">qperm</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> <span class="id">f^~</span> (<span class="id">size</span> <span class="id">x</span>)) <span class="id">=</span> <span class="id">qperm</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x'</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x'</span> (<span class="id">size</span> <span class="id">x'</span>)) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof77')">Proof.</span></div>
<div class="proofscript" id="proof77">
<span class="id">transitivity</span> (<span class="id">qperm</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">y,</span> <span class="id">size</span> <span class="id">y</span>)) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x'</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x'</span>.<span class="id">1</span> <span class="id">x'</span>.<span class="id">2</span>)).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">qperm_preserves_size</span> <span class="id">bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bind_qperm_guard</span> <span class="id">A</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">B</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">qperm</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="id">qperm</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">guard</span> (<span class="id">size</span> <span class="id">s</span> <span class="id">==</span> <span class="id">size</span> <span class="id">x</span>) <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">x</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof78')">Proof.</span></div>
<div class="proofscript" id="proof78">
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">qperm_preserves_size2</span> <span class="id">s</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">guard</span> (<span class="id">size</span> <span class="id">s</span> <span class="id">==</span> <span class="id">b</span>) <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">a</span>)).<br/>
<span class="id">rewrite</span> <span class="id">eqxx</span> <span class="id">guardT</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindskipf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">qperm_preserves_prePlusMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">fastproduct</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">product</span> <span class="id">:=</span> <span class="id">foldr</span> <span class="id">muln</span> <span class="id">1</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">product0</span> <span class="id">s</span> <span class="id">:</span> <span class="id">O</span> <span class="id">\in</span> <span class="id">s</span> <span class="id">-&gt;</span> <span class="id">product</span> <span class="id">s</span> <span class="id">=</span> <span class="id">O</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof79')">Proof.</span></div>
<div class="proofscript" id="proof79">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">//=</span> <span class="id">h</span> <span class="id">t</span> <span class="id">ih;</span> <span class="id">rewrite</span> <span class="id">inE</span> <span class="id">=&gt;</span> <span class="id">/orP[/eqP</span> <span class="id">&lt;-|/ih</span> <span class="id">-&gt;];</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">?muln0</span> <span class="id">?mul0n</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">work</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">work</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">O</span> <span class="id">\in</span> <span class="id">s</span> <span class="gallina-kwd">then</span> <span class="id">fail</span> <span class="gallina-kwd">else</span> <span class="id">Ret</span> (<span class="id">product</span> <span class="id">s</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Work</span> <span class="id">s</span> <span class="id">:=</span> <span class="gallina-kwd">if</span> <span class="id">O</span> <span class="id">\in</span> <span class="id">s</span> <span class="gallina-kwd">then</span> <span class="id">@fail</span> <span class="id">M</span> <span class="id">nat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">Ret</span> (<span class="id">product</span> <span class="id">s</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">workE</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">next</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">n</span> (<span class="id">mx</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="gallina-kwd">if</span> <span class="id">n</span> <span class="id">==</span> <span class="id">0</span> <span class="gallina-kwd">then</span> <span class="id">fail</span> <span class="gallina-kwd">else</span> <span class="id">fmap</span> (<span class="id">muln</span> <span class="id">n</span>) <span class="id">mx</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">work</span> <span class="id">=</span> <span class="id">foldr</span> <span class="id">next</span> (<span class="id">Ret</span> <span class="id">1</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof80')">Proof.</span></div>
<div class="proofscript" id="proof80">
<span class="id">apply</span> <span class="id">foldr_universal</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">h</span> <span class="id">t;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">[/eqP</span> <span class="id">-&gt;</span> <span class="id">//|</span> <span class="id">h0]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/work</span> <span class="id">inE</span> <span class="id">eq_sym</span> (<span class="id">negbTE</span> <span class="id">h0</span>) <span class="id">[_</span> <span class="id">||</span> <span class="id">_]/=</span> <span class="id">fmap_if</span> <span class="id">fmap_fail</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">work</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">work</span> <span class="id">{M}</span>.<br/>
<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">exceptMonad</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">fastprod</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">catch</span> (<span class="id">work</span> <span class="id">s</span>) (<span class="id">Ret</span> <span class="id">O</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Fastprod</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">nat</span>) <span class="id">:=</span> <span class="id">@catch</span> <span class="id">M</span> <span class="id">nat</span> (<span class="id">work</span> <span class="id">s</span>) (<span class="id">Ret</span> <span class="id">O</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fastprodE</span> <span class="id">s</span> <span class="id">:</span> <span class="id">fastprod</span> <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">product</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof81')">Proof.</span></div>
<div class="proofscript" id="proof81">
<span class="id">rewrite</span> <span class="id">/fastprod</span> <span class="id">/work</span> <span class="id">fun_if</span> <span class="id">if_arg</span> <span class="id">catchfailm</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">catchret;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">/product0</span> <span class="id">&lt;-</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">fastproduct</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">addM</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">a</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">b</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">+</span> <span class="id">y</span>))).<br/>
<span class="vernacular">Notation</span> <span class="id">"a&nbsp;+m&nbsp;b"&nbsp;:=&nbsp;(addM&nbsp;a&nbsp;b)&nbsp;(at&nbsp;level&nbsp;50,&nbsp;format&nbsp;"a&nbsp;&nbsp;+m&nbsp;&nbsp;b"</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">mulM</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">a</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">b</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">*</span> <span class="id">y</span>))).<br/>
<span class="vernacular">Notation</span> <span class="id">"a&nbsp;*m&nbsp;b"&nbsp;:=&nbsp;(mulM&nbsp;a&nbsp;b)&nbsp;(at&nbsp;level&nbsp;50,&nbsp;format&nbsp;"a&nbsp;&nbsp;*m&nbsp;&nbsp;b"</span>).<br/>
<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">continuation_example</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">contMonad</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">wadler94_sect31</span> <span class="id">:</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> <span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> <span class="id">f</span> <span class="id">100</span>) <span class="id">=</span> <span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">100</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof82')">Proof.</span></div>
<div class="proofscript" id="proof82">
<span class="id">rewrite</span> <span class="id">{1}/addM</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">callcc</span> <span class="id">_</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">100</span>) <span class="id">?bindretf</span> <span class="id">//</span>.<br/>
<span class="id">transitivity</span> (<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">100</span>))<span class="id">;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">callcc1</span>.<br/>
<span class="id">transitivity</span> (<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">10</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">100</span>)))<span class="id">;</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">callcc2</span>.<br/>
<span class="id">rewrite</span> <span class="id">callcc3</span> <span class="id">//;</span> <span class="id">congr</span> <span class="id">callcc</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">continuation_example</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">shiftreset_examples</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">shiftresetMonad</span> <span class="id">nat</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">wadler94_sect32_1</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">reset</span> (<span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">100</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> <span class="id">100</span>))).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof83')">Proof.</span></div>
<div class="proofscript" id="proof83">
<span class="id">rewrite</span> <span class="id">/addM</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">transitivity</span> ((<span class="id">Ret</span> (<span class="id">10</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> <span class="id">100</span>))) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">y</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">congr</span> (<span class="id">bind</span> <span class="id">_</span> <span class="id">_</span>).<br/>
<span class="id">rewrite</span> <span class="id">shiftreset3</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">10;</span> <span class="id">_</span> <span class="id">=</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">shift</span> (<span class="id">@^~</span> <span class="id">100</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_;</span> <span class="id">Ret</span> (<span class="id">10</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> <span class="id">y</span>)))<span class="id">%Do;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">shiftreset4</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">wadler94_sect32_2</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">reset</span> (<span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">100</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">100</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof84')">Proof.</span></div>
<div class="proofscript" id="proof84">
<span class="id">rewrite</span> <span class="id">/addM</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">transitivity</span> (<span class="id">Ret</span> <span class="id">100</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">y</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">congr</span> (<span class="id">bind</span> <span class="id">_</span> <span class="id">_</span>).<br/>
<span class="id">rewrite</span> (<span class="id">shiftreset2</span> <span class="id">_</span> <span class="id">_</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">shiftreset_examples</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">refin</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">A</span> (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="gallina-kwd">Prop</span> <span class="id">:=</span> <span class="id">m1</span> <span class="id">[~]</span> <span class="id">m2</span> <span class="id">=</span> <span class="id">m2</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">"m1&nbsp;`&lt;=`&nbsp;m2"</span> <span class="id">:=</span> (<span class="id">refin</span> <span class="id">m1</span> <span class="id">m2</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_bindr</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>) <span class="id">A</span> <span class="id">B</span> (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">m1</span> <span class="id">`&lt;=`</span> <span class="id">m2</span>) <span class="id">-&gt;</span> (<span class="id">m1</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">`&lt;=`</span> <span class="id">m2</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof85')">Proof.</span></div>
<div class="proofscript" id="proof85">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">m12;</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">-alt_bindDl</span> <span class="id">m12</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_if</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>) <span class="id">A</span> (<span class="id">m1</span> <span class="id">m2</span> <span class="id">m1'</span> <span class="id">m2'</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">b</span> <span class="id">:</span> <span class="id">bool</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">b</span> <span class="id">-&gt;</span> <span class="id">m1</span> <span class="id">`&lt;=`</span> <span class="id">m1'</span>) <span class="id">-&gt;</span> (<span class="id">~~</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">m2'</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">if</span> <span class="id">b</span> <span class="gallina-kwd">then</span> <span class="id">m1</span> <span class="gallina-kwd">else</span> <span class="id">m2</span>) <span class="id">`&lt;=`</span> (<span class="gallina-kwd">if</span> <span class="id">b</span> <span class="gallina-kwd">then</span> <span class="id">m1'</span> <span class="gallina-kwd">else</span> <span class="id">m2'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof86')">Proof.</span></div>
<div class="proofscript" id="proof86">
 <span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[+</span> <span class="id">_|_];</span> <span class="id">exact</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">plus_isNondet</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">plusMonad}</span> <span class="id">A</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:=</span> <span class="id">{m</span> <span class="id">|</span> <span class="id">nondetSem</span> <span class="id">m</span> <span class="id">=</span> <span class="id">n}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">plus_commute</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">plusMonad}</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">plus_commute</span> <span class="id">A</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">B</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">C</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">plus_isNondet</span> <span class="id">m</span> <span class="id">-&gt;</span> <span class="id">commute</span> <span class="id">m</span> <span class="id">n</span> <span class="id">f</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof87')">Proof.</span></div>
<div class="proofscript" id="proof87">
<span class="id">case=&gt;</span> <span class="id">x;</span> <span class="id">elim:</span> <span class="id">x</span> <span class="id">m</span> <span class="id">n</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">[{}A</span> <span class="id">a</span> <span class="id">m</span> <span class="id">n</span> <span class="id">f</span> <span class="id">&lt;-|</span> <span class="id">D</span> <span class="id">{}A</span> <span class="id">n0</span> <span class="id">ih0</span> <span class="id">n1</span> <span class="id">ih1</span> <span class="id">m</span> <span class="id">n2</span> <span class="id">f</span> <span class="id">&lt;-</span> <span class="id">|</span><br/>
&nbsp;&nbsp;<span class="id">D</span> <span class="id">m</span> <span class="id">n</span> <span class="id">f</span> <span class="id">&lt;-</span> <span class="id">|</span> <span class="id">D</span> <span class="id">n0</span> <span class="id">ih0</span> <span class="id">n1</span> <span class="id">ih1</span> <span class="id">m</span> <span class="id">n2</span> <span class="id">f</span> <span class="id">&lt;-]</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">/commute</span> <span class="id">bindretf</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">/commute</span> <span class="id">/=</span> <span class="id">bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">eq_bind</span>. <span class="id">move=&gt;</span> <span class="id">x;</span> <span class="id">rewrite</span> (<span class="id">ih1</span> <span class="id">x</span>) <span class="id">//</span>. <span class="id">over</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">ih0</span> <span class="id">//;</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">-bindA</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">/commute</span> <span class="id">/=</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindfailf</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindmfail</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">/commute</span> <span class="id">/=</span> <span class="id">alt_bindDl</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">[RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">alt_bindDl</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">alt_bindDr</span> <span class="id">ih0</span> <span class="id">//</span> <span class="id">ih1</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">liftM2_isNondet</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">C</span>) (<span class="id">ma</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">mb</span> <span class="id">:</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">plus_isNondet</span> <span class="id">ma</span> <span class="id">-&gt;</span> <span class="id">plus_isNondet</span> <span class="id">mb</span> <span class="id">-&gt;</span> <span class="id">plus_isNondet</span> (<span class="id">liftM2</span> <span class="id">f</span> <span class="id">ma</span> <span class="id">mb</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof88')">Proof.</span></div>
<div class="proofscript" id="proof88">
<span class="id">move=&gt;</span> <span class="id">[s1</span> <span class="id">s1_ma]</span> <span class="id">[s2</span> <span class="id">s2_mb]</span>.<br/>
<span class="gallina-kwd">exists</span> (<span class="id">ndBind</span> <span class="id">s1</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">ndBind</span> <span class="id">s2</span> (<span class="gallina-kwd">fun</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">ndRet</span> (<span class="id">f</span> <span class="id">a</span> <span class="id">b</span>)))).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">s1_ma</span> <span class="id">/comp</span> <span class="id">/=</span> <span class="id">s2_mb</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">guard_isNondet</span> (<span class="id">b</span> <span class="id">:</span> <span class="id">bool</span>) <span class="id">:</span> <span class="id">plus_isNondet</span> (<span class="id">guard</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof89')">Proof.</span></div>
<div class="proofscript" id="proof89">
<span class="gallina-kwd">exists</span> (<span class="gallina-kwd">if</span> <span class="id">b</span> <span class="gallina-kwd">then</span> <span class="id">ndRet</span> <span class="id">tt</span> <span class="gallina-kwd">else</span> <span class="id">@ndFail</span> <span class="id">_</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">ifP;</span> <span class="id">rewrite</span> (<span class="id">guardT,</span> <span class="id">guardF</span>).<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_isNondet</span> <span class="id">A</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">a</span> <span class="id">:</span> <span class="id">plus_isNondet</span> (<span class="id">@insert</span> <span class="id">M</span> <span class="id">_</span> <span class="id">a</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof90')">Proof.</span></div>
<div class="proofscript" id="proof90">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">ih];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> (<span class="id">ndRet</span> <span class="id">[::</span> <span class="id">a]</span>).<br/>
<span class="id">rewrite</span> <span class="id">insertE</span> <span class="id">/=;</span> <span class="id">have</span> <span class="id">[syn</span> <span class="id">synE]</span> <span class="id">:=</span> <span class="id">ih</span>.<br/>
<span class="gallina-kwd">exists</span> (<span class="id">ndAlt</span> (<span class="id">ndRet</span> <span class="id">[::</span> <span class="id">a,</span> <span class="id">h</span> <span class="id">&amp;</span> <span class="id">t]</span>) (<span class="id">ndBind</span> <span class="id">syn</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">ndRet</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">x</span>)))).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">synE</span> <span class="id">fmapE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">splits_isNondet</span> <span class="id">A</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">plus_isNondet</span> (<span class="id">splits</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof91')">Proof.</span></div>
<div class="proofscript" id="proof91">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">ih</span> <span class="id">/=];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> (<span class="id">ndRet</span> (<span class="id">[::],</span> <span class="id">[::]</span>)).<br/>
<span class="id">have</span> <span class="id">[syn</span> <span class="id">syn_splits]</span> <span class="id">:=</span> <span class="id">ih</span>.<br/>
<span class="gallina-kwd">exists</span> (<span class="id">ndBind</span> <span class="id">syn</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">a,</span> <span class="id">b</span>) <span class="id">=&gt;</span> <span class="id">ndAlt</span> (<span class="id">ndRet</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">a,</span> <span class="id">b</span>)) (<span class="id">ndRet</span> (<span class="id">a,</span> <span class="id">h</span> <span class="id">::</span> <span class="id">b</span>)))).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">syn_splits;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">splits_bseq_isNondet</span> <span class="id">A</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">plus_isNondet</span> (<span class="id">splits_bseq</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof92')">Proof.</span></div>
<div class="proofscript" id="proof92">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">ih];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> (<span class="id">ndRet</span> (<span class="id">[bseq],</span> <span class="id">[bseq]</span>)).<br/>
<span class="id">have</span> <span class="id">[syn</span> <span class="id">syn_tsplits]</span> <span class="id">:=</span> <span class="id">ih</span>.<br/>
<span class="gallina-kwd">exists</span> (<span class="id">ndBind</span> <span class="id">syn</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">a,</span> <span class="id">b</span>) <span class="id">=&gt;</span> <span class="id">ndAlt</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ndRet</span> (<span class="id">[bseq</span> <span class="id">of</span> <span class="id">h</span> <span class="id">::</span> <span class="id">a],</span> <span class="id">widen_bseq</span> (<span class="id">leqnSn</span> <span class="id">_</span>) <span class="id">b</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ndRet</span> (<span class="id">widen_bseq</span> (<span class="id">leqnSn</span> <span class="id">_</span>) <span class="id">a,</span> <span class="id">[bseq</span> <span class="id">of</span> <span class="id">h</span> <span class="id">::</span> <span class="id">b]</span>)))).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">syn_tsplits;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_isNondet</span> <span class="id">A</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">plus_isNondet</span> (<span class="id">qperm</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof93')">Proof.</span></div>
<div class="proofscript" id="proof93">
<span class="id">have</span> <span class="id">[n</span> <span class="id">sn]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">s</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span> <span class="id">s</span> <span class="gallina-kwd">in</span> <span class="id">sn</span> <span class="id">*</span>.<br/>
<span class="id">move:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t]</span> <span class="gallina-kwd">in</span> <span class="id">sn</span> <span class="id">*;</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> (<span class="id">ndRet</span> <span class="id">[::]</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">qperm_nil</span>.<br/>
<span class="id">rewrite</span> <span class="id">qperm_cons</span> <span class="id">splits_bseqE</span> <span class="id">fmapE</span> <span class="id">bindA</span>.<br/>
<span class="id">have</span> <span class="id">[syn</span> <span class="id">syn_tsplits]</span> <span class="id">:=</span> <span class="id">splits_bseq_isNondet</span> <span class="id">t</span>.<br/>
<span class="id">have</span> <span class="id">liftM2_qperm_isNondet</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> (<span class="id">size</span> <span class="id">t</span>).<span class="id">-bseq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">plus_isNondet</span> (<span class="id">liftM2</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">++</span> <span class="id">h</span> <span class="id">::</span> <span class="id">y</span>) (<span class="id">qperm</span> <span class="id">a</span>) (<span class="id">qperm</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)).<br/>
&nbsp;&nbsp;<span class="id">apply:</span> <span class="id">liftM2_isNondet</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">apply:</span> <span class="id">ih</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">leq_ltn_trans</span> (<span class="id">size_bseq</span> <span class="id">a</span>)).<br/>
&nbsp;&nbsp;<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">leq_ltn_trans</span> (<span class="id">size_bseq</span> <span class="id">b</span>)).<br/>
<span class="gallina-kwd">exists</span> (<span class="id">ndBind</span> <span class="id">syn</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">sval</span> (<span class="id">liftM2_qperm_isNondet</span> <span class="id">a</span>.<span class="id">1</span> <span class="id">a</span>.<span class="id">2</span>))).<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">syn_tsplits;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf;</span> <span class="id">case:</span> (<span class="id">liftM2_qperm_isNondet</span> <span class="id">_</span> <span class="id">_</span>).<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">plus_commute</span>.<br/>
<br/>
<span class="vernacular">Arguments</span> <span class="id">plus_commute</span> <span class="id">{M</span> <span class="id">A}</span> <span class="id">m</span> <span class="id">{B}</span> <span class="id">n</span> <span class="id">{C}</span> <span class="id">f</span>.<br/>
<span class="id">#[global]</span> <span class="vernacular">Hint</span> <span class="id">Extern</span> <span class="id">0</span> (<span class="id">liftM2_isNondet</span> (<span class="id">guard</span> <span class="id">_</span>)) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">solve[exact:</span> <span class="id">liftM2_isNondet]</span> <span class="id">:</span> <span class="id">core</span>.<br/>
<span class="id">#[global]</span> <span class="vernacular">Hint</span> <span class="id">Extern</span> <span class="id">0</span> (<span class="id">plus_isNondet</span> (<span class="id">guard</span> <span class="id">_</span>)) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">solve[exact:</span> <span class="id">guard_isNondet]</span> <span class="id">:</span> <span class="id">core</span>.<br/>
<span class="id">#[global]</span> <span class="vernacular">Hint</span> <span class="id">Extern</span> <span class="id">0</span> (<span class="id">plus_isNondet</span> (<span class="id">insert</span> <span class="id">_</span> <span class="id">_</span>)) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">solve[exact:</span> <span class="id">insert_isNondet]</span> <span class="id">:</span> <span class="id">core</span>.<br/>
<span class="id">#[global]</span> <span class="vernacular">Hint</span> <span class="id">Extern</span> <span class="id">0</span> (<span class="id">plus_isNondet</span> (<span class="id">splits</span> <span class="id">_</span>)) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">solve[exact:</span> <span class="id">splits_isNondet]</span> <span class="id">:</span> <span class="id">core</span>.<br/>
<span class="id">#[global]</span> <span class="vernacular">Hint</span> <span class="id">Extern</span> <span class="id">0</span> (<span class="id">plus_isNondet</span> (<span class="id">splits_bseq</span> <span class="id">_</span>)) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">solve[exact:</span> <span class="id">splits_bseq_isNondet]</span> <span class="id">:</span> <span class="id">core</span>.<br/>
<span class="id">#[global]</span> <span class="vernacular">Hint</span> <span class="id">Extern</span> <span class="id">0</span> (<span class="id">plus_isNondet</span> (<span class="id">qperm</span> <span class="id">_</span>)) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">solve[exact:</span> <span class="id">qperm_isNondet]</span> <span class="id">:</span> <span class="id">core</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">splits_plusMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">plusMonad}</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">guard_splits</span> <span class="id">{T</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">T</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">T</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">T</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">splits</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">guard</span> (<span class="id">all</span> <span class="id">p</span> <span class="id">t</span>) <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">x</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">splits</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">guard</span> (<span class="id">all</span> <span class="id">p</span> <span class="id">x</span>.<span class="id">1</span>) <span class="id">&gt;&gt;</span> <span class="id">guard</span> (<span class="id">all</span> <span class="id">p</span> <span class="id">x</span>.<span class="id">2</span>) <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">x</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof94')">Proof.</span></div>
<div class="proofscript" id="proof94">
<span class="id">rewrite</span> <span class="id">-plus_commute//</span>.<br/>
<span class="id">elim:</span> <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">ih]</span> <span class="gallina-kwd">in</span> <span class="id">p</span> <span class="id">f</span> <span class="id">*;</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!bindretf</span> <span class="id">guardT</span> <span class="id">bindmskip</span>.<br/>
<span class="id">rewrite</span> <span class="id">[LHS]/=</span> <span class="id">guard_and</span> <span class="id">2!bindA</span> <span class="id">ih</span> <span class="id">/=</span> <span class="id">plus_commute//</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">!alt_bindDl</span> <span class="id">!bindretf</span> <span class="id">/=</span> <span class="id">!guard_and</span> <span class="id">!bindA</span> <span class="id">!alt_bindDr</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">plus_commute</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">guard_all_qperm</span> <span class="id">{T</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">T</span>) <span class="id">s</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">qperm</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">guard</span> (<span class="id">all</span> <span class="id">p</span> <span class="id">s</span>) <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">x</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">qperm</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">guard</span> (<span class="id">all</span> <span class="id">p</span> <span class="id">x</span>) <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">x</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof95')">Proof.</span></div>
<div class="proofscript" id="proof95">
<span class="id">rewrite</span> <span class="id">-plus_commute//</span>.<br/>
<span class="id">have</span> <span class="id">[n</span> <span class="id">leMn]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">s</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span> <span class="gallina-kwd">in</span> <span class="id">s</span> <span class="id">f</span> <span class="id">leMn</span> <span class="id">*</span>.<br/>
<span class="id">case:</span> <span class="id">s</span> <span class="id">leMn</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">_;</span> <span class="id">rewrite</span> <span class="id">qperm_nil</span> <span class="id">!bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">ltnS</span> <span class="id">=&gt;</span> <span class="id">tn</span>.<br/>
<span class="id">rewrite</span> <span class="id">qperm_cons</span> <span class="id">!bindA</span> <span class="id">/=</span> <span class="id">guard_and</span> <span class="id">bindA</span> (<span class="id">@plus_commute</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">guard</span> (<span class="id">all</span> <span class="id">p</span> <span class="id">t</span>)))<span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">guard_splits</span> <span class="id">splits_bseqE</span> <span class="id">fmapE</span> <span class="id">2!bindA</span> <span class="id">plus_commute//</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b];</span> <span class="id">rewrite</span> <span class="id">2!bindretf</span> <span class="id">!bindA</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> (<span class="id">@plus_commute</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">guard</span> (<span class="id">all</span> <span class="id">p</span> <span class="id">b</span>)))<span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">ih;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">leq_trans</span> <span class="id">_</span> <span class="id">tn</span>) <span class="id">//=</span> <span class="id">ltnS</span> <span class="id">size_bseq</span>.<br/>
<span class="id">rewrite</span> (<span class="id">@plus_commute</span> <span class="id">_</span> <span class="id">_</span>(<span class="id">guard</span> (<span class="id">p</span> <span class="id">h</span>)))<span class="id">//</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a';</span> <span class="id">rewrite</span> <span class="id">!bindA</span> (<span class="id">@plus_commute</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">guard</span> (<span class="id">p</span> <span class="id">h</span>)))<span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">ih;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">leq_trans</span> <span class="id">_</span> <span class="id">tn</span>) <span class="id">//=</span> <span class="id">ltnS</span> <span class="id">size_bseq</span>.<br/>
<span class="id">rewrite</span> (<span class="id">@plus_commute</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">guard</span> (<span class="id">p</span> <span class="id">h</span>)))<span class="id">//</span> <span class="id">plus_commute//</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">b';</span> <span class="id">rewrite</span> <span class="id">!bindretf</span> <span class="id">all_cat</span> <span class="id">/=</span> <span class="id">andbA</span> <span class="id">andbAC</span> <span class="id">!guard_and</span> <span class="id">!bindA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">plus_commute//</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_cons_splits</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">p</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">iperm</span> (<span class="id">p</span> <span class="id">::</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">splits</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">'</span>(<span class="id">ys,</span> <span class="id">zs</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">liftM2</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">++</span> <span class="id">p</span> <span class="id">::</span> <span class="id">y</span>) (<span class="id">iperm</span> <span class="id">ys</span>) (<span class="id">iperm</span> <span class="id">zs</span>)) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof96')">Proof.</span></div>
<div class="proofscript" id="proof96">
<span class="id">have</span> <span class="id">[n</span> <span class="id">ns]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">s</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span> <span class="id">s</span> <span class="id">ns</span>.<br/>
<span class="id">move:</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">=&gt;</span> <span class="id">[ns</span> <span class="id">|h</span> <span class="id">t]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">bindretf</span> <span class="id">insertE</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">/liftM2</span> <span class="id">/=</span> <span class="id">!bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">_]/=</span> <span class="id">ltnS</span> <span class="id">=&gt;</span> <span class="id">ns</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]/=</span> <span class="id">bindA</span>.<br/>
<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">alt_bindDl</span> <span class="id">2!bindretf</span>.<br/>
<span class="id">transitivity</span> (<span class="id">iperm</span> <span class="id">[::</span> <span class="id">h,</span> <span class="id">p</span> <span class="id">&amp;</span> <span class="id">t]</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">perm_eq_iperm;</span> <span class="id">rewrite</span> <span class="id">-cat1s</span> <span class="id">-</span>(<span class="id">cat1s</span> <span class="id">h</span>) <span class="id">perm_catCA</span>.<br/>
<span class="id">rewrite</span> <span class="id">[p</span> <span class="id">::</span> <span class="id">t]lock</span> <span class="id">/=</span> <span class="id">-lock</span> <span class="id">ih</span> <span class="id">//</span> <span class="id">bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b]</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">liftM2E</span> <span class="id">/liftM2</span> <span class="id">/=</span> <span class="id">bindA</span> <span class="id">-alt_bindDr;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a'</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA</span> (<span class="id">plus_commute</span> (<span class="id">insert</span> <span class="id">h</span> <span class="id">a'</span>))<span class="id">//</span> <span class="id">-alt_bindDr</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insert_cat</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">splits_plusMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">qperm_lemmas</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">plusMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">eqType}</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_qperm</span> <span class="id">:</span> <span class="id">@iperm</span> <span class="id">M</span> <span class="id">A</span> <span class="id">=</span> <span class="id">@qperm</span> <span class="id">M</span> <span class="id">A</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof97')">Proof.</span></div>
<div class="proofscript" id="proof97">
<span class="id">rewrite</span> <span class="id">boolp.funeqE</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="id">apply</span> <span class="id">qperm_elim</span> <span class="id">=&gt;</span> <span class="id">[//|h</span> <span class="id">t</span> <span class="id">ihys</span> <span class="id">ihzs]</span>.<br/>
<span class="id">rewrite</span> <span class="id">iperm_cons_splits</span> <span class="id">splits_bseqE</span> <span class="id">fmapE</span> <span class="id">bindA</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a</span> <span class="id">b];</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">ihys</span> (<span class="id">a,</span> <span class="id">b</span>) <span class="id">_</span> <span class="id">b</span>) (<span class="id">ihzs</span> (<span class="id">a,</span> <span class="id">b</span>) <span class="id">a</span>).<br/>
Qed.</div>
<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">perm_eq_qperm</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">perm_eq</span> <span class="id">a</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">qperm</span> <span class="id">a</span> <span class="id">=</span> <span class="id">qperm</span> <span class="id">b</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof98')">Proof.</span></div>
<div class="proofscript" id="proof98">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-!iperm_qperm;</span> <span class="id">exact:</span> <span class="id">perm_eq_iperm</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_cons_rcons</span> <span class="id">h</span> (<span class="id">t</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">qperm</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">=</span> <span class="id">qperm</span> (<span class="id">rcons</span> <span class="id">t</span> <span class="id">h</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof99')">Proof.</span></div>
<div class="proofscript" id="proof99">
 <span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">perm_eq_qperm;</span> <span class="id">rewrite</span> <span class="id">perm_sym</span> <span class="id">perm_rcons</span> <span class="id">perm_refl</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_rcons</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">x</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">qperm</span> (<span class="id">rcons</span> <span class="id">s</span> <span class="id">x</span>) <span class="id">=</span> <span class="id">qperm</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s'</span> <span class="id">=&gt;</span> <span class="id">qperm</span> (<span class="id">rcons</span> <span class="id">s'</span> <span class="id">x</span>)) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof100')">Proof.</span></div>
<div class="proofscript" id="proof100">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-iperm_qperm</span> <span class="id">iperm_rcons_bind</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_idempotent</span> <span class="id">:</span> <span class="id">qperm</span> <span class="id">&gt;=&gt;</span> <span class="id">qperm</span> <span class="id">=</span> <span class="id">qperm</span> <span class="id">:&gt;</span> (<span class="id">seq</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof101')">Proof.</span></div>
<div class="proofscript" id="proof101">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-iperm_qperm</span> <span class="id">iperm_idempotent</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">qperm_lemmas</span>.<br/>
<br/>
<span class="vernacular">Import</span> <span class="id">Order.TTheory</span>.<br/>
<span class="id">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">order_scope</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">refin_lemmas_altCIMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>.<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_refl</span> <span class="id">A</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">a</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof102')">Proof.</span></div>
<div class="proofscript" id="proof102">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">altmm</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">eq_refin</span> <span class="id">A</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">=</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof103')">Proof.</span></div>
<div class="proofscript" id="proof103">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">-&gt;;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_trans</span> <span class="id">A</span> (<span class="id">b</span> <span class="id">a</span> <span class="id">c</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">b</span> <span class="id">`&lt;=`</span> <span class="id">c</span> <span class="id">-&gt;</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">c</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof104')">Proof.</span></div>
<div class="proofscript" id="proof104">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">=&gt;</span> <span class="id">h1</span> <span class="id">&lt;-;</span> <span class="id">rewrite</span> <span class="id">altA</span> <span class="id">h1</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_antisym</span> <span class="id">A</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">b</span> <span class="id">`&lt;=`</span> <span class="id">a</span> <span class="id">-&gt;</span> <span class="id">a</span> <span class="id">=</span> <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof105')">Proof.</span></div>
<div class="proofscript" id="proof105">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">=&gt;</span> <span class="id">h1</span> <span class="id">&lt;-;</span> <span class="id">rewrite</span> <span class="id">altC</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_alt</span> <span class="id">A</span> (<span class="id">m1</span> <span class="id">m1'</span> <span class="id">m2</span> <span class="id">m2'</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m1</span> <span class="id">`&lt;=`</span> <span class="id">m1'</span> <span class="id">-&gt;</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">m2'</span> <span class="id">-&gt;</span> <span class="id">m1</span> <span class="id">[~]</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">m1'</span> <span class="id">[~]</span> <span class="id">m2'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof106')">Proof.</span></div>
<div class="proofscript" id="proof106">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">h1</span> <span class="id">h2;</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">altACA</span> <span class="id">h1</span> <span class="id">h2</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refinR</span> <span class="id">A</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">a</span> <span class="id">[~]</span> <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof107')">Proof.</span></div>
<div class="proofscript" id="proof107">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">altA</span> <span class="id">altmm</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">refin_lemmas_altCIMonad</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">lrefin</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:=</span> <span class="gallina-kwd">forall</span> <span class="id">x,</span> <span class="id">f</span> <span class="id">x</span> <span class="id">`&lt;=`g</span> <span class="id">x</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">"f&nbsp;`&lt;.=`&nbsp;g"</span> <span class="id">:=</span> (<span class="id">lrefin</span> <span class="id">f</span> <span class="id">g</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">lrefin_lemmas_altCIMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">lrefin_refl</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">a</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof108')">Proof.</span></div>
<div class="proofscript" id="proof108">
 <span class="gallina-kwd">by</span> <span class="id">move</span> <span class="id">=&gt;</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">lrefin_trans</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">b</span> <span class="id">a</span> <span class="id">c</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">b</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">c</span> <span class="id">-&gt;</span> <span class="id">a</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">c</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof109')">Proof.</span></div>
<div class="proofscript" id="proof109">
 <span class="gallina-kwd">by</span> <span class="id">move</span> <span class="id">=&gt;</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">refin_trans</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">lrefin_antisym</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">b</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">a</span> <span class="id">-&gt;</span> <span class="id">a</span> <span class="id">=</span> <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof110')">Proof.</span></div>
<div class="proofscript" id="proof110">
 <span class="id">move</span> <span class="id">=&gt;</span> <span class="id">?</span> <span class="id">?;</span> <span class="id">apply</span> <span class="id">boolp.funext</span> <span class="id">=&gt;</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">refin_antisym</span>. Qed.</div>
<span class="vernacular">End</span> <span class="id">lrefin_lemmas_altCIMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_bindl</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">prePlusMonad</span>) <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">g</span>) <span class="id">-&gt;</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">`&lt;=`</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">g</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof111')">Proof.</span></div>
<div class="proofscript" id="proof111">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">fg;</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">-alt_bindDr;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">exact:</span> <span class="id">fg</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_bind</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) <span class="id">A</span> <span class="id">B</span> <span class="id">{m</span> <span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A}</span> <span class="id">{f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B}</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">`&lt;=`</span> <span class="id">n</span> <span class="id">-&gt;</span> <span class="id">f</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">g</span> <span class="id">-&gt;</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">`&lt;=`</span> (<span class="id">n</span> <span class="id">&gt;&gt;=</span> <span class="id">g</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof112')">Proof.</span></div>
<div class="proofscript" id="proof112">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">mn</span> <span class="id">/refin_bindl</span> <span class="id">?;</span> <span class="id">exact:</span> (<span class="id">refin_trans</span> <span class="id">_</span> (<span class="id">refin_bindr</span> <span class="id">_</span> <span class="id">mn</span>)).<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_liftM2</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">{f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">C}</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">{m1</span> <span class="id">n1</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A}</span> <span class="id">{m2</span> <span class="id">n2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">B}</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m1</span> <span class="id">`&lt;=`</span> <span class="id">n1</span> <span class="id">-&gt;</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">n2</span> <span class="id">-&gt;</span> <span class="id">liftM2</span> <span class="id">f</span> <span class="id">m1</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">liftM2</span> <span class="id">f</span> <span class="id">n1</span> <span class="id">n2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof113')">Proof.</span></div>
<div class="proofscript" id="proof113">
<span class="id">move=&gt;</span> <span class="id">mn1</span> <span class="id">mn2;</span> <span class="id">rewrite</span> <span class="id">/liftM2</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply:</span> (<span class="id">refin_bind</span> <span class="id">mn1</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">exact:</span> <span class="id">refin_bindr</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_guard_le</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">T</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">x</span> <span class="id">y</span> <span class="id">:</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">guard</span> (<span class="id">~~</span> (<span class="id">y</span> <span class="id">&lt;=</span> <span class="id">x</span>)<span class="id">%O</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">`&lt;=`</span> <span class="id">guard</span> (<span class="id">x</span> <span class="id">&lt;=</span> <span class="id">y</span>)<span class="id">%O</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof114')">Proof.</span></div>
<div class="proofscript" id="proof114">
<span class="id">rewrite</span> <span class="id">-ltNge</span> <span class="id">le_eqVlt</span>.<br/>
<span class="id">case:</span> <span class="id">guardPn</span> <span class="id">=&gt;</span> <span class="id">H</span>.<br/>
<span class="id">rewrite</span> <span class="id">orbT</span> <span class="id">guardT;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">orbF</span> <span class="id">/refin</span> <span class="id">altfailm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_if_guard</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) <span class="id">A</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">bool</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">if</span> <span class="id">p</span> <span class="gallina-kwd">then</span> <span class="id">m1</span> <span class="gallina-kwd">else</span> <span class="id">m2</span>) <span class="id">`&lt;=`</span> (<span class="id">guard</span> <span class="id">p</span> <span class="id">&gt;&gt;</span> <span class="id">m1</span>) <span class="id">[~]</span> (<span class="id">guard</span> (<span class="id">~~</span> <span class="id">p</span>) <span class="id">&gt;&gt;</span> <span class="id">m2</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof115')">Proof.</span></div>
<div class="proofscript" id="proof115">
<span class="id">rewrite</span> <span class="id">/refin;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">[pT|pF];</span> <span class="id">rewrite</span> <span class="id">!</span>(<span class="id">guardT,guardF</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindskipf</span> <span class="id">bindfailf</span> <span class="id">altA</span> <span class="id">altmm</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindfailf</span> <span class="id">bindskipf</span> <span class="id">altCA</span> <span class="id">altmm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_bind_guard</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">plusMonad}</span> <span class="id">A</span> (<span class="id">b</span> <span class="id">:</span> <span class="id">bool</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">b</span> <span class="id">-&gt;</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">m1</span>) <span class="id">-&gt;</span> <span class="id">guard</span> <span class="id">b</span> <span class="id">&gt;&gt;</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">guard</span> <span class="id">b</span> <span class="id">&gt;&gt;</span> <span class="id">m1</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof116')">Proof.</span></div>
<div class="proofscript" id="proof116">
<span class="id">case:</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[h|_];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">-[];</span> <span class="id">exact:</span> <span class="id">h</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">guardF</span> <span class="id">!bindfailf;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_ret_insert</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">h</span> (<span class="id">t</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">`&lt;=`</span> (<span class="id">insert</span> <span class="id">h</span> <span class="id">t</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof117')">Proof.</span></div>
<div class="proofscript" id="proof117">
<span class="id">elim:</span> <span class="id">t</span> <span class="id">h</span> <span class="id">=&gt;</span> <span class="id">[h|t1</span> <span class="id">t2</span> <span class="id">ih</span> <span class="id">h];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE;</span> <span class="id">exact:</span> <span class="id">refinR</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_ret_iperm</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">Ret</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">`&lt;=`</span> <span class="id">iperm</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof118')">Proof.</span></div>
<div class="proofscript" id="proof118">
<span class="gallina-kwd">by</span> <span class="id">case:</span> (<span class="id">@iperm_is_alt_ret</span> <span class="id">M</span> <span class="id">_</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">-&gt;;</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">altA</span> <span class="id">altmm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_qperm_ret</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">Ret</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">`&lt;=`</span> <span class="id">qperm</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof119')">Proof.</span></div>
<div class="proofscript" id="proof119">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-iperm_qperm;</span> <span class="id">exact:</span> <span class="id">refin_ret_iperm</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_refin_rcons</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) <span class="id">h</span> (<span class="id">t</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">Ret</span> (<span class="id">rcons</span> <span class="id">t</span> <span class="id">h</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">`&lt;=`</span> <span class="id">qperm</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof120')">Proof.</span></div>
<div class="proofscript" id="proof120">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">qperm_cons_rcons;</span> <span class="id">exact:</span> <span class="id">refin_qperm_ret</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">qperm_refin_cons</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) <span class="id">h</span> (<span class="id">t</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">Ret</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">`&lt;=`</span> <span class="id">qperm</span> (<span class="id">rcons</span> <span class="id">t</span> <span class="id">h</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof121')">Proof.</span></div>
<div class="proofscript" id="proof121">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-qperm_cons_rcons;</span> <span class="id">exact:</span> <span class="id">refin_qperm_ret</span>. Qed.</div>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/yoshihiro503/coq2html/">a fork of coq2html</a></div>
</body>
</html>

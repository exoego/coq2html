
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module monae.impredicative_set.ifail_lib</title>
<meta name="description" content="Documentation of Coq module monae.impredicative_set.ifail_lib" />
<link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath/texmath.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="init('proofscript')">
<h1 class="title">Module monae.impredicative_set.ifail_lib</h1>
<div class="coq">
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">all_ssreflect</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">imonae_lib</span>.<br/>
<span class="vernacular">From</span> <span class="id">HB</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">structures</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">ihierarchy</span> <span class="id">imonad_lib</span>.<br/>
<span class="vernacular">From</span> <span class="id">Equations</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">Equations</span>.<br/>
<br/>
<pre class="ssrdoc">
    Definitions and lemmas using failure and nondeterministic monads       
                                                                           
                  arb == arbitrary nondeterministic choice between         
                         booleans                                          
                foldM                                                      
        unfoldM p f y == generates a list a from a seed y, if p y holds    
                         the generation stops,otherwise an element and a   
                         new seed of generated using f                     
                hyloM == [2, Sect. 5.1]                                    
      arbitrary def s == nondeterministic choice of an element in the list 
                         s and def if the list is empty                    
               subs s == subsequence of a list                             
                         (ref: Sect. 3.1, gibbons2012utp)                  
           insert a s == insert a in the list s nondeterministically       
              iperm s == nondeterministic permutation of the list s,       
                         defined as a Fixpoint using insert [1, Sect. 3]   
             select s == nondeterministically splits the list s into a     
                         pair of one chosen element and the rest           
                      [2, Sect. 3.2]                                       
              uperm s == nondeterministically computes a permutation of s, 
                         defined using unfoldM and select [2, Sect. 3.2]   
             splits s == split a list nondeterministically                 
                         type: seq A -&gt; M (seq A * seq A)                  
           m1 `&lt;=` m2 == m1 refines m2, i.e., every result of m1 is a      
                         possible result of m2                             
            f `&lt;.=` g == refinement relation lifted to functions, i.e.,    
                         forall x, f x `&lt;=` g x                            
                                                                           
ref:                                                                       
- [1] mu2019tr2                                                            
- [2] mu2019tr3                                                            
- [3] gibbons2011icfp                                                      
- [4] mu2020flops                                                          
</pre>
<br/>
<span class="vernacular">Reserved</span> <span class="vernacular">Notation</span> <span class="id">&quot;m1 `&lt;=` m2&quot;</span> (<span class="gallina-kwd">at</span> <span class="id">level</span> <span class="id">70,</span> <span class="id">no</span> <span class="id">associativity</span>).<br/>
<span class="vernacular">Reserved</span> <span class="vernacular">Notation</span> <span class="id">&quot;f `&lt;.=` g&quot;</span> (<span class="gallina-kwd">at</span> <span class="id">level</span> <span class="id">70,</span> <span class="id">no</span> <span class="id">associativity</span>).<br/>
<br/>
<span class="gallina-kwd">Set</span> <span class="vernacular">Implicit</span> <span class="vernacular">Arguments</span>.<br/>
<span class="vernacular">Unset</span> <span class="vernacular">Strict</span> <span class="vernacular">Implicit</span>.<br/>
<span class="vernacular">Unset</span> <span class="vernacular">Printing</span> <span class="vernacular">Implicit</span> <span class="vernacular">Defensive</span>.<br/>
<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">mem_rcons_cat</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">b</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">h</span> <span class="id">:</span> <span class="id">h</span> <span class="id">\in</span> <span class="id">b</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> <span class="id">b1</span> <span class="id">b2,</span> <span class="id">b</span> <span class="id">=</span> <span class="id">rcons</span> <span class="id">b1</span> <span class="id">h</span> <span class="id">++</span> <span class="id">b2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof1')">Proof.</span></div>
<div class="proofscript" id="proof1">
<span class="id">move=&gt;</span> <span class="id">hb;</span> <span class="gallina-kwd">exists</span> (<span class="id">take</span> (<span class="id">index</span> <span class="id">h</span> <span class="id">b</span>) <span class="id">b</span>)<span class="id">,</span> (<span class="id">drop</span> (<span class="id">index</span> <span class="id">h</span> <span class="id">b</span>).<span class="id">+1</span> <span class="id">b</span>).<br/>
<span class="id">rewrite</span> <span class="id">-cats1</span> <span class="id">-catA</span> <span class="id">-{1}</span>(<span class="id">cat_take_drop</span> (<span class="id">index</span> <span class="id">h</span> <span class="id">b</span>) <span class="id">b</span>)<span class="id">;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">++</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-{2}</span>(<span class="id">nth_index</span> <span class="id">h</span> <span class="id">hb</span>) <span class="id">-drop_nth</span> <span class="id">//</span> <span class="id">index_mem</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bind_ext_guard</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">failMonad}</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">b</span> <span class="id">:</span> <span class="id">bool</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">b</span> <span class="id">-&gt;</span> <span class="id">m1</span> <span class="id">=</span> <span class="id">m2</span>) <span class="id">-&gt;</span> <span class="id">guard</span> <span class="id">b</span> <span class="id">&gt;&gt;</span> <span class="id">m1</span> <span class="id">=</span> <span class="id">guard</span> <span class="id">b</span> <span class="id">&gt;&gt;</span> <span class="id">m2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof2')">Proof.</span></div>
<div class="proofscript" id="proof2">
 <span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[-&gt;//|_];</span> <span class="id">rewrite</span> <span class="id">guardF</span> <span class="id">!bindfailf</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">arb</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">:</span> <span class="id">M</span> <span class="id">bool</span> <span class="id">:=</span> <span class="id">Ret</span> <span class="id">true</span> <span class="id">[~]</span> <span class="id">Ret</span> <span class="id">false</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">monadalt_lemmas</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">alt_fmapDr</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) (<span class="id">m1</span> <span class="id">[~]</span> <span class="id">m2</span>) <span class="id">=</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m1</span> <span class="id">[~]</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof3')">Proof.</span></div>
<div class="proofscript" id="proof3">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">3!fmapE</span> <span class="id">alt_bindDl</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">monadalt_lemmas</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fmap_fail</span> <span class="id">{A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">fail</span> <span class="id">=</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof4')">Proof.</span></div>
<div class="proofscript" id="proof4">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindfailf</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">well_founded_size</span> <span class="id">A</span> <span class="id">:</span> <span class="id">well_founded</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">size</span> <span class="id">x</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">y</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof5')">Proof.</span></div>
<div class="proofscript" id="proof5">
 <span class="gallina-kwd">by</span> <span class="id">apply:</span> (<span class="id">@Wf_nat</span>.<span class="id">well_founded_lt_compat</span> <span class="id">_</span> <span class="id">size</span>) <span class="id">=&gt;</span> <span class="id">?</span> <span class="id">?</span> <span class="id">/ltP</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">bassert_hylo</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">failMonad}</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">B</span>)<span class="id">%type</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">B</span>) (<span class="id">r</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">p</span> <span class="id">f,</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">bool</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">b,</span> <span class="id">f</span> <span class="id">b</span> <span class="id">=</span> <span class="id">bassert</span> (<span class="gallina-kwd">fun</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">r</span> <span class="id">p</span> <span class="id">f</span> <span class="id">z</span>.<span class="id">2</span> <span class="id">b</span>) (<span class="id">f</span> <span class="id">b</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">bassert_size</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">failMonad}</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">B</span>)<span class="id">%type</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">@bassert_hylo</span> <span class="id">M</span> <span class="id">_</span> <span class="id">_</span> <span class="id">f</span> <span class="id">predT</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">_</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">size</span> <span class="id">x</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">y</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">foldM</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">T</span> <span class="id">R</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">R</span> <span class="id">-&gt;</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">R</span>).<br/>
<span class="vernacular">Fixpoint</span> <span class="id">foldM</span> <span class="id">z</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span> <span class="id">:=</span> <span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">is</span> <span class="id">x</span> <span class="id">::</span> <span class="id">s'</span> <span class="gallina-kwd">then</span> <span class="id">f</span> <span class="id">z</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">foldM</span> <span class="id">y</span> <span class="id">s'</span>) <span class="gallina-kwd">else</span> (<span class="id">Ret</span> <span class="id">z</span>).<br/>
<span class="vernacular">End</span> <span class="id">foldM</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">unfoldM</span>.<br/>
<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">unfoldM_monad</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Variable</span> (<span class="id">r</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">bool</span>).<br/>
<span class="vernacular">Hypothesis</span> <span class="id">wfr</span> <span class="id">:</span> <span class="id">well_founded</span> <span class="id">r</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">B</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">B</span>)<span class="id">%type</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">unfoldM'</span> (<span class="id">y</span> <span class="id">:</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">y'</span> <span class="id">:</span> <span class="id">B,</span> <span class="id">r</span> <span class="id">y'</span> <span class="id">y</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>)) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">p</span> <span class="id">y</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span> <span class="id">f</span> <span class="id">y</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">xz</span> <span class="id">=&gt;</span> <span class="gallina-kwd">match</span> <span class="id">Bool.bool_dec</span> (<span class="id">r</span> <span class="id">xz</span>.<span class="id">2</span> <span class="id">y</span>) <span class="id">true</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">left</span> <span class="id">H</span> <span class="id">=&gt;</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">xz</span>.<span class="id">1</span>) (<span class="id">g</span> <span class="id">xz</span>.<span class="id">2</span> <span class="id">H</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">right</span> <span class="id">H</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">[::]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">end</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">unfoldM</span> <span class="id">:=</span> <span class="id">Fix</span> <span class="id">wfr</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">unfoldM'</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">unfoldM_monad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">unfoldM_failMonad</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span>) (<span class="id">A</span> <span class="id">B'</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Let</span> <span class="id">B</span> <span class="id">:=</span> <span class="id">seq</span> <span class="id">B'</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">unfoldM</span> <span class="id">:=</span> (<span class="id">@unfoldM</span> <span class="id">M</span> <span class="id">A</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">@well_founded_size</span> <span class="id">B'</span>)).<br/>
<span class="vernacular">Variables</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">B</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">B</span>)<span class="id">%type</span>).<br/>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">decr_size</span> <span class="id">:</span> <span class="id">bassert_size</span> <span class="id">f</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">unfoldME</span> <span class="id">y</span> <span class="id">:</span> <span class="id">unfoldM</span> <span class="id">p</span> <span class="id">f</span> <span class="id">y</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">p</span> <span class="id">y</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">f</span> <span class="id">y</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">xz</span> <span class="id">=&gt;</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">xz</span>.<span class="id">1</span>) (<span class="id">unfoldM</span> <span class="id">p</span> <span class="id">f</span> <span class="id">xz</span>.<span class="id">2</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof6')">Proof.</span></div>
<div class="proofscript" id="proof6">
<span class="id">rewrite</span> <span class="id">/unfoldM</span> <span class="id">Init.Wf.Fix_eq</span><span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> <span class="id">=&gt;</span> <span class="id">b</span> <span class="id">g</span> <span class="id">g'</span> <span class="id">H;</span> <span class="id">rewrite</span> <span class="id">/unfoldM';</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">pb</span>.<br/>
&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a'</span> <span class="id">b']</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">Bool.bool_dec</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">H</span>.<br/>
<span class="id">rewrite</span> <span class="id">/unfoldM';</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">py</span>.<br/>
<span class="id">rewrite</span> <span class="id">decr_size</span> <span class="id">/bassert</span> <span class="id">2!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a'</span> <span class="id">b']</span>.<br/>
<span class="id">case:</span> <span class="id">assertPn</span> <span class="id">=&gt;</span> <span class="id">b'y;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!bindfailf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!bindretf</span> <span class="id">/=</span> <span class="id">b'y</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">unfoldM_failMonad</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">unfoldM</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">unfoldM</span> <span class="id">:</span> <span class="id">simpl</span> <span class="id">never</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">hyloM</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span>) (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Variables</span> (<span class="id">op</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) (<span class="id">e</span> <span class="id">:</span> <span class="id">C</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">B</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">B</span>)<span class="id">%type</span>).<br/>
<span class="vernacular">Variable</span> <span class="id">seed</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">B</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">B</span>)<span class="id">%type</span>)<span class="id">,</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">bool</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">hyloM'</span> (<span class="id">y</span> <span class="id">:</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">y',</span> <span class="id">seed</span> <span class="id">p</span> <span class="id">f</span> <span class="id">y'</span> <span class="id">y</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">C</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">p</span> <span class="id">y</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">e</span> <span class="gallina-kwd">else</span> <span class="id">f</span> <span class="id">y</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">xz</span> <span class="id">=&gt;</span> <span class="gallina-kwd">match</span> <span class="id">Bool.bool_dec</span> (<span class="id">seed</span> <span class="id">p</span> <span class="id">f</span> <span class="id">xz</span>.<span class="id">2</span> <span class="id">y</span>) <span class="id">true</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">left</span> <span class="id">H</span> <span class="id">=&gt;</span> <span class="id">op</span> <span class="id">xz</span>.<span class="id">1</span> (<span class="id">g</span> <span class="id">xz</span>.<span class="id">2</span> <span class="id">H</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">right</span> <span class="id">H</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">end</span>).<br/>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">well_founded_seed</span> <span class="id">:</span> <span class="id">well_founded</span> (<span class="id">seed</span> <span class="id">p</span> <span class="id">f</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">hyloM</span> <span class="id">:=</span> <span class="id">Fix</span> <span class="id">well_founded_seed</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">hyloM'</span>.<br/>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">Hdecr_seed</span> <span class="id">:</span> <span class="id">bassert_hylo</span> <span class="id">f</span> <span class="id">p</span> <span class="id">seed</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">hyloME</span> <span class="id">y</span> <span class="id">:</span> <span class="id">hyloM</span> <span class="id">y</span> <span class="id">=</span> <span class="gallina-kwd">if</span> <span class="id">p</span> <span class="id">y</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">f</span> <span class="id">y</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">xz</span> <span class="id">=&gt;</span> <span class="id">op</span> <span class="id">xz</span>.<span class="id">1</span> (<span class="id">hyloM</span> <span class="id">xz</span>.<span class="id">2</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof7')">Proof.</span></div>
<div class="proofscript" id="proof7">
<span class="id">rewrite</span> <span class="id">/hyloM</span> <span class="id">Init.Wf.Fix_eq</span><span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> <span class="id">=&gt;</span> <span class="id">b</span> <span class="id">g</span> <span class="id">g'</span> <span class="id">K;</span> <span class="id">rewrite</span> <span class="id">/hyloM';</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">pb</span>.<br/>
&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[a'</span> <span class="id">b']</span> <span class="id">/=</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">Bool.bool_dec</span> <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">K</span>.<br/>
<span class="id">rewrite</span> <span class="id">{1}/hyloM';</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">py</span>.<br/>
<span class="id">rewrite</span> <span class="id">Hdecr_seed</span> <span class="id">/bassert</span> <span class="id">!bindA</span>.<br/>
<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">-[b'</span> <span class="id">a']</span>.<br/>
<span class="id">case:</span> <span class="id">assertPn</span> <span class="id">=&gt;</span> <span class="id">Hseed;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!bindfailf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">2!bindretf</span> <span class="id">Hseed</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">hyloM</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">hyloM</span> <span class="id">{M}</span> <span class="id">{A}</span> <span class="id">{B}</span> <span class="id">{C}</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">arbitrary</span>.<br/>
<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">def</span> <span class="id">:</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">arbitrary</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">foldr1</span> (<span class="id">Ret</span> <span class="id">def</span>) (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">[~]</span> <span class="id">y</span>) <span class="id">\o</span> <span class="id">map</span> <span class="id">Ret</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">arbitrary</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">arbitrary</span> <span class="id">{M}</span> <span class="id">{A}</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary1</span> (<span class="id">N</span> <span class="id">:</span> <span class="id">altMonad</span>) (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">def</span> <span class="id">:</span> <span class="id">T</span>) <span class="id">h</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> <span class="id">[::</span> <span class="id">h]</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">h</span> <span class="id">:&gt;</span> <span class="id">N</span> <span class="id">T</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof8')">Proof.</span></div>
<div class="proofscript" id="proof8">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">arbitrary_lemmas</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary2</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">def</span> <span class="id">:</span> <span class="id">T</span>) <span class="id">h</span> <span class="id">t</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> <span class="id">[::</span> <span class="id">h;</span> <span class="id">t]</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">h</span> <span class="id">[~]</span> <span class="id">Ret</span> <span class="id">t</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof9')">Proof.</span></div>
<div class="proofscript" id="proof9">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/arbitrary</span> <span class="id">/=</span> <span class="id">altC</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_cons</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">def</span> <span class="id">:</span> <span class="id">T</span>) <span class="id">h</span> <span class="id">t</span> <span class="id">:</span> <span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">t</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">=</span> <span class="id">Ret</span> <span class="id">h</span> <span class="id">[~]</span> <span class="id">arbitrary</span> <span class="id">def</span> <span class="id">t</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof10')">Proof.</span></div>
<div class="proofscript" id="proof10">
<span class="id">move:</span> <span class="id">def</span> <span class="id">h;</span> <span class="id">elim:</span> <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">a</span> <span class="id">[//|b</span> <span class="id">[|c</span> <span class="id">t]]</span> <span class="id">ih</span> <span class="id">def</span> <span class="id">h</span> <span class="id">_</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">arbitrary2</span>.<br/>
<span class="id">-</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/arbitrary</span> <span class="id">/=</span> <span class="id">altA</span> <span class="id">altC</span> (<span class="id">altC</span> (<span class="id">Ret</span> <span class="id">b</span>)).<br/>
<span class="id">-</span> <span class="id">move:</span> (<span class="id">ih</span> <span class="id">a</span> <span class="id">h</span> <span class="id">erefl</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">/arbitrary</span> <span class="id">/=</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="id">move:</span> (<span class="id">ih</span> <span class="id">h</span> <span class="id">a</span> <span class="id">erefl</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">/arbitrary</span> <span class="id">/=</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">altCA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_naturality</span> (<span class="id">T</span> <span class="id">U</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">T</span>) (<span class="id">b</span> <span class="id">:</span> <span class="id">U</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">U</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">x,</span> <span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">x</span> <span class="id">-&gt;</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">arbitrary</span> <span class="id">a</span>) <span class="id">x</span> <span class="id">=</span> (<span class="id">arbitrary</span> <span class="id">b</span> <span class="id">\o</span> <span class="id">map</span> <span class="id">f</span>) <span class="id">x</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof11')">Proof.</span></div>
<div class="proofscript" id="proof11">
<span class="id">elim=&gt;</span> <span class="id">//</span> <span class="id">x</span> <span class="id">[_</span> <span class="id">_</span> <span class="id">|</span> <span class="id">x'</span> <span class="id">xs</span> <span class="id">/</span>(<span class="id">_</span> <span class="id">isT</span>)<span class="id">]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]compE</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">_]/=</span> <span class="id">fmapE</span> <span class="id">=&gt;</span> <span class="id">ih</span> <span class="id">_</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]compE</span> <span class="id">[in</span> <span class="id">RHS]/=</span> <span class="id">[in</span> <span class="id">RHS]</span>(<span class="id">arbitrary_cons</span> <span class="id">b</span>) <span class="id">//</span> <span class="id">[in</span> <span class="id">LHS]compE</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]arbitrary_cons</span> <span class="id">//</span> <span class="id">fmapE</span> <span class="id">/=</span> <span class="id">alt_bindDl</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">ih</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">mpair_arbitrary_base_case</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">a</span> <span class="id">x</span> (<span class="id">y</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">y</span>)<span class="id">%nat</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> (<span class="id">a,</span> <span class="id">a</span>) (<span class="id">cp</span> <span class="id">[::</span> <span class="id">x]</span> <span class="id">y</span>) <span class="id">=</span> <span class="id">mpair</span> (<span class="id">arbitrary</span> <span class="id">a</span> <span class="id">[::</span> <span class="id">x],</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">y</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof12')">Proof.</span></div>
<div class="proofscript" id="proof12">
<span class="id">move=&gt;</span> <span class="id">y0;</span> <span class="id">rewrite</span> <span class="id">cp1</span>.<br/>
<span class="id">transitivity</span> (<span class="id">arbitrary</span> <span class="id">a</span> <span class="id">y</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y'</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x,</span> <span class="id">y'</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">arbitrary</span> <span class="id">_</span>)) <span class="id">-</span>(<span class="id">arbitrary_naturality</span> <span class="id">a</span>) <span class="id">//</span> <span class="id">compE</span> <span class="id">fmapE</span>.<br/>
<span class="id">transitivity</span> (<span class="id">do</span> <span class="id">z</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">x;</span> <span class="id">do</span> <span class="id">y'</span> <span class="id">&lt;-</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">y;</span> <span class="id">Ret</span> (<span class="id">z,</span> <span class="id">y'</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">%Do</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">[]</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_cat</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">T</span>) <span class="id">s</span> <span class="id">t</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">m</span> <span class="id">:=</span> <span class="id">size</span> <span class="id">s</span> <span class="gallina-kwd">in</span> <span class="gallina-kwd">let</span> <span class="id">n</span> <span class="id">:=</span> <span class="id">size</span> <span class="id">t</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">0</span> <span class="id">&lt;</span> <span class="id">m</span> <span class="id">-&gt;</span> <span class="id">0</span> <span class="id">&lt;</span> <span class="id">n</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">a</span> (<span class="id">s</span> <span class="id">++</span> <span class="id">t</span>) <span class="id">=</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">s</span> <span class="id">[~]</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">t</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof13')">Proof.</span></div>
<div class="proofscript" id="proof13">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">[//|s1</span> <span class="id">s2</span> <span class="id">IH]</span>.<br/>
<span class="id">elim/last_ind</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">t1</span> <span class="id">t2</span> <span class="id">_</span> <span class="id">m</span> <span class="id">n</span> <span class="id">m0</span> <span class="id">n0</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">cat_cons</span> <span class="id">[in</span> <span class="id">LHS]arbitrary_cons;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_cat</span> <span class="id">size_rcons</span> <span class="id">addnS</span>.<br/>
<span class="id">destruct</span> <span class="id">s2</span> <span class="gallina-kwd">as</span> <span class="id">[|s2</span> <span class="id">s3]</span> <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">IH</span> <span class="id">//</span> <span class="id">altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]arbitrary_cons</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">mpair_arbitrary</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">a</span> (<span class="id">x</span> <span class="id">y</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">x</span> <span class="id">-&gt;</span> <span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">y</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">mpair</span> (<span class="id">arbitrary</span> <span class="id">a</span> <span class="id">x,</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">y</span>) <span class="id">=</span> <span class="id">arbitrary</span> (<span class="id">a,</span> <span class="id">a</span>) (<span class="id">cp</span> <span class="id">x</span> <span class="id">y</span>) <span class="id">:&gt;</span> <span class="id">M</span> (<span class="id">T</span> <span class="id">*</span> <span class="id">T</span>)<span class="id">%type</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof14')">Proof.</span></div>
<div class="proofscript" id="proof14">
<span class="id">elim:</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">x;</span> <span class="id">case=&gt;</span> <span class="id">[_</span> <span class="id">y</span> <span class="id">_</span> <span class="id">size_y|x'</span> <span class="id">xs</span> <span class="id">IH</span> <span class="id">y</span> <span class="id">_</span> <span class="id">size_y];</span> <span class="id">apply/esym</span>.<br/>
&nbsp;&nbsp;<span class="id">exact/mpair_arbitrary_base_case</span>.<br/>
<span class="id">set</span> <span class="id">xxs</span> <span class="id">:=</span> <span class="id">x'</span> <span class="id">::</span> <span class="id">xs</span>.<br/>
<span class="id">rewrite</span> <span class="id">/cp</span> <span class="id">-cat1s</span> <span class="id">allpairs_cat</span> <span class="id">-/</span>(<span class="id">cp</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">cp1</span> <span class="id">/=</span> <span class="id">arbitrary_cat;</span> <span class="id">last</span> <span class="id">2</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_map</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">size_cat</span> <span class="id">size_map</span> <span class="id">addn_gt0</span> <span class="id">size_y</span>.<br/>
<span class="id">pose</span> <span class="id">n</span> <span class="id">:=</span> <span class="id">size</span> <span class="id">y</span>.<br/>
<span class="id">pose</span> <span class="id">l</span> <span class="id">:=</span> <span class="id">size</span> (<span class="id">cp</span> <span class="id">xxs</span> <span class="id">y</span>).<br/>
<span class="id">rewrite</span> <span class="id">-IH</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">-/xxs</span>.<br/>
<span class="id">move:</span> (<span class="id">mpair_arbitrary_base_case</span> <span class="id">a</span> <span class="id">x</span> <span class="id">size_y</span>).<br/>
<span class="id">rewrite</span> <span class="id">{1}/cp</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">arbitrary</span> <span class="id">_</span> <span class="id">X]/=</span> <span class="id">cats0</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
<span class="id">rewrite</span> <span class="id">-alt_bindDl</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-arbitrary_cat</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_inde</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">a</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">T</span>) <span class="id">{U}</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">U</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">s</span> <span class="id">-&gt;</span> <span class="id">arbitrary</span> <span class="id">a</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">m</span> <span class="id">=</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof15')">Proof.</span></div>
<div class="proofscript" id="proof15">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">a</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">h</span> <span class="id">[_</span> <span class="id">a</span> <span class="id">m</span> <span class="id">_|h'</span> <span class="id">t</span> <span class="id">ih</span> <span class="id">a</span> <span class="id">m</span> <span class="id">_]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">arbitrary1</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">arbitrary_cons</span> <span class="id">//</span> <span class="id">alt_bindDl</span> <span class="id">ih</span> <span class="id">//</span> <span class="id">bindretf</span> <span class="id">altmm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_flatten</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">def</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">A</span>) <span class="id">:</span> (<span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">s</span>)<span class="id">%nat</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">arbitrary</span> <span class="id">def</span> <span class="id">s;</span> <span class="id">Ret</span> (<span class="id">f</span> <span class="id">x</span>))<span class="id">%Do</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> (<span class="id">flatten</span> <span class="id">[seq</span> <span class="id">[::</span> <span class="id">f</span> <span class="id">y]</span> <span class="id">|</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">s]</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof16')">Proof.</span></div>
<div class="proofscript" id="proof16">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">a</span> <span class="id">[_</span> <span class="id">f</span> <span class="id">_</span> <span class="id">/=|h</span> <span class="id">t</span> <span class="id">ih</span> <span class="id">f</span> <span class="id">_]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/arbitrary</span> <span class="id">/=</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[h</span> <span class="id">::</span> <span class="id">t]lock</span> <span class="id">/=</span> <span class="id">-lock</span> <span class="id">[in</span> <span class="id">RHS]arbitrary_cons//</span> <span class="id">-ih//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">arbitrary_cons//</span> <span class="id">alt_bindDl</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">arbitrary_flatten2</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">def</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">A</span>) <span class="id">:</span> (<span class="id">0</span> <span class="id">&lt;</span> <span class="id">size</span> <span class="id">s</span>)<span class="id">%nat</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">arbitrary</span> <span class="id">def</span> <span class="id">s;</span> <span class="id">Ret</span> (<span class="id">f</span> <span class="id">x</span>) <span class="id">[~]</span> <span class="id">Ret</span> (<span class="id">g</span> <span class="id">x</span>))<span class="id">%Do</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">arbitrary</span> <span class="id">def</span> (<span class="id">flatten</span> <span class="id">[seq</span> <span class="id">[::</span> <span class="id">f</span> <span class="id">y;</span> <span class="id">g</span> <span class="id">y]</span> <span class="id">|</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">s]</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof17')">Proof.</span></div>
<div class="proofscript" id="proof17">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">def</span> <span class="id">f</span> <span class="id">g</span> <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
<span class="id">move=&gt;</span> <span class="id">h</span> <span class="id">[|t1</span> <span class="id">t2]</span> <span class="id">ih</span> <span class="id">def</span> <span class="id">f</span> <span class="id">g</span> <span class="id">_</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">arbitrary1</span> <span class="id">bindretf</span> <span class="id">arbitrary_cons</span> <span class="id">//</span>.<br/>
<span class="id">rewrite</span> <span class="id">[t1</span> <span class="id">::</span> <span class="id">t2]lock</span> <span class="id">/=</span> <span class="id">-lock</span> <span class="id">[in</span> <span class="id">RHS]arbitrary_cons//</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]arbitrary_cons//</span> <span class="id">-ih//</span> <span class="id">arbitrary_cons//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">alt_bindDl</span> <span class="id">bindretf</span> <span class="id">altA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">arbitrary_lemmas</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">arbitrary_naturality</span> <span class="id">{M</span> <span class="id">T</span> <span class="id">U}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">subsequences_of_a_list</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">subs</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">t'</span> <span class="id">:=</span> <span class="id">subs</span> <span class="id">t</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">fmap</span> (<span class="id">cons</span> <span class="id">h</span>) <span class="id">t'</span> <span class="id">[~]</span> <span class="id">t'</span>.<br/>
<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">subs_cons</span> <span class="id">x</span> (<span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">subs</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">xs</span>) <span class="id">=</span> <span class="gallina-kwd">let</span> <span class="id">t'</span> <span class="id">:=</span> <span class="id">subs</span> <span class="id">xs</span> <span class="gallina-kwd">in</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">x</span>) <span class="id">t'</span> <span class="id">[~]</span> <span class="id">t'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof18')">Proof.</span></div>
<div class="proofscript" id="proof18">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">subs_cat</span> (<span class="id">xs</span> <span class="id">ys</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">subs</span> (<span class="id">xs</span> <span class="id">++</span> <span class="id">ys</span>) <span class="id">=</span> <span class="id">do</span> <span class="id">us</span> <span class="id">&lt;-</span> <span class="id">subs</span> <span class="id">xs;</span> <span class="id">do</span> <span class="id">vs</span> <span class="id">&lt;-</span> <span class="id">subs</span> <span class="id">ys;</span> <span class="id">Ret</span> (<span class="id">us</span> <span class="id">++</span> <span class="id">vs</span>))<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof19')">Proof.</span></div>
<div class="proofscript" id="proof19">
<span class="id">elim:</span> <span class="id">xs</span> <span class="id">ys</span> <span class="id">=&gt;</span> <span class="id">[ys</span> <span class="id">|x</span> <span class="id">xs</span> <span class="id">ih</span> <span class="id">ys]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">cat0s</span> <span class="id">/=</span> <span class="id">bindretf</span> <span class="id">bindmret</span>.<br/>
<span class="id">rewrite</span> <span class="id">{1}[in</span> <span class="id">RHS]/subs</span> <span class="id">fmapE</span> <span class="id">-/</span>(<span class="id">subs</span> <span class="id">_</span>) <span class="id">alt_bindDl</span> <span class="id">bindA</span>.<br/>
<span class="vernacular">Open</span> (<span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">subs</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> <span class="id">X</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">cat_cons</span>.<br/>
&nbsp;&nbsp;<span class="id">over</span>.<br/>
<span class="id">rewrite</span> <span class="id">[X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">=</span> <span class="id">X</span> <span class="id">[~]</span> <span class="id">_]</span>(<span class="id">_</span> <span class="id">:</span> <span class="id">_</span> <span class="id">=</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">x</span>) (<span class="id">do</span> <span class="id">x0</span> <span class="id">&lt;-</span> <span class="id">subs</span> <span class="id">xs;</span> <span class="id">do</span> <span class="id">x1</span> <span class="id">&lt;-</span> <span class="id">subs</span> <span class="id">ys;</span> <span class="id">Ret</span> (<span class="id">x0</span> <span class="id">++</span> <span class="id">x1</span>)))<span class="id">%Do;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">x0</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">bindA</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-ih</span> <span class="id">cat_cons</span> <span class="id">subs_cons</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">subsequences_of_a_list</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">insert</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">insert</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">a]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">a</span> <span class="id">::</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">[~]</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">h</span>) (<span class="id">insert</span> <span class="id">a</span> <span class="id">t</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insertE</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">s</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> <span class="id">a</span> <span class="id">s</span> <span class="id">=</span> <span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">a]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">a</span> <span class="id">::</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">[~]</span> <span class="id">fmap</span> (<span class="id">cons</span> <span class="id">h</span>) (<span class="id">insert</span> <span class="id">a</span> <span class="id">t</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof20')">Proof.</span></div>
<div class="proofscript" id="proof20">
 <span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">s</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">insert</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">insert</span> <span class="id">:</span> <span class="id">simpl</span> <span class="id">never</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">insert_altMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_map</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> (<span class="id">f</span> <span class="id">a</span>) <span class="id">\o</span> <span class="id">map</span> <span class="id">f</span> <span class="id">=</span> <span class="id">map</span> <span class="id">f</span> (<span class="id">o</span>) <span class="id">insert</span> <span class="id">a</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof21')">Proof.</span></div>
<div class="proofscript" id="proof21">
<span class="id">apply</span> <span class="id">funext;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[|y</span> <span class="id">xs</span> <span class="id">IH]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">fmap</span> (<span class="id">map</span> <span class="id">f</span>))) (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">compE</span> <span class="id">insertE</span>.<br/>
<span class="id">apply/esym</span>.<br/>
<span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">alt_fmapDr</span>.<br/>
<span class="comment">(*&nbsp;first&nbsp;branch&nbsp;*)</span><br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">fmap</span> (<span class="id">map</span> <span class="id">f</span>))) (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">FIdE</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">[~]</span> <span class="id">_</span> <span class="id">]/=</span>.<br/>
<span class="comment">(*&nbsp;second&nbsp;branch&nbsp;*)</span><br/>
<span class="id">rewrite</span> <span class="id">-fmap_oE</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">map</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">cons</span> <span class="id">y</span> <span class="id">=</span> <span class="id">cons</span> (<span class="id">f</span> <span class="id">y</span>) <span class="id">\o</span> <span class="id">map</span> <span class="id">f</span>) <span class="id">//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmap_oE</span> <span class="id">-</span>(<span class="id">fcompE</span> (<span class="id">map</span> <span class="id">f</span>)) <span class="id">-IH</span> <span class="id">[RHS]/=</span> <span class="id">insertE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">Mmm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">idempotent</span> (<span class="id">@alt</span> <span class="id">_</span> <span class="id">A</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Variables</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">filter_insertN</span> <span class="id">a</span> <span class="id">:</span> <span class="id">~~</span> <span class="id">p</span> <span class="id">a</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">s,</span> (<span class="id">filter</span> <span class="id">p</span> (<span class="id">o</span>) <span class="id">insert</span> <span class="id">a</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">filter</span> <span class="id">p</span> <span class="id">s</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof22')">Proof.</span></div>
<div class="proofscript" id="proof22">
<span class="id">move=&gt;</span> <span class="id">pa;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">IH]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">fmap</span> <span class="id">_</span>)) (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">FIdE</span> <span class="id">/=</span> (<span class="id">negbTE</span> <span class="id">pa</span>).<br/>
<span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">alt_fmapDr</span>.<br/>
<span class="id">rewrite</span> <span class="id">-</span>(<span class="id">compE</span> (<span class="id">fmap</span> <span class="id">_</span>)) (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">FIdE</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">[~]</span> <span class="id">_]/=</span> (<span class="id">negbTE</span> <span class="id">pa</span>).<br/>
<span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">ph</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">-fmap_oE</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">filter</span> <span class="id">p</span> <span class="id">\o</span> <span class="id">cons</span> <span class="id">h</span> <span class="id">=</span> <span class="id">cons</span> <span class="id">h</span> <span class="id">\o</span> <span class="id">filter</span> <span class="id">p</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">/=;</span> <span class="id">rewrite</span> <span class="id">ph</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">fmap_oE</span>.<br/>
&nbsp;&nbsp;<span class="id">move:</span> (<span class="id">IH</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">/=</span> <span class="id">ph</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">Mmm</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">-fmap_oE</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">filter</span> <span class="id">p</span> <span class="id">\o</span> <span class="id">cons</span> <span class="id">h</span> <span class="id">=</span> <span class="id">filter</span> <span class="id">p</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">/=;</span> <span class="id">rewrite</span> (<span class="id">negbTE</span> <span class="id">ph</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">move:</span> (<span class="id">IH</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span> <span class="id">/=;</span> <span class="id">rewrite</span> (<span class="id">negbTE</span> <span class="id">ph</span>) <span class="id">Mmm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">filter_insertT</span> <span class="id">a</span> <span class="id">:</span> <span class="id">p</span> <span class="id">a</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">filter</span> <span class="id">p</span> (<span class="id">o</span>) <span class="id">insert</span> <span class="id">a</span> <span class="id">=</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">\o</span> <span class="id">filter</span> <span class="id">p</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof23')">Proof.</span></div>
<div class="proofscript" id="proof23">
<span class="id">move=&gt;</span> <span class="id">pa;</span> <span class="id">apply</span> <span class="id">funext;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">IH]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">!insertE</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">pa</span>.<br/>
<span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">[in</span> <span class="id">RHS]/=;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">ph</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]insertE</span>.<br/>
&nbsp;&nbsp;<span class="id">move:</span> (<span class="id">IH</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">_]/=</span> <span class="id">=&gt;</span> <span class="id">&lt;-</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]insertE</span> <span class="id">alt_fmapDr;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">pa</span> <span class="id">ph</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!fmapE</span> <span class="id">/=</span> <span class="id">fcompE</span> <span class="id">bind_fmap</span> <span class="id">bindA</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">[LHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">ph</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]insertE</span> <span class="id">alt_fmapDr</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">-[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">[~]</span> <span class="id">X</span> <span class="id">=</span> <span class="id">_]fmap_oE</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> (<span class="id">filter</span> <span class="id">p</span> <span class="id">\o</span> <span class="id">cons</span> <span class="id">h</span>) <span class="id">=</span> <span class="id">filter</span> <span class="id">p</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">/=;</span> <span class="id">rewrite</span> (<span class="id">negbTE</span> <span class="id">ph</span>).<br/>
&nbsp;&nbsp;<span class="id">move:</span> (<span class="id">IH</span>)<span class="id">;</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">/=</span> <span class="id">pa</span> (<span class="id">negbTE</span> <span class="id">ph</span>) <span class="id">[in</span> <span class="id">RHS]insertE;</span> <span class="id">case:</span> (<span class="id">filter</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="id">[|h'</span> <span class="id">t']</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE</span> <span class="id">Mmm</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!insertE</span> <span class="id">altA</span> <span class="id">Mmm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">insert_altMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">insert_altCIMonad</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>).<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_rcons</span> <span class="id">a'</span> <span class="id">s</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> <span class="id">a</span> (<span class="id">rcons</span> <span class="id">s</span> <span class="id">a'</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">s</span> <span class="id">++</span> <span class="id">[::</span> <span class="id">a';</span> <span class="id">a]</span>) <span class="id">[~]</span> <span class="id">fmap</span> (<span class="id">rcons^~</span> <span class="id">a'</span>) (<span class="id">insert</span> <span class="id">a</span> <span class="id">s</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof24')">Proof.</span></div>
<div class="proofscript" id="proof24">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">a'</span> <span class="id">=&gt;</span> <span class="id">[a'|s1</span> <span class="id">s2</span> <span class="id">IH</span> <span class="id">a']</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">cat0s</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">insertE</span> <span class="id">altC;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]/=</span> <span class="id">insertE</span> <span class="id">IH</span>.<br/>
<span class="id">rewrite</span> <span class="id">alt_fmapDr</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">[~]</span> <span class="id">X</span> <span class="id">=</span> <span class="id">_]fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">alt_fmapDr</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> <span class="id">_</span> <span class="id">=</span> <span class="id">_</span> <span class="id">[~]</span> <span class="id">X]fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-!fmap_oE</span> <span class="id">altCA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">rev_insert</span> <span class="id">:</span> <span class="id">rev</span> (<span class="id">o</span>) <span class="id">insert</span> <span class="id">a</span> <span class="id">=</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">\o</span> <span class="id">rev</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof25')">Proof.</span></div>
<div class="proofscript" id="proof25">
<span class="id">apply</span> <span class="id">funext;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">ih]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">insertE</span> <span class="id">compE</span> <span class="id">alt_fmapDr</span> <span class="id">fmapE</span> <span class="id">bindretf</span> <span class="id">compE</span> <span class="id">[in</span> <span class="id">RHS]rev_cons</span>.<br/>
<span class="id">rewrite</span> <span class="id">insert_rcons</span> <span class="id">rev_cons</span> <span class="id">-cats1</span> <span class="id">rev_cons</span> <span class="id">-cats1</span> <span class="id">-catA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
<span class="id">move:</span> <span class="id">ih;</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">[X</span> <span class="gallina-kwd">in</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">_]/=</span> <span class="id">=&gt;</span> <span class="id">&lt;-</span>.<br/>
<span class="id">rewrite</span> <span class="id">-!fmap_oE</span>. <span class="id">congr</span> (<span class="id">fmap</span> <span class="id">_</span> (<span class="id">insert</span> <span class="id">a</span> <span class="id">t</span>)).<br/>
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">-rev_cons</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">insert_altCIMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">test_canonical</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">nondetMonad</span>) <span class="id">A</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">b</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">a</span> <span class="id">[~]</span> (<span class="id">fail</span> <span class="id">&gt;&gt;=</span> <span class="id">b</span>) <span class="id">=</span> <span class="id">a</span> <span class="id">[~]</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof26')">Proof.</span></div>
<div class="proofscript" id="proof26">
<span class="gallina-kwd">Set</span> <span class="vernacular">Printing</span> <span class="id">All</span>.<br/>
<span class="vernacular">Unset</span> <span class="vernacular">Printing</span> <span class="id">All</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindfailf</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">insert_plusMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insertC</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">a</span> <span class="id">b</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">b</span> <span class="id">s;</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">x</span> <span class="id">=</span> <span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">s;</span> <span class="id">insert</span> <span class="id">b</span> <span class="id">x</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof27')">Proof.</span></div>
<div class="proofscript" id="proof27">
<span class="id">have</span> <span class="id">[n</span> <span class="id">ns]</span> <span class="id">:=</span> <span class="id">ubnP</span> (<span class="id">size</span> <span class="id">s</span>)<span class="id">;</span> <span class="id">elim:</span> <span class="id">n</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">a</span> <span class="id">b</span>.<br/>
<span class="id">case:</span> <span class="id">s</span> <span class="id">ns</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">!insertE</span> <span class="id">!bindretf</span> <span class="id">!insertE</span> <span class="id">altC</span> <span class="id">!fmapE</span> <span class="id">!bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">ltnS</span> <span class="id">/=</span> <span class="id">=&gt;</span> <span class="id">ns</span>.<br/>
<span class="id">rewrite</span> (<span class="id">insertE</span> <span class="id">_</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>)) <span class="id">alt_bindDl</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]</span>(<span class="id">insertE</span> <span class="id">_</span> <span class="id">[::</span> <span class="id">b,</span> <span class="id">h</span> <span class="id">&amp;</span> <span class="id">t]</span>) <span class="id">[in</span> <span class="id">LHS]</span>(<span class="id">insertE</span> <span class="id">_</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>)).<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]</span>(<span class="id">insertE</span> <span class="id">_</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>)) <span class="id">[in</span> <span class="id">RHS]alt_bindDl</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">2![in</span> <span class="id">RHS]insertE</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]alt_fmapDr</span> <span class="id">![in</span> <span class="id">LHS]altA</span> <span class="id">[in</span> <span class="id">LHS]</span>(<span class="id">altC</span> (<span class="id">Ret</span> <span class="id">[::</span> <span class="id">a,</span> <span class="id">b,</span> <span class="id">h</span> <span class="id">&amp;</span> <span class="id">t]</span>)).<br/>
<span class="id">rewrite</span> <span class="id">-!altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">alt_fmapDr</span> <span class="id">-!altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]altC</span> <span class="id">bind_fmap</span> <span class="id">/=</span> <span class="id">[in</span> <span class="id">LHS]/comp</span> <span class="id">/=</span>.<br/>
<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insertE</span>.<br/>
<span class="id">rewrite</span> <span class="id">alt_bindDr</span>.<br/>
<span class="id">under</span> <span class="id">[in</span> <span class="id">X</span> <span class="gallina-kwd">in</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">X</span>) <span class="id">[~]</span> <span class="id">_]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">fmapE</span>.<br/>
<span class="id">rewrite</span> <span class="id">-bindA</span> <span class="id">[in</span> <span class="id">LHS]ih</span> <span class="id">//</span> <span class="id">[in</span> <span class="id">RHS]altC</span> <span class="id">bind_fmap</span> <span class="id">/=</span> <span class="id">[in</span> <span class="id">RHS]/comp</span> <span class="id">/=</span>.<br/>
<span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insertE</span>.<br/>
<span class="id">rewrite</span> <span class="id">alt_bindDr</span> <span class="id">[in</span> <span class="id">RHS]altC</span> <span class="id">-!altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!fmapE</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">!bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]altC;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!fmapE</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">fmapE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_cat</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">h</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">u</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> <span class="id">h</span> (<span class="id">a</span> <span class="id">++</span> <span class="id">u</span> <span class="id">::</span> <span class="id">b</span>) <span class="id">=</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">h</span> <span class="id">a;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">++</span> <span class="id">u</span> <span class="id">::</span> <span class="id">b</span>))<span class="id">%Do</span> <span class="id">[~]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">h</span> <span class="id">b;</span> <span class="id">Ret</span> (<span class="id">a</span> <span class="id">++</span> <span class="id">u</span> <span class="id">::</span> <span class="id">x</span>))<span class="id">%Do</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof28')">Proof.</span></div>
<div class="proofscript" id="proof28">
<span class="id">elim:</span> <span class="id">a</span> <span class="id">h</span> <span class="id">u</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[h</span> <span class="id">u</span> <span class="id">b|a1</span> <span class="id">a2</span> <span class="id">ih</span> <span class="id">h</span> <span class="id">u</span> <span class="id">b]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> (<span class="id">insertE</span> <span class="id">h</span> <span class="id">nil</span>) <span class="id">bindretf</span> <span class="id">insertE</span> <span class="id">fmapE</span>.<br/>
<span class="id">rewrite</span> <span class="id">cat_cons</span> <span class="id">[in</span> <span class="id">LHS]insertE</span> <span class="id">[u</span> <span class="id">::</span> <span class="id">b]lock</span> <span class="id">/=</span> <span class="id">-lock</span> <span class="id">[in</span> <span class="id">LHS]ih</span>.<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]insertE</span> <span class="id">[in</span> <span class="id">RHS]alt_bindDl</span> <span class="id">bindretf</span> <span class="id">-altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>).<br/>
<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]bind_fmap</span> <span class="id">[in</span> <span class="id">LHS]fmapE</span> <span class="id">[in</span> <span class="id">LHS]alt_bindDl</span> <span class="id">!bindA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">insert_plusMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">insert_nondetMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">nondetMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span>.<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_Ret</span> <span class="id">a</span> <span class="id">s</span> <span class="id">:</span> <span class="gallina-kwd">exists</span> <span class="id">m,</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">a</span> <span class="id">::</span> <span class="id">s</span>) <span class="id">[~]</span> <span class="id">m</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof29')">Proof.</span></div>
<div class="proofscript" id="proof29">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">[m</span> <span class="id">ih]]</span> <span class="id">/=;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">eexists;</span> <span class="id">rewrite</span> <span class="id">insertE;</span> <span class="id">reflexivity</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE;</span> <span class="gallina-kwd">exists</span> <span class="id">fail;</span> <span class="id">rewrite</span> <span class="id">altmfail</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">insert_nondetMonad</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">iperm</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span> <span class="id">iperm</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> <span class="id">insert</span> <span class="id">h</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">iperm_altMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_o_map</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">iperm</span> <span class="id">\o</span> <span class="id">map</span> <span class="id">f</span> <span class="id">=</span> <span class="id">map</span> <span class="id">f</span> (<span class="id">o</span>) <span class="id">iperm</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof30')">Proof.</span></div>
<div class="proofscript" id="proof30">
<span class="id">apply</span> <span class="id">funext;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[/=|x</span> <span class="id">xs</span> <span class="id">IH]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">[iperm</span> <span class="id">_]/=</span> <span class="id">-[in</span> <span class="id">RHS]compE</span> (<span class="id">natural</span> <span class="id">ret</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">[in</span> <span class="id">iperm</span> <span class="id">_]/=</span> <span class="id">fmap_bind</span> <span class="id">-insert_map</span> <span class="id">-bind_fmap</span> <span class="id">-fcompE</span> <span class="id">-IH</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">Mmm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">idempotent</span> (<span class="id">@alt</span> <span class="id">_</span> <span class="id">A</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Variables</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_filter</span> <span class="id">:</span> <span class="id">iperm</span> <span class="id">\o</span> <span class="id">filter</span> <span class="id">p</span> <span class="id">=</span> <span class="id">filter</span> <span class="id">p</span> (<span class="id">o</span>) <span class="id">iperm</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof31')">Proof.</span></div>
<div class="proofscript" id="proof31">
<span class="id">apply</span> <span class="id">funext;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">/=</span> <span class="id">IH]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">fmapE</span> <span class="id">bindretf</span>.<br/>
<span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">ph</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">LHS]/=</span> <span class="id">IH</span> <span class="id">[in</span> <span class="id">LHS]fcomp_def</span> <span class="id">compE</span> <span class="id">[in</span> <span class="id">LHS]bind_fmap</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]fcomp_def</span> <span class="id">compE</span> <span class="id">-/</span>(<span class="id">fmap</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">[in</span> <span class="id">RHS]fmap_bind;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">filter_insertT</span>.<br/>
<span class="id">rewrite</span> <span class="id">fcompE</span> <span class="id">fmap_bind</span> <span class="id">IH</span> <span class="id">fcompE</span> <span class="id">fmapE;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">filter_insertN</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">iperm_altMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">iperm_nondetMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">nondetMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span>.<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_is_alt_ret</span> <span class="id">s</span> <span class="id">:</span> <span class="gallina-kwd">exists</span> <span class="id">m,</span> <span class="id">iperm</span> <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">s</span> <span class="id">[~]</span> <span class="id">m</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof32')">Proof.</span></div>
<div class="proofscript" id="proof32">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[|h</span> <span class="id">t</span> <span class="id">[m</span> <span class="id">ih]</span> <span class="id">/=];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="gallina-kwd">exists</span> <span class="id">fail;</span> <span class="id">rewrite</span> <span class="id">altmfail</span>.<br/>
<span class="id">case:</span> (<span class="id">@insert_Ret</span> <span class="id">M</span> <span class="id">A</span> <span class="id">h</span> <span class="id">t</span>) <span class="id">=&gt;</span> <span class="id">n</span> <span class="id">Hn</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">eexists;</span> <span class="id">rewrite</span> <span class="id">ih</span> <span class="id">alt_bindDl</span> <span class="id">bindretf</span> <span class="id">Hn</span> <span class="id">-altA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">iperm_nondetMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">iperm_plusMonad</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">plusMonad}</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">iperm_insert</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span> <span class="id">a</span> <span class="id">b</span> (<span class="id">s</span> <span class="id">t</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">iperm</span> (<span class="id">b</span> <span class="id">::</span> <span class="id">s</span> <span class="id">++</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">x</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">s</span> <span class="id">a</span> <span class="id">++</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">insert</span> <span class="id">b</span> <span class="id">x</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">%Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof33')">Proof.</span></div>
<div class="proofscript" id="proof33">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">[/=|h</span> <span class="id">tl</span> <span class="id">ih]</span> <span class="gallina-kwd">in</span> <span class="id">a</span> <span class="id">b</span> <span class="id">t</span> <span class="id">*</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">!bindA</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insertC</span>.<br/>
<span class="id">rewrite</span> <span class="id">[h</span> <span class="id">::</span> <span class="id">tl]lock</span> <span class="id">/=</span> <span class="id">-lock</span> <span class="id">ih</span> <span class="id">/=</span> <span class="id">!bindA</span>.<br/>
<span class="id">suff</span> <span class="id">:</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">tl</span> <span class="id">b</span> <span class="id">++</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">do</span> <span class="id">x0</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">a</span> <span class="id">x;</span> <span class="id">insert</span> <span class="id">h</span> <span class="id">x0</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">iperm</span> (<span class="id">rcons</span> <span class="id">tl</span> <span class="id">a</span> <span class="id">++</span> <span class="id">t</span>)<span class="id">;</span> <span class="id">do</span> <span class="id">x0</span> <span class="id">&lt;-</span> <span class="id">insert</span> <span class="id">b</span> <span class="id">x;</span> <span class="id">insert</span> <span class="id">h</span> <span class="id">x0</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">%Do</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insertC</span>.<br/>
&nbsp;&nbsp;<span class="id">move=&gt;</span> <span class="id">-&gt;</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">insertC</span>.<br/>
<span class="id">rewrite</span> <span class="id">-bindA</span> <span class="id">-ih</span> <span class="id">/=</span> <span class="id">-bindA</span> <span class="id">-[in</span> <span class="id">RHS]ih</span> <span class="id">/=</span> <span class="id">!bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a'</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-bindA</span> <span class="id">insertC</span> <span class="id">bindA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">iperm_plusMonad</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">select</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">nondetMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">select</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">A</span>)<span class="id">%type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">fail</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;(<span class="id">Ret</span> (<span class="id">h,</span> <span class="id">t</span>) <span class="id">[~]</span> <span class="id">select</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span>.<span class="id">1,</span> <span class="id">h</span> <span class="id">::</span> <span class="id">x</span>.<span class="id">2</span>))).<br/>
<br/>
<span class="vernacular">End</span> <span class="id">select</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">select</span> <span class="id">{M}</span> <span class="id">{A}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">uperm</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">nondetMonad</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">uperm</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">unfoldM</span> (<span class="id">@well_founded_size</span> <span class="id">_</span>) (<span class="id">@nilp</span> <span class="id">_</span>) <span class="id">select</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">uperm</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">uperm</span> <span class="id">{A}</span> <span class="id">{M}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">splits</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span>.<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">splits</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">A</span>)<span class="id">%type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">x</span> <span class="id">::</span> <span class="id">xs</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">[::],</span> <span class="id">[::]</span>) <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">splits</span> <span class="id">xs</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">yz</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">yz</span>.<span class="id">1,</span> <span class="id">yz</span>.<span class="id">2</span>) <span class="id">[~]</span> <span class="id">Ret</span> (<span class="id">yz</span>.<span class="id">1,</span> <span class="id">x</span> <span class="id">::</span> <span class="id">yz</span>.<span class="id">2</span>)).<br/>
<br/>
<span class="vernacular">End</span> <span class="id">splits</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">fastproduct</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">product</span> <span class="id">:=</span> <span class="id">foldr</span> <span class="id">muln</span> <span class="id">1</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">product0</span> <span class="id">s</span> <span class="id">:</span> <span class="id">O</span> <span class="id">\in</span> <span class="id">s</span> <span class="id">-&gt;</span> <span class="id">product</span> <span class="id">s</span> <span class="id">=</span> <span class="id">O</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof34')">Proof.</span></div>
<div class="proofscript" id="proof34">
<span class="id">elim:</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">//=</span> <span class="id">h</span> <span class="id">t</span> <span class="id">ih;</span> <span class="id">rewrite</span> <span class="id">inE</span> <span class="id">=&gt;</span> <span class="id">/orP[/eqP</span> <span class="id">&lt;-|/ih</span> <span class="id">-&gt;];</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">?muln0</span> <span class="id">?mul0n</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">work</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">work</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">O</span> <span class="id">\in</span> <span class="id">s</span> <span class="gallina-kwd">then</span> <span class="id">fail</span> <span class="gallina-kwd">else</span> <span class="id">Ret</span> (<span class="id">product</span> <span class="id">s</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Work</span> <span class="id">s</span> <span class="id">:=</span> <span class="gallina-kwd">if</span> <span class="id">O</span> <span class="id">\in</span> <span class="id">s</span> <span class="gallina-kwd">then</span> <span class="id">@fail</span> <span class="id">M</span> <span class="id">nat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">Ret</span> (<span class="id">product</span> <span class="id">s</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">workE</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">next</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">n</span> (<span class="id">mx</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="gallina-kwd">if</span> <span class="id">n</span> <span class="id">==</span> <span class="id">0</span> <span class="gallina-kwd">then</span> <span class="id">fail</span> <span class="gallina-kwd">else</span> <span class="id">fmap</span> (<span class="id">muln</span> <span class="id">n</span>) <span class="id">mx</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">work</span> <span class="id">=</span> <span class="id">foldr</span> <span class="id">next</span> (<span class="id">Ret</span> <span class="id">1</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof35')">Proof.</span></div>
<div class="proofscript" id="proof35">
<span class="id">apply</span> <span class="id">foldr_universal</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">h</span> <span class="id">t;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">[/eqP</span> <span class="id">-&gt;</span> <span class="id">//|</span> <span class="id">h0]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/work</span> <span class="id">inE</span> <span class="id">eq_sym</span> (<span class="id">negbTE</span> <span class="id">h0</span>) <span class="id">[_</span> <span class="id">||</span> <span class="id">_]/=</span> <span class="id">fmap_if</span> <span class="id">fmap_fail</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">work</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">work</span> <span class="id">{M}</span>.<br/>
<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">exceptMonad</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">fastprod</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">catch</span> (<span class="id">work</span> <span class="id">s</span>) (<span class="id">Ret</span> <span class="id">O</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Fastprod</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">nat</span>) <span class="id">:=</span> <span class="id">@catch</span> <span class="id">M</span> <span class="id">nat</span> (<span class="id">work</span> <span class="id">s</span>) (<span class="id">Ret</span> <span class="id">O</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fastprodE</span> <span class="id">s</span> <span class="id">:</span> <span class="id">fastprod</span> <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">product</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof36')">Proof.</span></div>
<div class="proofscript" id="proof36">
<span class="id">rewrite</span> <span class="id">/fastprod</span> <span class="id">/work</span> <span class="id">fun_if</span> <span class="id">if_arg</span> <span class="id">catchfailm</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">catchret;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">/product0</span> <span class="id">&lt;-</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">fastproduct</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">addM</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">a</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">b</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">+</span> <span class="id">y</span>))).<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;a +m b&quot; := (addM a b) (at level 50, format &quot;a  +m  b&quot;</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">mulM</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">a</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">b</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">*</span> <span class="id">y</span>))).<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;a *m b&quot; := (mulM a b) (at level 50, format &quot;a  *m  b&quot;</span>).<br/>
<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">continuation_example</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">contMonad</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">wadler94_sect31</span> <span class="id">:</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> <span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> <span class="id">f</span> <span class="id">100</span>) <span class="id">=</span> <span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">100</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof37')">Proof.</span></div>
<div class="proofscript" id="proof37">
<span class="id">rewrite</span> <span class="id">{1}/addM</span> <span class="id">bindretf</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">callcc</span> <span class="id">_</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">100</span>) <span class="id">?bindretf</span> <span class="id">//</span>.<br/>
<span class="id">transitivity</span> (<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">100</span>))<span class="id">;</span> <span class="id">last</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">callcc1</span>.<br/>
<span class="id">transitivity</span> (<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">10</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">100</span>)))<span class="id">;</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">callcc2</span>.<br/>
<span class="id">rewrite</span> <span class="id">callcc3</span> <span class="id">//;</span> <span class="id">congr</span> <span class="id">callcc</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">continuation_example</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">shiftreset_examples</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">shiftresetMonad</span> <span class="id">nat</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">wadler94_sect32_1</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">reset</span> (<span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">100</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> <span class="id">100</span>))).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof38')">Proof.</span></div>
<div class="proofscript" id="proof38">
<span class="id">rewrite</span> <span class="id">/addM</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">transitivity</span> ((<span class="id">Ret</span> (<span class="id">10</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> <span class="id">100</span>))) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">y</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">congr</span> (<span class="id">bind</span> <span class="id">_</span> <span class="id">_</span>).<br/>
<span class="id">rewrite</span> <span class="id">shiftreset3</span>.<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">10;</span> <span class="id">_</span> <span class="id">=</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> <span class="id">shift</span> (<span class="id">@^~</span> <span class="id">100</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_;</span> <span class="id">Ret</span> (<span class="id">10</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> <span class="id">y</span>)))<span class="id">%Do;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">shiftreset4</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">wadler94_sect32_2</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">reset</span> (<span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">100</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">100</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof39')">Proof.</span></div>
<div class="proofscript" id="proof39">
<span class="id">rewrite</span> <span class="id">/addM</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">transitivity</span> (<span class="id">Ret</span> <span class="id">100</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">y</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
<span class="id">congr</span> (<span class="id">bind</span> <span class="id">_</span> <span class="id">_</span>).<br/>
<span class="id">rewrite</span> (<span class="id">shiftreset2</span> <span class="id">_</span> <span class="id">_</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">shiftreset_examples</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">refin</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">A</span> (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="gallina-kwd">Prop</span> <span class="id">:=</span> <span class="id">m1</span> <span class="id">[~]</span> <span class="id">m2</span> <span class="id">=</span> <span class="id">m2</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;m1 `&lt;=` m2&quot;</span> <span class="id">:=</span> (<span class="id">refin</span> <span class="id">m1</span> <span class="id">m2</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_bindr</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>) <span class="id">A</span> <span class="id">B</span> (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">m1</span> <span class="id">`&lt;=`</span> <span class="id">m2</span>) <span class="id">-&gt;</span> (<span class="id">m1</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">`&lt;=`</span> <span class="id">m2</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof40')">Proof.</span></div>
<div class="proofscript" id="proof40">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">m12;</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">-alt_bindDl</span> <span class="id">m12</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_if</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altMonad</span>) <span class="id">A</span> (<span class="id">m1</span> <span class="id">m2</span> <span class="id">m1'</span> <span class="id">m2'</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">b</span> <span class="id">:</span> <span class="id">bool</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">b</span> <span class="id">-&gt;</span> <span class="id">m1</span> <span class="id">`&lt;=`</span> <span class="id">m1'</span>) <span class="id">-&gt;</span> (<span class="id">~~</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">m2'</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">if</span> <span class="id">b</span> <span class="gallina-kwd">then</span> <span class="id">m1</span> <span class="gallina-kwd">else</span> <span class="id">m2</span>) <span class="id">`&lt;=`</span> (<span class="gallina-kwd">if</span> <span class="id">b</span> <span class="gallina-kwd">then</span> <span class="id">m1'</span> <span class="gallina-kwd">else</span> <span class="id">m2'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof41')">Proof.</span></div>
<div class="proofscript" id="proof41">
 <span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[+</span> <span class="id">_|_];</span> <span class="id">exact</span>. Qed.</div>
<br/>
<span class="vernacular">Import</span> <span class="id">Order.TTheory</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">order_scope</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">refin_lemmas_altCIMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>.<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_refl</span> <span class="id">A</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">a</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof42')">Proof.</span></div>
<div class="proofscript" id="proof42">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">altmm</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">eq_refin</span> <span class="id">A</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">=</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof43')">Proof.</span></div>
<div class="proofscript" id="proof43">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">-&gt;;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_trans</span> <span class="id">A</span> (<span class="id">b</span> <span class="id">a</span> <span class="id">c</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">b</span> <span class="id">`&lt;=`</span> <span class="id">c</span> <span class="id">-&gt;</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">c</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof44')">Proof.</span></div>
<div class="proofscript" id="proof44">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">=&gt;</span> <span class="id">h1</span> <span class="id">&lt;-;</span> <span class="id">rewrite</span> <span class="id">altA</span> <span class="id">h1</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_antisym</span> <span class="id">A</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">b</span> <span class="id">`&lt;=`</span> <span class="id">a</span> <span class="id">-&gt;</span> <span class="id">a</span> <span class="id">=</span> <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof45')">Proof.</span></div>
<div class="proofscript" id="proof45">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">=&gt;</span> <span class="id">h1</span> <span class="id">&lt;-;</span> <span class="id">rewrite</span> <span class="id">altC</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_alt</span> <span class="id">A</span> (<span class="id">m1</span> <span class="id">m1'</span> <span class="id">m2</span> <span class="id">m2'</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m1</span> <span class="id">`&lt;=`</span> <span class="id">m1'</span> <span class="id">-&gt;</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">m2'</span> <span class="id">-&gt;</span> <span class="id">m1</span> <span class="id">[~]</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">m1'</span> <span class="id">[~]</span> <span class="id">m2'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof46')">Proof.</span></div>
<div class="proofscript" id="proof46">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">h1</span> <span class="id">h2;</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">altACA</span> <span class="id">h1</span> <span class="id">h2</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refinR</span> <span class="id">A</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;=`</span> <span class="id">a</span> <span class="id">[~]</span> <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof47')">Proof.</span></div>
<div class="proofscript" id="proof47">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">altA</span> <span class="id">altmm</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">refin_lemmas_altCIMonad</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">lrefin</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">altMonad}</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:=</span> <span class="gallina-kwd">forall</span> <span class="id">x,</span> <span class="id">f</span> <span class="id">x</span> <span class="id">`&lt;=`g</span> <span class="id">x</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;f `&lt;.=` g&quot;</span> <span class="id">:=</span> (<span class="id">lrefin</span> <span class="id">f</span> <span class="id">g</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">lrefin_lemmas_altCIMonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">lrefin_refl</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">a</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof48')">Proof.</span></div>
<div class="proofscript" id="proof48">
 <span class="gallina-kwd">by</span> <span class="id">move</span> <span class="id">=&gt;</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">lrefin_trans</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">b</span> <span class="id">a</span> <span class="id">c</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">b</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">c</span> <span class="id">-&gt;</span> <span class="id">a</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">c</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof49')">Proof.</span></div>
<div class="proofscript" id="proof49">
 <span class="gallina-kwd">by</span> <span class="id">move</span> <span class="id">=&gt;</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">refin_trans</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">lrefin_antisym</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">a</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">b</span> <span class="id">-&gt;</span> <span class="id">b</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">a</span> <span class="id">-&gt;</span> <span class="id">a</span> <span class="id">=</span> <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof50')">Proof.</span></div>
<div class="proofscript" id="proof50">
 <span class="id">move</span> <span class="id">=&gt;</span> <span class="id">?</span> <span class="id">?;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">?;</span> <span class="id">exact:</span> <span class="id">refin_antisym</span>. Qed.</div>
<span class="vernacular">End</span> <span class="id">lrefin_lemmas_altCIMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_bindl</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">prePlusMonad</span>) <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">g</span>) <span class="id">-&gt;</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">`&lt;=`</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">g</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof51')">Proof.</span></div>
<div class="proofscript" id="proof51">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">fg;</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">-alt_bindDr;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">exact:</span> <span class="id">fg</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_bind</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) <span class="id">A</span> <span class="id">B</span> <span class="id">{m</span> <span class="id">n</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A}</span> <span class="id">{f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B}</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">`&lt;=`</span> <span class="id">n</span> <span class="id">-&gt;</span> <span class="id">f</span> <span class="id">`&lt;</span>.<span class="id">=`</span> <span class="id">g</span> <span class="id">-&gt;</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">`&lt;=`</span> (<span class="id">n</span> <span class="id">&gt;&gt;=</span> <span class="id">g</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof52')">Proof.</span></div>
<div class="proofscript" id="proof52">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">mn</span> <span class="id">/refin_bindl</span> <span class="id">?;</span> <span class="id">exact:</span> (<span class="id">refin_trans</span> <span class="id">_</span> (<span class="id">refin_bindr</span> <span class="id">_</span> <span class="id">mn</span>)).<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_liftM2</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">{f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">C}</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">{m1</span> <span class="id">n1</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A}</span> <span class="id">{m2</span> <span class="id">n2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">B}</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m1</span> <span class="id">`&lt;=`</span> <span class="id">n1</span> <span class="id">-&gt;</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">n2</span> <span class="id">-&gt;</span> <span class="id">liftM2</span> <span class="id">f</span> <span class="id">m1</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">liftM2</span> <span class="id">f</span> <span class="id">n1</span> <span class="id">n2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof53')">Proof.</span></div>
<div class="proofscript" id="proof53">
<span class="id">move=&gt;</span> <span class="id">mn1</span> <span class="id">mn2;</span> <span class="id">rewrite</span> <span class="id">/liftM2</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply:</span> (<span class="id">refin_bind</span> <span class="id">mn1</span> <span class="id">_</span>) <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">exact:</span> <span class="id">refin_bindr</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_guard_le</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) (<span class="id">d</span> <span class="id">:</span> <span class="id">unit</span>) (<span class="id">T</span> <span class="id">:</span> <span class="id">orderType</span> <span class="id">d</span>) (<span class="id">x</span> <span class="id">y</span> <span class="id">:</span> <span class="id">T</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">guard</span> (<span class="id">~~</span> (<span class="id">y</span> <span class="id">&lt;=</span> <span class="id">x</span>)<span class="id">%O</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">`&lt;=`</span> <span class="id">guard</span> (<span class="id">x</span> <span class="id">&lt;=</span> <span class="id">y</span>)<span class="id">%O</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof54')">Proof.</span></div>
<div class="proofscript" id="proof54">
<span class="id">rewrite</span> <span class="id">-ltNge</span> <span class="id">le_eqVlt</span>.<br/>
<span class="id">case:</span> <span class="id">guardPn</span> <span class="id">=&gt;</span> <span class="id">H</span>.<br/>
<span class="id">rewrite</span> <span class="id">orbT</span> <span class="id">guardT;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">orbF</span> <span class="id">/refin</span> <span class="id">altfailm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_if_guard</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) <span class="id">A</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">bool</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">if</span> <span class="id">p</span> <span class="gallina-kwd">then</span> <span class="id">m1</span> <span class="gallina-kwd">else</span> <span class="id">m2</span>) <span class="id">`&lt;=`</span> (<span class="id">guard</span> <span class="id">p</span> <span class="id">&gt;&gt;</span> <span class="id">m1</span>) <span class="id">[~]</span> (<span class="id">guard</span> (<span class="id">~~</span> <span class="id">p</span>) <span class="id">&gt;&gt;</span> <span class="id">m2</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof55')">Proof.</span></div>
<div class="proofscript" id="proof55">
<span class="id">rewrite</span> <span class="id">/refin;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">[pT|pF];</span> <span class="id">rewrite</span> <span class="id">!</span>(<span class="id">guardT,guardF</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindskipf</span> <span class="id">bindfailf</span> <span class="id">altA</span> <span class="id">altmm</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindfailf</span> <span class="id">bindskipf</span> <span class="id">altCA</span> <span class="id">altmm</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_bind_guard</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">plusMonad}</span> <span class="id">A</span> (<span class="id">b</span> <span class="id">:</span> <span class="id">bool</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">b</span> <span class="id">-&gt;</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">m1</span>) <span class="id">-&gt;</span> <span class="id">guard</span> <span class="id">b</span> <span class="id">&gt;&gt;</span> <span class="id">m2</span> <span class="id">`&lt;=`</span> <span class="id">guard</span> <span class="id">b</span> <span class="id">&gt;&gt;</span> <span class="id">m1</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof56')">Proof.</span></div>
<div class="proofscript" id="proof56">
<span class="id">case:</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">[h|_];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">refin_bindl</span> <span class="id">=&gt;</span> <span class="id">-[];</span> <span class="id">exact:</span> <span class="id">h</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">guardF</span> <span class="id">!bindfailf;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_ret_insert</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">h</span> (<span class="id">t</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">`&lt;=`</span> (<span class="id">insert</span> <span class="id">h</span> <span class="id">t</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof57')">Proof.</span></div>
<div class="proofscript" id="proof57">
<span class="id">elim:</span> <span class="id">t</span> <span class="id">h</span> <span class="id">=&gt;</span> <span class="id">[h|t1</span> <span class="id">t2</span> <span class="id">ih</span> <span class="id">h];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE;</span> <span class="id">exact:</span> <span class="id">refin_refl</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">insertE;</span> <span class="id">exact:</span> <span class="id">refinR</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">refin_ret_iperm</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">plusMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">Ret</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">`&lt;=`</span> <span class="id">iperm</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof58')">Proof.</span></div>
<div class="proofscript" id="proof58">
<span class="gallina-kwd">by</span> <span class="id">case:</span> (<span class="id">@iperm_is_alt_ret</span> <span class="id">M</span> <span class="id">_</span> <span class="id">s</span>) <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">-&gt;;</span> <span class="id">rewrite</span> <span class="id">/refin</span> <span class="id">altA</span> <span class="id">altmm</span>.<br/>
Qed.</div>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/yoshihiro503/coq2html/">a fork of coq2html</a></div>
</body>
</html>

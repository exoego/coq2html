
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module monae.impredicative_set.imonad_model</title>
<meta name="description" content="Documentation of Coq module monae.impredicative_set.imonad_model" />
<link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath/texmath.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="init('proofscript')">

  <header>
    <p><a href="./index.html">coq2html</a></p>
    <h1 class="title">Module monae.impredicative_set.imonad_model</h1>
    <p><a href="">source</a></p>
  </header>

  <main>
    <div class="sidebar">
      <h2>Files</h2>
      <li><details><summary>monae</summary>
          <ul>
          <li><a href="monae.proba_monad_model.html">proba_monad_model</a></li>
<li><a href="monae.example_monty.html">example_monty</a></li>
<li><a href="monae.typed_store_lib.html">typed_store_lib</a></li>
<li><a href="monae.monae_lib.html">monae_lib</a></li>
<li><a href="monae.example_spark.html">example_spark</a></li>
<li><a href="monae.example_quicksort.html">example_quicksort</a></li>
<li><a href="monae.monad_model.html">monad_model</a></li>
<li><a href="monae.fail_lib.html">fail_lib</a></li>
<li><a href="monae.category.html">category</a></li>
<li><a href="monae.altprob_model.html">altprob_model</a></li>
<li><a href="monae.typed_store_model.html">typed_store_model</a></li>
<li><a href="monae.category_ext.html">category_ext</a></li>
<li><a href="monae.proba_lib.html">proba_lib</a></li>
<li><a href="monae.monad_composition.html">monad_composition</a></li>
<li><a href="monae.example_transformer.html">example_transformer</a></li>
<li><a href="monae.hierarchy.html">hierarchy</a></li>
<li><a href="monae.example_typed_store.html">example_typed_store</a></li>
<li><a href="monae.example_relabeling.html">example_relabeling</a></li>
<li><a href="monae.monad_lib.html">monad_lib</a></li>
<li><a href="monae.example_nqueens.html">example_nqueens</a></li>
<li><a href="monae.smallstep.html">smallstep</a></li>
<li><a href="monae.array_lib.html">array_lib</a></li>
<li><a href="monae.state_lib.html">state_lib</a></li>
<li><a href="monae.monad_transformer.html">monad_transformer</a></li>
<li><a href="monae.example_iquicksort.html">example_iquicksort</a></li>
<li><a href="monae.gcm_model.html">gcm_model</a></li>
<li><a href="monae.trace_lib.html">trace_lib</a></li>
          </ul>
          </details>
          </li>
<li><details><summary>monaeImpredicativeSet</summary>
          <ul>
          <li><a href="monaeImpredicativeSet.imonad_composition.html">imonad_composition</a></li>
<li><a href="monaeImpredicativeSet.ihierarchy.html">ihierarchy</a></li>
<li><a href="monaeImpredicativeSet.imonad_lib.html">imonad_lib</a></li>
<li><a href="monaeImpredicativeSet.imonae_lib.html">imonae_lib</a></li>
<li><a href="monaeImpredicativeSet.ifail_lib.html">ifail_lib</a></li>
          </ul>
          </details>
          </li>
    </div>

  <div class="coq">

    <div class="content">
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">all_ssreflect</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">imonae_lib</span>.<br/>
<span class="vernacular">From</span> <span class="id">HB</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">structures</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">ihierarchy</span> <span class="id">imonad_lib</span> <span class="id">ifail_lib</span> <span class="id">istate_lib</span> <span class="id">itrace_lib</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">imonad_transformer</span>.<br/>
<span class="vernacular">Require</span> <span class="id">PropExtensionality</span>.<br/>
<br/>
<pre class="ssrdoc">
                      Models for various monads                            
                                                                           
Sample models for monads in hierarchy.v (see also other *_model.v files).  
As for naming, we tend to use the identifier acto for the actions on       
objects and actm for the actions on morphisms.                             
                                                                           
Instances of monads (Modules):                                             
IdentityMonad      == identity monad idfun                                 
ListMonad          == list monad seq                                       
ExceptMonad        == exception monad E + A                                
option_monad       == alias for ExceptMonad.acto unit                      
OutputMonad        == output monad X * seq L                               
EnvironmentMonad   == environment monad E -&gt; A                             
StateMonad         == state monad S -&gt; A * S                               
ContMonad          == continuation monad (A -&gt; r) -&gt; r                     
                                                                           
Sigma-operations (with algebraicity proofs):                               
empty_op                == empty operation                                 
append_op               == append operation                                
flush_op                == flush operation                                 
output_op               == output operation                                
ask_op                  == ask operation                                   
local_op                == local operation                                 
throw_op                == throw operation                                 
handle_op               == handle operation                                
get_op                  == get operation                                   
put_op                  == put operation                                   
abort_op                == abort operation                                 
acallcc_op              == algebraic callcc operation                      
                                                                           
Models of interfaces:                                                      
Module Fail             == failMonad for option_monad, ListMonad.acto, set 
Module Except           == exceptMonad for ExcetMonad.acto unit            
Module State            == stateMonad for StateMonad.acto S                
Module Alt              == altMonad for ListMonad.acto, set                
Module AltCI            == altCIMonad for ListMonad.acto, set              
Module Nondet           == nondetMonad for ListMonad.acto, set             
Module ModelStateTrace  == stateTraceMonad for StateMonad.acto (S * seq T) 
Module ModelCont        == contMonad for ContMonad.acto r                  
Module ModelShiftReset  == shiftResetMonad for ContMonad.acto r            
Module ModelReify       == reifyModel for StateMonad.acto (S * seq T)      
Module ModelStateTraceReify == stateTraceReify monad for                   
                               StateMonad.acto (S * seq T)                 
Module ModelArray       == array monad                                     
Module ModelMonadStateRun       == stateRunMonad for MS                    
Module ModelMonadExceptStateRun == exceptStateRunMonad                     
                                                                           
references:                                                                
- Wadler, P. Monads and composable continuations. LISP and Symbolic        
  Computation 7, 39â€“55 (1994)                                              
</pre>
<br/>
<span class="gallina-kwd">Set</span> <span class="vernacular">Implicit</span> <span class="vernacular">Arguments</span>.<br/>
<span class="vernacular">Unset</span> <span class="vernacular">Strict</span> <span class="vernacular">Implicit</span>.<br/>
<span class="vernacular">Unset</span> <span class="vernacular">Printing</span> <span class="vernacular">Implicit</span> <span class="vernacular">Defensive</span>.<br/>
<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">assoc</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">I</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">s</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">I</span> <span class="id">-&gt;</span> <span class="id">S</span>) <span class="id">j</span> <span class="id">:=</span> <span class="gallina-kwd">if</span> <span class="id">i</span> <span class="id">==</span> <span class="id">j</span> <span class="gallina-kwd">then</span> <span class="id">s</span> <span class="gallina-kwd">else</span> <span class="id">a</span> <span class="id">j</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">insert_insert</span> <span class="id">i</span> <span class="id">s'</span> <span class="id">s</span> <span class="id">a</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> <span class="id">i</span> <span class="id">s'</span> (<span class="id">insert</span> <span class="id">i</span> <span class="id">s</span> <span class="id">a</span>) <span class="id">=</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">s'</span> <span class="id">a</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof1')">Proof.</span></div>
<div class="proofscript" id="proof1">
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">j;</span> <span class="id">rewrite</span> <span class="id">/insert;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">/negbTE</span> <span class="id">-&gt;</span>.<br/>
Qed.</div>
<span class="vernacular">Lemma</span> <span class="id">insert_same</span> <span class="id">i</span> <span class="id">a</span> <span class="id">s</span> <span class="id">:</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">s</span> <span class="id">a</span> <span class="id">i</span> <span class="id">=</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof2')">Proof.</span></div>
<div class="proofscript" id="proof2">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/insert</span> <span class="id">eqxx</span>. Qed.</div>
<span class="vernacular">Lemma</span> <span class="id">insert_same2</span> <span class="id">i</span> <span class="id">a</span> <span class="id">:</span> <span class="id">insert</span> <span class="id">i</span> (<span class="id">a</span> <span class="id">i</span>) <span class="id">a</span> <span class="id">=</span> <span class="id">a</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof3')">Proof.</span></div>
<div class="proofscript" id="proof3">
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">j;</span> <span class="id">rewrite</span> <span class="id">/insert;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">/eqP</span> <span class="id">-&gt;</span>.<br/>
Qed.</div>
<span class="vernacular">Lemma</span> <span class="id">insertC</span> <span class="id">j</span> <span class="id">i</span> <span class="id">v</span> <span class="id">u</span> <span class="id">a</span> <span class="id">:</span> <span class="id">i</span> <span class="id">!=</span> <span class="id">j</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">insert</span> <span class="id">j</span> <span class="id">v</span> (<span class="id">insert</span> <span class="id">i</span> <span class="id">u</span> <span class="id">a</span>) <span class="id">=</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">u</span> (<span class="id">insert</span> <span class="id">j</span> <span class="id">v</span> <span class="id">a</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof4')">Proof.</span></div>
<div class="proofscript" id="proof4">
<span class="id">move=&gt;</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">k;</span> <span class="id">rewrite</span> <span class="id">/insert;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">/eqP</span> <span class="id">&lt;-{k}</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> (<span class="id">negbTE</span> <span class="id">h</span>).<br/>
Qed.</div>
<span class="vernacular">Lemma</span> <span class="id">insertC2</span> <span class="id">j</span> <span class="id">i</span> <span class="id">v</span> <span class="id">a</span> <span class="id">:</span> <span class="id">insert</span> <span class="id">j</span> <span class="id">v</span> (<span class="id">insert</span> <span class="id">i</span> <span class="id">v</span> <span class="id">a</span>) <span class="id">=</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">v</span> (<span class="id">insert</span> <span class="id">j</span> <span class="id">v</span> <span class="id">a</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof5')">Proof.</span></div>
<div class="proofscript" id="proof5">
<span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">k;</span> <span class="id">rewrite</span> <span class="id">/insert;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">/eqP</span> <span class="id">&lt;-{k}</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">if_same</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">assoc</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">IdentityMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">identitymonad</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">a</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> (<span class="id">NId</span> <span class="id">idfun</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof6')">Proof.</span></div>
<div class="proofscript" id="proof6">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> (<span class="id">NId</span> <span class="id">idfun</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof7')">Proof.</span></div>
<div class="proofscript" id="proof7">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof8')">Proof.</span></div>
<div class="proofscript" id="proof8">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">acto</span> <span class="id">:=</span> (@<span class="id">idfun</span> <span class="id">UU0</span>).<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonad_ret_bind.Build</span><br/>
&nbsp;&nbsp;<span class="id">acto</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">identitymonad</span>.<br/>
<span class="vernacular">End</span> <span class="id">IdentityMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">IdentityMonad</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ListMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">listmonad</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">seq</span> <span class="id">A</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">x</span> <span class="id">=&gt;</span> (@<span class="id">cons</span> <span class="id">A</span>) <span class="id">x</span> <span class="id">[::]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="id">flatten</span> (<span class="id">map</span> <span class="id">f</span> <span class="id">m</span>).<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof9')">Proof.</span></div>
<div class="proofscript" id="proof9">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">/ret</span> <span class="id">/=</span> <span class="id">cats0</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof10')">Proof.</span></div>
<div class="proofscript" id="proof10">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">flatten_seq1</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof11')">Proof.</span></div>
<div class="proofscript" id="proof11">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C;</span> <span class="id">elim</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">h</span> <span class="id">t;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">=&gt;</span> <span class="id">ih</span> <span class="id">f</span> <span class="id">g</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/=</span> <span class="id">map_cat</span> <span class="id">flatten_cat</span> <span class="id">/=</span> <span class="id">ih</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">listmonad</span>.<br/>
<span class="vernacular">End</span> <span class="id">ListMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">ListMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">list_bindE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">ListMonad.acto</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="id">flatten</span> (<span class="id">map</span> <span class="id">f</span> <span class="id">m</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof12')">Proof.</span></div>
<div class="proofscript" id="proof12">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">ExceptMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">exceptmonad</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> (<span class="id">E</span> <span class="id">+</span> <span class="id">A</span>)%<span class="id">type</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> @<span class="id">inr</span> <span class="id">E</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">m</span> <span class="gallina-kwd">with</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">|</span> <span class="id">inr</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">b</span> <span class="gallina-kwd">end</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof13')">Proof.</span></div>
<div class="proofscript" id="proof13">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof14')">Proof.</span></div>
<div class="proofscript" id="proof14">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof15')">Proof.</span></div>
<div class="proofscript" id="proof15">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">exceptmonad</span>.<br/>
<span class="vernacular">End</span> <span class="id">ExceptMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">ExceptMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">except_bindE</span> (<span class="id">E</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">ExceptMonad.acto</span> <span class="id">E</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="gallina-kwd">match</span> <span class="id">m</span> <span class="gallina-kwd">with</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">|</span> <span class="id">inr</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">b</span> <span class="gallina-kwd">end</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof16')">Proof.</span></div>
<div class="proofscript" id="proof16">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">option_monad</span> <span class="id">:=</span> <span class="id">ExceptMonad.acto</span> <span class="id">unit</span>.<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">Monad.on</span> <span class="id">option_monad</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">OutputMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">output</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">L</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> (<span class="id">X</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">L</span>)%<span class="id">type</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">a</span> <span class="id">=&gt;</span> (<span class="id">a,</span> <span class="id">[::]</span>).<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> (<span class="id">x,</span> <span class="id">w</span>) <span class="id">:=</span> <span class="id">m</span> <span class="gallina-kwd">in</span> <span class="id">let:</span> (<span class="id">x',</span> <span class="id">w'</span>) <span class="id">:=</span> <span class="id">f</span> <span class="id">x</span> <span class="gallina-kwd">in</span> (<span class="id">x',</span> <span class="id">w</span> <span class="id">++</span> <span class="id">w'</span>).<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof17')">Proof.</span></div>
<div class="proofscript" id="proof17">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">f</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof18')">Proof.</span></div>
<div class="proofscript" id="proof18">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">w;</span> <span class="id">rewrite</span> <span class="id">cats0</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof19')">Proof.</span></div>
<div class="proofscript" id="proof19">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">m</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">/bind;</span> <span class="id">case:</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">w;</span> <span class="id">case:</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">x'</span> <span class="id">w'</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">g</span> <span class="id">=&gt;</span> <span class="id">x''</span> <span class="id">w'';</span> <span class="id">rewrite</span> <span class="id">catA</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">output</span>.<br/>
<span class="vernacular">End</span> <span class="id">OutputMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">OutputMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">output_bindE</span> (<span class="id">L</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">OutputMonad.acto</span> <span class="id">L</span>)<br/>
&nbsp;&nbsp;&nbsp;(<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="id">let:</span> (<span class="id">x,</span> <span class="id">w</span>) <span class="id">:=</span> <span class="id">m</span> <span class="gallina-kwd">in</span> <span class="id">let:</span> (<span class="id">x',</span> <span class="id">w'</span>) <span class="id">:=</span> <span class="id">f</span> <span class="id">x</span> <span class="gallina-kwd">in</span> (<span class="id">x',</span> <span class="id">w</span> <span class="id">++</span> <span class="id">w'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof20')">Proof.</span></div>
<div class="proofscript" id="proof20">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">EnvironmentMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">environment</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">E</span> <span class="id">-&gt;</span> <span class="id">A</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">e</span> <span class="id">=&gt;</span> <span class="id">x</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">e</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">m</span> <span class="id">e</span>) <span class="id">e</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof21')">Proof.</span></div>
<div class="proofscript" id="proof21">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof22')">Proof.</span></div>
<div class="proofscript" id="proof22">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof23')">Proof.</span></div>
<div class="proofscript" id="proof23">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">environment</span>.<br/>
<span class="vernacular">End</span> <span class="id">EnvironmentMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">EnvironmentMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">environment_bindE</span> (<span class="id">E</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">EnvironmentMonad.acto</span> <span class="id">E</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">e</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">m</span> <span class="id">e</span>) <span class="id">e</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof24')">Proof.</span></div>
<div class="proofscript" id="proof24">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">StateMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">state</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>. <br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">A</span> <span class="id">*</span> <span class="id">S</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="id">a,</span> <span class="id">s</span>).<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="id">uncurry</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">m</span>.<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof25')">Proof.</span></div>
<div class="proofscript" id="proof25">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">apply</span> <span class="id">funext</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof26')">Proof.</span></div>
<div class="proofscript" id="proof26">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">f;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">/=;</span> <span class="id">case:</span> (<span class="id">f</span> <span class="id">s</span>).<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof27')">Proof.</span></div>
<div class="proofscript" id="proof27">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">a</span> <span class="id">b</span> <span class="id">c;</span> <span class="id">rewrite</span> <span class="id">/bind</span> <span class="id">compA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">\o</span> <span class="id">_</span>).<br/>
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">state</span>.<br/>
<span class="vernacular">End</span> <span class="id">StateMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">StateMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">state_bindE</span> (<span class="id">S</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">StateMonad.acto</span> <span class="id">S</span>)<br/>
&nbsp;&nbsp;(<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="id">uncurry</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof28')">Proof.</span></div>
<div class="proofscript" id="proof28">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">ContMonad</span>.<br/>
<span class="vernacular">Section</span> <span class="id">cont</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>. <br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">r</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:</span> <span class="id">idfun</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">a</span>.<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">m</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">a</span> <span class="id">k</span>).<br/>
<span class="vernacular">Let</span> <span class="id">left_neutral</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof29')">Proof.</span></div>
<div class="proofscript" id="proof29">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">Br</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">right_neutral</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof30')">Proof.</span></div>
<div class="proofscript" id="proof30">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">associative</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof31')">Proof.</span></div>
<div class="proofscript" id="proof31">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonad_ret_bind.Build</span> <span class="id">M</span> <span class="id">left_neutral</span> <span class="id">right_neutral</span> <span class="id">associative</span>.<br/>
<span class="vernacular">End</span> <span class="id">cont</span>.<br/>
<span class="vernacular">End</span> <span class="id">ContMonad</span>.<br/>
<span class="id">HB.export</span> <span class="id">ContMonad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">cont_bindE</span> (<span class="id">r</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:=</span> <span class="id">ContMonad.acto</span> <span class="id">r</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">m</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">a</span> <span class="id">k</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof32')">Proof.</span></div>
<div class="proofscript" id="proof32">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Module</span> <span class="id">Empty</span>.<br/>
<span class="vernacular">Section</span> <span class="id">empty</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">UU0</span> <span class="id">:=</span> <span class="id">unit</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> <span class="id">tt</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof33')">Proof.</span></div>
<div class="proofscript" id="proof33">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof34')">Proof.</span></div>
<div class="proofscript" id="proof34">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">empty</span>.<br/>
<span class="vernacular">End</span> <span class="id">Empty</span>.<br/>
<span class="id">HB.export</span> <span class="id">Empty</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Append</span>.<br/>
<span class="vernacular">Section</span> <span class="id">append</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> (<span class="id">X</span> <span class="id">*</span> <span class="id">X</span>)%<span class="id">type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> (<span class="id">x1,</span> <span class="id">x2</span>) <span class="id">:=</span> <span class="id">t</span> <span class="gallina-kwd">in</span> (<span class="id">f</span> <span class="id">x1,</span> <span class="id">f</span> <span class="id">x2</span>).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof35')">Proof.</span></div>
<div class="proofscript" id="proof35">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof36')">Proof.</span></div>
<div class="proofscript" id="proof36">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">append</span>.<br/>
<span class="vernacular">End</span> <span class="id">Append</span>.<br/>
<span class="id">HB.export</span> <span class="id">Append</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">appendop</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">ListMonad.acto</span><span class="id">]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">empty</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Empty.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">_</span> <span class="id">=&gt;</span> @<span class="id">nil</span> <span class="id">A</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">naturality_empty</span> <span class="id">:</span> <span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Empty.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">M</span> <span class="id">empty</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof37')">Proof.</span></div>
<div class="proofscript" id="proof37">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Empty.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">M</span> <span class="id">empty</span> <span class="id">naturality_empty</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">empty_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Empty.acto</span><span class="id">]</span>.<span class="id">-operation</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">empty]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_empty</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">empty_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof38')">Proof.</span></div>
<div class="proofscript" id="proof38">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">append</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Append.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">let:</span> (<span class="id">s1,</span> <span class="id">s2</span>) <span class="id">:=</span> <span class="id">x</span> <span class="gallina-kwd">in</span> (<span class="id">s1</span> <span class="id">++</span> <span class="id">s2</span>).<br/>
<span class="vernacular">Let</span> <span class="id">naturality_append</span> <span class="id">:</span> <span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Append.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">M</span> <span class="id">append</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof39')">Proof.</span></div>
<div class="proofscript" id="proof39">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[s1</span> <span class="id">s2]</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/actm</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">map_cat</span> <span class="id">flatten_cat</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Append.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">M</span> <span class="id">append</span> <span class="id">naturality_append</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">append_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Append.acto</span><span class="id">]</span>.<span class="id">-operation</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">append]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_append</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">append_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof40')">Proof.</span></div>
<div class="proofscript" id="proof40">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">[t1</span> <span class="id">t2]</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">3!list_bindE</span> <span class="id">-flatten_cat</span> <span class="id">-map_cat</span>.<br/>
Qed.</div>
<span class="vernacular">End</span> <span class="id">appendop</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Output</span>.<br/>
<span class="vernacular">Section</span> <span class="id">output</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">L</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> (<span class="id">seq</span> <span class="id">L</span> <span class="id">*</span> <span class="id">X</span>)%<span class="id">type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> (<span class="id">w,</span> <span class="id">x</span>) <span class="id">:=</span> <span class="id">t</span> <span class="gallina-kwd">in</span> (<span class="id">w,</span> <span class="id">f</span> <span class="id">x</span>).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof41')">Proof.</span></div>
<div class="proofscript" id="proof41">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext;</span> <span class="id">case</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof42')">Proof.</span></div>
<div class="proofscript" id="proof42">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">apply</span> <span class="id">funext;</span> <span class="id">case</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">output</span>.<br/>
<span class="vernacular">End</span> <span class="id">Output</span>.<br/>
<span class="id">HB.export</span> <span class="id">Output</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Flush</span>.<br/>
<span class="vernacular">Section</span> <span class="id">flush</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">X</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> <span class="id">f</span> <span class="id">t</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof43')">Proof.</span></div>
<div class="proofscript" id="proof43">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof44')">Proof.</span></div>
<div class="proofscript" id="proof44">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">flush</span>.<br/>
<span class="vernacular">End</span> <span class="id">Flush</span>.<br/>
<span class="id">HB.export</span> <span class="id">Flush</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">outputops</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">L</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">OutputMonad.acto</span> <span class="id">L</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">output</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Output.acto</span> <span class="id">L</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">let:</span> (<span class="id">x,</span> <span class="id">w'</span>) <span class="id">:=</span> <span class="id">m</span>.<span class="id">2</span> <span class="gallina-kwd">in</span> (<span class="id">x,</span> <span class="id">m</span>.<span class="id">1</span> <span class="id">++</span> <span class="id">w'</span>). <br/>
<span class="vernacular">Let</span> <span class="id">naturality_output</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Output.acto</span> <span class="id">L</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">output</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof45')">Proof.</span></div>
<div class="proofscript" id="proof45">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h</span>.<br/>
<span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[w</span> <span class="id">[x</span> <span class="id">w']]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/output</span> <span class="id">/=</span> <span class="id">catA</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Output.acto</span> <span class="id">L</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">output</span> <span class="id">naturality_output</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">output_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Output.acto</span> <span class="id">L]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">output]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_output</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">output_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof46')">Proof.</span></div>
<div class="proofscript" id="proof46">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">[w</span> <span class="id">[x</span> <span class="id">w']]</span>.<br/>
<span class="id">rewrite</span> <span class="id">output_bindE/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/output</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">output_bindE</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">x'</span> <span class="id">w'';</span> <span class="id">rewrite</span> <span class="id">catA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">flush</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Flush.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">let:</span> (<span class="id">x,</span> <span class="id">_</span>) <span class="id">:=</span> <span class="id">m</span> <span class="gallina-kwd">in</span> (<span class="id">x,</span> <span class="id">[::]</span>).<br/>
<span class="vernacular">Let</span> <span class="id">naturality_flush</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Flush.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">flush</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof47')">Proof.</span></div>
<div class="proofscript" id="proof47">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Flush.acto</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">flush</span> <span class="id">naturality_flush</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">flush_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Flush.acto</span><span class="id">]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">flush]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_flush</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">flush_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof48')">Proof.</span></div>
<div class="proofscript" id="proof48">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">[x</span> <span class="id">w]</span>.<br/>
<span class="id">rewrite</span> <span class="id">output_bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">/flush_op</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/flush</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/actm</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">output_bindE</span>.<br/>
<span class="id">case:</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">x'</span> <span class="id">w'</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">End</span> <span class="id">outputops</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Output'</span>.<br/>
<span class="vernacular">Section</span> <span class="id">output</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">L</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">OutputMonad.acto</span> <span class="id">L</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">output</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">L</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">w</span> <span class="id">=&gt;</span> <span class="id">output_op</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">w,</span> <span class="id">Ret</span> <span class="id">tt</span>).<br/>
<span class="vernacular">Lemma</span> <span class="id">outputE</span> <span class="id">:</span> <span class="id">output</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">w</span> <span class="id">=&gt;</span> (<span class="id">tt,</span> <span class="id">w</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof49')">Proof.</span></div>
<div class="proofscript" id="proof49">
<span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">w</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/output</span> <span class="id">/=</span> <span class="id">/imonad_model</span>.<span class="id">output</span> <span class="id">/=</span> <span class="id">cats0</span>.<br/>
Qed.</div>
<span class="vernacular">End</span> <span class="id">output</span>.<br/>
<span class="vernacular">End</span> <span class="id">Output'</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Ask</span>.<br/>
<span class="vernacular">Section</span> <span class="id">ask</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">E</span> <span class="id">-&gt;</span> <span class="id">X</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">t</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof50')">Proof.</span></div>
<div class="proofscript" id="proof50">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof51')">Proof.</span></div>
<div class="proofscript" id="proof51">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">ask</span>.<br/>
<span class="vernacular">End</span> <span class="id">Ask</span>.<br/>
<span class="id">HB.export</span> <span class="id">Ask</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="vernacular">Local</span>.<br/>
<span class="vernacular">Section</span> <span class="id">local</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> ((<span class="id">E</span> <span class="id">-&gt;</span> <span class="id">E</span>) <span class="id">*</span> <span class="id">X</span>)%<span class="id">type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> (<span class="id">e,</span> <span class="id">x</span>) <span class="id">:=</span> <span class="id">t</span> <span class="gallina-kwd">in</span> (<span class="id">e,</span> <span class="id">f</span> <span class="id">x</span>).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof52')">Proof.</span></div>
<div class="proofscript" id="proof52">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof53')">Proof.</span></div>
<div class="proofscript" id="proof53">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">g</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">local</span>.<br/>
<span class="vernacular">End</span> <span class="vernacular">Local</span>.<br/>
<span class="id">HB.export</span> <span class="vernacular">Local</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">environmentops</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">EnvironmentMonad.acto</span> <span class="id">E</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">ask</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Ask.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">f</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">s</span> <span class="id">s</span>. <br/>
<span class="vernacular">Let</span> <span class="id">naturality_ask</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Ask.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">ask</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof54')">Proof.</span></div>
<div class="proofscript" id="proof54">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Ask.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">ask</span> <span class="id">naturality_ask</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">ask_op</span> <span class="id">:</span>  <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Ask.acto</span> <span class="id">E]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">ask]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_ask</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">ask_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof55')">Proof.</span></div>
<div class="proofscript" id="proof55">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">local</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Local.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">x</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">let:</span> (<span class="id">e,</span> <span class="id">t</span>) <span class="id">:=</span> <span class="id">x</span> <span class="gallina-kwd">in</span> <span class="id">t</span> (<span class="id">e</span> <span class="id">s</span>).<br/>
<span class="vernacular">Lemma</span> <span class="id">naturality_local</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Local.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">local</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof56')">Proof.</span></div>
<div class="proofscript" id="proof56">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Local.acto</span> <span class="id">E</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">local</span> <span class="id">naturality_local</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">local_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Local.acto</span> <span class="id">E]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">local]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_local</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">local_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof57')">Proof.</span></div>
<div class="proofscript" id="proof57">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">t</span>.<br/>
<span class="id">rewrite</span> <span class="id">environment_bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">/local_op</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/local</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/actm</span> <span class="id">/=</span>.<br/>
<span class="id">case:</span> <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">ee</span> <span class="id">m</span>.<br/>
<span class="id">rewrite</span> <span class="id">environment_bindE</span>.<br/>
<span class="id">apply</span> <span class="id">funext=&gt;</span> <span class="id">x</span> <span class="id">/=</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">End</span> <span class="id">environmentops</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Environment</span>.<br/>
<span class="vernacular">Section</span> <span class="id">environment</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">E</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">EnvironmentMonad.acto</span> <span class="id">E</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">ask</span> <span class="id">:</span> <span class="id">M</span> <span class="id">E</span> <span class="id">:=</span> <span class="id">ask_op</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Ret</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">askE</span> <span class="id">:</span> <span class="id">ask</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">e</span> <span class="id">=&gt;</span> <span class="id">e</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof58')">Proof.</span></div>
<div class="proofscript" id="proof58">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">End</span> <span class="id">environment</span>.<br/>
<span class="vernacular">End</span> <span class="id">Environment</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Throw</span>.<br/>
<span class="vernacular">Section</span> <span class="id">throw</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">Z</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">Z</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> <span class="id">t</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof59')">Proof.</span></div>
<div class="proofscript" id="proof59">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof60')">Proof.</span></div>
<div class="proofscript" id="proof60">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">throw</span>.<br/>
<span class="vernacular">End</span> <span class="id">Throw</span>.<br/>
<span class="id">HB.export</span> <span class="id">Throw</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Handle</span>.<br/>
<span class="vernacular">Section</span> <span class="id">handle</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">Z</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> (<span class="id">X</span> <span class="id">*</span> (<span class="id">Z</span> <span class="id">-&gt;</span> <span class="id">X</span>))%<span class="id">type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> (<span class="id">x,</span> <span class="id">h</span>) <span class="id">:=</span> <span class="id">t</span> <span class="gallina-kwd">in</span> (<span class="id">f</span> <span class="id">x,</span> <span class="gallina-kwd">fun</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">h</span> <span class="id">z</span>)).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof61')">Proof.</span></div>
<div class="proofscript" id="proof61">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof62')">Proof.</span></div>
<div class="proofscript" id="proof62">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">g</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">handle</span>.<br/>
<span class="vernacular">End</span> <span class="id">Handle</span>.<br/>
<span class="id">HB.export</span> <span class="id">Handle</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">exceptops</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">Z</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">ExceptMonad.acto</span> <span class="id">Z</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">throw</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Throw.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">inl</span> <span class="id">z</span>.<br/>
<span class="vernacular">Let</span> <span class="id">naturality_throw</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Throw.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">throw</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof63')">Proof.</span></div>
<div class="proofscript" id="proof63">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Throw.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">throw</span> <span class="id">naturality_throw</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">throw_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Throw.acto</span> <span class="id">Z]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">throw]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_throw</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">throw_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof64')">Proof.</span></div>
<div class="proofscript" id="proof64">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isAOperation.Build</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">throw</span> <span class="id">algebraic_throw</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">throw_aop</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Throw.acto</span> <span class="id">Z]</span>.<span class="id">-aoperation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">aoperation</span> <span class="id">_</span> <span class="id">_</span> <span class="id">of</span> <span class="id">throw]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">handle'</span> <span class="id">A</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">h</span> <span class="id">:</span> <span class="id">Z</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">m</span> <span class="gallina-kwd">with</span> <span class="id">inl</span> <span class="id">z</span> <span class="id">=&gt;</span> <span class="id">h</span> <span class="id">z</span> <span class="id">|</span> <span class="id">inr</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">inr</span> <span class="id">x</span> <span class="gallina-kwd">end</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">handle</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Handle.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">uncurry</span> (@<span class="id">handle'</span> <span class="id">A</span>).<br/>
<span class="vernacular">Let</span> <span class="id">naturality_handle</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Handle.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">handle</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof65')">Proof.</span></div>
<div class="proofscript" id="proof65">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[[]]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Handle.acto</span> <span class="id">Z</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">handle</span> <span class="id">naturality_handle</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">handle_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">Handle.acto</span> <span class="id">Z]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">handle]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_handle</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">handle_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof66')">Proof.</span></div>
<div class="proofscript" id="proof66">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">t</span>.<br/>
<span class="id">rewrite</span> <span class="id">except_bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">/handle_op</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/handle</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/uncurry</span> <span class="id">/=</span>.<br/>
<span class="id">case:</span> <span class="id">t</span> <span class="id">=&gt;</span> <span class="id">-[z//|a]</span> <span class="id">g</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">except_bindE</span>.<br/>
<span class="id">case:</span> (<span class="id">f</span> <span class="id">a</span>) <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">z</span>.<br/>
<span class="id">rewrite</span> <span class="id">/handle'</span>.<br/>
<span class="id">rewrite</span> <span class="id">except_bindE</span>.<br/>
<span class="id">case:</span> (<span class="id">g</span> <span class="id">z</span>) <span class="id">=&gt;</span> <span class="id">[z0|a0]</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">End</span> <span class="id">exceptops</span>.<br/>
<br/>
<span class="vernacular">Arguments</span> <span class="id">throw_op</span> <span class="id">{Z}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">handle_op</span> <span class="id">{Z}</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">StateOpsGet</span>.<br/>
<span class="vernacular">Section</span> <span class="id">get</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">X</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">t</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof67')">Proof.</span></div>
<div class="proofscript" id="proof67">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof68')">Proof.</span></div>
<div class="proofscript" id="proof68">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">g</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">get</span>.<br/>
<span class="vernacular">End</span> <span class="id">StateOpsGet</span>.<br/>
<span class="id">HB.export</span> <span class="id">StateOpsGet</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">StateOpsPut</span>.<br/>
<span class="vernacular">Section</span> <span class="id">put</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">X</span>)%<span class="id">type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">sx</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span> (<span class="id">sx</span>.<span class="id">1,</span> <span class="id">f</span> <span class="id">sx</span>.<span class="id">2</span>).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof69')">Proof.</span></div>
<div class="proofscript" id="proof69">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof70')">Proof.</span></div>
<div class="proofscript" id="proof70">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">g</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">put</span>.<br/>
<span class="vernacular">End</span> <span class="id">StateOpsPut</span>.<br/>
<span class="id">HB.export</span> <span class="id">StateOpsPut</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">stateops</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">StateMonad.acto</span> <span class="id">S</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">get</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">k</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<span class="vernacular">Let</span> <span class="id">naturality_get</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">get</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof71')">Proof.</span></div>
<div class="proofscript" id="proof71">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">m;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">FCompE</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">get</span> <span class="id">naturality_get</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">get_op</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">get]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_get</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">get_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof72')">Proof.</span></div>
<div class="proofscript" id="proof72">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isAOperation.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">get</span> <span class="id">algebraic_get</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">get_aop</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S]</span>.<span class="id">-aoperation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">aoperation</span> <span class="id">_</span> <span class="id">_</span> <span class="id">of</span> <span class="id">get]</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">put'</span> <span class="id">A</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">s</span>.<br/>
<span class="vernacular">Let</span> <span class="id">put</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">uncurry</span> (<span class="id">put'</span> (<span class="id">A</span> <span class="id">:=</span> <span class="id">A</span>)).<br/>
<span class="vernacular">Let</span> <span class="id">naturality_put</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">put</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof73')">Proof.</span></div>
<div class="proofscript" id="proof73">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">h;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">-[s</span> <span class="id">m</span> <span class="id">/=];</span> <span class="id">apply</span> <span class="id">funext</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">put</span> <span class="id">naturality_put</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">put_op</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">put]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraic_put</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">put_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof74')">Proof.</span></div>
<div class="proofscript" id="proof74">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">?</span> <span class="id">?</span> <span class="id">?</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isAOperation.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">put</span> <span class="id">algebraic_put</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">put_aop</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S]</span>.<span class="id">-aoperation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">aoperation</span> <span class="id">_</span> <span class="id">_</span> <span class="id">of</span> <span class="id">put]</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">stateops</span>.<br/>
<br/>
<span class="vernacular">Arguments</span> <span class="id">get_op</span> <span class="id">{S}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">put_op</span> <span class="id">{S}</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ContOpsAbort</span>.<br/>
<span class="vernacular">Section</span> <span class="id">abort</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> (<span class="id">X</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">r</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">x</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">B</span> <span class="id">:=</span> <span class="id">x</span>.<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof75')">Proof.</span></div>
<div class="proofscript" id="proof75">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof76')">Proof.</span></div>
<div class="proofscript" id="proof76">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">abort</span>.<br/>
<span class="vernacular">End</span> <span class="id">ContOpsAbort</span>.<br/>
<span class="id">HB.export</span> <span class="id">ContOpsAbort</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ContOpsAcallcc</span>.<br/>
<span class="vernacular">Section</span> <span class="id">acallcc</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">A</span>.<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">X</span> <span class="id">Y</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">X</span> <span class="id">-&gt;</span> <span class="id">Y</span>) (<span class="id">t</span> <span class="id">:</span> <span class="id">acto</span> <span class="id">X</span>) <span class="id">:</span> <span class="id">acto</span> <span class="id">Y</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> (<span class="id">g</span> <span class="id">:</span> <span class="id">Y</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">t</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">g</span> (<span class="id">f</span> <span class="id">x</span>))).<br/>
<span class="vernacular">Let</span> <span class="id">func_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof77')">Proof.</span></div>
<div class="proofscript" id="proof77">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">func_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof78')">Proof.</span></div>
<div class="proofscript" id="proof78">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">acto</span> <span class="id">func_id</span> <span class="id">func_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">acallcc</span>.<br/>
<span class="vernacular">End</span> <span class="id">ContOpsAcallcc</span>.<br/>
<span class="id">HB.export</span> <span class="id">ContOpsAcallcc</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">contops</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">ContMonad.acto</span> <span class="id">r</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">abort</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAbort.acto</span> <span class="id">r</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">r</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">r</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">naturality_abort</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAbort.acto</span> <span class="id">r</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">abort</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof79')">Proof.</span></div>
<div class="proofscript" id="proof79">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span><br/>
&nbsp;&nbsp;<span class="id">_</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">abort</span> <span class="id">naturality_abort</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">abort_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAbort.acto</span> <span class="id">r]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">abort]</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">algebraicity_abort</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">abort_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof80')">Proof.</span></div>
<div class="proofscript" id="proof80">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isAOperation.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAbort.acto</span> <span class="id">r]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span><br/>
&nbsp;&nbsp;<span class="id">abort</span> <span class="id">algebraicity_abort</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">abort_aop</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAbort.acto</span> <span class="id">r]</span>.<span class="id">-aoperation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">aoperation</span> <span class="id">_</span> <span class="id">_</span> <span class="id">of</span> <span class="id">abort]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">acallcc</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">~~&gt;</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">f</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">k</span>) <span class="id">k</span>.<br/>
<span class="vernacular">Let</span> <span class="id">naturality_acallcc</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">naturality</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r</span> <span class="id">\o</span> <span class="id">M]</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">acallcc</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof81')">Proof.</span></div>
<div class="proofscript" id="proof81">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">acallcc</span> <span class="id">naturality_acallcc</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">acallcc_op</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r]</span>.<span class="id">-operation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">_</span> <span class="id">~&gt;</span> <span class="id">_</span> <span class="id">of</span> <span class="id">acallcc]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">algebraicity_callcc</span> <span class="id">:</span> <span class="id">algebraicity</span> <span class="id">acallcc_op</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof82')">Proof.</span></div>
<div class="proofscript" id="proof82">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isAOperation.Build</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r]</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span><br/>
&nbsp;&nbsp;<span class="id">acallcc</span> <span class="id">algebraicity_callcc</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">callcc_aop</span> <span class="id">:</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r]</span>.<span class="id">-aoperation</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">aoperation</span> <span class="id">_</span> <span class="id">_</span> <span class="id">of</span> <span class="id">acallcc]</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">contops</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="vernacular">Fail</span>.<br/>
<span class="vernacular">Section</span> <span class="id">fail</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">option_fail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">option_monad</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> @<span class="id">throw</span> <span class="id">unit</span> <span class="id">A</span> <span class="id">tt</span>.<br/>
<span class="vernacular">Let</span> <span class="id">option_bindfailf</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> (@<span class="id">bind</span> <span class="id">_</span>) <span class="id">option_fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof83')">Proof.</span></div>
<div class="proofscript" id="proof83">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">Monad.on</span> <span class="id">option_monad</span>.<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> @<span class="id">isMonadFail.Build</span> <span class="id">option_monad</span><br/>
&nbsp;&nbsp;<span class="id">option_fail</span> <span class="id">option_bindfailf</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">list_fail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">ListMonad.acto</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> @<span class="id">empty</span> <span class="id">_</span> <span class="id">tt</span>.<br/>
<span class="vernacular">Let</span> <span class="id">list_bindfailf</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> (@<span class="id">bind</span> <span class="id">_</span>) <span class="id">list_fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof84')">Proof.</span></div>
<div class="proofscript" id="proof84">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> @<span class="id">isMonadFail.Build</span> <span class="id">ListMonad.acto</span> <span class="id">list_fail</span> <span class="id">list_bindfailf</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">fail</span>.<br/>
<span class="vernacular">End</span> <span class="vernacular">Fail</span>.<br/>
<span class="id">HB.export</span> <span class="vernacular">Fail</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Except</span>.<br/>
<span class="vernacular">Section</span> <span class="id">except</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span> <span class="id">:=</span> <span class="id">option_monad</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">handle</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">m1</span> <span class="id">m2</span> <span class="id">=&gt;</span> @<span class="id">handle_op</span> <span class="id">unit</span> <span class="id">_</span> (<span class="id">m1,</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m2</span>)).<br/>
<span class="vernacular">Lemma</span> <span class="id">handleE</span> <span class="id">:</span> <span class="id">handle</span> <span class="id">=</span> (<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">m</span> <span class="id">m'</span> <span class="id">=&gt;</span> <span class="gallina-kwd">if</span> <span class="id">m</span> <span class="id">is</span> <span class="id">inr</span> <span class="id">x</span> <span class="gallina-kwd">then</span> <span class="id">m</span> <span class="gallina-kwd">else</span> <span class="id">m'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof85')">Proof.</span></div>
<div class="proofscript" id="proof85">
 <span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">catchmfail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">right_id</span> <span class="id">fail</span> (@<span class="id">handle</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof86')">Proof.</span></div>
<div class="proofscript" id="proof86">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">case</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">case</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">catchfailm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">left_id</span> <span class="id">fail</span> (@<span class="id">handle</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof87')">Proof.</span></div>
<div class="proofscript" id="proof87">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">case</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">catchA</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">ssrfun.associative</span> (@<span class="id">handle</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof88')">Proof.</span></div>
<div class="proofscript" id="proof88">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">case</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">catchret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">x,</span> @<span class="id">left_zero</span> (<span class="id">M</span> <span class="id">A</span>) (<span class="id">M</span> <span class="id">A</span>) (<span class="id">Ret</span> <span class="id">x</span>) (@<span class="id">handle</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof89')">Proof.</span></div>
<div class="proofscript" id="proof89">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">x;</span> <span class="id">case</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadExcept.Build</span> <span class="id">option_monad</span><br/>
&nbsp;&nbsp;<span class="id">catchmfail</span> <span class="id">catchfailm</span> <span class="id">catchA</span> <span class="id">catchret</span>.<br/>
<span class="vernacular">End</span> <span class="id">except</span>.<br/>
<span class="vernacular">End</span> <span class="id">Except</span>.<br/>
<span class="id">HB.export</span> <span class="id">Except</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">State</span>.<br/>
<span class="vernacular">Section</span> <span class="id">state</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">StateMonad.acto</span> <span class="id">S</span>).<br/>
<span class="vernacular">Let</span> <span class="id">get</span> <span class="id">:</span> <span class="id">M</span> <span class="id">S</span> <span class="id">:=</span> <span class="id">get_op</span> <span class="id">_</span> <span class="id">Ret</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">getE</span> <span class="id">:</span> <span class="id">get</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="id">s,</span> <span class="id">s</span>)<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof90')">Proof.</span></div>
<div class="proofscript" id="proof90">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">put</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">put_op</span> <span class="id">_</span> (<span class="id">s,</span> <span class="id">Ret</span> <span class="id">tt</span>).<br/>
<span class="vernacular">Lemma</span> <span class="id">putE</span> <span class="id">:</span> <span class="id">put</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">s'</span> <span class="id">_</span> <span class="id">=&gt;</span> (<span class="id">tt,</span> <span class="id">s'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof91')">Proof.</span></div>
<div class="proofscript" id="proof91">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">putput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">s',</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">put</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">put</span> <span class="id">s'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof92')">Proof.</span></div>
<div class="proofscript" id="proof92">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">putget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s,</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">get</span> <span class="id">=</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof93')">Proof.</span></div>
<div class="proofscript" id="proof93">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">getputskip</span> <span class="id">:</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="id">put</span> <span class="id">=</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof94')">Proof.</span></div>
<div class="proofscript" id="proof94">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">getget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof95')">Proof.</span></div>
<div class="proofscript" id="proof95">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadState.Build</span> <span class="id">S</span> (<span class="id">StateMonad.acto</span> <span class="id">S</span>)<br/>
&nbsp;&nbsp;<span class="id">putput</span> <span class="id">putget</span> <span class="id">getputskip</span> <span class="id">getget</span>.<br/>
<span class="vernacular">End</span> <span class="id">state</span>.<br/>
<span class="vernacular">End</span> <span class="id">State</span>.<br/>
<span class="id">HB.export</span> <span class="id">State</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Alt</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">list</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">ListMonad.acto</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">list_alt</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">T,</span> <span class="id">M</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">T</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">curry</span> (@<span class="id">append</span> <span class="id">A</span>).<br/>
<span class="vernacular">Let</span> <span class="id">altA</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span> <span class="id">ssrfun.associative</span> (@<span class="id">list_alt</span> <span class="id">T</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof96')">Proof.</span></div>
<div class="proofscript" id="proof96">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">a</span> <span class="id">b</span> <span class="id">c;</span> <span class="id">rewrite</span> <span class="id">/list_alt</span> <span class="id">/=</span> <span class="id">/curry</span> <span class="id">/=</span> <span class="id">catA</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">alt_bindDl</span> <span class="id">:</span> <span class="id">BindLaws.left_distributive</span> (@<span class="id">bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">ListMonad.acto</span><span class="id">]</span>) <span class="id">list_alt</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof97')">Proof.</span></div>
<div class="proofscript" id="proof97">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">/=</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">k</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">list_bindE</span> <span class="id">map_cat</span> <span class="id">flatten_cat</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadAlt.Build</span> <span class="id">ListMonad.acto</span> <span class="id">altA</span> <span class="id">alt_bindDl</span>.<br/>
<span class="vernacular">End</span> <span class="id">list</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">Alt</span>.<br/>
<span class="id">HB.export</span> <span class="id">Alt</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">Nondet</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">list</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">ListMonad.acto</span><span class="id">]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">N</span> <span class="id">:</span> <span class="id">altMonad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">altMonad</span> <span class="id">of</span> <span class="id">ListMonad.acto</span><span class="id">]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">altfailm</span> <span class="id">:</span> @<span class="id">BindLaws.left_id</span> <span class="id">_</span> (@<span class="id">fail</span> <span class="id">M</span>) (@<span class="id">alt</span> <span class="id">N</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof98')">Proof.</span></div>
<div class="proofscript" id="proof98">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">altmfail</span> <span class="id">:</span> @<span class="id">BindLaws.right_id</span> <span class="id">_</span> (@<span class="id">fail</span> <span class="id">M</span>) (@<span class="id">alt</span> <span class="id">N</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof99')">Proof.</span></div>
<div class="proofscript" id="proof99">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">l</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/alt</span> <span class="id">/=</span> <span class="id">/list_alt</span> <span class="id">/=</span> <span class="id">/curry</span> <span class="id">/=</span> <span class="id">/fail</span> <span class="id">/=</span> <span class="id">/list_fail</span> <span class="id">/=</span> <span class="id">cats0</span>.<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadNondet.Build</span> <span class="id">ListMonad.acto</span> <span class="id">altfailm</span> <span class="id">altmfail</span>.<br/>
<span class="vernacular">End</span> <span class="id">list</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">Nondet</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelStateTrace</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">st</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">S</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">StateMonad.acto</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)%<span class="id">type]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">st_get</span> <span class="id">:</span> <span class="id">M</span> <span class="id">S</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="id">s</span>.<span class="id">1,</span> <span class="id">s</span>).<br/>
<span class="vernacular">Let</span> <span class="id">st_put</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> (<span class="gallina-kwd">fun</span> <span class="id">s'</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="id">tt,</span> (<span class="id">s',</span> <span class="id">s</span>.<span class="id">2</span>))).<br/>
<span class="vernacular">Let</span> <span class="id">st_mark</span> <span class="id">:</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> (<span class="gallina-kwd">fun</span> <span class="id">t</span> <span class="id">s</span> <span class="id">=&gt;</span> (<span class="id">tt,</span> (<span class="id">s</span>.<span class="id">1,</span> <span class="id">rcons</span> <span class="id">s</span>.<span class="id">2</span> <span class="id">t</span>))).<br/>
<span class="vernacular">Let</span> <span class="id">st_putput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">s',</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">st_put</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">st_put</span> <span class="id">s'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof100')">Proof.</span></div>
<div class="proofscript" id="proof100">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">st_putget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s,</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">st_get</span> <span class="id">=</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof101')">Proof.</span></div>
<div class="proofscript" id="proof101">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">st_getputskip</span> <span class="id">:</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="id">st_put</span> <span class="id">=</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof102')">Proof.</span></div>
<div class="proofscript" id="proof102">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">*;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">-[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">st_getget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">st_get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof103')">Proof.</span></div>
<div class="proofscript" id="proof103">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">st_putmark</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">e,</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">st_mark</span> <span class="id">e</span> <span class="id">=</span> <span class="id">st_mark</span> <span class="id">e</span> <span class="id">&gt;&gt;</span> <span class="id">st_put</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof104')">Proof.</span></div>
<div class="proofscript" id="proof104">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">st_getmark</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">e</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">S</span>)<span class="id">,</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">st_mark</span> <span class="id">e</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">v</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">st_mark</span> <span class="id">e</span> <span class="id">&gt;&gt;</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof105')">Proof.</span></div>
<div class="proofscript" id="proof105">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> @<span class="id">isMonadStateTrace.Build</span> <span class="id">S</span> <span class="id">T</span> (<span class="id">StateMonad.acto</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)%<span class="id">type</span>)<br/>
&nbsp;&nbsp;<span class="id">st_get</span> <span class="id">st_put</span> <span class="id">st_mark</span> <span class="id">st_putput</span> <span class="id">st_putget</span> <span class="id">st_getputskip</span> <span class="id">st_getget</span> <span class="id">st_putmark</span> <span class="id">st_getmark</span>.<br/>
<span class="vernacular">End</span> <span class="id">st</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelStateTrace</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelStateTrace</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">usual_callcc</span> <span class="id">r</span> (<span class="id">M</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">C</span> <span class="id">=&gt;</span> (<span class="id">C</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">A</span> <span class="id">B</span> (<span class="id">f</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">a</span>) <span class="id">k</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelCont</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelcont</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> (<span class="id">ContMonad.acto</span> <span class="id">r</span>)<span class="id">]</span>.<br/>
<span class="vernacular">Let</span> <span class="id">callcc</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">acallcc_op</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> (<span class="id">Ret</span> <span class="id">x</span>))).<br/>
<span class="vernacular">Lemma</span> <span class="id">callccE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">callcc</span> <span class="id">f</span> <span class="id">=</span> <span class="id">usual_callcc</span> <span class="id">f</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof106')">Proof.</span></div>
<div class="proofscript" id="proof106">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">callcc0</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">g</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">g</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>)) <span class="id">=</span> @<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> <span class="id">g</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof107')">Proof.</span></div>
<div class="proofscript" id="proof107">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">callcc1</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">B</span>)<span class="id">,</span> @<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">m</span>) <span class="id">=</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof108')">Proof.</span></div>
<div class="proofscript" id="proof108">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">callcc2</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">x</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">a</span> <span class="id">b</span>))) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">x</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof109')">Proof.</span></div>
<div class="proofscript" id="proof109">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">callcc3</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">b,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">b</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">b</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof110')">Proof.</span></div>
<div class="proofscript" id="proof110">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadContinuation.Build</span> (<span class="id">ContMonad.acto</span> <span class="id">r</span>)<br/>
&nbsp;&nbsp;<span class="id">callcc0</span> <span class="id">callcc1</span> <span class="id">callcc2</span> <span class="id">callcc3</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelcont</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelCont</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelCont</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">continuation_examples</span>.<br/>
<span class="vernacular">Fixpoint</span> <span class="id">fib</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">n</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">0</span> <span class="id">=&gt;</span> <span class="id">1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">1</span> <span class="id">=&gt;</span> <span class="id">1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> (<span class="id">m</span>.<span class="id">+1</span> <span class="gallina-kwd">as</span> <span class="id">sm</span>).<span class="id">+1</span> <span class="id">=&gt;</span> <span class="id">fib</span> <span class="id">sm</span> <span class="id">+</span> <span class="id">fib</span> <span class="id">m</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">end</span>.<br/>
<span class="vernacular">Fixpoint</span> <span class="id">fib_cps</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">monad}</span> (<span class="id">n</span> <span class="id">:</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">n</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">0</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">1</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> (<span class="id">m</span>.<span class="id">+1</span> <span class="gallina-kwd">as</span> <span class="id">sm</span>).<span class="id">+1</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fib_cps</span> <span class="id">sm</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">fib_cps</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">a</span> <span class="id">+</span> <span class="id">b</span>)<br/>
&nbsp;&nbsp;<span class="gallina-kwd">end</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fib_cpsE</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">n</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">fib_cps</span> <span class="id">n</span>.<span class="id">+2</span> <span class="id">=</span> (<span class="id">fib_cps</span> <span class="id">n</span>.<span class="id">+1</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">fib_cps</span> <span class="id">n</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">a</span> <span class="id">+</span> <span class="id">b</span>)) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof111')">Proof.</span></div>
<div class="proofscript" id="proof111">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">nat_ind2</span> (<span class="id">P</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="gallina-kwd">Prop</span>) (<span class="id">P0</span> <span class="id">:</span> <span class="id">P</span> <span class="id">O</span>) (<span class="id">P1</span> <span class="id">:</span> <span class="id">P</span> <span class="id">1</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span> <span class="id">m,</span> <span class="id">P</span> <span class="id">m</span> <span class="id">-&gt;</span> <span class="id">P</span> <span class="id">m</span>.<span class="id">+1</span> <span class="id">-&gt;</span> <span class="id">P</span> <span class="id">m</span>.<span class="id">+2</span>) <span class="id">-&gt;</span> <span class="gallina-kwd">forall</span> <span class="id">m,</span> <span class="id">P</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof112')">Proof.</span></div>
<div class="proofscript" id="proof112">
<span class="id">move=&gt;</span> <span class="id">H</span> <span class="id">n;</span> <span class="id">suff</span> <span class="id">:</span> <span class="id">P</span> <span class="id">n</span> <span class="id">/\</span> <span class="id">P</span> <span class="id">n</span>.<span class="id">+1</span> <span class="gallina-kwd">by</span> <span class="id">case</span>.<br/>
<span class="id">elim:</span> <span class="id">n</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">[]</span> <span class="id">H1</span> <span class="id">H2;</span> <span class="id">split</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">exact:</span> <span class="id">H</span>.<br/>
Qed.</div>
<span class="vernacular">Goal</span> <span class="gallina-kwd">forall</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">n,</span> <span class="id">fib_cps</span> <span class="id">n</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">fib</span> <span class="id">n</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">nat</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof113')">Proof.</span></div>
<div class="proofscript" id="proof113">
<span class="id">move=&gt;</span> <span class="id">M;</span> <span class="id">apply</span> <span class="id">nat_ind2</span> <span class="id">=&gt;</span> <span class="id">//</span> <span class="id">n</span> <span class="id">ih1</span> <span class="id">ih2</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fib_cpsE</span> <span class="id">ih2</span> <span class="id">bindretf</span> <span class="id">ih1</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">oaddn</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">acc</span> <span class="id">:</span> <span class="id">nat</span>) (<span class="id">x</span> <span class="id">:</span> <span class="id">option</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">is</span> <span class="id">Some</span> <span class="id">x</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">+</span> <span class="id">acc</span>) <span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">acc</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">sum_just</span> <span class="id">M</span> (<span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> (<span class="id">option</span> <span class="id">nat</span>)) <span class="id">:=</span> <span class="id">foldM</span> (<span class="id">oaddn</span> <span class="id">M</span>) <span class="id">0</span> <span class="id">xs</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">oaddn_break</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">break</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span>) (<span class="id">acc</span> <span class="id">:</span> <span class="id">nat</span>) (<span class="id">x</span> <span class="id">:</span> <span class="id">option</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">is</span> <span class="id">Some</span> <span class="id">x</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">+</span> <span class="id">acc</span>) <span class="gallina-kwd">else</span> <span class="id">break</span> <span class="id">acc</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">contMonad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">contMonad</span> <span class="id">of</span> <span class="id">ContMonad.acto</span> <span class="id">nat]</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">sum_break</span> (<span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> (<span class="id">option</span> <span class="id">nat</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">break</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">foldM</span> (<span class="id">oaddn_break</span> <span class="id">break</span>) <span class="id">0</span> <span class="id">xs</span>).<br/>
<br/>
<span class="vernacular">Compute</span> (<span class="id">sum_break</span> <span class="id">[::</span> <span class="id">Some</span> <span class="id">2;</span> <span class="id">Some</span> <span class="id">6;</span> <span class="id">None;</span> <span class="id">Some</span> <span class="id">4]</span>).<br/>
<br/>
<span class="vernacular">Goal</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">f</span> <span class="id">100</span>))) <span class="id">=</span> <span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">100</span>) <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof114')">Proof.</span></div>
<div class="proofscript" id="proof114">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/addM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">funext</span>. Abort.</div>
<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">list_iter</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">A</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">is</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">f</span> <span class="id">h</span> <span class="id">&gt;&gt;</span> <span class="id">list_iter</span> <span class="id">f</span> <span class="id">t</span> <span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">tt</span>.<br/>
<br/>
<span class="vernacular">Compute</span> (@<span class="id">list_iter</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">idfun]</span> <span class="id">nat</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">tt</span>) <span class="id">[::</span> <span class="id">O;</span> <span class="id">1;</span> <span class="id">2]</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">list_find</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">contMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">list_iter</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="gallina-kwd">if</span> <span class="id">p</span> <span class="id">x</span> <span class="gallina-kwd">then</span>  <span class="id">k</span> (<span class="id">Some</span> <span class="id">x</span>) <span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">tt</span>) <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">None</span>).<br/>
<br/>
<br/>
<span class="vernacular">Compute</span> (@<span class="id">list_find</span> <span class="id">[the</span> <span class="id">contMonad</span> <span class="id">of</span> <span class="id">ContMonad.acto</span> <span class="id">bool]</span> <span class="id">nat</span> <span class="id">[pred</span> <span class="id">x</span> <span class="id">|</span> <span class="id">odd</span> <span class="id">x]</span> <span class="id">[::</span> <span class="id">2;</span> <span class="id">4;</span> <span class="id">6]</span>).<br/>
<br/>
<br/>
<span class="vernacular">Compute</span> (@<span class="id">list_find</span> <span class="id">[the</span> <span class="id">contMonad</span> <span class="id">of</span> (<span class="id">ContMonad.acto</span> <span class="id">bool</span>)<span class="id">]</span> <span class="id">nat</span> <span class="id">[pred</span> <span class="id">x</span> <span class="id">|</span> <span class="id">odd</span> <span class="id">x]</span> <span class="id">[::</span> <span class="id">2;</span> <span class="id">4;</span> <span class="id">3;</span> <span class="id">6]</span>).<br/>
<br/>
<span class="vernacular">End</span> <span class="id">continuation_examples</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelShiftReset</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelshiftreset</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">r</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">contMonad</span> <span class="id">of</span> <span class="id">ContMonad.acto</span> <span class="id">r]</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">shift</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> ((<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">h</span> <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">c</span> <span class="id">=&gt;</span> <span class="id">h</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">c'</span> <span class="id">=&gt;</span> <span class="id">c'</span> (<span class="id">c</span> <span class="id">v</span>)) <span class="id">ssrfun.id</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">reset</span> <span class="id">:</span> <span class="id">M</span> <span class="id">r</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">r</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">m</span>  <span class="id">=&gt;</span> <span class="gallina-kwd">fun</span> <span class="id">c</span> <span class="id">=&gt;</span> <span class="id">c</span> (<span class="id">m</span> <span class="id">ssrfun.id</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">shiftreset0</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>) <span class="id">=</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof115')">Proof.</span></div>
<div class="proofscript" id="proof115">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">shiftreset1</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">h</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">callcc</span> <span class="id">h</span> <span class="id">=</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k'</span> <span class="id">=&gt;</span> <span class="id">h</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k''</span> <span class="id">=&gt;</span> <span class="id">k'</span> <span class="id">x</span>)) <span class="id">&gt;&gt;=</span> <span class="id">k'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof116')">Proof.</span></div>
<div class="proofscript" id="proof116">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">shiftreset2</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">c</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">c':</span> <span class="id">r</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span> <span class="id">-&gt;</span> <span class="id">_</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">reset</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">c;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">c'</span>)<span class="id">;</span> <span class="id">k</span> <span class="id">x</span> <span class="id">y</span>) <span class="id">=</span> <span class="id">Ret</span> <span class="id">c</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">c'</span>)%<span class="id">Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof117')">Proof.</span></div>
<div class="proofscript" id="proof117">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">shiftreset3</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">c</span> <span class="id">c'</span> <span class="id">:</span> <span class="id">r</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">r</span> <span class="id">-&gt;</span> <span class="id">r</span> <span class="id">-&gt;</span> <span class="id">_</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">reset</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">c;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">do</span> <span class="id">v</span> <span class="id">&lt;-</span> <span class="id">f</span> <span class="id">c';</span> <span class="id">f</span> <span class="id">v</span>)<span class="id">;</span> <span class="id">Ret</span> (<span class="id">k</span> <span class="id">x</span> <span class="id">y</span>)) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reset</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">c;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">c'</span>)<span class="id">;</span> <span class="id">Ret</span> (<span class="id">k</span> <span class="id">x</span> (<span class="id">k</span> <span class="id">x</span> <span class="id">y</span>))))%<span class="id">Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof118')">Proof.</span></div>
<div class="proofscript" id="proof118">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">shiftreset4</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">c</span> <span class="id">:</span> <span class="id">r</span>) <span class="id">k,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">reset</span> (<span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> @<span class="id">shift</span> <span class="id">_</span> (@<span class="id">^~</span> <span class="id">c</span>)<span class="id">;</span> <span class="id">Ret</span> (<span class="id">k</span> <span class="id">y</span>)) <span class="id">=</span> <span class="id">Ret</span> (<span class="id">k</span> <span class="id">c</span>))%<span class="id">Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof119')">Proof.</span></div>
<div class="proofscript" id="proof119">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadShiftReset.Build</span> <span class="id">r</span> (<span class="id">ContMonad.acto</span> <span class="id">r</span>)<br/>
&nbsp;&nbsp;<span class="id">shiftreset0</span> <span class="id">shiftreset1</span> <span class="id">shiftreset2</span> <span class="id">shiftreset3</span> <span class="id">shiftreset4</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelshiftreset</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelShiftReset</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelShiftReset</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">shiftreset_examples</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">shiftresetMonad</span> <span class="id">nat</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">shiftresetMonad</span> <span class="id">nat</span> <span class="id">of</span> <span class="id">ContMonad.acto</span> <span class="id">nat]</span>.<br/>
<span class="vernacular">Goal</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">reset</span> (<span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="id">100</span>) <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> <span class="id">100</span>))).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof120')">Proof.</span></div>
<div class="proofscript" id="proof120">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/addM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">funext</span>. Abort.</div>
<span class="vernacular">Goal</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">reset</span> (<span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">100</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> <span class="id">100</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof121')">Proof.</span></div>
<div class="proofscript" id="proof121">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/addM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">funext</span>. Abort.</div>
<span class="vernacular">Goal</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">+m</span> (<span class="id">reset</span> (<span class="id">Ret</span> <span class="id">10</span> <span class="id">+m</span> (<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">100</span> <span class="id">+m</span> <span class="id">f</span> <span class="id">1000</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">1</span> <span class="id">+</span> ((<span class="id">10</span> <span class="id">+</span> <span class="id">100</span>) <span class="id">+</span> (<span class="id">10</span> <span class="id">+</span> <span class="id">1000</span>))).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof122')">Proof.</span></div>
<div class="proofscript" id="proof122">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/addM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">funext</span>. Abort.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">N</span> <span class="id">:</span> <span class="id">shiftresetMonad</span> (<span class="id">seq</span> <span class="id">nat</span>) <span class="id">:=</span> <span class="id">[the</span> <span class="id">shiftresetMonad</span> (<span class="id">seq</span> <span class="id">nat</span>) <span class="id">of</span> <span class="id">ContMonad.acto</span> (<span class="id">seq</span> <span class="id">nat</span>)<span class="id">]</span>.<br/>
<span class="vernacular">Fixpoint</span> <span class="id">perverse</span> (<span class="id">l</span> <span class="id">:</span> <span class="id">seq</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">N</span> (<span class="id">seq</span> <span class="id">nat</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">l</span> <span class="id">is</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">N</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">h</span> <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">perverse</span> <span class="id">t</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">y</span>))))<br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">[::]</span>.<br/>
<span class="vernacular">Goal</span> <span class="id">reset</span> (<span class="id">perverse</span> <span class="id">[::</span> <span class="id">1;</span> <span class="id">2;</span> <span class="id">3]</span>) <span class="id">=</span> <span class="id">Ret</span> <span class="id">[::</span> <span class="id">3;</span> <span class="id">2;</span> <span class="id">1]</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">[]</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">stranger</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">g</span> <span class="id">b</span> <span class="id">:=</span> <span class="id">reset</span> ((<span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">b</span>) <span class="id">&gt;&gt;=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="gallina-kwd">if</span> <span class="id">x</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">2</span> <span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">3</span>))) <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">g</span> <span class="id">true</span> <span class="id">+m</span> <span class="id">g</span> <span class="id">false</span>.<br/>
<span class="vernacular">Goal</span> <span class="id">stranger</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">5</span>. <span class="gallina-kwd">by</span> <span class="id">[]</span>. Abort.</div>
<br/>
<span class="vernacular">Goal</span> <span class="id">reset</span> (<span class="id">Ret</span> <span class="id">2</span> <span class="id">+m</span> <span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">3</span> <span class="id">+m</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">=</span> <span class="id">Ret</span> <span class="id">6</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof123')">Proof.</span></div>
<div class="proofscript" id="proof123">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/addM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">funext</span>. Abort.</div>
<span class="vernacular">Goal</span> <span class="id">reset</span> (<span class="id">Ret</span> <span class="id">2</span> <span class="id">*m</span> <span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">4</span> <span class="id">+m</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">*m</span> <span class="id">shift</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">3</span> <span class="id">+m</span> <span class="id">Ret</span> <span class="id">1</span> <span class="id">:</span> <span class="id">M</span> <span class="id">_</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">_</span> ) <span class="id">=</span> <span class="id">Ret</span> <span class="id">26</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof124')">Proof.</span></div>
<div class="proofscript" id="proof124">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/mulM</span> <span class="id">bindretf;</span> <span class="id">apply</span> <span class="id">funext</span>. Abort.</div>
<br/>
<span class="vernacular">End</span> <span class="id">shiftreset_examples</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelStateLoop</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelstateloop</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">StateMonad.acto</span> <span class="id">S</span>).<br/>
<span class="vernacular">Fixpoint</span> <span class="id">mforeach</span> (<span class="id">it</span> <span class="id">min</span> <span class="id">:</span> <span class="id">nat</span>) (<span class="id">body</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">it</span> <span class="id">&lt;=</span> <span class="id">min</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">tt</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="gallina-kwd">if</span> <span class="id">it</span> <span class="id">is</span> <span class="id">it'</span>.<span class="id">+1</span> <span class="gallina-kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">body</span> <span class="id">it'</span>) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">mforeach</span> <span class="id">it'</span> <span class="id">min</span> <span class="id">body</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">tt</span>.<br/>
<span class="vernacular">Let</span> <span class="id">loop0</span> <span class="id">m</span> <span class="id">body</span> <span class="id">:</span> <span class="id">mforeach</span> <span class="id">m</span> <span class="id">m</span> <span class="id">body</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">tt</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof125')">Proof.</span></div>
<div class="proofscript" id="proof125">
 <span class="gallina-kwd">by</span> <span class="id">case:</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">//=</span> <span class="id">n;</span> <span class="id">rewrite</span> <span class="id">ltnS</span> <span class="id">leqnn</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">loop1</span> <span class="id">m</span> <span class="id">n</span> <span class="id">body</span> <span class="id">:</span> <span class="id">mforeach</span> (<span class="id">m</span>.<span class="id">+1</span> <span class="id">+</span> <span class="id">n</span>) <span class="id">m</span> <span class="id">body</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">body</span> (<span class="id">m</span> <span class="id">+</span> <span class="id">n</span>)) <span class="id">&gt;&gt;</span> <span class="id">mforeach</span> (<span class="id">m</span> <span class="id">+</span> <span class="id">n</span>) <span class="id">m</span> <span class="id">body</span> <span class="id">:&gt;</span> <span class="id">M</span> <span class="id">unit</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof126')">Proof.</span></div>
<div class="proofscript" id="proof126">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/mforeach</span> <span class="id">/=;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">//;</span> <span class="id">rewrite</span> <span class="id">ltnNge</span> <span class="id">leq_addr</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadStateLoop.Build</span> <span class="id">S</span> <span class="id">M</span> <span class="id">loop0</span> <span class="id">loop1</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelstateloop</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelStateLoop</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelStateLoop</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelReify</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelreify</span>.<br/>
<span class="vernacular">Variables</span> <span class="id">S</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">state_trace</span> <span class="id">:=</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)%<span class="id">type</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:=</span> (<span class="id">StateMonad.acto</span> <span class="id">state_trace</span>).<br/>
<span class="vernacular">Let</span> <span class="id">reify</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">state_trace</span> <span class="id">-&gt;</span> <span class="id">option</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">state_trace</span>) <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">m</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">Some</span> (<span class="id">m</span> <span class="id">s</span>).<br/>
<span class="vernacular">Let</span> <span class="id">reifyret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">s,</span> @<span class="id">reify</span> <span class="id">_</span> (<span class="id">Ret</span> <span class="id">a</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Some</span> (<span class="id">a,</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof127')">Proof.</span></div>
<div class="proofscript" id="proof127">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">reifybind</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">s,</span><br/>
&nbsp;&nbsp;@<span class="id">reify</span> <span class="id">_</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">s</span> <span class="id">=</span> <span class="gallina-kwd">match</span> @<span class="id">reify</span> <span class="id">_</span> <span class="id">m</span> <span class="id">s</span> <span class="gallina-kwd">with</span> <span class="id">|</span> <span class="id">Some</span> <span class="id">a's'</span> <span class="id">=&gt;</span> @<span class="id">reify</span> <span class="id">_</span> (<span class="id">f</span> <span class="id">a's'</span>.<span class="id">1</span>) <span class="id">a's'</span>.<span class="id">2</span> <span class="id">|</span> <span class="id">None</span> <span class="id">=&gt;</span> <span class="id">None</span> <span class="gallina-kwd">end</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof128')">Proof.</span></div>
<div class="proofscript" id="proof128">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m0</span> <span class="id">f</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> <span class="id">state_bindE</span>.<br/>
<span class="id">rewrite</span> <span class="id">/uncurry</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/comp</span> <span class="id">/=</span> <span class="id">/reify</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case</span> (<span class="id">m0</span> <span class="id">s</span>).<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadReify.Build</span> <span class="id">state_trace</span> (<span class="id">StateMonad.acto</span> <span class="id">state_trace</span>)<br/>
&nbsp;&nbsp;<span class="id">reifyret</span> <span class="id">reifybind</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelreify</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelReify</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelReify</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelStateTraceReify</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelstatetracereify</span>.<br/>
<span class="vernacular">Variables</span> <span class="id">S</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">acto</span> <span class="id">:=</span> (<span class="id">StateMonad.acto</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)).<br/>
<span class="vernacular">Let</span> <span class="id">reifystget</span> <span class="id">:</span>  <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">l,</span> @<span class="id">reify</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> (@<span class="id">st_get</span> <span class="id">_</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateTraceMonad</span> <span class="id">S</span> <span class="id">T</span> <span class="id">of</span> <span class="id">acto]</span>) (<span class="id">s,</span> <span class="id">l</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">s,</span> (<span class="id">s,</span> <span class="id">l</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof129')">Proof.</span></div>
<div class="proofscript" id="proof129">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">reifystput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">l</span> <span class="id">s',</span> @<span class="id">reify</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> (@<span class="id">st_put</span> <span class="id">_</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateTraceMonad</span> <span class="id">S</span> <span class="id">T</span> <span class="id">of</span> <span class="id">acto]</span> <span class="id">s'</span>) (<span class="id">s,</span> <span class="id">l</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">tt,</span> (<span class="id">s',</span> <span class="id">l</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof130')">Proof.</span></div>
<div class="proofscript" id="proof130">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">reifystmark</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">t</span> <span class="id">s</span> <span class="id">l,</span> @<span class="id">reify</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> (@<span class="id">st_mark</span> <span class="id">_</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateTraceMonad</span> <span class="id">S</span> <span class="id">T</span> <span class="id">of</span> <span class="id">acto]</span> <span class="id">t</span>) (<span class="id">s,</span> <span class="id">l</span>) <span class="id">=</span> <span class="id">Some</span> (<span class="id">tt,</span> (<span class="id">s,</span> <span class="id">rcons</span> <span class="id">l</span> <span class="id">t</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof131')">Proof.</span></div>
<div class="proofscript" id="proof131">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadStateTraceReify.Build</span> <span class="id">S</span> <span class="id">T</span> (<span class="id">StateMonad.acto</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)) <span class="id">reifystget</span> <span class="id">reifystput</span> <span class="id">reifystmark</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelstatetracereify</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelStateTraceReify</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelArray</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelarray</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">I</span> <span class="id">:</span> <span class="id">eqType</span>).<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> (<span class="id">i</span> <span class="id">j</span> <span class="id">:</span> <span class="id">I</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">acto</span> <span class="id">:=</span> <span class="id">StateMonad.acto</span> (<span class="id">I</span> <span class="id">-&gt;</span> <span class="id">S</span>).<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">acto</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">:</span> <span class="id">M</span> <span class="id">S</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> (<span class="id">a</span> <span class="id">i,</span> <span class="id">a</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> (<span class="id">tt,</span> <span class="id">insert</span> <span class="id">i</span> <span class="id">s</span> <span class="id">a</span>).<br/>
<span class="vernacular">Let</span> <span class="id">aputput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">s'</span> <span class="id">:</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof132')">Proof.</span></div>
<div class="proofscript" id="proof132">
<span class="id">rewrite</span> <span class="id">state_bindE;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">insert_insert</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">aputget</span> <span class="id">i</span> <span class="id">s</span> <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof133')">Proof.</span></div>
<div class="proofscript" id="proof133">
<span class="id">rewrite</span> <span class="id">state_bindE;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">insert_same</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">agetputskip</span> <span class="id">i</span> <span class="id">:</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">=</span> <span class="id">skip</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof134')">Proof.</span></div>
<div class="proofscript" id="proof134">
<span class="id">rewrite</span> <span class="id">state_bindE;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">insert_same2</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">agetget</span> <span class="id">i</span> <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof135')">Proof.</span></div>
<div class="proofscript" id="proof135">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">agetC</span> <span class="id">i</span> <span class="id">j</span> <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">u</span> <span class="id">v</span>)) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">u</span> <span class="id">v</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof136')">Proof.</span></div>
<div class="proofscript" id="proof136">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">aputC</span> <span class="id">i</span> <span class="id">j</span> <span class="id">u</span> <span class="id">v</span> <span class="id">:</span> (<span class="id">i</span> <span class="id">!=</span> <span class="id">j</span>) <span class="id">\/</span> (<span class="id">u</span> <span class="id">=</span> <span class="id">v</span>) <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">j</span> <span class="id">v</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">j</span> <span class="id">v</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">u</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof137')">Proof.</span></div>
<div class="proofscript" id="proof137">
<span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">[ij|-&gt;{u}];</span> <span class="id">rewrite</span> <span class="id">!state_bindE</span> <span class="id">/aput;</span> <span class="id">apply/funext</span> <span class="id">=&gt;</span> <span class="id">a/=;</span><br/>
&nbsp;&nbsp;<span class="id">[rewrite</span> <span class="id">insertC|rewrite</span> <span class="id">insertC2]</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">aputgetC</span> <span class="id">i</span> <span class="id">j</span> <span class="id">u</span> <span class="id">A</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">i</span> <span class="id">!=</span> <span class="id">j</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">v</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof138')">Proof.</span></div>
<div class="proofscript" id="proof138">
<span class="id">move=&gt;</span> <span class="id">ij;</span> <span class="id">rewrite</span> <span class="id">/aput</span> <span class="id">!state_bindE;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">a/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">state_bindE/=</span> <span class="id">{1}/insert</span> (<span class="id">negbTE</span> <span class="id">ij</span>).<br/>
Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonadArray.Build</span><br/>
&nbsp;&nbsp;<span class="id">S</span> <span class="id">I</span> <span class="id">acto</span> <span class="id">aputput</span> <span class="id">aputget</span> <span class="id">agetputskip</span> <span class="id">agetget</span> <span class="id">agetC</span> <span class="id">aputC</span> <span class="id">aputgetC</span>.<br/>
<span class="vernacular">End</span> <span class="id">modelarray</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelArray</span>.<br/>
<br/>
<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">monad_transformer_calcul</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">contTi</span> <span class="id">T</span> <span class="id">:=</span> <span class="id">MC</span> <span class="id">T</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">idfun]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">break_if_none</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">break</span> <span class="id">:</span> <span class="id">_</span>) (<span class="id">acc</span> <span class="id">:</span> <span class="id">nat</span>) (<span class="id">x</span> <span class="id">:</span> <span class="id">option</span> <span class="id">nat</span>) <span class="id">:</span> <span class="id">m</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">if</span> <span class="id">x</span> <span class="id">is</span> <span class="id">Some</span> <span class="id">x</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">+</span> <span class="id">acc</span>) <span class="gallina-kwd">else</span> <span class="id">break</span> <span class="id">acc</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">sum_until_none</span> (<span class="id">xs</span> <span class="id">:</span> <span class="id">seq</span> (<span class="id">option</span> <span class="id">nat</span>)) <span class="id">:</span> <span class="id">contTi</span> <span class="id">nat</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">break</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">contTi</span> <span class="id">nat</span> <span class="id">nat</span> <span class="id">=&gt;</span> <span class="id">foldM</span> (<span class="id">break_if_none</span> <span class="id">break</span>) <span class="id">0</span> <span class="id">xs</span>).<br/>
<br/>
<span class="vernacular">Goal</span> <span class="id">sum_until_none</span> <span class="id">[::</span> <span class="id">Some</span> <span class="id">2;</span> <span class="id">Some</span> <span class="id">6;</span> <span class="id">None;</span> <span class="id">Some</span> <span class="id">4]</span> <span class="id">=</span> @<span class="id">^~</span> <span class="id">8</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">cbv</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">calcul</span> <span class="id">:</span> <span class="id">contTi</span> <span class="id">nat</span> <span class="id">nat</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;(<span class="id">_</span> <span class="id">#</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">8</span> <span class="id">+</span> <span class="id">x</span>))<br/>
&nbsp;&nbsp;(<span class="id">callcc</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">contTi</span> <span class="id">nat</span> <span class="id">_</span> <span class="id">=&gt;</span> (<span class="id">k</span> <span class="id">5</span>) <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">Ret</span> (<span class="id">y</span> <span class="id">+</span> <span class="id">4</span>)))).<br/>
<br/>
<span class="vernacular">Goal</span> <span class="id">calcul</span> <span class="id">=</span> @<span class="id">^~</span> <span class="id">13</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">cbv</span>.<br/>
Abort.</div>
<br/>
<span class="vernacular">End</span> <span class="id">monad_transformer_calcul</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">examples_of_algebraic_lifting</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">state_exceptT</span>.<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">S</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">StateMonad.acto</span> <span class="id">S]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">aLGet</span> <span class="id">{Z</span> <span class="id">S}</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsGet.acto</span> <span class="id">S]</span>.<span class="id">-aoperation</span> (<span class="id">exceptT</span> <span class="id">Z</span> (<span class="id">M</span> <span class="id">S</span>)) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">alifting</span> (<span class="id">get_aop</span> <span class="id">S</span>) (<span class="id">Lift</span> <span class="id">_</span> (<span class="id">M</span> <span class="id">S</span>)).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">aLPut</span> <span class="id">{Z</span> <span class="id">S}</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">StateOpsPut.acto</span> <span class="id">S]</span>.<span class="id">-operation</span> (<span class="id">exceptT</span> <span class="id">Z</span> (<span class="id">M</span> <span class="id">S</span>)) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">alifting</span> (<span class="id">put_aop</span> <span class="id">S</span>) (<span class="id">Lift</span> <span class="id">_</span> (<span class="id">M</span> <span class="id">S</span>)).<br/>
<br/>
<span class="vernacular">Goal</span> <span class="gallina-kwd">forall</span> <span class="id">Z</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">X</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">exceptT</span> <span class="id">Z</span> (<span class="id">M</span> <span class="id">S</span>) <span class="id">X</span>)<span class="id">,</span> <span class="id">aLGet</span> <span class="id">_</span> <span class="id">k</span> <span class="id">=</span> <span class="id">get_op</span> <span class="id">_</span> <span class="id">k</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof139')">Proof.</span></div>
<div class="proofscript" id="proof139">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">Z</span> <span class="id">S</span> <span class="id">X</span> <span class="id">k;</span> <span class="id">rewrite</span> <span class="id">/aLGet</span> <span class="id">aliftingE</span>. Qed.</div>
<br/>
<span class="vernacular">Goal</span> <span class="gallina-kwd">forall</span> <span class="id">Z</span> <span class="id">S,</span> <span class="id">aLGet</span> <span class="id">_</span> <span class="id">Ret</span> <span class="id">=</span> <span class="id">Lift</span> <span class="id">[the</span> <span class="id">monadT</span> <span class="id">of</span> <span class="id">exceptT</span> <span class="id">Z]</span> (<span class="id">M</span> <span class="id">S</span>) <span class="id">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">get</span> <span class="id">S</span> <span class="id">[the</span> <span class="id">stateMonad</span> <span class="id">S</span> <span class="id">of</span> <span class="id">StateMonad.acto</span> <span class="id">S]</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof140')">Proof.</span></div>
<div class="proofscript" id="proof140">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">Z</span> <span class="id">S;</span> <span class="id">rewrite</span> <span class="id">/aLGet</span> <span class="id">aliftingE</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">state_exceptT</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">continuation_stateT</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">r</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Let</span> <span class="id">M</span> <span class="id">:</span> <span class="id">monad</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">ContMonad.acto</span> <span class="id">r]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">aLCallcc</span> <span class="id">:</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">ContOpsAcallcc.acto</span> <span class="id">r]</span>.<span class="id">-aoperation</span> (<span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">alifting</span> (<span class="id">callcc_aop</span> <span class="id">r</span>) (<span class="id">Lift</span> <span class="id">_</span> <span class="id">M</span>).<br/>
<br/>
<span class="vernacular">Goal</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> (<span class="id">f</span> <span class="id">:</span> (<span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">-&gt;</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;<span class="id">aLCallcc</span> <span class="id">_</span> <span class="id">f</span> <span class="id">=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">uncurry</span> <span class="id">m</span> (<span class="id">s,</span> <span class="id">k</span>)) <span class="id">s</span> <span class="id">k</span>) <span class="id">:&gt;</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof141')">Proof.</span></div>
<div class="proofscript" id="proof141">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/aLCallcc</span> <span class="id">aliftingE</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">usual_callccS</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">_</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">k</span> (<span class="id">x,</span> <span class="id">s</span>)) <span class="id">s</span> <span class="id">k</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">callccS_E</span> <span class="id">A</span> <span class="id">B</span> <span class="id">f</span> <span class="id">:</span> @<span class="id">aLCallcc</span> <span class="id">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">:</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">r</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">f</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> (<span class="gallina-kwd">fun</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">S</span>) (<span class="id">_</span> <span class="id">:</span> <span class="id">B</span> <span class="id">*</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">r</span>) <span class="id">=&gt;</span> <span class="id">k</span> (<span class="id">Ret</span> <span class="id">x</span>)) <span class="id">:</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">M</span> <span class="id">B</span>)) <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">usual_callccS</span> <span class="id">f</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof142')">Proof.</span></div>
<div class="proofscript" id="proof142">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/aLCallcc</span> <span class="id">aliftingE</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">continuation_stateT</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">examples_of_algebraic_lifting</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelMonadStateRun</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelmonadstaterun</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">N</span> <span class="id">:</span> <span class="id">monad</span> <span class="id">:=</span> <span class="id">option_monad</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">M</span> <span class="id">:</span> <span class="id">stateMonad</span> <span class="id">S</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">stateMonad</span> <span class="id">S</span> <span class="id">of</span> <span class="id">stateT</span> <span class="id">S</span> <span class="id">N]</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">runStateT</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">N</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)%<span class="id">type</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="id">id</span>.<br/>
<span class="vernacular">Let</span> <span class="id">runStateTret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>)<span class="id">,</span> @<span class="id">runStateT</span> <span class="id">_</span> (<span class="id">Ret</span> <span class="id">a</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">a,</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof143')">Proof.</span></div>
<div class="proofscript" id="proof143">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">runStateTbind</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;@<span class="id">runStateT</span> <span class="id">_</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">s</span> <span class="id">=</span> @<span class="id">runStateT</span> <span class="id">_</span> <span class="id">m</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> @<span class="id">runStateT</span> <span class="id">_</span> (<span class="id">f</span> <span class="id">x</span>.<span class="id">1</span>) <span class="id">x</span>.<span class="id">2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof144')">Proof.</span></div>
<div class="proofscript" id="proof144">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">M</span> <span class="id">m</span> <span class="id">f</span> <span class="id">s</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/=</span> <span class="id">/runStateT</span> <span class="id">bindE</span> <span class="id">/=</span> <span class="id">/join_of_bind</span> <span class="id">/bindS</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">MS_mapE</span> <span class="id">/actm</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">case:</span> (<span class="id">m</span> <span class="id">s</span>).<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">runStateTget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">:</span> <span class="id">S,</span> <span class="id">runStateT</span> <span class="id">get</span> <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">s,</span> <span class="id">s</span>) <span class="id">:&gt;</span> <span class="id">N</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof145')">Proof.</span></div>
<div class="proofscript" id="proof145">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">runStateTput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s'</span> <span class="id">s</span> <span class="id">:</span> <span class="id">S,</span> @<span class="id">runStateT</span> <span class="id">_</span> (<span class="id">put</span> <span class="id">s'</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">tt,</span> <span class="id">s'</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof146')">Proof.</span></div>
<div class="proofscript" id="proof146">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isMonadStateRun.Build</span> <span class="id">S</span> <span class="id">N</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">N</span>)<br/>
&nbsp;&nbsp;<span class="id">runStateTret</span><br/>
&nbsp;&nbsp;<span class="id">runStateTbind</span><br/>
&nbsp;&nbsp;<span class="id">runStateTget</span><br/>
&nbsp;&nbsp;<span class="id">runStateTput</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">modelmonadstaterun</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelMonadStateRun</span>.<br/>
<span class="id">HB.export</span> <span class="id">ModelMonadStateRun</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">ModelMonadExceptStateRun</span>.<br/>
<span class="vernacular">Section</span> <span class="id">modelmonadexceptstaterun</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Let</span> <span class="id">N</span> <span class="id">:</span> <span class="id">exceptMonad</span> <span class="id">:=</span> <span class="id">option_monad</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">M</span> <span class="id">:</span> <span class="id">stateRunMonad</span> <span class="id">S</span> <span class="id">N</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">stateRunMonad</span> <span class="id">S</span> <span class="id">N</span> <span class="id">of</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">N]</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">failure</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">N</span> <span class="id">A</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">liftS</span> (@<span class="id">fail</span> <span class="id">N</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Bindfailf</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> (@<span class="id">bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">MS</span> <span class="id">S</span> <span class="id">N]</span>) <span class="id">failure</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof147')">Proof.</span></div>
<div class="proofscript" id="proof147">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> @<span class="id">isMonadFail.Build</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">N</span>) <span class="id">failure</span> <span class="id">Bindfailf</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Catch</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">mapStateT2</span> (@<span class="id">catch</span> <span class="id">N</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)%<span class="id">type</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">Catchmfail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">right_id</span> (<span class="id">liftS</span> (@<span class="id">fail</span> <span class="id">N</span> <span class="id">A</span>)) (@<span class="id">Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof148')">Proof.</span></div>
<div class="proofscript" id="proof148">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/mapStateT2;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">catchmfail</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">Catchfailm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">left_id</span> (<span class="id">liftS</span> (@<span class="id">fail</span> <span class="id">N</span> <span class="id">A</span>)) (@<span class="id">Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof149')">Proof.</span></div>
<div class="proofscript" id="proof149">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/mapStateT2;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">catchfailm</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">CatchA</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">ssrfun.associative</span> (@<span class="id">Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof150')">Proof.</span></div>
<div class="proofscript" id="proof150">
<span class="id">move=&gt;</span> <span class="id">A;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/mapStateT2</span> <span class="id">=&gt;</span> <span class="id">a</span> <span class="id">b</span> <span class="id">c;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">catchA</span>.<br/>
Qed.</div>
<span class="vernacular">Let</span> <span class="id">Catchret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">x,</span> @<span class="id">left_zero</span> (<span class="id">M</span> <span class="id">A</span>) (<span class="id">M</span> <span class="id">A</span>) (<span class="id">Ret</span> <span class="id">x</span>) (@<span class="id">Catch</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof151')">Proof.</span></div>
<div class="proofscript" id="proof151">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">x</span> <span class="id">y;</span> <span class="id">rewrite</span> <span class="id">/Catch</span> <span class="id">/mapStateT2;</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">s</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">catchret</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;@<span class="id">isMonadExcept.Build</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">N</span>) <span class="id">Catch</span> <span class="id">Catchmfail</span> <span class="id">Catchfailm</span> <span class="id">CatchA</span> <span class="id">Catchret</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">RunStateTfail</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">runStateT</span> (@<span class="id">fail</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">N</span>)<span class="id">]</span> <span class="id">A</span>) <span class="id">s</span> <span class="id">=</span> @<span class="id">fail</span> <span class="id">N</span> <span class="id">_</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof152')">Proof.</span></div>
<div class="proofscript" id="proof152">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">RunStateTcatch</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">_</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">runStateT</span> (<span class="id">Catch</span> <span class="id">m1</span> <span class="id">m2</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">catch</span> (<span class="id">runStateT</span> <span class="id">m1</span> <span class="id">s</span>) (<span class="id">runStateT</span> <span class="id">m2</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof153')">Proof.</span></div>
<div class="proofscript" id="proof153">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> @<span class="id">isMonadExceptStateRun.Build</span> <span class="id">S</span> <span class="id">N</span> (<span class="id">MS</span> <span class="id">S</span> <span class="id">N</span>)<br/>
&nbsp;&nbsp;<span class="id">RunStateTfail</span> <span class="id">RunStateTcatch</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">modelmonadexceptstaterun</span>.<br/>
<span class="vernacular">End</span> <span class="id">ModelMonadExceptStateRun</span>.<br/>

      <div class="footer"><hr/>Generated by <a href="https://github.com/yoshihiro503/coq2html/">a fork of coq2html</a></div>
    </div>
  </div>
    </main>
</body>
</html>


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module monae.impredicative_set.ihierarchy</title>
<meta name="description" content="Documentation of Coq module monae.impredicative_set.ihierarchy" />
<link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath/texmath.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="init('proofscript')">

  <header>
    <p><a href="./index.html">coq2html</a></p>
    <h1 class="title">Module monae.impredicative_set.ihierarchy</h1>
    <p><a href="">source</a></p>
  </header>

  <main>
    <div class="sidebar">
      <h2>Files</h2>
      <li><details><summary>monae</summary>
          <ul>
          <li><a href="monae.proba_monad_model.html">proba_monad_model</a></li>
<li><a href="monae.example_monty.html">example_monty</a></li>
<li><a href="monae.typed_store_lib.html">typed_store_lib</a></li>
<li><a href="monae.monae_lib.html">monae_lib</a></li>
<li><a href="monae.example_spark.html">example_spark</a></li>
<li><a href="monae.example_quicksort.html">example_quicksort</a></li>
<li><a href="monae.monad_model.html">monad_model</a></li>
<li><a href="monae.fail_lib.html">fail_lib</a></li>
<li><a href="monae.category.html">category</a></li>
<li><a href="monae.altprob_model.html">altprob_model</a></li>
<li><a href="monae.typed_store_model.html">typed_store_model</a></li>
<li><a href="monae.category_ext.html">category_ext</a></li>
<li><a href="monae.proba_lib.html">proba_lib</a></li>
<li><a href="monae.monad_composition.html">monad_composition</a></li>
<li><a href="monae.example_transformer.html">example_transformer</a></li>
<li><a href="monae.hierarchy.html">hierarchy</a></li>
<li><a href="monae.example_typed_store.html">example_typed_store</a></li>
<li><a href="monae.example_relabeling.html">example_relabeling</a></li>
<li><a href="monae.monad_lib.html">monad_lib</a></li>
<li><a href="monae.example_nqueens.html">example_nqueens</a></li>
<li><a href="monae.smallstep.html">smallstep</a></li>
<li><a href="monae.array_lib.html">array_lib</a></li>
<li><a href="monae.state_lib.html">state_lib</a></li>
<li><a href="monae.monad_transformer.html">monad_transformer</a></li>
<li><a href="monae.example_iquicksort.html">example_iquicksort</a></li>
<li><a href="monae.gcm_model.html">gcm_model</a></li>
<li><a href="monae.trace_lib.html">trace_lib</a></li>
          </ul>
          </details>
          </li>
<li><details><summary>monaeImpredicativeSet</summary>
          <ul>
          <li><a href="monaeImpredicativeSet.imonad_composition.html">imonad_composition</a></li>
<li><a href="monaeImpredicativeSet.ihierarchy.html">ihierarchy</a></li>
<li><a href="monaeImpredicativeSet.imonad_lib.html">imonad_lib</a></li>
<li><a href="monaeImpredicativeSet.imonae_lib.html">imonae_lib</a></li>
<li><a href="monaeImpredicativeSet.ifail_lib.html">ifail_lib</a></li>
          </ul>
          </details>
          </li>
    </div>

  <div class="coq">

    <div class="content">
<span class="vernacular">Ltac</span> <span class="id">typeof</span> <span class="id">X</span> <span class="id">:=</span> <span class="id">type</span> <span class="id">of</span> <span class="id">X</span>.<br/>
<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">ssrmatching</span> <span class="id">JMeq</span>.<br/>
<span class="vernacular">From</span> <span class="id">mathcomp</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">all_ssreflect</span>.<br/>
<span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">imonae_lib</span>.<br/>
<span class="vernacular">From</span> <span class="id">HB</span> <span class="vernacular">Require</span> <span class="vernacular">Import</span> <span class="id">structures</span>.<br/>
<br/>
<pre class="ssrdoc">
       A formalization of monadic effects over the category Set            
                                                                           
We consider the type Type of Coq as the category Set and define functors   
and a hierarchy of monads on top of functors. These monads are used to     
develop the basics of monadic equational reasoning. The file category.v    
provides a more generic definition of functors and monads as well as a     
bridge to this file.                                                       
                                                                           
Module FunctorLaws == map laws of a functor                                
           functor == type of functors                                     
             F # g == application of the functor F to the morphism g       
               FId == notation for the identity functor                    
            F ~&gt; G == natural transformation from functor F to functor G   
           f ~~&gt; g == forall A, f A -&gt; g A, notation used for the          
                      components of a natural transformation               
  naturality F G f == the components f form a natural transformation       
                      F ~&gt; G                                               
   Module JoinLaws == join laws of a monad                                 
           isMonad == mixin of monad                                       
               &gt;&gt;= == notation for the standard bind operator              
            m &gt;&gt; f := m &gt;&gt;= (fun _ =&gt; f)                                   
             monad == type of monads                                       
               Ret == natural transformation FId ~&gt; M for a monad M        
              Join == natural transformation M \o M ~&gt; M for a monad M     
   Module BindLaws == bind laws of a monad                                 
                                                                           
Failure and nondeterministic monads:                                       
         failMonad == failure monad                                        
       failR0Monad == fail is right zero of bind                           
          altMonad == monad with nondeterministic choice                   
      prePlusMonad == nondeterminism + failR0 + distributivity             
         plusMonad == preplusMonad + commutativity and idempotence         
        altCIMonad == altMonad + commutativity + idempotence               
       nondetMonad == failMonad + altMonad                                 
     nondetCIMonad == failMOnad + altCIMonad                               
       exceptMonad == failMonad + catch                                    
                                                                           
Control monads (wip):                                                      
  contMonad, shiftresetMonad, jumpMonad                                    
                                                                           
State monads:                                                              
        stateMonad S == state monad with a state of type S                 
       stateRunMonad == state + RunStateT                                  
                        let N be a monad and S be the type of states, then 
                        when m is a computation in the monad               
                        stateRunMonad S N, RunStateT m s runs m in a       
                        state s and returns a computation in the monad N   
 exceptStateRunMonad == stateRun + except                                  
          reifyMonad == reify interface                                    
     stateReifyMonad == monadState + reify                                 
 failStateReifyMonad == stateReify + fail                                  
    nondetStateMonad == backtrackable state                                
          arrayMonad == array monad                                        
     plusArrayMonad  == plus monad + array monad                           
                                                                           
Trace monads:                                                              
           traceMonad == trace monad                                       
      traceReifyMonad == trace + reify                                     
      stateTraceMonad == state + trace                                     
 stateTraceReifyMonad == stateTrace + reify                                
                                                                           
Freshness monads:                                                          
        freshMonad == monad with freshness                                 
    failFreshMonad == freshMonad + failure                                 
                                                                           
references:                                                                
- R. Affeldt, D. Nowak, Extending Equational Monadic Reasoning with Monad  
Transformers, TYPES 2020, https://arxiv.org/abs/2011.03463                 
- R. Affeldt, D. Nowak, T. Saikawa, A Hierarchy of Monadic Effects for     
Program Verification using Equational Reasoning, MPC 2019                  
- J. Gibbons, R. Hinze, Just do it: simple monadic equational reasoning,   
ICFP 2011                                                                  
- J. Gibbons, Unifying Theories of Programming with Monads, UTP 2012       
</pre>
<br/>
<span class="gallina-kwd">Set</span> <span class="vernacular">Implicit</span> <span class="vernacular">Arguments</span>.<br/>
<span class="vernacular">Unset</span> <span class="vernacular">Strict</span> <span class="vernacular">Implicit</span>.<br/>
<span class="vernacular">Unset</span> <span class="vernacular">Printing</span> <span class="vernacular">Implicit</span> <span class="vernacular">Defensive</span>.<br/>
<br/>
<span class="vernacular">Declare</span> <span class="vernacular">Scope</span> <span class="id">do_notation</span>.<br/>
<span class="vernacular">Declare</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<span class="vernacular">Declare</span> <span class="vernacular">Scope</span> <span class="id">monae_scope</span>.<br/>
<span class="vernacular">Delimit</span> <span class="vernacular">Scope</span> <span class="id">monae_scope</span> <span class="gallina-kwd">with</span> <span class="id">monae</span>.<br/>
<br/>
<span class="vernacular">Reserved</span> <span class="vernacular">Notation</span> <span class="id">&quot;f (o) g&quot;</span> (<span class="gallina-kwd">at</span> <span class="id">level</span> <span class="id">11</span>).<br/>
<span class="vernacular">Reserved</span> <span class="vernacular">Notation</span> <span class="id">&quot;m &gt;&gt; f&quot;</span> (<span class="gallina-kwd">at</span> <span class="id">level</span> <span class="id">49</span>).<br/>
<span class="vernacular">Reserved</span> <span class="vernacular">Notation</span> <span class="id">&quot;'fmap' f&quot;</span> (<span class="gallina-kwd">at</span> <span class="id">level</span> <span class="id">4</span>).<br/>
<span class="vernacular">Reserved</span> <span class="vernacular">Notation</span> <span class="id">&quot;x '[~]' y&quot;</span> (<span class="gallina-kwd">at</span> <span class="id">level</span> <span class="id">50</span>).<br/>
<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;f ~~&gt; g&quot;</span> <span class="id">:=</span> (<span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">f</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">g</span> <span class="id">A</span>)<br/>
&nbsp;&nbsp;(<span class="gallina-kwd">at</span> <span class="id">level</span> <span class="id">51,</span> <span class="id">only</span> <span class="id">parsing</span>) <span class="id">:</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="vernacular">Notation</span> <span class="id">UU1</span> <span class="id">:=</span> <span class="gallina-kwd">Type</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">UU0</span> <span class="id">:=</span> <span class="gallina-kwd">Set</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">FunctorLaws</span>.<br/>
<span class="vernacular">Section</span> <span class="id">def</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">F</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0,</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">id</span> <span class="id">:=</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">f</span> <span class="id">id</span> <span class="id">=</span> <span class="id">id</span> <span class="id">:&gt;</span> (<span class="id">F</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">A</span>).<br/>
<span class="vernacular">Definition</span> <span class="id">comp</span> <span class="id">:=</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">C</span>) (<span class="id">h</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;<span class="id">f</span> (<span class="id">g</span> <span class="id">\o</span> <span class="id">h</span>) <span class="id">=</span> <span class="id">f</span> <span class="id">g</span> <span class="id">\o</span> <span class="id">f</span> <span class="id">h</span>.<br/>
<span class="vernacular">End</span> <span class="id">def</span>.<br/>
<span class="vernacular">End</span> <span class="id">FunctorLaws</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isFunctor</span> (<span class="id">F</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">actm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0,</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">functor_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">functor_o</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=functor</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">Functor</span> <span class="id">:=</span> <span class="id">{F</span> <span class="id">of</span> <span class="id">isFunctor</span> <span class="id">F}</span>.<br/>
<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;F # g&quot;</span> <span class="id">:=</span> (@<span class="id">actm</span> <span class="id">F</span> <span class="id">_</span> <span class="id">_</span> <span class="id">g</span>) <span class="id">:</span> <span class="id">monae_scope</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;'fmap' f&quot;</span> <span class="id">:=</span> (<span class="id">_</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">:</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">functorid</span>.<br/>
<span class="vernacular">Let</span> <span class="id">id_actm</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">idfun</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">idfun</span> <span class="id">B</span> <span class="id">:=</span> <span class="id">f</span>.<br/>
<span class="vernacular">Let</span> <span class="id">id_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">id_actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof1')">Proof.</span></div>
<div class="proofscript" id="proof1">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="vernacular">Let</span> <span class="id">id_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">id_actm</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof2')">Proof.</span></div>
<div class="proofscript" id="proof2">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">idfun</span> <span class="id">id_id</span> <span class="id">id_comp</span>.<br/>
<span class="vernacular">End</span> <span class="id">functorid</span>.<br/>
<br/>
<span class="vernacular">Notation</span> <span class="id">FId</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">idfun]</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">FIdE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">FId</span> <span class="id">#</span> <span class="id">f</span> <span class="id">=</span> <span class="id">f</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof3')">Proof.</span></div>
<div class="proofscript" id="proof3">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">functor_composition</span>.<br/>
<span class="vernacular">Variables</span> <span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">functor</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">comp_actm</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">h</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">:</span> (<span class="id">f</span> <span class="id">\o</span> <span class="id">g</span>) <span class="id">A</span> <span class="id">-&gt;</span> (<span class="id">f</span> <span class="id">\o</span> <span class="id">g</span>) <span class="id">B</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">f</span> <span class="id">#</span> (<span class="id">g</span> <span class="id">#</span> <span class="id">h</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">comp_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">comp_actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof4')">Proof.</span></div>
<div class="proofscript" id="proof4">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/FunctorLaws</span>.<span class="id">id</span> <span class="id">=&gt;</span> <span class="id">A;</span> <span class="id">rewrite</span> <span class="id">/comp_actm</span> <span class="id">2!functor_id</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">comp_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">comp_actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof5')">Proof.</span></div>
<div class="proofscript" id="proof5">
<span class="id">rewrite</span> <span class="id">/FunctorLaws</span>.<span class="id">comp</span> <span class="id">=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">g'</span> <span class="id">h;</span> <span class="id">rewrite</span> <span class="id">/comp_actm</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">[in</span> <span class="id">RHS]compE</span> <span class="id">2!functor_o</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> (<span class="id">f</span> <span class="id">\o</span> <span class="id">g</span>) <span class="id">comp_id</span> <span class="id">comp_comp</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">functor_composition</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">FCompE</span> (<span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">g]</span> <span class="id">#</span> <span class="id">k</span> <span class="id">=</span> <span class="id">f</span> <span class="id">#</span> (<span class="id">g</span> <span class="id">#</span> <span class="id">k</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof6')">Proof.</span></div>
<div class="proofscript" id="proof6">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">fcomp</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">functor</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">fcomp</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">C</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">locked</span> ((<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">\o</span> <span class="id">g</span>).<br/>
<span class="vernacular">Arguments</span> <span class="id">fcomp</span> <span class="id">:</span> <span class="id">simpl</span> <span class="id">never</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">&quot;f (o) g&quot;</span> <span class="id">:=</span> (<span class="id">fcomp</span> <span class="id">f</span> <span class="id">g</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fcomp_def</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">C</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">f</span> (<span class="id">o</span>) <span class="id">g</span> <span class="id">=</span> ((<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>)) <span class="id">\o</span> <span class="id">g</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof7')">Proof.</span></div>
<div class="proofscript" id="proof7">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/fcomp;</span> <span class="id">unlock</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fcompE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">C</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">c</span> <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">f</span> (<span class="id">o</span>) <span class="id">g</span>) <span class="id">c</span> <span class="id">=</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) (<span class="id">g</span> <span class="id">c</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof8')">Proof.</span></div>
<div class="proofscript" id="proof8">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fcomp_def</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fcomp_comp</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">D</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">C</span> <span class="id">-&gt;</span> <span class="id">A</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">D</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">\o</span> <span class="id">g</span>) (<span class="id">o</span>) <span class="id">m</span> <span class="id">=</span> <span class="id">f</span> (<span class="id">o</span>) (<span class="id">g</span> (<span class="id">o</span>) <span class="id">m</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof9')">Proof.</span></div>
<div class="proofscript" id="proof9">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">3!fcomp_def</span> <span class="id">functor_o</span> <span class="id">compA</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">fcomp</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;f (o) g&quot;</span> <span class="id">:=</span> (<span class="id">fcomp</span> <span class="id">f</span> <span class="id">g</span>) <span class="id">:</span> <span class="id">mprog</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">fcomp</span> <span class="id">:</span> <span class="id">simpl</span> <span class="id">never</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">functor_ext</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">functor</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> (<span class="id">H</span> <span class="id">:</span> <span class="id">Functor.sort</span> <span class="id">F</span> <span class="id">=</span> <span class="id">Functor.sort</span> <span class="id">G</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;@<span class="id">actm</span> <span class="id">G</span> <span class="id">=</span><br/>
&nbsp;&nbsp;<span class="id">eq_rect</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">m</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span> <span class="id">=&gt;</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0,</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">m</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">m</span> <span class="id">B</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">actm</span> <span class="id">F</span>) <span class="id">_</span> <span class="id">H</span>  <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;<span class="id">G</span> <span class="id">=</span> <span class="id">F</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof10')">Proof.</span></div>
<div class="proofscript" id="proof10">
<span class="id">move:</span> <span class="id">F</span> <span class="id">G</span> <span class="id">=&gt;</span> <span class="id">[F</span> <span class="id">[[HF1</span> <span class="id">HF2</span> <span class="id">HF3]]]</span> <span class="id">[G</span> <span class="id">[[HG1</span> <span class="id">HG2</span> <span class="id">HG3]]]</span> <span class="id">/=</span> <span class="id">H</span>.<br/>
<span class="id">subst</span> <span class="id">F</span> <span class="id">=&gt;</span> <span class="id">/=</span> <span class="id">H</span>.<br/>
<span class="id">congr</span> (<span class="id">Functor.Pack</span> (<span class="id">Functor.Class</span> <span class="id">_</span>)).<br/>
<span class="id">have</span> <span class="id">?</span> <span class="id">:</span> <span class="id">HG1</span> <span class="id">=</span> <span class="id">HF1</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">/actm</span> <span class="id">/=</span> <span class="gallina-kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">x</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">y</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">z</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">move/</span>(<span class="id">congr1</span> (<span class="gallina-kwd">fun</span> <span class="id">i</span> <span class="id">=&gt;</span> <span class="id">i</span> <span class="id">x</span> <span class="id">y</span> <span class="id">z</span>)) <span class="id">:</span> <span class="id">H</span>.<br/>
<span class="id">subst</span> <span class="id">HG1</span>.<br/>
<span class="id">congr</span> (<span class="id">isFunctor.Axioms_</span> <span class="id">_</span>)<span class="id">;</span> <span class="id">exact/proof_irr</span>.<br/>
Defined.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">naturality</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~~&gt;</span> <span class="id">G</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">h</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>)<span class="id">,</span> (<span class="id">G</span> <span class="id">#</span> <span class="id">h</span>) <span class="id">\o</span> <span class="id">f</span> <span class="id">A</span> <span class="id">=</span> <span class="id">f</span> <span class="id">B</span> <span class="id">\o</span> (<span class="id">F</span> <span class="id">#</span> <span class="id">h</span>).<br/>
<span class="vernacular">Arguments</span> <span class="id">naturality</span> <span class="id">:</span> <span class="id">clear</span> <span class="id">implicits</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isNatural</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~~&gt;</span> <span class="id">G</span>) <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">natural</span> <span class="id">:</span> <span class="id">naturality</span> <span class="id">F</span> <span class="id">G</span> <span class="id">f</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=nattrans</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">Nattrans</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">functor</span>) <span class="id">:=</span> <span class="id">{f</span> <span class="id">of</span> <span class="id">isNatural</span> <span class="id">F</span> <span class="id">G</span> <span class="id">f}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">natural</span> <span class="id">{F</span> <span class="id">G}</span> <span class="id">s</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;f ~&gt; g&quot;</span> <span class="id">:=</span> (<span class="id">nattrans</span> <span class="id">f</span> <span class="id">g</span>) <span class="id">:</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">natrans_lemmas</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">F</span> <span class="id">G</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">phi</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>).<br/>
<span class="vernacular">Lemma</span> <span class="id">nattrans_ext</span> (<span class="id">f</span> <span class="id">g</span> <span class="id">:</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">G</span>) <span class="id">:</span> <span class="id">f</span> <span class="id">=</span> <span class="id">g</span> <span class="id">&lt;-&gt;</span> <span class="gallina-kwd">forall</span> <span class="id">a,</span> (<span class="id">f</span> <span class="id">a</span> <span class="id">=</span> <span class="id">g</span> <span class="id">a</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">_</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof11')">Proof.</span></div>
<div class="proofscript" id="proof11">
<span class="id">split</span> <span class="id">=&gt;</span> <span class="id">[</span> <span class="id">-&gt;</span> <span class="id">//</span> <span class="id">|];</span> <span class="id">move:</span> <span class="id">f</span> <span class="id">g</span> <span class="id">=&gt;</span> <span class="id">[f</span> <span class="id">Hf]</span> <span class="id">[g</span> <span class="id">Hg]</span> <span class="id">/=</span> <span class="id">fg</span>.<br/>
<span class="id">have</span> <span class="id">?</span> <span class="id">:</span> <span class="id">f</span> <span class="id">=</span> <span class="id">g</span> <span class="gallina-kwd">by</span> <span class="id">exact:</span> <span class="id">funext_dep</span>.<br/>
<span class="id">subst</span> <span class="id">g</span>.<br/>
<span class="id">suff</span> <span class="id">:</span> <span class="id">Hf</span> <span class="id">=</span> <span class="id">Hg</span> <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">-&gt;</span>.<br/>
<span class="id">case:</span> <span class="id">Hf</span> <span class="id">=&gt;</span> <span class="id">-[Hf]</span>.<br/>
<span class="id">case:</span> <span class="id">Hg</span> <span class="id">=&gt;</span> <span class="id">-[Hg]</span>.<br/>
<span class="id">do</span> <span class="id">2</span> <span class="id">f_equal</span>.<br/>
<span class="id">exact:</span> <span class="id">proof_irr</span>.<br/>
Qed.</div>
<span class="vernacular">End</span> <span class="id">natrans_lemmas</span>.<br/>
<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">JoinLaws</span>.<br/>
<span class="vernacular">Section</span> <span class="id">join_laws</span>.<br/>
<span class="vernacular">Context</span> <span class="id">{F</span> <span class="id">:</span> <span class="id">functor}</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">ret</span> <span class="id">:</span> <span class="id">FId</span> <span class="id">~&gt;</span> <span class="id">F</span>) (<span class="id">join</span> <span class="id">:</span> <span class="id">F</span> <span class="id">\o</span> <span class="id">F</span> <span class="id">~~&gt;</span> <span class="id">F</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">left_unit</span> <span class="id">:=</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> @<span class="id">join</span> <span class="id">A</span> <span class="id">\o</span> <span class="id">ret</span> (<span class="id">F</span> <span class="id">A</span>) <span class="id">=</span> <span class="id">id</span> <span class="id">:&gt;</span> (<span class="id">F</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">right_unit</span> <span class="id">:=</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> @<span class="id">join</span> <span class="id">A</span> <span class="id">\o</span> <span class="id">F</span> <span class="id">#</span> <span class="id">ret</span> <span class="id">A</span> <span class="id">=</span> <span class="id">id</span> <span class="id">:&gt;</span> (<span class="id">F</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">associativity</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">A,</span> @<span class="id">join</span> <span class="id">A</span> <span class="id">\o</span> <span class="id">F</span> <span class="id">#</span> @<span class="id">join</span> <span class="id">A</span> <span class="id">=</span> @<span class="id">join</span> <span class="id">A</span> <span class="id">\o</span> @<span class="id">join</span> (<span class="id">F</span> <span class="id">A</span>) <span class="id">:&gt;</span> (<span class="id">F</span> (<span class="id">F</span> (<span class="id">F</span> <span class="id">A</span>)) <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">A</span>).<br/>
<br/>
<span class="vernacular">End</span> <span class="id">join_laws</span>.<br/>
<span class="vernacular">End</span> <span class="id">JoinLaws</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonad</span> (<span class="id">F</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">Functor</span> <span class="id">F</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">ret</span> <span class="id">:</span> <span class="id">FId</span> <span class="id">~&gt;</span> <span class="id">F</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">join</span> <span class="id">:</span> <span class="id">F</span> <span class="id">\o</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">F</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">bind</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>)<span class="id">,</span> <span class="id">F</span> <span class="id">A</span> <span class="id">-&gt;</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">bindE</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">F</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bind</span> <span class="id">A</span> <span class="id">B</span> <span class="id">m</span> <span class="id">f</span> <span class="id">=</span> <span class="id">join</span> <span class="id">B</span> ((<span class="id">F</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">joinretM</span> <span class="id">:</span> <span class="id">JoinLaws.left_unit</span> <span class="id">ret</span> <span class="id">join</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">joinMret</span> <span class="id">:</span> <span class="id">JoinLaws.right_unit</span> <span class="id">ret</span> <span class="id">join</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">joinA</span> <span class="id">:</span> <span class="id">JoinLaws.associativity</span> <span class="id">join</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=monad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">Monad</span> <span class="id">:=</span> <span class="id">{F</span> <span class="id">of</span> <span class="id">isMonad</span> <span class="id">F</span> &amp;<span class="id">}</span>.<br/>
<br/>
<span class="vernacular">Notation</span> <span class="id">Ret</span> <span class="id">:=</span> (@<span class="id">ret</span> <span class="id">_</span> <span class="id">_</span>).<br/>
<span class="vernacular">Notation</span> <span class="id">Join</span> <span class="id">:=</span> (@<span class="id">join</span> <span class="id">_</span> <span class="id">_</span>).<br/>
<span class="vernacular">Arguments</span> <span class="id">bind</span> <span class="id">{s</span> <span class="id">A</span> <span class="id">B}</span> <span class="id">:</span> <span class="id">simpl</span> <span class="id">never</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;m &gt;&gt;= f&quot;</span> <span class="id">:=</span> (<span class="id">bind</span> <span class="id">m</span> <span class="id">f</span>) <span class="id">:</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">eq_bind</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f1</span> <span class="id">f2</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">f1</span> <span class="id">=1</span> <span class="id">f2</span> <span class="id">-&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f1</span> <span class="id">=</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof12')">Proof.</span></div>
<div class="proofscript" id="proof12">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">f12;</span> <span class="id">congr</span> <span class="id">bind;</span> <span class="id">apply</span> <span class="id">funext</span>. Qed.</div>
<br/>
<span class="vernacular">Section</span> <span class="id">monad_lemmas</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fmapE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;(<span class="id">M</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span> <span class="id">=</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="id">ret</span> <span class="id">B</span> <span class="id">\o</span> <span class="id">f</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof13')">Proof.</span></div>
<div class="proofscript" id="proof13">
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindE</span> <span class="id">[in</span> <span class="id">RHS]functor_o</span> <span class="id">-[in</span> <span class="id">RHS]compE</span> <span class="id">compA</span> <span class="id">joinMret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">monad_lemmas</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">BindLaws</span>.<br/>
<span class="vernacular">Section</span> <span class="id">bindlaws</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">F</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">b</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>)<span class="id">,</span> <span class="id">F</span> <span class="id">A</span> <span class="id">-&gt;</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">&quot;m &gt;&gt;= f&quot;</span> <span class="id">:=</span> (<span class="id">b</span> <span class="id">m</span> <span class="id">f</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">associative</span> <span class="id">:=</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">F</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">C</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;(<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">&gt;&gt;=</span> <span class="id">g</span> <span class="id">=</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> <span class="id">g</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">right_distributive</span> (<span class="id">add</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">B,</span> <span class="id">F</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">F</span> <span class="id">A</span>) (<span class="id">k1</span> <span class="id">k2</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">add</span> <span class="id">_</span> (<span class="id">k1</span> <span class="id">x</span>) (<span class="id">k2</span> <span class="id">x</span>)) <span class="id">=</span> <span class="id">add</span> <span class="id">_</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">k1</span>) (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">k2</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">left_distributive</span> (<span class="id">add</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">B,</span> <span class="id">F</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">F</span> <span class="id">A</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">add</span> <span class="id">_</span> <span class="id">m1</span> <span class="id">m2</span>) <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span> <span class="id">add</span> <span class="id">_</span> (<span class="id">m1</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>) (<span class="id">m2</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>).<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">left_zero</span> (<span class="id">f</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">F</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>)<span class="id">,</span> <span class="id">f</span> <span class="id">A</span> <span class="id">&gt;&gt;=</span> <span class="id">g</span> <span class="id">=</span> <span class="id">f</span> <span class="id">B</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">right_zero</span> (<span class="id">f</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">F</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">F</span> <span class="id">B</span>)<span class="id">,</span> <span class="id">g</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">A</span>) <span class="id">=</span> <span class="id">f</span> <span class="id">A</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">left_neutral</span> (<span class="id">r</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>)<span class="id">,</span> <span class="id">r</span> <span class="id">_</span> <span class="id">a</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span> <span class="id">=</span> <span class="id">f</span> <span class="id">a</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">right_neutral</span> (<span class="id">r</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">A</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">F</span> <span class="id">A</span>)<span class="id">,</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">r</span> <span class="id">_</span> <span class="id">=</span> <span class="id">m</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">left_id</span> (<span class="id">r</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">F</span> <span class="id">A</span>) (<span class="id">op</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">B,</span> <span class="id">F</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">A</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">F</span> <span class="id">A</span>)<span class="id">,</span> <span class="id">op</span> <span class="id">_</span> (<span class="id">r</span> <span class="id">_</span>) <span class="id">m</span> <span class="id">=</span> <span class="id">m</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">right_id</span> (<span class="id">r</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">F</span> <span class="id">A</span>) (<span class="id">op</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">B,</span> <span class="id">F</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span> <span class="id">A</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">F</span> <span class="id">A</span>)<span class="id">,</span> <span class="id">op</span> <span class="id">_</span> <span class="id">m</span> (<span class="id">r</span> <span class="id">_</span>) <span class="id">=</span> <span class="id">m</span>.<br/>
<br/>
<span class="vernacular">End</span> <span class="id">bindlaws</span>.<br/>
<span class="vernacular">End</span> <span class="id">BindLaws</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">join_of_bind</span> (<span class="id">F</span> <span class="id">:</span> <span class="id">functor</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">b</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>)<span class="id">,</span> <span class="id">F</span> <span class="id">A</span> <span class="id">-&gt;</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">F</span> <span class="id">\o</span> <span class="id">F</span> <span class="id">~~&gt;</span> <span class="id">F</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">=&gt;</span> (<span class="id">b</span> <span class="id">_</span> <span class="id">A</span>)<span class="id">^~</span> <span class="id">id</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">bind_of_join</span> (<span class="id">F</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">j</span> <span class="id">:</span> <span class="id">F</span> <span class="id">\o</span> <span class="id">F</span> <span class="id">~~&gt;</span> <span class="id">F</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">F</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">F</span> <span class="id">B</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">j</span> <span class="id">B</span> ((<span class="id">F</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span>).<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">from_join_laws_to_bind_laws</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">F</span> <span class="id">:</span> <span class="id">functor</span>) (<span class="id">ret</span> <span class="id">:</span> <span class="id">FId</span> <span class="id">~&gt;</span> <span class="id">F</span>) (<span class="id">join</span> <span class="id">:</span> <span class="id">F</span> <span class="id">\o</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">F</span>).<br/>
<br/>
<span class="vernacular">Hypothesis</span> <span class="id">joinretM</span> <span class="id">:</span> <span class="id">JoinLaws.left_unit</span> <span class="id">ret</span> <span class="id">join</span>.<br/>
<span class="vernacular">Hypothesis</span> <span class="id">joinMret</span> <span class="id">:</span> <span class="id">JoinLaws.right_unit</span> <span class="id">ret</span> <span class="id">join</span>.<br/>
<span class="vernacular">Hypothesis</span> <span class="id">joinA</span> <span class="id">:</span> <span class="id">JoinLaws.associativity</span> <span class="id">join</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bindretf_derived</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> (<span class="id">bind_of_join</span> <span class="id">join</span>) <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof14')">Proof.</span></div>
<div class="proofscript" id="proof14">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">a</span> <span class="id">f;</span> <span class="id">rewrite</span> <span class="id">/bind_of_join</span> <span class="id">-</span>(<span class="id">compE</span> (@<span class="id">join</span> <span class="id">_</span>)) <span class="id">-</span>(<span class="id">compE</span> <span class="id">_</span> (@<span class="id">ret</span> <span class="id">_</span>)).<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-compA</span> (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">compA</span> <span class="id">joinretM</span> <span class="id">compidf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bindmret_derived</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> (<span class="id">bind_of_join</span> <span class="id">join</span>) <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof15')">Proof.</span></div>
<div class="proofscript" id="proof15">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">m;</span> <span class="id">rewrite</span> <span class="id">/bind_of_join</span> <span class="id">-</span>(<span class="id">compE</span> (@<span class="id">join</span> <span class="id">_</span>)) <span class="id">joinMret</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bindA_derived</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> (<span class="id">bind_of_join</span> <span class="id">join</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof16')">Proof.</span></div>
<div class="proofscript" id="proof16">
<span class="id">move=&gt;</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">m</span> <span class="id">f</span> <span class="id">g;</span> <span class="id">rewrite</span> <span class="id">/bind_of_join</span>.<br/>
<span class="id">rewrite</span> <span class="id">[LHS]</span>(<span class="id">_</span> <span class="id">:</span> <span class="id">_</span> <span class="id">=</span> ((@<span class="id">join</span> <span class="id">_</span> <span class="id">\o</span> (<span class="id">F</span> <span class="id">#</span> <span class="id">g</span> <span class="id">\o</span> @<span class="id">join</span> <span class="id">_</span>) <span class="id">\o</span> <span class="id">F</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span>)) <span class="id">//</span>.<br/>
<span class="id">rewrite</span> (<span class="id">natural</span> <span class="id">join</span>) (<span class="id">compA</span> (@<span class="id">join</span> <span class="id">C</span>)) <span class="id">-joinA</span> <span class="id">-</span>(<span class="id">compE</span> (@<span class="id">join</span> <span class="id">_</span>)).<br/>
<span class="id">transitivity</span> ((@<span class="id">join</span> <span class="id">_</span> <span class="id">\o</span> <span class="id">F</span> <span class="id">#</span> (@<span class="id">join</span> <span class="id">_</span> <span class="id">\o</span> (<span class="id">F</span> <span class="id">#</span> <span class="id">g</span> <span class="id">\o</span> <span class="id">f</span>))) <span class="id">m</span>) <span class="id">=&gt;</span> <span class="id">//</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-2!compA</span> <span class="id">functor_o</span> <span class="id">FCompE</span> <span class="id">-[in</span> <span class="id">LHS]</span>(@<span class="id">functor_o</span> <span class="id">F</span>).<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">from_join_laws_to_bind_laws</span>.<br/>
<br/>
<span class="id">HB.factory</span> <span class="vernacular">Record</span> <span class="id">isMonad_ret_join</span> (<span class="id">F</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">isFunctor</span> <span class="id">F</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">ret</span> <span class="id">:</span> <span class="id">FId</span> <span class="id">~&gt;</span> <span class="id">F</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">join</span> <span class="id">:</span> <span class="id">F</span> <span class="id">\o</span> <span class="id">F</span> <span class="id">~&gt;</span> <span class="id">F</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">joinretM</span> <span class="id">:</span> <span class="id">JoinLaws.left_unit</span> <span class="id">ret</span> <span class="id">join</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">joinMret</span> <span class="id">:</span> <span class="id">JoinLaws.right_unit</span> <span class="id">ret</span> <span class="id">join</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">joinA</span> <span class="id">:</span> <span class="id">JoinLaws.associativity</span> <span class="id">join</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.builders</span> <span class="vernacular">Context</span> <span class="id">M</span> <span class="id">of</span> <span class="id">isMonad_ret_join</span> <span class="id">M</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">F</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bind</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">F</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">F</span> <span class="id">B</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">bind_of_join</span> <span class="id">join</span> <span class="id">m</span> <span class="id">f</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bindE</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">bind</span> <span class="id">m</span> <span class="id">f</span> <span class="id">=</span> <span class="id">join</span> <span class="id">B</span> ((<span class="id">F</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof17')">Proof.</span></div>
<div class="proofscript" id="proof17">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonad.Build</span> <span class="id">M</span> <span class="id">bindE</span> <span class="id">joinretM</span> <span class="id">joinMret</span> <span class="id">joinA</span>.<br/>
<span class="id">HB.end</span>.<br/>
<br/>
<span class="id">HB.factory</span> <span class="vernacular">Record</span> <span class="id">isMonad_ret_bind</span> (<span class="id">F</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">ret'</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>)<span class="id">,</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">A</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">bind</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>)<span class="id">,</span> <span class="id">F</span> <span class="id">A</span> <span class="id">-&gt;</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">B</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">bindretf</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> <span class="id">bind</span> <span class="id">ret'</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">bindmret</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> <span class="id">bind</span> <span class="id">ret'</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">bindA</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> <span class="id">bind</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.builders</span> <span class="vernacular">Context</span> <span class="id">M</span> <span class="id">of</span> <span class="id">isMonad_ret_bind</span> <span class="id">M</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">actm</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">a</span> <span class="id">-&gt;</span> <span class="id">b</span>) <span class="id">m</span> <span class="id">:=</span> <span class="id">bind</span> <span class="id">m</span> (@<span class="id">ret'</span> <span class="id">_</span> <span class="id">\o</span> <span class="id">f</span>).<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">actm_id</span> <span class="id">:</span> <span class="id">FunctorLaws.id</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof18')">Proof.</span></div>
<div class="proofscript" id="proof18">
<span class="id">move=&gt;</span> <span class="id">a</span>.<br/>
<span class="id">rewrite</span> <span class="id">/actm;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindmret</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">actm_comp</span> <span class="id">:</span> <span class="id">FunctorLaws.comp</span> <span class="id">actm</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof19')">Proof.</span></div>
<div class="proofscript" id="proof19">
<span class="id">move=&gt;</span> <span class="id">a</span> <span class="id">b</span> <span class="id">c</span> <span class="id">g</span> <span class="id">h</span>.<br/>
<span class="id">rewrite</span> <span class="id">/actm;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA</span>.<br/>
<span class="id">congr</span> <span class="id">bind</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">u</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isFunctor.Build</span> <span class="id">M</span> <span class="id">actm_id</span> <span class="id">actm_comp</span>.<br/>
<span class="vernacular">Let</span> <span class="id">F</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">M]</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">FF</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">functor</span> <span class="id">of</span> <span class="id">F</span> <span class="id">\o</span> <span class="id">F]</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">ret'_naturality</span> <span class="id">:</span> <span class="id">naturality</span> <span class="id">FId</span> <span class="id">F</span> <span class="id">ret'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof20')">Proof.</span></div>
<div class="proofscript" id="proof20">
<span class="id">move=&gt;</span> <span class="id">a</span> <span class="id">b</span> <span class="id">h</span>.<br/>
<span class="id">rewrite</span> <span class="id">FIdE</span> <span class="id">/ihierarchy</span>.<span class="id">actm</span> <span class="id">/=</span> <span class="id">/actm;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">isNatural.Build</span> <span class="id">FId</span> <span class="id">F</span> (<span class="id">ret'</span> <span class="id">:</span> <span class="id">FId</span> <span class="id">~~&gt;</span> <span class="id">F</span>) <span class="id">ret'_naturality</span>.<br/>
<span class="vernacular">Let</span> <span class="id">ret</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">FId</span> <span class="id">~&gt;</span> <span class="id">F</span> <span class="id">of</span> <span class="id">ret']</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">join'</span> <span class="id">:</span> <span class="id">FF</span> <span class="id">~~&gt;</span> <span class="id">F</span> <span class="id">:=</span> <span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">m</span> <span class="id">=&gt;</span> <span class="id">bind</span> <span class="id">m</span> <span class="id">idfun</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">actm_bind</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">c</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">a</span> <span class="id">-&gt;</span> <span class="id">b</span>) <span class="id">m</span> (<span class="id">g</span> <span class="id">:</span> <span class="id">c</span> <span class="id">-&gt;</span> <span class="id">F</span> <span class="id">a</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">actm</span> <span class="id">f</span>) (<span class="id">bind</span> <span class="id">m</span> <span class="id">g</span>) <span class="id">=</span> <span class="id">bind</span> <span class="id">m</span> (<span class="id">actm</span> <span class="id">f</span> <span class="id">\o</span> <span class="id">g</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof21')">Proof.</span></div>
<div class="proofscript" id="proof21">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/actm</span> <span class="id">bindA</span>. Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">join'_naturality</span> <span class="id">:</span> <span class="id">naturality</span> <span class="id">FF</span> <span class="id">F</span> <span class="id">join'</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof22')">Proof.</span></div>
<div class="proofscript" id="proof22">
<span class="id">move=&gt;</span> <span class="id">a</span> <span class="id">b</span> <span class="id">h</span>.<br/>
<span class="id">rewrite</span> <span class="id">/join'</span> <span class="id">/=;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">mm</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">/ihierarchy</span>.<span class="id">actm</span> <span class="id">/=</span> <span class="id">/isFunctor</span>.<span class="id">actm</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">actm_bind</span> <span class="id">bindA</span> <span class="id">/=</span>.<br/>
<span class="id">congr</span> <span class="id">bind</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span> <span class="id">/=</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isNatural.Build</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">join'_naturality</span>.<br/>
<span class="vernacular">Let</span> <span class="id">join</span> <span class="id">:=</span> <span class="id">[the</span> <span class="id">FF</span> <span class="id">~&gt;</span> <span class="id">F</span> <span class="id">of</span> <span class="id">join']</span>.<br/>
<br/>
<span class="vernacular">Let</span> <span class="id">bind_map</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">bind</span> ((<span class="id">F</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span>) <span class="id">g</span> <span class="id">=</span> <span class="id">bind</span> <span class="id">m</span> (<span class="id">g</span> <span class="id">\o</span> <span class="id">f</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof23')">Proof.</span></div>
<div class="proofscript" id="proof23">
<span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">congr</span> <span class="id">bind</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">?;</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">bindE</span> (<span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">a</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">b</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">a</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">bind</span> <span class="id">m</span> <span class="id">f</span> <span class="id">=</span> <span class="id">join</span> <span class="id">b</span> ((<span class="id">F</span> <span class="id">#</span> <span class="id">f</span>) <span class="id">m</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof24')">Proof.</span></div>
<div class="proofscript" id="proof24">
<span class="id">rewrite</span> <span class="id">/join</span> <span class="id">/=</span> <span class="id">/ihierarchy</span>.<span class="id">actm</span> <span class="id">/=</span> <span class="id">/join'</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bind_map</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">joinretM</span> <span class="id">:</span> <span class="id">JoinLaws.left_unit</span> <span class="id">ret</span> <span class="id">join</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof25')">Proof.</span></div>
<div class="proofscript" id="proof25">
<span class="id">move=&gt;</span> <span class="id">a;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/join</span> <span class="id">/=</span> <span class="id">/join'</span> <span class="id">/=</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">joinMret</span> <span class="id">:</span> <span class="id">JoinLaws.right_unit</span> <span class="id">ret</span> <span class="id">join</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof26')">Proof.</span></div>
<div class="proofscript" id="proof26">
<span class="id">move=&gt;</span> <span class="id">a;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span>.<br/>
<span class="id">rewrite</span> <span class="id">/join</span> <span class="id">/=</span> <span class="id">/join'</span>.<br/>
<span class="id">rewrite</span> <span class="id">/ihierarchy</span>.<span class="id">actm</span> <span class="id">/=</span> <span class="id">/actm</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">bindA</span> <span class="id">/=</span>.<br/>
<span class="id">rewrite</span> <span class="id">[X</span> <span class="gallina-kwd">in</span> <span class="id">bind</span> <span class="id">m</span> <span class="id">X]</span>(<span class="id">_</span> <span class="id">:</span> <span class="id">_</span> <span class="id">=</span> <span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">ret'</span> <span class="id">x</span>) <span class="id">?bindmret</span> <span class="id">//=;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">?</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Let</span> <span class="id">joinA</span> <span class="id">:</span> <span class="id">JoinLaws.associativity</span> <span class="id">join</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof27')">Proof.</span></div>
<div class="proofscript" id="proof27">
<span class="id">move</span> <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">m</span>.<br/>
<span class="id">rewrite</span> <span class="id">/join</span> <span class="id">/=</span> <span class="id">/join'</span>.<br/>
<span class="id">rewrite</span> <span class="id">/ihierarchy</span>.<span class="id">actm</span> <span class="id">/=</span> <span class="id">/actm</span>.<br/>
<span class="id">rewrite</span> <span class="id">!bindA</span>.<br/>
<span class="id">congr</span> <span class="id">bind</span>.<br/>
<span class="id">apply:</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">u</span> <span class="id">/=</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindretf</span>.<br/>
Qed.</div>
<br/>
<span class="id">HB.instance</span> <span class="vernacular">Definition</span> <span class="id">_</span> <span class="id">:=</span> <span class="id">isMonad.Build</span> <span class="id">M</span> <span class="id">bindE</span> <span class="id">joinretM</span> <span class="id">joinMret</span> <span class="id">joinA</span>.<br/>
<span class="id">HB.end</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">monad_lemmas</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bindretf</span> <span class="id">:</span> <span class="id">BindLaws.left_neutral</span> (@<span class="id">bind</span> <span class="id">M</span>) <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof28')">Proof.</span></div>
<div class="proofscript" id="proof28">
<span class="id">move:</span> (@<span class="id">bindretf_derived</span> <span class="id">M</span> <span class="id">ret</span> <span class="id">join</span> <span class="id">joinretM</span>).<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">bind_of_join</span> <span class="id">_</span> <span class="id">=</span> @<span class="id">bind</span> <span class="id">M</span>) <span class="id">//</span>.<br/>
<span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">B</span>.<br/>
<span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">m;</span> <span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">f</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bindmret</span> <span class="id">:</span> <span class="id">BindLaws.right_neutral</span> (@<span class="id">bind</span> <span class="id">M</span>) <span class="id">ret</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof29')">Proof.</span></div>
<div class="proofscript" id="proof29">
<span class="id">move:</span> (@<span class="id">bindmret_derived</span> <span class="id">M</span> <span class="id">ret</span> <span class="id">join</span> <span class="id">joinMret</span>).<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">bind_of_join</span> <span class="id">_</span> <span class="id">=</span> @<span class="id">bind</span> <span class="id">M</span>) <span class="id">//</span>.<br/>
<span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">B</span>.<br/>
<span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">m;</span> <span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">f</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bindA</span> <span class="id">:</span> <span class="id">BindLaws.associative</span> (@<span class="id">bind</span> <span class="id">M</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof30')">Proof.</span></div>
<div class="proofscript" id="proof30">
<span class="id">move:</span> (@<span class="id">bindA_derived</span> <span class="id">M</span> <span class="id">join</span> <span class="id">joinA</span>).<br/>
<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">bind_of_join</span> <span class="id">_</span> <span class="id">=</span> @<span class="id">bind</span> <span class="id">M</span>) <span class="id">//</span>.<br/>
<span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">A;</span> <span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">B</span>.<br/>
<span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">m;</span> <span class="id">apply</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">f</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">monad_lemmas</span>.<br/>
<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;'do' x &lt;- m ; e&quot;</span> <span class="id">:=</span> (<span class="id">bind</span> <span class="id">m</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">e</span>)) (<span class="id">only</span> <span class="id">parsing</span>) <span class="id">:</span> <span class="id">do_notation</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;'do' x : T &lt;- m ; e&quot;</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;(<span class="id">bind</span> <span class="id">m</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">:</span> <span class="id">T</span> <span class="id">=&gt;</span> <span class="id">e</span>)) (<span class="id">only</span> <span class="id">parsing</span>) <span class="id">:</span> <span class="id">do_notation</span>.<br/>
<span class="vernacular">Delimit</span> <span class="vernacular">Scope</span> <span class="id">do_notation</span> <span class="gallina-kwd">with</span> <span class="id">Do</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;m &gt;&gt; f&quot;</span> <span class="id">:=</span> (<span class="id">bind</span> <span class="id">m</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">f</span>)) <span class="id">:</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="vernacular">Fixpoint</span> <span class="id">sequence</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">A</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">seq</span> (<span class="id">M</span> <span class="id">A</span>)) <span class="id">:</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">if</span> <span class="id">s</span> <span class="id">isn't</span> <span class="id">h</span> <span class="id">::</span> <span class="id">t</span> <span class="gallina-kwd">then</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="gallina-kwd">else</span><br/>
&nbsp;&nbsp;<span class="id">do</span> <span class="id">v</span> <span class="id">&lt;-</span> <span class="id">h;</span> <span class="id">do</span> <span class="id">vs</span> <span class="id">&lt;-</span> <span class="id">sequence</span> <span class="id">t;</span> <span class="id">Ret</span> (<span class="id">v</span> <span class="id">::</span> <span class="id">vs</span>))%<span class="id">Do</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">sequence_nil</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">sequence</span> <span class="id">[::]</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">[::]</span> <span class="id">:&gt;</span> <span class="id">M</span> (<span class="id">seq</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof31')">Proof.</span></div>
<div class="proofscript" id="proof31">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">sequence_cons</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">A</span> <span class="id">h</span> (<span class="id">t</span> <span class="id">:</span> <span class="id">seq</span> (<span class="id">M</span> <span class="id">A</span>)) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">sequence</span> (<span class="id">h</span> <span class="id">::</span> <span class="id">t</span>) <span class="id">=</span> <span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">h</span> <span class="id">;</span> <span class="id">do</span> <span class="id">vs</span> <span class="id">&lt;-</span> <span class="id">sequence</span> <span class="id">t</span> <span class="id">;</span> <span class="id">Ret</span> (<span class="id">x</span> <span class="id">::</span> <span class="id">vs</span>))%<span class="id">Do</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof32')">Proof.</span></div>
<div class="proofscript" id="proof32">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">skip</span> <span class="id">M</span> <span class="id">:=</span> @<span class="id">ret</span> <span class="id">M</span> <span class="id">_</span> <span class="id">tt</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">skip</span> <span class="id">{M}</span> <span class="id">:</span> <span class="id">simpl</span> <span class="id">never</span>.<br/>
<br/>
<span class="vernacular">Ltac</span> <span class="id">bind_ext</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">congr_ext</span> <span class="id">m</span> <span class="id">:=</span> <span class="id">ltac:</span>(<span class="id">congr</span> (<span class="id">bind</span> <span class="id">m</span>)<span class="id">;</span> <span class="id">apply</span> <span class="id">funext</span>) <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">match</span> <span class="id">goal</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">|-</span> @<span class="id">bind</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">?m</span> <span class="id">?f1</span> <span class="id">=</span> @<span class="id">bind</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">?m</span> <span class="id">?f2</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">congr_ext</span> <span class="id">m</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">|-</span> @<span class="id">bind</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">?m1</span> <span class="id">?f1</span> <span class="id">=</span> @<span class="id">bind</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">?m2</span> <span class="id">?f2</span> <span class="id">=&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">first[</span> <span class="id">simpl</span> <span class="id">m1;</span> <span class="id">congr_ext</span> <span class="id">m1</span> <span class="id">|</span> <span class="id">simpl</span> <span class="id">m2;</span> <span class="id">congr_ext</span> <span class="id">m2</span> <span class="id">]</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">end</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">bindskip</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">bindmskip</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span>) <span class="id">:</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">skip</span> <span class="id">=</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof33')">Proof.</span></div>
<div class="proofscript" id="proof33">
 <span class="id">rewrite</span> <span class="id">-[RHS]bindmret;</span> <span class="id">bind_ext;</span> <span class="gallina-kwd">by</span> <span class="id">case</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bindskipf</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">A</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">skip</span> <span class="id">&gt;&gt;</span> <span class="id">m</span> <span class="id">=</span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof34')">Proof.</span></div>
<div class="proofscript" id="proof34">
 <span class="id">exact:</span> <span class="id">bindretf</span>. Qed.</div>
<span class="vernacular">End</span> <span class="id">bindskip</span>.<br/>
<br/>
<span class="vernacular">Tactic</span> <span class="vernacular">Notation</span> <span class="id">&quot;With&quot; tactic(tac) &quot;Open&quot;</span> <span class="id">ssrpatternarg</span>(<span class="id">pat</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">ssrpattern</span> <span class="id">pat;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">f</span> <span class="id">:=</span> <span class="id">fresh</span> <span class="id">&quot;f&quot;</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">intro</span> <span class="id">f;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">g</span> <span class="id">:=</span> <span class="id">fresh</span> <span class="id">&quot;g&quot;</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">typ</span> <span class="id">:=</span> <span class="id">typeof</span> <span class="id">f</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">let</span> <span class="id">x</span> <span class="id">:=</span> <span class="id">fresh</span> <span class="id">&quot;x&quot;</span> <span class="gallina-kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">evar</span> (<span class="id">g</span> <span class="id">:</span> <span class="id">typ</span>)<span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">_</span> <span class="id">:</span> <span class="id">f</span> <span class="id">=</span> <span class="id">g</span>)<span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">[rewrite</span> <span class="id">{}/f</span> <span class="id">{}/g|</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">{}/g</span> <span class="id">{}/f;</span> <span class="id">tac];</span> <span class="id">last</span> <span class="id">first</span>.<br/>
<br/>
<span class="vernacular">Tactic</span> <span class="vernacular">Notation</span> <span class="id">&quot;Open&quot;</span> <span class="id">ssrpatternarg</span>(<span class="id">pat</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">With</span> (<span class="id">idtac</span>) <span class="vernacular">Open</span> <span class="id">pat</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">fmap_and_join</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bind_fmap</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">fmap</span> <span class="id">f</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">g</span> <span class="id">=</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="id">g</span> <span class="id">\o</span> <span class="id">f</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof35')">Proof.</span></div>
<div class="proofscript" id="proof35">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindA;</span> <span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">bindretf</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fmap_if</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">b</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">a</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">fmap</span> <span class="id">f</span> (<span class="gallina-kwd">if</span> <span class="id">b</span> <span class="gallina-kwd">then</span> <span class="id">m</span> <span class="gallina-kwd">else</span> <span class="id">Ret</span> <span class="id">a</span>) <span class="id">=</span> <span class="gallina-kwd">if</span> <span class="id">b</span> <span class="gallina-kwd">then</span> <span class="id">fmap</span> <span class="id">f</span> <span class="id">m</span> <span class="gallina-kwd">else</span> <span class="id">Ret</span> (<span class="id">f</span> <span class="id">a</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof36')">Proof.</span></div>
<div class="proofscript" id="proof36">
 <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">Hb</span> <span class="id">//;</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmapE</span> <span class="id">bindretf</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">fmap_bind</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) <span class="id">m</span> (<span class="id">g</span> <span class="id">:</span> <span class="id">C</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">fmap</span> <span class="id">f</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">g</span>) <span class="id">=</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="id">f</span> (<span class="id">o</span>) <span class="id">g</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof37')">Proof.</span></div>
<div class="proofscript" id="proof37">
<span class="id">rewrite</span> <span class="id">fcomp_def</span> <span class="id">fmapE</span> <span class="id">bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">c</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">compE</span> <span class="id">-/</span>(<span class="id">fmap</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">fmapE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">skip_fmap</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">mb</span> <span class="id">:</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">ma</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">mb</span> <span class="id">&gt;&gt;</span> (<span class="id">fmap</span> <span class="id">f</span> <span class="id">ma</span>) <span class="id">=</span> <span class="id">fmap</span> <span class="id">f</span> (<span class="id">mb</span> <span class="id">&gt;&gt;</span> <span class="id">ma</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof38')">Proof.</span></div>
<div class="proofscript" id="proof38">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">fmap_bind</span> <span class="id">fcomp_def</span>. Qed.</div>
<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">joinE</span> <span class="id">A</span> (<span class="id">pp</span> <span class="id">:</span> <span class="id">M</span> (<span class="id">M</span> <span class="id">A</span>)) <span class="id">:</span> <span class="id">Join</span> <span class="id">pp</span> <span class="id">=</span> <span class="id">pp</span> <span class="id">&gt;&gt;=</span> <span class="id">id</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof39')">Proof.</span></div>
<div class="proofscript" id="proof39">
 <span class="id">rewrite</span> <span class="id">bindE;</span> <span class="id">congr</span> <span class="id">Join;</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">functor_id</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">join_fmap</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">Join</span> (<span class="id">fmap</span> <span class="id">f</span> <span class="id">m</span>) <span class="id">=</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof40')">Proof.</span></div>
<div class="proofscript" id="proof40">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindE</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">fmap_and_join</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">kleisli</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">monad</span>.<br/>
<span class="vernacular">Implicit</span> <span class="id">Types</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">D</span> <span class="id">:</span> <span class="id">UU0</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">kleisli</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) (<span class="id">n</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">Join</span> <span class="id">\o</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">m</span>) <span class="id">\o</span> <span class="id">n</span>.<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">&quot;m &lt;=&lt; n&quot;</span> <span class="id">:=</span> (<span class="id">kleisli</span> <span class="id">m</span> <span class="id">n</span>).<br/>
<span class="vernacular">Local</span> <span class="vernacular">Notation</span> <span class="id">&quot;m &gt;=&gt; n&quot;</span> <span class="id">:=</span> (<span class="id">kleisli</span> <span class="id">n</span> <span class="id">m</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">kleisli_def</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> (<span class="id">g</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">&gt;=&gt;</span> <span class="id">g</span>) <span class="id">=</span> <span class="id">Join</span> <span class="id">\o</span> (<span class="id">M</span> <span class="id">#</span> <span class="id">g</span>) <span class="id">\o</span> <span class="id">f</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof41')">Proof.</span></div>
<div class="proofscript" id="proof41">
 <span class="gallina-kwd">by</span> <span class="id">[]</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">kleisliE</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> (<span class="id">g</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;(<span class="id">f</span> <span class="id">&gt;=&gt;</span> <span class="id">g</span>) <span class="id">a</span> <span class="id">=</span> (<span class="id">f</span> <span class="id">a</span>) <span class="id">&gt;&gt;=</span> <span class="id">g</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof42')">Proof.</span></div>
<div class="proofscript" id="proof42">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/kleisli</span> <span class="id">/=</span> <span class="id">join_fmap</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">bind_kleisli</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">m</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="id">f</span> <span class="id">&gt;=&gt;</span> <span class="id">g</span>) <span class="id">=</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">&gt;&gt;=</span> <span class="id">g</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof43')">Proof.</span></div>
<div class="proofscript" id="proof43">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindA;</span> <span class="id">bind_ext</span> <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">rewrite</span> <span class="id">/kleisli</span> <span class="id">!compE</span> <span class="id">join_fmap</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">ret_kleisli</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span> <span class="id">Ret</span> <span class="id">&gt;=&gt;</span> <span class="id">k</span> <span class="id">=</span> <span class="id">k</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof44')">Proof.</span></div>
<div class="proofscript" id="proof44">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/kleisli</span> <span class="id">-compA</span> (<span class="id">natural</span> <span class="id">ret</span>) <span class="id">FIdE</span> <span class="id">compA</span> <span class="id">joinretM</span>. Qed.</div>
<br/>
<span class="vernacular">Local</span> <span class="vernacular">Open</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<span class="vernacular">Lemma</span> <span class="id">fcomp_kleisli</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">D</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">C</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">h</span> <span class="id">:</span> <span class="id">D</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">f</span> (<span class="id">o</span>) (<span class="id">g</span> <span class="id">&lt;=&lt;</span> <span class="id">h</span>) <span class="id">=</span> (<span class="id">f</span> (<span class="id">o</span>) <span class="id">g</span>) <span class="id">&lt;=&lt;</span> <span class="id">h</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof45')">Proof.</span></div>
<div class="proofscript" id="proof45">
<span class="id">rewrite</span> <span class="id">/kleisli</span> <span class="id">2!fcomp_def</span> <span class="id">2!</span>(<span class="id">compA</span> (<span class="id">fmap</span> <span class="id">f</span>)) <span class="id">natural</span> <span class="id">[in</span> <span class="id">RHS]functor_o</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">-compA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">kleisli_fcomp</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">A</span>) (<span class="id">h</span> <span class="id">:</span> <span class="id">C</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;((<span class="id">f</span> <span class="id">\o</span> <span class="id">g</span>) <span class="id">&lt;=&lt;</span> <span class="id">h</span>) <span class="id">=</span> <span class="id">f</span> <span class="id">&lt;=&lt;</span> (<span class="id">g</span> (<span class="id">o</span>) <span class="id">h</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof46')">Proof.</span></div>
<div class="proofscript" id="proof46">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/kleisli</span> <span class="id">fcomp_def</span> <span class="id">functor_o</span> <span class="id">2!compA</span>. Qed.</div>
<span class="vernacular">Local</span> <span class="vernacular">Close</span> <span class="vernacular">Scope</span> <span class="id">mprog</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">kleisliA</span> <span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">D</span> (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) (<span class="id">g</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>) (<span class="id">h</span> <span class="id">:</span> <span class="id">C</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">D</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">f</span> <span class="id">&gt;=&gt;</span> <span class="id">g</span> <span class="id">&gt;=&gt;</span> <span class="id">h</span> <span class="id">=</span> <span class="id">f</span> <span class="id">&gt;=&gt;</span> (<span class="id">g</span> <span class="id">&gt;=&gt;</span> <span class="id">h</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof47')">Proof.</span></div>
<div class="proofscript" id="proof47">
<span class="id">apply:</span> <span class="id">funext_dep</span> <span class="id">=&gt;</span> <span class="id">a;</span> <span class="id">rewrite</span> <span class="id">!kleisliE</span> <span class="id">bindA</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">under</span> <span class="id">[in</span> <span class="id">RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">kleisliE</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">kleisli</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;m &lt;=&lt; n&quot;</span> <span class="id">:=</span> (<span class="id">kleisli</span> <span class="id">m</span> <span class="id">n</span>) <span class="id">:</span> <span class="id">monae_scope</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;m &gt;=&gt; n&quot;</span> <span class="id">:=</span> (<span class="id">kleisli</span> <span class="id">n</span> <span class="id">m</span>) <span class="id">:</span> <span class="id">monae_scope</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadFail</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">Monad</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">fail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">M</span> <span class="id">A;</span><br/>
&nbsp;&nbsp;<span class="id">bindfailf</span> <span class="id">:</span> <span class="id">BindLaws.left_zero</span> (@<span class="id">bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span>) <span class="id">fail</span><br/>
 <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=failMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadFail</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadFail</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="vernacular">Arguments</span> <span class="id">bindfailf</span> <span class="id">[_]</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">fail</span> <span class="id">{_}</span> <span class="id">{_}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">guard_assert</span>.<br/>
<span class="vernacular">Variable</span> <span class="id">M</span> <span class="id">:</span> <span class="id">failMonad</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">guard</span> (<span class="id">b</span> <span class="id">:</span> <span class="id">bool</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">:=</span> <span class="id">locked</span> (<span class="gallina-kwd">if</span> <span class="id">b</span> <span class="gallina-kwd">then</span> <span class="id">skip</span> <span class="gallina-kwd">else</span> <span class="id">fail</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">guardPn</span> (<span class="id">b</span> <span class="id">:</span> <span class="id">bool</span>) <span class="id">:</span> <span class="id">if_spec</span> <span class="id">b</span> <span class="id">skip</span> <span class="id">fail</span> (<span class="id">~~</span> <span class="id">b</span>) <span class="id">b</span> (<span class="id">guard</span> <span class="id">b</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof48')">Proof.</span></div>
<div class="proofscript" id="proof48">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/guard;</span> <span class="id">unlock;</span> <span class="id">case:</span> <span class="id">ifPn</span> <span class="id">=&gt;</span> <span class="id">?;</span> <span class="id">constructor</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">guardT</span> <span class="id">:</span> <span class="id">guard</span> <span class="id">true</span> <span class="id">=</span> <span class="id">skip</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof49')">Proof.</span></div>
<div class="proofscript" id="proof49">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/guard;</span> <span class="id">unlock</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">guardF</span> <span class="id">:</span> <span class="id">guard</span> <span class="id">false</span> <span class="id">=</span> <span class="id">fail</span><br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof50')">Proof.</span></div>
<div class="proofscript" id="proof50">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/guard;</span> <span class="id">unlock</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">guard_and</span> <span class="id">a</span> <span class="id">b</span> <span class="id">:</span> <span class="id">guard</span> (<span class="id">a</span> &amp;&amp; <span class="id">b</span>) <span class="id">=</span> <span class="id">guard</span> <span class="id">a</span> <span class="id">&gt;&gt;</span> <span class="id">guard</span> <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof51')">Proof.</span></div>
<div class="proofscript" id="proof51">
<span class="id">move:</span> <span class="id">a</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">-[|]</span> <span class="id">b</span> <span class="id">/=;</span> <span class="gallina-kwd">by</span> <span class="id">[rewrite</span> <span class="id">guardT</span> <span class="id">bindskipf</span> <span class="id">|</span> <span class="id">rewrite</span> <span class="id">guardF</span> <span class="id">bindfailf]</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">assert</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">locked</span> (<span class="id">guard</span> (<span class="id">p</span> <span class="id">a</span>) <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">a</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">assertE</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">assert</span> <span class="id">p</span> <span class="id">a</span> <span class="id">=</span> <span class="id">guard</span> (<span class="id">p</span> <span class="id">a</span>) <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">a</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof52')">Proof.</span></div>
<div class="proofscript" id="proof52">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">/assert;</span> <span class="id">unlock</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">assertT</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">assert</span> <span class="id">xpredT</span> <span class="id">a</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">a</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof53')">Proof.</span></div>
<div class="proofscript" id="proof53">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">assertE</span> <span class="id">guardT</span> <span class="id">bindskipf</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">assertF</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">assert</span> <span class="id">xpred0</span> <span class="id">a</span> <span class="id">=</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof54')">Proof.</span></div>
<div class="proofscript" id="proof54">
 <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">assertE</span> <span class="id">guardF</span> <span class="id">bindfailf</span>. Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">assertPn</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">if_spec</span> (<span class="id">p</span> <span class="id">a</span>) (<span class="id">Ret</span> <span class="id">a</span>) <span class="id">fail</span> (<span class="id">~~</span> (<span class="id">p</span> <span class="id">a</span>)) (<span class="id">p</span> <span class="id">a</span>) (<span class="id">assert</span> <span class="id">p</span> <span class="id">a</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof55')">Proof.</span></div>
<div class="proofscript" id="proof55">
<span class="id">rewrite</span> <span class="id">assertE;</span> <span class="id">case:</span> <span class="id">guardPn</span> <span class="id">=&gt;</span> <span class="id">pa;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">[rewrite</span> <span class="id">bindskipf;</span> <span class="id">constructor</span> <span class="id">|</span> <span class="id">rewrite</span> <span class="id">bindfailf;</span> <span class="id">constructor]</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Definition</span> <span class="id">bassert</span> <span class="id">{A</span> <span class="id">:</span> <span class="id">UU0}</span> (<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> <span class="id">A</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">:</span> <span class="id">M</span> <span class="id">A</span> <span class="id">:=</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">assert</span> <span class="id">p</span>.<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">commutativity_of_assertions</span> <span class="id">A</span> <span class="id">q</span> <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">Join</span> <span class="id">\o</span> (<span class="id">M</span> <span class="id">#</span> (<span class="id">bassert</span> <span class="id">q</span>)) <span class="id">=</span> <span class="id">bassert</span> <span class="id">q</span> <span class="id">\o</span> <span class="id">Join</span> <span class="id">:&gt;</span> (<span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof56')">Proof.</span></div>
<div class="proofscript" id="proof56">
<span class="gallina-kwd">by</span> <span class="id">apply</span> <span class="id">funext</span> <span class="id">=&gt;</span> <span class="id">x;</span> <span class="id">rewrite</span> <span class="id">!compE</span> <span class="id">join_fmap</span> <span class="id">/bassert</span> <span class="id">joinE</span> <span class="id">bindA</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">guardsC</span> (<span class="id">HM</span> <span class="id">:</span> <span class="id">BindLaws.right_zero</span> (@<span class="id">bind</span> <span class="id">M</span>) (@<span class="id">fail</span> <span class="id">_</span>)) <span class="id">b</span> <span class="id">B</span> (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">:</span><br/>
&nbsp;&nbsp;<span class="id">guard</span> <span class="id">b</span> <span class="id">&gt;&gt;</span> <span class="id">m</span> <span class="id">=</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">assert</span> (<span class="id">fun=&gt;</span> <span class="id">b</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof57')">Proof.</span></div>
<div class="proofscript" id="proof57">
<span class="id">case:</span> <span class="id">guardPn</span> <span class="id">=&gt;</span> <span class="id">Hb</span>.<br/>
<span class="id">-</span> <span class="id">rewrite</span> <span class="id">bindskipf</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span> <span class="id">eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">assertT</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindmret</span>.<br/>
<span class="id">-</span> <span class="id">under</span> <span class="id">[RHS]eq_bind</span> <span class="id">do</span> <span class="id">rewrite</span> <span class="id">assertF</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">bindfailf</span> <span class="id">HM</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">guard_assert</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">assert</span> <span class="id">{M}</span> <span class="id">{A}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">guard</span> <span class="id">{M}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadAlt</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">Monad</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">alt</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">M</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">T</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">altA</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">associative</span> (@<span class="id">alt</span> <span class="id">T</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">alt_bindDl</span> <span class="id">:</span> <span class="id">BindLaws.left_distributive</span> (@<span class="id">bind</span> <span class="id">M</span>) <span class="id">alt</span><br/>
 <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=altMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadAlt</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadAlt</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;a [~] b&quot;</span> <span class="id">:=</span> (@<span class="id">alt</span> <span class="id">_</span> <span class="id">_</span> <span class="id">a</span> <span class="id">b</span>). <br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadAltCI</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">MonadAlt</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">altmm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">idempotent</span> (@<span class="id">alt</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">altC</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">commutative</span> (@<span class="id">alt</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=altCIMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadAltCI</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadAltCI</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="vernacular">Arguments</span> <span class="id">altC</span> <span class="id">{_}</span> <span class="id">{_}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">altmm</span> <span class="id">{_}</span> <span class="id">{_}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">altci_lemmas</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">altCIMonad</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">altCA</span> <span class="id">A</span> <span class="id">:</span> @<span class="id">left_commutative</span> (<span class="id">M</span> <span class="id">A</span>) (<span class="id">M</span> <span class="id">A</span>) (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">[~]</span> <span class="id">y</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof58')">Proof.</span></div>
<div class="proofscript" id="proof58">
 <span class="gallina-kwd">by</span> <span class="id">move=&gt;</span> <span class="id">x</span> <span class="id">y</span> <span class="id">z;</span> <span class="id">rewrite</span> <span class="id">altA</span> <span class="id">altC</span> <span class="id">altA</span> <span class="id">altC</span> (<span class="id">altC</span> <span class="id">x</span>). Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">altAC</span> <span class="id">A</span> <span class="id">:</span> @<span class="id">right_commutative</span> (<span class="id">M</span> <span class="id">A</span>) (<span class="id">M</span> <span class="id">A</span>) (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">[~]</span> <span class="id">y</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof59')">Proof.</span></div>
<div class="proofscript" id="proof59">
 <span class="id">move=&gt;</span> <span class="id">x</span> <span class="id">y</span> <span class="id">z;</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">altC</span> <span class="id">altA</span> (<span class="id">altC</span> <span class="id">x</span>). Qed.</div>
<br/>
<span class="vernacular">Lemma</span> <span class="id">altACA</span> <span class="id">A</span> <span class="id">:</span> @<span class="id">interchange</span> (<span class="id">M</span> <span class="id">A</span>) (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">[~]</span> <span class="id">y</span>) (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">y</span> <span class="id">=&gt;</span> <span class="id">x</span> <span class="id">[~]</span> <span class="id">y</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof60')">Proof.</span></div>
<div class="proofscript" id="proof60">
 <span class="id">move=&gt;</span> <span class="id">x</span> <span class="id">y</span> <span class="id">z</span> <span class="id">t;</span> <span class="id">rewrite</span> <span class="id">!altA;</span> <span class="id">congr</span> (<span class="id">_</span> <span class="id">[~]</span> <span class="id">_</span>)<span class="id">;</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">altAC</span>. Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">altci_lemmas</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadNondet</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">MonadFail</span> <span class="id">M</span> &amp; <span class="id">MonadAlt</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">altfailm</span> <span class="id">:</span> @<span class="id">BindLaws.left_id</span> <span class="id">M</span> (@<span class="id">fail</span> <span class="id">M</span>) (@<span class="id">alt</span> <span class="id">M</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">altmfail</span> <span class="id">:</span> @<span class="id">BindLaws.right_id</span> <span class="id">M</span> (@<span class="id">fail</span> <span class="id">M</span>) (@<span class="id">alt</span> <span class="id">M</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=nondetMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadNondet</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadNondet</span> <span class="id">M</span> &amp; <span class="id">MonadFail</span> <span class="id">M</span> &amp; <span class="id">MonadAlt</span> <span class="id">M}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=nondetCIMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadCINondet</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">MonadAltCI</span> <span class="id">M</span> &amp; <span class="id">MonadNondet</span> <span class="id">M}</span>.<br/>
<br/>
<span class="vernacular">Section</span> <span class="id">nondet_big</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">nondetMonad</span>) (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>).<br/>
<span class="vernacular">Canonical</span> <span class="id">alt_monoid</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">Monoid.Law</span> (@<span class="id">altA</span> <span class="id">M</span> <span class="id">A</span>) (@<span class="id">altfailm</span> <span class="id">_</span> <span class="id">_</span>) (@<span class="id">altmfail</span> <span class="id">_</span> <span class="id">_</span>).<br/>
<br/>
<span class="vernacular">Lemma</span> <span class="id">test_bigop</span> <span class="id">n</span> <span class="id">:</span> <span class="id">\big[</span>(@<span class="id">alt</span> <span class="id">_</span> <span class="id">_</span>)<span class="id">/fail]_</span>(<span class="id">i</span> <span class="id">&lt;</span> <span class="id">n</span>) (<span class="id">fail</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">=</span> <span class="id">fail</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof61')">Proof.</span></div>
<div class="proofscript" id="proof61">
<span class="id">elim:</span> <span class="id">n</span> <span class="id">=&gt;</span> <span class="id">[|n</span> <span class="id">IH];</span> <span class="id">first</span> <span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">big_ord0</span>.<br/>
<span class="gallina-kwd">by</span> <span class="id">rewrite</span> <span class="id">big_ord_recr</span> <span class="id">/=</span> <span class="id">IH</span> <span class="id">altmfail</span>.<br/>
Qed.</div>
<br/>
<span class="vernacular">End</span> <span class="id">nondet_big</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadFailR0</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">MonadFail</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;<span class="id">{</span> <span class="id">bindmfail</span> <span class="id">:</span> <span class="id">BindLaws.right_zero</span> (@<span class="id">bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span>) (@<span class="id">fail</span> <span class="id">_</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=failR0Monad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadFailR0</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadFailR0</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadPrePlus</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">of</span> <span class="id">MonadNondet</span> <span class="id">M</span> &amp; <span class="id">MonadFailR0</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">alt_bindDr</span> <span class="id">:</span> <span class="id">BindLaws.right_distributive</span> (@<span class="id">bind</span> <span class="id">M</span>) <span class="id">alt</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=prePlusMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadPrePlus</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadPrePlus</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=plusMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadPlus</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">MonadCINondet</span> <span class="id">M</span> &amp; <span class="id">MonadPrePlus</span> <span class="id">M}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadExcept</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">MonadFail</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">catch</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">catchmfail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">right_id</span> <span class="id">fail</span> (@<span class="id">catch</span> <span class="id">A</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">catchfailm</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">left_id</span> <span class="id">fail</span> (@<span class="id">catch</span> <span class="id">A</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">catchA</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A,</span> <span class="id">associative</span> (@<span class="id">catch</span> <span class="id">A</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">catchret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">x,</span> @<span class="id">left_zero</span> (<span class="id">M</span> <span class="id">A</span>) (<span class="id">M</span> <span class="id">A</span>) (<span class="id">Ret</span> <span class="id">x</span>) (@<span class="id">catch</span> <span class="id">A</span>)<br/>
 <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=exceptMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadExcept</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadExcept</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="vernacular">Arguments</span> <span class="id">catch</span> <span class="id">{_}</span> <span class="id">{_}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadContinuation</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">Monad</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">callcc</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0,</span> ((<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A;</span><br/>
&nbsp;&nbsp;<span class="id">callcc0</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">g</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">g</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>)) <span class="id">=</span> @<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> <span class="id">g</span><br/>
<span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">callcc1</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">B</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">=&gt;</span> <span class="id">m</span>) <span class="id">=</span> <span class="id">m</span><br/>
<span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">callcc2</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">C</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">x</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">C</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">a</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">x</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">b</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">a</span> <span class="id">b</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">=</span> @<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">x</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">callcc3</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) <span class="id">b,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">f</span> <span class="id">b</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">callcc</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">:</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">b</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=contMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadContinuation</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadContinuation</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">callcc</span> <span class="id">{_}</span> <span class="id">{_}</span> <span class="id">{_}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadShiftReset</span> (<span class="id">U</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">of</span> <span class="id">MonadContinuation</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">shift</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> ((<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">U</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">U</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">reset</span> <span class="id">:</span> <span class="id">M</span> <span class="id">U</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">U</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">shiftreset0</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k</span> <span class="id">=&gt;</span> <span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span>) <span class="id">=</span> <span class="id">m</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">shiftreset1</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">h</span> <span class="id">:</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span> <span class="id">callcc</span> <span class="id">h</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k'</span> <span class="id">=&gt;</span> <span class="id">h</span> (<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">k''</span> <span class="id">=&gt;</span> <span class="id">k'</span> <span class="id">x</span>)) <span class="id">&gt;&gt;=</span> <span class="id">k'</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">shiftreset2</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">c</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">c':</span> <span class="id">U</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">U</span> <span class="id">-&gt;</span> <span class="id">_</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">reset</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">c;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">Ret</span> <span class="id">c'</span>)<span class="id">;</span> <span class="id">k</span> <span class="id">x</span> <span class="id">y</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> <span class="id">c</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">c'</span>)%<span class="id">Do</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">shiftreset3</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">c</span> <span class="id">c'</span> <span class="id">:</span> <span class="id">U</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">U</span> <span class="id">-&gt;</span> <span class="id">U</span> <span class="id">-&gt;</span> <span class="id">_</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">reset</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">c;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">do</span> <span class="id">v</span> <span class="id">&lt;-</span> <span class="id">f</span> <span class="id">c';</span> <span class="id">f</span> <span class="id">v</span>)<span class="id">;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">k</span> <span class="id">x</span> <span class="id">y</span>)) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reset</span> (<span class="id">do</span> <span class="id">x</span> <span class="id">&lt;-</span> <span class="id">Ret</span> <span class="id">c;</span> <span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> @<span class="id">shift</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">f</span> <span class="id">=&gt;</span> <span class="id">f</span> <span class="id">c'</span>)<span class="id">;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ret</span> (<span class="id">k</span> <span class="id">x</span> (<span class="id">k</span> <span class="id">x</span> <span class="id">y</span>))))%<span class="id">Do</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">shiftreset4</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">c</span> <span class="id">:</span> <span class="id">U</span>) <span class="id">k,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">reset</span> (<span class="id">do</span> <span class="id">y</span> <span class="id">&lt;-</span> @<span class="id">shift</span> <span class="id">_</span> (@<span class="id">^~</span> <span class="id">c</span>)<span class="id">;</span> <span class="id">Ret</span> (<span class="id">k</span> <span class="id">y</span>)) <span class="id">=</span> <span class="id">Ret</span> (<span class="id">k</span> <span class="id">c</span>))%<span class="id">Do</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=shiftresetMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadShiftReset</span> <span class="id">U</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadShiftReset</span> <span class="id">U</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">shift</span> <span class="id">{_}</span> <span class="id">{_}</span> <span class="id">{_}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadJump</span> (<span class="id">ref</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">Monad</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">jump</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">ref</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B;</span><br/>
&nbsp;&nbsp;<span class="id">sub</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0,</span> (<span class="id">ref</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> (<span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B;</span><br/>
&nbsp;&nbsp;<span class="id">jump0</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">k</span> <span class="id">x,</span> @<span class="id">sub</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">r</span> <span class="id">=&gt;</span> @<span class="id">jump</span> <span class="id">A</span> <span class="id">B</span> <span class="id">r</span> <span class="id">x</span>) <span class="id">k</span> <span class="id">=</span> <span class="id">k</span> <span class="id">x</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">jump1</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">p</span> <span class="id">k,</span> @<span class="id">sub</span> <span class="id">A</span> <span class="id">B</span> (<span class="gallina-kwd">fun</span> <span class="id">_</span> <span class="id">=&gt;</span> <span class="id">p</span>) <span class="id">k</span> <span class="id">=</span> <span class="id">p;</span><br/>
&nbsp;&nbsp;<span class="id">jump2</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">p</span> <span class="id">r',</span> @<span class="id">sub</span> <span class="id">_</span> <span class="id">_</span> <span class="id">p</span> (@<span class="id">jump</span> <span class="id">A</span> <span class="id">B</span> <span class="id">r'</span>) <span class="id">=</span> <span class="id">p</span> <span class="id">r';</span><br/>
&nbsp;&nbsp;<span class="id">jump3</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">p</span> <span class="id">:</span> <span class="id">ref</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">ref</span> <span class="id">B</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) (<span class="id">k1</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">k2,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">sub</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">r1</span> <span class="id">:</span> <span class="id">ref</span> <span class="id">A</span> <span class="id">=&gt;</span> @<span class="id">sub</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">r2</span> <span class="id">=&gt;</span> <span class="id">p</span> <span class="id">r1</span> <span class="id">r2</span>) (<span class="id">k2</span> <span class="id">r1</span>)) <span class="id">k1</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">sub</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">r2</span> <span class="id">:</span> <span class="id">ref</span> <span class="id">B</span> <span class="id">=&gt;</span> @<span class="id">sub</span> <span class="id">_</span> <span class="id">_</span> (<span class="gallina-kwd">fun</span> <span class="id">r1</span> <span class="id">=&gt;</span> <span class="id">p</span> <span class="id">r1</span> <span class="id">r2</span>) <span class="id">k1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> @<span class="id">sub</span> <span class="id">_</span> <span class="id">_</span> (<span class="id">k2^~</span> <span class="id">x</span>) <span class="id">k1</span>)<br/>
<span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">jump4</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">r</span> <span class="id">x</span> <span class="id">k,</span> (@<span class="id">jump</span> <span class="id">A</span> <span class="id">B</span> <span class="id">r</span> <span class="id">x</span>) <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span> @<span class="id">jump</span> <span class="id">A</span> <span class="id">B</span> <span class="id">r</span> <span class="id">x;</span><br/>
&nbsp;&nbsp;<span class="id">jump5</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">p</span> <span class="id">q</span> <span class="id">k,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">sub</span> <span class="id">A</span> <span class="id">B</span> <span class="id">p</span> <span class="id">q</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span> @<span class="id">sub</span> <span class="id">A</span> <span class="id">B</span> (<span class="id">p</span> <span class="id">&gt;=&gt;</span> <span class="id">k</span>) (<span class="id">q</span> <span class="id">&gt;=&gt;</span> <span class="id">k</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=jumpMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadJump</span> <span class="id">ref</span> <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadJump</span> <span class="id">ref</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">Jump</span> <span class="id">ref</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">jumpMonad</span> <span class="id">ref</span>) <span class="id">:=</span> @<span class="id">jump</span> <span class="id">ref</span> <span class="id">M</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">Jump</span> <span class="id">{_}</span> <span class="id">{_}</span> <span class="id">{_}</span> <span class="id">{_}</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">Sub</span> <span class="id">ref</span> (<span class="id">M</span> <span class="id">:</span> <span class="id">jumpMonad</span> <span class="id">ref</span>) <span class="id">:=</span> @<span class="id">sub</span> <span class="id">ref</span> <span class="id">M</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">sub</span> <span class="id">{_}</span> <span class="id">{_}</span> <span class="id">{_}</span> <span class="id">{_}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadState</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">Monad</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">get</span> <span class="id">:</span> <span class="id">M</span> <span class="id">S</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">put</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">putput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">s',</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">put</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">put</span> <span class="id">s'</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">putget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s,</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">get</span> <span class="id">=</span> <span class="id">put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">s</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">getputskip</span> <span class="id">:</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="id">put</span> <span class="id">=</span> <span class="id">skip</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">getget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">get</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=stateMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadState</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">{</span> <span class="id">M</span> <span class="id">of</span> <span class="id">isMonadState</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=failStateMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadFailState</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">M</span> <span class="id">of</span> <span class="id">isMonadFail</span> <span class="id">M</span> &amp; <span class="id">isMonadState</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">isMonad</span> <span class="id">M</span> &amp; <span class="id">isFunctor</span> <span class="id">M</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=failR0StateMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadFailR0State</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">M</span> <span class="id">of</span> <span class="id">isMonadFailR0</span> <span class="id">M</span> &amp; <span class="id">isMonadState</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">isMonadFail</span> <span class="id">M</span> &amp; <span class="id">isMonad</span> <span class="id">M</span> &amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">isFunctor</span> <span class="id">M</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=nondetStateMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadNondetState</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">M</span> <span class="id">of</span> <span class="id">MonadPrePlus</span> <span class="id">M</span> &amp; <span class="id">MonadState</span> <span class="id">S</span> <span class="id">M</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadStateRun</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>)<br/>
&nbsp;&nbsp;&nbsp;(<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">MonadState</span> <span class="id">S</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">runStateT</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">N</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)%<span class="id">type</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">runStateTret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">runStateT</span> <span class="id">_</span> (<span class="id">Ret</span> <span class="id">a</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">a,</span> <span class="id">s</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">runStateTbind</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">runStateT</span> <span class="id">_</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">s</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">runStateT</span> <span class="id">_</span> <span class="id">m</span> <span class="id">s</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">x</span> <span class="id">=&gt;</span> @<span class="id">runStateT</span> <span class="id">_</span> (<span class="id">f</span> <span class="id">x</span>.<span class="id">1</span>) <span class="id">x</span>.<span class="id">2</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">runStateTget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">:</span> <span class="id">S,</span> @<span class="id">runStateT</span> <span class="id">_</span> <span class="id">get</span> <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">s,</span> <span class="id">s</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">runStateTput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s'</span> <span class="id">s</span> <span class="id">:</span> <span class="id">S,</span> @<span class="id">runStateT</span> <span class="id">_</span> (<span class="id">put</span> <span class="id">s'</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Ret</span> (<span class="id">tt,</span> <span class="id">s'</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=stateRunMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadStateRun</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">N</span> <span class="id">:</span> <span class="id">monad</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadStateRun</span> <span class="id">S</span> <span class="id">N</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="vernacular">Arguments</span> <span class="id">runStateT</span> <span class="id">{_}</span> <span class="id">{_}</span> <span class="id">{_}</span> <span class="id">{_}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadExceptStateRun</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">N</span> <span class="id">:</span> <span class="id">exceptMonad</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">of</span> <span class="id">MonadStateRun</span> <span class="id">S</span> <span class="id">N</span> <span class="id">M</span> &amp; <span class="id">MonadExcept</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">Mixin</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">runStateTfail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">runStateT</span> (@<span class="id">fail</span> <span class="id">[the</span> <span class="id">exceptMonad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">A</span>) <span class="id">s</span> <span class="id">=</span> @<span class="id">fail</span> <span class="id">N</span> <span class="id">_</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">runStateTcatch</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>) (<span class="id">m1</span> <span class="id">m2</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">runStateT</span> (@<span class="id">catch</span> <span class="id">[the</span> <span class="id">exceptMonad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">_</span> <span class="id">m1</span> <span class="id">m2</span>) <span class="id">s</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">catch</span> <span class="id">N</span> <span class="id">_</span> (<span class="id">runStateT</span> <span class="id">m1</span> <span class="id">s</span>) (<span class="id">runStateT</span> <span class="id">m2</span> <span class="id">s</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=exceptStateRunMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadExceptStateRun</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">N</span> <span class="id">:</span> <span class="id">exceptMonad</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadExceptStateRun</span> <span class="id">S</span> <span class="id">N</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadReify</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">Monad</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">reify</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">A</span> <span class="id">:</span> <span class="id">UU0,</span> <span class="id">M</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">option</span> (<span class="id">A</span> <span class="id">*</span> <span class="id">S</span>)%<span class="id">type</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">reifyret</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">a</span> <span class="id">:</span> <span class="id">A</span>) <span class="id">s,</span> @<span class="id">reify</span> <span class="id">_</span> (<span class="id">Ret</span> <span class="id">a</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Some</span> (<span class="id">a,</span> <span class="id">s</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">reifybind</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">B</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">m</span> <span class="id">:</span> <span class="id">M</span> <span class="id">A</span>) (<span class="id">f</span> <span class="id">:</span> <span class="id">A</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">B</span>) <span class="id">s,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">reify</span> <span class="id">_</span> (<span class="id">m</span> <span class="id">&gt;&gt;=</span> <span class="id">f</span>) <span class="id">s</span> <span class="id">=</span> <span class="gallina-kwd">match</span> @<span class="id">reify</span> <span class="id">_</span> <span class="id">m</span> <span class="id">s</span> <span class="gallina-kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">Some</span> <span class="id">a's'</span> <span class="id">=&gt;</span> @<span class="id">reify</span> <span class="id">_</span> (<span class="id">f</span> <span class="id">a's'</span>.<span class="id">1</span>) <span class="id">a's'</span>.<span class="id">2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">|</span> <span class="id">None</span> <span class="id">=&gt;</span> <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">end</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=reifyMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadReify</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadReify</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<span class="vernacular">Arguments</span> <span class="id">reify</span> <span class="id">{_}</span> <span class="id">{_}</span> <span class="id">{_}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadStateReify</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">of</span> <span class="id">MonadReify</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">MonadState</span> <span class="id">S</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">reifyget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s,</span> <span class="id">reify</span> (@<span class="id">get</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateMonad</span> <span class="id">S</span> <span class="id">of</span> <span class="id">M]</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Some</span> (<span class="id">s,</span> <span class="id">s</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">reifyput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">s',</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reify</span> (@<span class="id">put</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateMonad</span> <span class="id">S</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">s'</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">Some</span> (<span class="id">tt,</span> <span class="id">s'</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=stateReifyMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadStateReify</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadStateReify</span> <span class="id">S</span> <span class="id">M</span> &amp;<span class="id">}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadFailReify</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">of</span> <span class="id">MonadReify</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">MonadFail</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">reifyfail</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">S'</span> (<span class="id">s</span> <span class="id">:</span> <span class="id">S</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reify</span> (@<span class="id">fail</span> <span class="id">[the</span> <span class="id">failMonad</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">S'</span>) <span class="id">s</span> <span class="id">=</span> <span class="id">None</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=failReifyMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadFailReify</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadFailReify</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=failFailR0ReifyMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadFailFailR0Reify</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{M</span> <span class="id">of</span> <span class="id">MonadFailReify</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">MonadFailR0</span> <span class="id">M}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=failStateReifyMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadFailStateReify</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{M</span> <span class="id">of</span> <span class="id">MonadStateReify</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">MonadFailFailR0Reify</span> <span class="id">S</span> <span class="id">M}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadStateLoop</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">of</span> <span class="id">MonadState</span> <span class="id">S</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">foreach</span> <span class="id">:</span> <span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">nat</span> <span class="id">-&gt;</span> (<span class="id">nat</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span>) <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">loop0</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">m</span> <span class="id">body,</span> <span class="id">foreach</span> <span class="id">m</span> <span class="id">m</span> <span class="id">body</span> <span class="id">=</span> <span class="id">Ret</span> <span class="id">tt</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">loop1</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">m</span> <span class="id">n</span> <span class="id">body,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">foreach</span> (<span class="id">m</span>.<span class="id">+1</span> <span class="id">+</span> <span class="id">n</span>) <span class="id">m</span> <span class="id">body</span> <span class="id">=</span> (<span class="id">body</span> (<span class="id">m</span> <span class="id">+</span> <span class="id">n</span>)) <span class="id">&gt;&gt;</span> <span class="id">foreach</span> (<span class="id">m</span> <span class="id">+</span> <span class="id">n</span>) <span class="id">m</span> <span class="id">body</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=loopStateMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadStateLoop</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadStateLoop</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadArray</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">I</span> <span class="id">:</span> <span class="id">eqType</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">of</span> <span class="id">Monad</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">aget</span> <span class="id">:</span> <span class="id">I</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">S</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">aput</span> <span class="id">:</span> <span class="id">I</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">aputput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">i</span> <span class="id">s</span> <span class="id">s',</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s'</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">aputget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">i</span> <span class="id">s</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">agetputskip</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">i,</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">=</span> <span class="id">skip</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">agetget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">i</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">agetC</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">i</span> <span class="id">j</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">u</span> <span class="id">v</span>)) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">aget</span> <span class="id">i</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">u</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">u</span> <span class="id">v</span>)) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">aputC</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">i</span> <span class="id">j</span> <span class="id">u</span> <span class="id">v,</span> <span class="id">i</span> <span class="id">!=</span> <span class="id">j</span> <span class="id">\/</span> <span class="id">u</span> <span class="id">=</span> <span class="id">v</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">j</span> <span class="id">v</span> <span class="id">=</span> <span class="id">aput</span> <span class="id">j</span> <span class="id">v</span> <span class="id">&gt;&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">aputgetC</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">i</span> <span class="id">j</span> <span class="id">u</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span> <span class="id">i</span> <span class="id">!=</span> <span class="id">j</span> <span class="id">-&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">aget</span> <span class="id">j</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">aput</span> <span class="id">i</span> <span class="id">u</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">v</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=arrayMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadArray</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">I</span> <span class="id">:</span> <span class="id">eqType</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">M</span> <span class="id">of</span> <span class="id">isMonadArray</span> <span class="id">S</span> <span class="id">I</span> <span class="id">M</span> &amp; <span class="id">isMonad</span> <span class="id">M</span> &amp; <span class="id">isFunctor</span> <span class="id">M</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=plusArrayMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadPlusArray</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">I</span> <span class="id">:</span> <span class="id">eqType</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">M</span> <span class="id">of</span> <span class="id">MonadPlus</span> <span class="id">M</span> &amp; <span class="id">isMonadArray</span> <span class="id">S</span> <span class="id">I</span> <span class="id">M}</span>.<br/>
<br/>
<span class="vernacular">Variant</span> <span class="id">loc</span> (<span class="id">ml_type</span> <span class="id">:</span> <span class="gallina-kwd">Type</span>) (<span class="id">locT</span> <span class="id">:</span> <span class="id">eqType</span>) <span class="id">:</span> <span class="id">ml_type</span> <span class="id">-&gt;</span> <span class="gallina-kwd">Type</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">mkloc</span> <span class="id">T</span> <span class="id">:</span> <span class="id">locT</span> <span class="id">-&gt;</span> <span class="id">loc</span> <span class="id">locT</span> <span class="id">T</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">loc_id</span> (<span class="id">ml_type</span> <span class="id">:</span> <span class="gallina-kwd">Type</span>) (<span class="id">locT</span> <span class="id">:</span> <span class="id">eqType</span>) <span class="id">{T</span> <span class="id">:</span> <span class="id">ml_type}</span> (<span class="id">l</span> <span class="id">:</span> <span class="id">loc</span> <span class="id">locT</span> <span class="id">T</span>) <span class="id">:</span> <span class="id">locT</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">let:</span> <span class="id">mkloc</span> <span class="id">_</span> <span class="id">n</span> <span class="id">:=</span> <span class="id">l</span> <span class="gallina-kwd">in</span> <span class="id">n</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadTrace</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">Monad</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;<span class="id">{</span> <span class="id">mark</span> <span class="id">:</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=traceMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadTrace</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadTrace</span> <span class="id">T</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadTraceReify</span> (<span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">of</span> <span class="id">MonadReify</span> (<span class="id">seq</span> <span class="id">T</span>) <span class="id">M</span> &amp; <span class="id">MonadTrace</span> <span class="id">T</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">reifytmark</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">t</span> <span class="id">l,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reify</span> (@<span class="id">mark</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">traceMonad</span> <span class="id">T</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">t</span>) <span class="id">l</span> <span class="id">=</span> <span class="id">Some</span> (<span class="id">tt,</span> <span class="id">rcons</span> <span class="id">l</span> <span class="id">t</span>) <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadStateTrace</span> (<span class="id">S</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">Monad</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">st_get</span> <span class="id">:</span> <span class="id">M</span> <span class="id">S</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">st_put</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">st_mark</span> <span class="id">:</span> <span class="id">T</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">unit</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">st_putput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">s',</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">st_put</span> <span class="id">s'</span> <span class="id">=</span> <span class="id">st_put</span> <span class="id">s'</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">st_putget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s,</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">st_get</span> <span class="id">=</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">Ret</span> <span class="id">s</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">st_getputskip</span> <span class="id">:</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="id">st_put</span> <span class="id">=</span> <span class="id">skip</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">st_getget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> (<span class="id">A</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">k</span> <span class="id">:</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">S</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">A</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">st_get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">s</span>) <span class="id">=</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="gallina-kwd">fun</span> <span class="id">s</span> <span class="id">=&gt;</span> <span class="id">k</span> <span class="id">s</span> <span class="id">s</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">st_putmark</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">e,</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">&gt;&gt;</span> <span class="id">st_mark</span> <span class="id">e</span> <span class="id">=</span> <span class="id">st_mark</span> <span class="id">e</span> <span class="id">&gt;&gt;</span> <span class="id">st_put</span> <span class="id">s</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">st_getmark</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">e</span> (<span class="id">k</span> <span class="id">:</span> <span class="id">_</span> <span class="id">-&gt;</span> <span class="id">M</span> <span class="id">S</span>)<span class="id">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">st_get</span> <span class="id">&gt;&gt;=</span> (<span class="gallina-kwd">fun</span> <span class="id">v</span> <span class="id">=&gt;</span> <span class="id">st_mark</span> <span class="id">e</span> <span class="id">&gt;&gt;</span> <span class="id">k</span> <span class="id">v</span>) <span class="id">=</span> <span class="id">st_mark</span> <span class="id">e</span> <span class="id">&gt;&gt;</span> <span class="id">st_get</span> <span class="id">&gt;&gt;=</span> <span class="id">k</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=stateTraceMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadStateTrace</span> (<span class="id">S</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">M</span> <span class="id">of</span> <span class="id">isMonadStateTrace</span> <span class="id">S</span> <span class="id">T</span> <span class="id">M</span> &amp; <span class="id">isMonad</span> <span class="id">M</span> &amp; <span class="id">isFunctor</span> <span class="id">M</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadStateTraceReify</span> (<span class="id">S</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">of</span> <span class="id">MonadReify</span> (<span class="id">S</span> <span class="id">*</span> <span class="id">seq</span> <span class="id">T</span>)%<span class="id">type</span> <span class="id">M</span> &amp; <span class="id">MonadStateTrace</span> <span class="id">S</span> <span class="id">T</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">reifystget</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">l,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reify</span> (@<span class="id">st_get</span> <span class="id">_</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateTraceMonad</span> <span class="id">S</span> <span class="id">T</span> <span class="id">of</span> <span class="id">M]</span>) (<span class="id">s,</span> <span class="id">l</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span> (<span class="id">s,</span> (<span class="id">s,</span> <span class="id">l</span>)) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">reifystput</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">s</span> <span class="id">l</span> <span class="id">s',</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reify</span> (@<span class="id">st_put</span> <span class="id">_</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateTraceMonad</span> <span class="id">S</span> <span class="id">T</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">s'</span>) (<span class="id">s,</span> <span class="id">l</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span> (<span class="id">tt,</span> (<span class="id">s',</span> <span class="id">l</span>)) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">reifystmark</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">t</span> <span class="id">s</span> <span class="id">l,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reify</span> (@<span class="id">st_mark</span> <span class="id">_</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">stateTraceMonad</span> <span class="id">S</span> <span class="id">T</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">t</span>) (<span class="id">s,</span> <span class="id">l</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span> (<span class="id">tt,</span> (<span class="id">s,</span> <span class="id">rcons</span> <span class="id">l</span> <span class="id">t</span>)) <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=stateTraceReifyMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadStateTraceReify</span> (<span class="id">S</span> <span class="id">T</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">M</span> <span class="id">of</span> <span class="id">isMonadStateTraceReify</span> <span class="id">S</span> <span class="id">T</span> <span class="id">M</span> &amp; <span class="id">isFunctor</span> <span class="id">M</span> &amp; <span class="id">isMonad</span> <span class="id">M</span> &amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">isMonadReify</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">isMonadStateTrace</span> <span class="id">S</span> <span class="id">T</span> <span class="id">M</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadFresh</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>) <span class="id">of</span> <span class="id">Monad</span> <span class="id">M</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">fresh</span> <span class="id">:</span> <span class="id">M</span> <span class="id">S</span> <span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=freshMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadFresh</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span> <span class="id">{M</span> <span class="id">of</span> <span class="id">isMonadFresh</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">}</span>.<br/>
<br/>
<span class="vernacular">Module</span> <span class="id">segment_closed</span>.<br/>
<span class="vernacular">Record</span> <span class="id">t</span> <span class="id">A</span> <span class="id">:=</span> <span class="id">mk</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">p</span> <span class="id">:</span> <span class="id">pred</span> (<span class="id">seq</span> <span class="id">A</span>) <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">H</span> <span class="id">:</span> <span class="gallina-kwd">forall</span> <span class="id">a</span> <span class="id">b,</span> <span class="id">p</span> (<span class="id">a</span> <span class="id">++</span> <span class="id">b</span>) <span class="id">-&gt;</span> <span class="id">p</span> <span class="id">a</span> <span class="id">/\</span> <span class="id">p</span> <span class="id">b</span> <span class="id">}</span>.<br/>
<span class="vernacular">End</span> <span class="id">segment_closed</span>.<br/>
<span class="vernacular">Definition</span> <span class="id">segment_closed_p</span> <span class="id">A</span> <span class="id">:=</span> @<span class="id">segment_closed.p</span> <span class="id">A</span>.<br/>
<span class="vernacular">Coercion</span> <span class="id">segment_closed_p</span> <span class="id">:</span> <span class="id">segment_closed.t</span> <span class="id">&gt;-&gt;</span> <span class="id">pred</span>.<br/>
<br/>
<span class="vernacular">Definition</span> <span class="id">symbols</span> <span class="id">{S}</span> <span class="id">{M</span> <span class="id">:</span> <span class="id">freshMonad</span> <span class="id">S}</span> <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span> <span class="id">n</span> <span class="id">=&gt;</span> <span class="id">sequence</span> (<span class="id">nseq</span> <span class="id">n</span> (@<span class="id">fresh</span> <span class="id">_</span> <span class="id">M</span>)).<br/>
<br/>
<span class="id">HB.mixin</span> <span class="vernacular">Record</span> <span class="id">isMonadFailFresh</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) (<span class="id">M</span> <span class="id">:</span> <span class="id">UU0</span> <span class="id">-&gt;</span> <span class="id">UU0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">of</span> <span class="id">MonadFresh</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">MonadFail</span> <span class="id">M</span> <span class="id">:=</span> <span class="id">Mixin</span> <span class="id">{</span><br/>
&nbsp;&nbsp;<span class="id">distinct</span> <span class="id">:</span> <span class="id">segment_closed.t</span> <span class="id">S</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">bassert_symbols</span> <span class="id">:</span> <span class="id">bassert</span> <span class="id">distinct</span> <span class="id">\o</span> (@<span class="id">symbols</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">freshMonad</span> <span class="id">S</span> <span class="id">of</span> <span class="id">M]</span>) <span class="id">=</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">symbols</span> <span class="id">_</span> <span class="id">[the</span> <span class="id">freshMonad</span> <span class="id">S</span> <span class="id">of</span> <span class="id">M]</span> <span class="id">;</span><br/>
&nbsp;&nbsp;<span class="id">failfresh_bindmfail</span> <span class="id">:</span> <span class="id">BindLaws.right_zero</span> (@<span class="id">bind</span> <span class="id">[the</span> <span class="id">monad</span> <span class="id">of</span> <span class="id">M]</span>) (@<span class="id">fail</span> <span class="id">_</span>)<br/>
<span class="id">}</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=failFreshMonad</span>)<span class="id">]</span><br/>
<span class="id">HB.structure</span> <span class="vernacular">Definition</span> <span class="id">MonadFailFresh</span> (<span class="id">S</span> <span class="id">:</span> <span class="id">UU0</span>) <span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">{</span> <span class="id">M</span> <span class="id">of</span> <span class="id">isMonadFailFresh</span> <span class="id">S</span> <span class="id">M</span> &amp; <span class="id">isFunctor</span> <span class="id">M</span> &amp; <span class="id">isMonad</span> <span class="id">M</span> &amp; <span class="id">isMonadFresh</span> <span class="id">S</span> <span class="id">M</span> &amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">isMonadFail</span> <span class="id">M</span> <span class="id">}</span>.<br/>

      <div class="footer"><hr/>Generated by <a href="https://github.com/yoshihiro503/coq2html/">a fork of coq2html</a></div>
    </div>
  </div>
    </main>
</body>
</html>
